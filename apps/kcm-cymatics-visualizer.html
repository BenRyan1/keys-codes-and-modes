<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="color-scheme" content="dark light">
<meta name="theme-color" content="#2a4d6f">

<title>Cymatics Music Theory Visualizer | Keys, Codes & Modes</title>
<meta name="description" content="Interactive 3D Cymatics visualizer showing the geometry of sound. Explore musical intervals, chords, scales with synchronized chromatic circle, piano keyboard, guitar fretboard, and staff notation.">
<meta name="keywords" content="cymatics, music theory, chromatic circle, circle of fifths, piano keyboard, guitar fretboard, staff notation, musical intervals, chords, harmonics, sound visualization, Keys Codes Modes, Ben Ryan, music education, interactive music, triads, seventh chords, ninth chords, eleventh chords, thirteenth chords, perfect fifth, major third, tritone, octave, augmented, diminished, suspended">
<meta name="author" content="Ben Ryan, Keys Codes & Modes">
<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
<meta name="copyright" content="¬© Keys, Codes & Modes ‚Äî Ben Ryan">
<link rel="canonical" href="https://keyscodesandmodes.com/apps/kcm-cymatics-visualizer">

<!-- Favicon & Touch Icons -->
<link rel="icon" type="image/svg+xml" href="https://keyscodesandmodes.com/favicon.svg">
<link rel="icon" type="image/png" href="https://keyscodesandmodes.com/favicon.png">
<link rel="apple-touch-icon" href="https://keyscodesandmodes.com/apple-touch-icon.png">
<link rel="manifest" href="https://keyscodesandmodes.com/site.webmanifest">

<!-- Performance: Preconnect to external origins -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

<!-- Open Graph / Facebook / LinkedIn -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://keyscodesandmodes.com/apps/kcm-cymatics-visualizer">
<meta property="og:title" content="Cymatics Music Theory Visualizer | Keys, Codes & Modes">
<meta property="og:description" content="See the geometry of sound. Interactive 3D cymatics patterns synchronized with piano, guitar fretboard, chromatic circle, and staff notation.">
<meta property="og:site_name" content="Keys, Codes & Modes">
<meta property="og:image" content="https://keyscodesandmodes.com/images/cymatics-visualizer-og.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="Cymatics Music Theory Visualizer showing 3D sound wave patterns with chromatic circle">
<meta property="og:locale" content="en_US">

<!-- Twitter / X Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@keyscodesandmodes">
<meta name="twitter:creator" content="@benryankm">
<meta name="twitter:title" content="Cymatics Music Theory Visualizer | Keys, Codes & Modes">
<meta name="twitter:description" content="Interactive 3D cymatics: See how music creates geometry. Play notes, intervals, and chords ‚Äî all visualized in real time.">
<meta name="twitter:image" content="https://keyscodesandmodes.com/images/cymatics-visualizer-og.jpg">
<meta name="twitter:image:alt" content="3D cymatics visualization of musical intervals and chords">

<!-- Structured Data / JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Cymatics Music Theory Visualizer",
  "url": "https://keyscodesandmodes.com/apps/kcm-cymatics-visualizer",
  "description": "Interactive 3D cymatics visualizer demonstrating the geometry of sound through musical intervals, chords, and scales.",
  "applicationCategory": "EducationalApplication",
  "operatingSystem": "Web",
  "browserRequirements": "Requires JavaScript. Requires a modern browser with Web Audio API support.",
  "inLanguage": "en-US",
  "isAccessibleForFree": true,
  "keywords": "cymatics, music theory, intervals, chords, piano, guitar, staff notation, chromatic circle",
  "author": {
    "@type": "Person",
    "name": "Ben Ryan",
    "url": "https://keyscodesandmodes.com",
    "jobTitle": "Music Educator, Inventor, Computer Graphics Pioneer"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Keys, Codes & Modes",
    "url": "https://keyscodesandmodes.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://keyscodesandmodes.com/images/kcm-logo.svg"
    }
  },
  "image": "https://keyscodesandmodes.com/images/cymatics-visualizer-og.jpg",
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://keyscodesandmodes.com" },
      { "@type": "ListItem", "position": 2, "name": "Apps", "item": "https://keyscodesandmodes.com/apps" },
      { "@type": "ListItem", "position": 3, "name": "Cymatics Visualizer", "item": "https://keyscodesandmodes.com/apps/kcm-cymatics-visualizer" }
    ]
  }
}
</script>

<!-- Google Analytics ‚Äî Stream: Keys, Codes and Modes | ID: 13262711898 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EGC5ZNZPF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-6EGC5ZNZPF', {
    page_title: 'Cymatics Music Theory Visualizer',
    page_path: '/apps/kcm-cymatics-visualizer'
  });
</script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --ocean-blue: #4A7BA7;
    --deep-navy: #2a4d6f;
    --golden-yellow: #F4D03F;
    --light-yellow: #E8D77F;
    --mystic-purple: #8B6BA3;
    --teal: #6FA5A5;
    --coral: #CF7A5A;
    --sage-green: #9AAF7A;
  }

  /* ‚îÄ‚îÄ Accessibility: Screen Reader Only ‚îÄ‚îÄ */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
  }

  /* ‚îÄ‚îÄ Accessibility: Focus Visible (keyboard nav only) ‚îÄ‚îÄ */
  :focus-visible {
    outline: 3px solid var(--golden-yellow);
    outline-offset: 3px;
    border-radius: 3px;
  }
  /* Remove default focus ring for mouse users */
  :focus:not(:focus-visible) { outline: none; }

  /* ‚îÄ‚îÄ Accessibility: Respect reduced motion preference ‚îÄ‚îÄ */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* ‚îÄ‚îÄ High contrast mode support ‚îÄ‚îÄ */
  @media (forced-colors: active) {
    button { border: 2px solid ButtonText; }
    .white-key { border: 2px solid ButtonText; }
    .black-key { background: ButtonText; }
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    color: white;
    overflow-x: hidden;
  }

  /* Skip link for accessibility */
  .skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--golden-yellow);
    color: #000;
    padding: 8px 16px;
    font-weight: bold;
    z-index: 1000;
    text-decoration: none;
    border-radius: 0 0 4px 0;
  }
  .skip-link:focus { top: 0; }

  /* Header / Nav */
  .site-header {
    background: linear-gradient(90deg, var(--deep-navy) 0%, var(--ocean-blue) 100%);
    padding: 0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }

  .header-top {
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo-container {
    display: flex;
    align-items: center;
    gap: 16px;
    text-decoration: none;
  }

  .logo { width: 54px; height: 54px; flex-shrink: 0; }

  .site-title-block h1 {
    color: var(--golden-yellow);
    font-size: 1.6em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    line-height: 1.1;
  }

  .site-title-block .subtitle {
    color: var(--light-yellow);
    font-size: 0.95em;
    margin-top: 2px;
  }

  .site-nav {
    background: rgba(0,0,0,0.2);
    padding: 8px 24px;
  }

  .site-nav ul {
    list-style: none;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }

  .site-nav a {
    color: var(--light-yellow);
    text-decoration: none;
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    transition: background 0.2s, color 0.2s;
  }
  .site-nav a:hover, .site-nav a[aria-current="page"] {
    background: rgba(244, 208, 63, 0.2);
    color: var(--golden-yellow);
  }

  /* Main Layout */
  .main-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    min-height: calc(100vh - 180px);
  }

  /* Control Panel */
  .control-panel {
    background: rgba(42, 77, 111, 0.9);
    padding: 16px;
    overflow-y: auto;
    box-shadow: 4px 0 20px rgba(0,0,0,0.3);
  }

  .section {
    margin-bottom: 18px;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    border-left: 4px solid var(--golden-yellow);
  }

  .section h2 {
    color: var(--golden-yellow);
    margin-bottom: 10px;
    font-size: 1em;
    font-weight: 700;
  }

  button {
    width: 100%;
    padding: 10px 12px;
    margin: 4px 0;
    background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--teal) 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 600;
    transition: all 0.25s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 208, 63, 0.3);
    background: linear-gradient(135deg, var(--teal) 0%, var(--ocean-blue) 100%);
  }
  button.active {
    background: linear-gradient(135deg, var(--golden-yellow) 0%, var(--coral) 100%);
    color: #000;
    box-shadow: 0 4px 16px rgba(244, 208, 63, 0.5);
  }
  button:focus { outline: 3px solid var(--golden-yellow); outline-offset: 2px; }

  select {
    width: 100%;
    padding: 8px 10px;
    margin: 4px 0;
    background: var(--deep-navy);
    color: white;
    border: 2px solid var(--ocean-blue);
    border-radius: 6px;
    font-size: 0.9em;
    cursor: pointer;
  }
  select:focus { outline: 3px solid var(--golden-yellow); }
  optgroup { color: var(--golden-yellow); font-style: normal; font-weight: 700; }
  option { color: white; background: var(--deep-navy); font-weight: 400; }

  .info-box {
    background: rgba(74, 123, 167, 0.2);
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid var(--ocean-blue);
    margin-top: 8px;
  }
  .info-box p { font-size: 0.82em; line-height: 1.5; color: var(--light-yellow); }

  /* Visualization Area */
  .viz-area {
    display: flex;
    flex-direction: column;
    background: #0a0a0a;
  }

  #cymatics-canvas {
    width: 100%;
    height: 45vh;
    display: block;
  }

  /* Active note display bar */
  .active-note-bar {
    background: rgba(42,77,111,0.95);
    padding: 8px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 2px solid var(--ocean-blue);
    min-height: 42px;
    flex-wrap: wrap;
  }
  .active-note-bar .label { color: var(--light-yellow); font-size: 0.85em; font-weight: 600; }
  .note-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 3px 10px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9em;
    color: #000;
    border: 2px solid rgba(0,0,0,0.2);
  }
  .note-swatch { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.3); }

  /* Theory Panels Grid */
  .theory-panels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 14px;
    padding: 14px;
    background: rgba(26, 26, 46, 0.8);
  }

  .panel {
    background: rgba(42, 77, 111, 0.3);
    padding: 14px;
    border-radius: 8px;
    border: 2px solid var(--ocean-blue);
  }

  .panel h3 {
    color: var(--golden-yellow);
    margin-bottom: 10px;
    font-size: 0.95em;
  }

  /* ============ PIANO KEYBOARD ============ */
  .piano-wrapper {
    overflow-x: auto;
    padding-bottom: 4px;
  }

  .piano {
    display: flex;
    height: 90px;
    position: relative;
    width: 100%;
    min-width: 280px;
    max-width: 480px;
    margin: 0 auto;
  }

  .white-key {
    flex: 1;
    background: white;
    border: 1.5px solid #555;
    border-top: none;
    border-radius: 0 0 4px 4px;
    position: relative;
    cursor: pointer;
    transition: background 0.08s, box-shadow 0.08s;
    min-width: 0;
  }
  .white-key:hover { background: #e8f4ff; }
  .white-key.active {
    box-shadow: 0 0 18px var(--active-glow, #F4D03F), inset 0 -2px 6px rgba(0,0,0,0.2);
  }
  .white-key .key-label {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #444;
    font-weight: 600;
    pointer-events: none;
    user-select: none;
  }
  .white-key.active .key-label { color: #000; font-weight: 700; }

  .black-key {
    width: 60%;         /* percent of white key width ‚Äî set via JS */
    max-width: 18px;
    height: 58%;
    background: #111;
    border: 1.5px solid #000;
    border-top: none;
    border-radius: 0 0 3px 3px;
    position: absolute;
    cursor: pointer;
    z-index: 2;
    transition: background 0.08s, box-shadow 0.08s;
    top: 0;
  }
  .black-key:hover { background: #333; }
  .black-key.active {
    box-shadow: 0 0 16px var(--active-glow, #CF7A5A), inset 0 -2px 4px rgba(0,0,0,0.4);
  }
  .black-key .key-label {
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 8px;
    color: #ccc;
    font-weight: 600;
    pointer-events: none;
    user-select: none;
    white-space: nowrap;
  }
  .black-key.active .key-label { color: #fff; }

  /* ============================================================
     FRETBOARD
     COLUMNS (West‚ÜíEast) = 6 STRINGS:  E  A  D  G  B  e
     ROWS (North‚ÜíSouth)  = FRET ROWS:
       Row 0 = NUT/OPEN combined ‚Äî shows open note name, lights up when played
       Row 1 = Fret 1
       Row 2 = Fret 2  ‚Ä¶ etc.
     ============================================================ */

  .fretboard-controls {
    display: flex; gap: 10px; margin-bottom: 10px;
    align-items: center; flex-wrap: wrap;
  }
  .fretboard-controls label { color: var(--golden-yellow); font-weight: bold; font-size: 0.9em; }
  .fretboard-controls select { width: auto; padding: 6px 10px; }

  .fretboard-outer {
    overflow-x: auto;
    display: flex;
    justify-content: center;
  }

  /* Neck wood ‚Äî compact & centered */
  .fretboard {
    background: linear-gradient(90deg, #2e1e0a 0%, #3d2d14 15%, #4a3820 50%, #3d2d14 85%, #2e1e0a 100%);
    border-radius: 8px;
    padding: 8px 10px 12px 10px;
    box-shadow: inset 0 3px 14px rgba(0,0,0,0.7), 0 4px 20px rgba(0,0,0,0.4);
    display: inline-block;
    width: auto;
    min-width: 0;
  }

  /* ‚îÄ‚îÄ HEADER ROW: string name labels across the top ‚îÄ‚îÄ */
  .fb-header-row {
    display: flex;
    margin-bottom: 0;
  }
  /* Left label column placeholder (matches .fb-row-label width) */
  .fb-header-spacer {
    width: 32px;
    flex-shrink: 0;
  }
  /* Each string name cell in the header */
  .fb-string-header {
    flex: 1;
    min-width: 32px;
    text-align: center;
    font-size: 0.95em;
    font-weight: 800;
    color: var(--golden-yellow);
    text-shadow: 0 1px 4px rgba(0,0,0,0.8);
    padding: 3px 0 5px;
    letter-spacing: 0px;
  }

  /* ‚îÄ‚îÄ EACH FRET ROW (one row = one fret position across all 6 strings) ‚îÄ‚îÄ */
  .fb-fret-row {
    display: flex;
    align-items: stretch;
    position: relative;
  }

  /* NUT/OPEN row gets a thick bottom border (the nut bar) */
  .fb-fret-row[data-fret="0"] {
    border-bottom: 7px solid #e8dfc8;
    box-shadow: 0 4px 0 #c0b090;
    margin-bottom: 2px;
  }
  /* All other rows get a thinner fret-wire bottom border */
  .fb-fret-row:not([data-fret="0"]) {
    border-bottom: 3px solid rgba(200,175,90,0.7);
  }

  /* ‚îÄ‚îÄ ROW LABEL (fret number on the left) ‚îÄ‚îÄ */
  .fb-row-label {
    width: 32px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 6px;
    color: var(--light-yellow);
    font-size: 0.72em;
    font-weight: 700;
    opacity: 0.85;
  }
  /* NUT/OPEN row label says "NUT" */
  .fb-fret-row[data-fret="0"] .fb-row-label {
    color: #e8dfc8;
    font-size: 0.65em;
    letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ STRING COLUMN WIRES (vertical, run through all fret rows) ‚îÄ‚îÄ */
  /* Drawn as ::after pseudo on each cell, thickness varies by string */
  .fb-cell {
    flex: 1;
    min-width: 32px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    transition: background 0.1s;
  }
  .fb-cell:hover { background: rgba(74,123,167,0.22); border-radius: 3px; }

  /* String wire running vertically through the cell */
  .fb-cell::before {
    content: '';
    position: absolute;
    top: 0; bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    pointer-events: none;
    z-index: 1;
    border-radius: 2px;
  }
  /* String 0=E(low/thick) ‚Üí String 5=e(high/thin) */
  .fb-cell[data-string="0"]::before { width: 4px;   background: linear-gradient(180deg,#bfb8b0,#8a8480,#bfb8b0); }
  .fb-cell[data-string="1"]::before { width: 3.2px; background: linear-gradient(180deg,#c4bdb5,#908c88,#c4bdb5); }
  .fb-cell[data-string="2"]::before { width: 2.5px; background: linear-gradient(180deg,#c8c2bc,#959190,#c8c2bc); }
  .fb-cell[data-string="3"]::before { width: 2px;   background: linear-gradient(180deg,#ccc6c0,#9a9694,#ccc6c0); }
  .fb-cell[data-string="4"]::before { width: 1.5px; background: linear-gradient(180deg,#d0cac4,#9e9a98,#d0cac4); }
  .fb-cell[data-string="5"]::before { width: 1px;   background: linear-gradient(180deg,#d4cec8,#a2a09e,#d4cec8); }

  /* ‚îÄ‚îÄ NOTE DOT ‚îÄ‚îÄ */
  .fb-dot {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: 800;
    color: #000;
    position: relative;
    z-index: 3;
    transition: all 0.15s;
    pointer-events: none;
    /* Hidden by default on fretted notes */
    opacity: 0;
    transform: scale(0.4);
    box-shadow: none;
  }

  /* NUT/OPEN row: always show note name at reduced opacity */
  .fb-fret-row[data-fret="0"] .fb-dot {
    opacity: 0.55;
    transform: scale(0.85);
    font-size: 9px;
    font-weight: 900;
    border-color: rgba(255,255,255,0.6);
  }

  /* ACTIVE = played ‚Äî full brightness + glow */
  .fb-cell.active .fb-dot {
    opacity: 1 !important;
    transform: scale(1) !important;
    box-shadow: 0 0 16px var(--dot-glow, #F4D03F), 0 2px 8px rgba(0,0,0,0.6) !important;
    border-color: white !important;
  }

  /* ‚îÄ‚îÄ INLAY DOTS ROW (below all fret rows) ‚îÄ‚îÄ */
  .fb-inlay-row {
    display: flex;
    padding-top: 6px;
  }
  .fb-inlay-spacer { width: 32px; flex-shrink: 0; }
  .fb-inlay-cell {
    flex: 1;
    min-width: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    min-height: 14px;
  }
  .fb-inlay-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(244,208,63,0.65) 0%, rgba(244,208,63,0.15) 100%);
    border: 1px solid rgba(255,255,255,0.2);
  }

  /* ============ CHROMATIC CIRCLE ============ */
  .circle-canvas-wrap {
    display: flex;
    justify-content: center;
  }
  .circle-of-fifths {
    width: 100%;
    max-width: 280px;
    height: 280px;
    cursor: pointer;
    display: block;
  }

  /* ============ STAFF NOTATION ============ */
  .staff-wrap {
    background: #fffdf5;
    border-radius: 6px;
    padding: 10px 12px 14px 12px;
    position: relative;
    height: 200px;
    overflow: hidden;
  }

  .staff-lines {
    position: absolute;
    left: 0; right: 0;
    top: 0; bottom: 0;
    pointer-events: none;
  }

  /*
    TREBLE CLEF ‚Äî correct positions:
    Staff wrap height = 200px
    5 lines centred vertically, 10px apart (line to line).
    Step = 5px (line ‚Üí space = 5px, space ‚Üí line = 5px)
    Lines at top: 70, 80, 90, 100, 110
    Each step up = -5px from previous position

    Reading from bottom line up:
      Line 1 (E4) = 110px
      Space      (F4) = 105px
      Line 2 (G4) = 100px
      Space      (A4) = 95px
      Line 3 (B4) = 90px
      Space      (C5) = 85px
      Line 4 (D5) = 80px
      Space      (E5) = 75px
      Line 5 (F5) = 70px

    Below staff:
      Space (D4) = 115px
      Ledger line / Middle C (C4) = 120px

    Above staff:
      Space (G5) = 65px
      Ledger line (A5) = 60px  ‚Äî actually A5 sits in space
      Space (A5) = 60px
      Ledger (B5, needs line) ‚Äî etc.
  */
  .staff-line-el {
    position: absolute;
    left: 48px; right: 10px;
    height: 2px;
    background: #333;
  }

  .treble-clef-svg {
    position: absolute;
    left: 10px;
    top: 48px;   /* vertically centred on staff */
    height: 110px;
    width: 34px;
    pointer-events: none;
    z-index: 2;
  }

  .staff-note-marker {
    position: absolute;
    width: 18px;
    height: 12px;
    border-radius: 50%;
    transform: rotate(-12deg);
    transition: transform 0.15s, box-shadow 0.15s;
    cursor: pointer;
    z-index: 10;
    border: 1.5px solid rgba(0,0,0,0.25);
  }
  .staff-note-marker:hover {
    transform: rotate(-12deg) scale(1.2);
    box-shadow: 0 0 14px currentColor !important;
  }

  /* Stem on note */
  .staff-note-stem {
    position: absolute;
    width: 2px;
    background: #222;
    z-index: 9;
    pointer-events: none;
  }

  .staff-ledger {
    position: absolute;
    height: 2px;
    background: #444;
    z-index: 5;
    pointer-events: none;
  }

  .staff-accidental {
    position: absolute;
    font-size: 13px;
    font-weight: 700;
    color: #222;
    z-index: 11;
    pointer-events: none;
    line-height: 1;
  }

  .staff-note-name {
    position: absolute;
    font-size: 8px;
    font-weight: 800;
    z-index: 12;
    pointer-events: none;
    text-align: center;
    line-height: 1;
  }

  /* ============ TAB ============ */
  .tab {
    background: #1a1a2e;
    color: #aac;
    padding: 12px 14px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.92em;
    line-height: 1.9;
    border: 1px solid var(--ocean-blue);
    user-select: none;
  }
  .tab span:hover {
    background: rgba(74,123,167,0.15);
    border-radius: 3px;
  }

  /* ============ WAVE INFO ============ */
  .wave-type {
    display: inline-block;
    padding: 2px 8px;
    background: var(--mystic-purple);
    border-radius: 4px;
    font-size: 0.8em;
    margin-left: 8px;
  }

  #wave-list { list-style: none; padding: 0; }
  #wave-list li {
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 0.88em;
  }
  #wave-list li:last-child { border-bottom: none; }

  /* ============ EDUCATIONAL SECTION ============ */
  .theory-info {
    background: rgba(74, 123, 167, 0.15);
    padding: 16px 20px;
    margin: 0;
    border-top: 2px solid var(--ocean-blue);
  }
  .theory-info h3 { color: var(--golden-yellow); margin-bottom: 10px; }
  .theory-info ul { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; }
  .theory-info li { padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.87em; line-height: 1.5; }
  .theory-info strong { color: var(--golden-yellow); }

  /* ============ FOOTER ============ */
  .site-footer {
    background: linear-gradient(90deg, #0d1b2a 0%, #1a2d4a 100%);
    padding: 32px 24px 16px;
    border-top: 2px solid var(--deep-navy);
    color: var(--light-yellow);
  }

  .footer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 28px;
    max-width: 1200px;
    margin: 0 auto 24px;
  }

  .footer-col h4 {
    color: var(--golden-yellow);
    margin-bottom: 12px;
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .footer-col ul { list-style: none; padding: 0; }
  .footer-col li { margin-bottom: 7px; }
  .footer-col a {
    color: var(--light-yellow);
    text-decoration: none;
    font-size: 0.88em;
    transition: color 0.2s;
  }
  .footer-col a:hover { color: var(--golden-yellow); text-decoration: underline; }
  .footer-col p { font-size: 0.86em; line-height: 1.6; color: #aac; }

  .footer-bottom {
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid rgba(74, 123, 167, 0.3);
    font-size: 0.82em;
    color: #7a9ab0;
    max-width: 1200px;
    margin: 0 auto;
  }
  .footer-bottom a { color: var(--light-yellow); text-decoration: none; }
  .footer-bottom a:hover { text-decoration: underline; }

  /* ============ RESPONSIVE ============ */
  @media (max-width: 1024px) {
    .main-container { grid-template-columns: 1fr; }
    .control-panel { max-height: 320px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .section { margin-bottom: 0; }
  }

  @media (max-width: 640px) {
    .site-title-block h1 { font-size: 1.2em; }
    .theory-panels { grid-template-columns: 1fr; }
    .control-panel { grid-template-columns: 1fr; }
    .piano { width: 300px; min-width: 300px; }
  }
</style>
</head>
<body>

<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- ============ HEADER / NAV ============ -->
<header class="site-header" role="banner">
  <div class="header-top">
    <a href="https://keyscodesandmodes.com" class="logo-container" aria-label="Keys, Codes & Modes Home">
      <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <circle cx="100" cy="100" r="98" fill="#4A7BA7" stroke="#2a4d6f" stroke-width="1"/>
        <polygon points="100,15 185,185 15,185" fill="#F4D03F" opacity="0.85"/>
        <polygon points="100,15 15,185 15,55" fill="#8B6BA3" opacity="0.75"/>
        <polygon points="100,15 185,55 185,185" fill="#6FA5A5" opacity="0.75"/>
        <polygon points="15,55 100,100 15,185" fill="#CF7A5A" opacity="0.65"/>
        <polygon points="185,55 100,100 185,185" fill="#9AAF7A" opacity="0.65"/>
        <polygon points="100,55 145,100 100,145 55,100" fill="#E8D77F" opacity="0.6"/>
        <circle cx="100" cy="100" r="50" fill="none" stroke="#2a4d6f" stroke-width="2.5"/>
        <circle cx="100" cy="100" r="7" fill="#2a4d6f"/>
        <line x1="40" y1="40" x2="160" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
        <line x1="160" y1="40" x2="40" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
        <line x1="100" y1="20" x2="100" y2="180" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
        <line x1="20" y1="100" x2="180" y2="100" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
      </svg>
      <div class="site-title-block">
        <h1>Cymatics Music Theory Visualizer</h1>
        <div class="subtitle">See the Geometry of Sound | Keys, Codes &amp; Modes</div>
      </div>
    </a>
  </div>
  <nav class="site-nav" aria-label="Site navigation">
    <ul role="list">
      <li><a href="https://keyscodesandmodes.com">Home</a></li>
      <li><a href="https://keyscodesandmodes.com/apps">Apps</a></li>
      <li><a href="https://keyscodesandmodes.com/apps/kcm-cymatics-visualizer" aria-current="page">Cymatics Visualizer</a></li>
      <li><a href="https://keyscodesandmodes.com/apps/music-theory-explorer">Music Theory Explorer</a></li>
      <li><a href="https://axexel.myshopify.com/collections/keys-codes-and-modes-book-the-book-that-changes-everything">Book</a></li>
      <li><a href="https://keyscodesandmodes.com/freestyle">FreeStyle¬Æ Device</a></li>
      <li><a href="https://keyscodesandmodes.com/about">About</a></li>
      <li><a href="https://keyscodesandmodes.com/contact">Contact</a></li>
    </ul>
  </nav>
</header>

<!-- ============ MAIN CONTENT ============ -->
<main id="main-content">
<div class="main-container">

  <!-- Control Panel -->
  <aside class="control-panel" aria-label="Music controls">

    <!-- Octave Register -->
    <div class="section">
      <h2>üéöÔ∏è Octave Register</h2>
      <label for="octave-select" class="sr-only">Select octave</label>
      <select id="octave-select" onchange="changeOctave(this.value)" aria-label="Select octave register">
        <option value="2">Octave 2 (Very Low)</option>
        <option value="3">Octave 3 (Low)</option>
        <option value="4" selected>Octave 4 (Middle C)</option>
        <option value="5">Octave 5</option>
        <option value="6">Octave 6 (High)</option>
      </select>
      <div class="info-box">
        <p><strong>Current:</strong> <span id="current-octave">Octave 4</span><br>
        <strong>Range:</strong> <span id="octave-range">C4‚ÄìB4</span></p>
      </div>
    </div>

    <!-- Single Notes -->
    <div class="section">
      <h2>üéµ Single Notes</h2>
      <label for="note-select" class="sr-only">Select a note to play</label>
      <select id="note-select" onchange="playSelectedNote(this.value)" aria-label="Choose a note to play">
        <option value="">‚Äî Choose a Note ‚Äî</option>
        <option value="C">C (Do)</option>
        <option value="C#">C# / D‚ô≠</option>
        <option value="D">D (Re)</option>
        <option value="D#">D# / E‚ô≠</option>
        <option value="E">E (Mi)</option>
        <option value="F">F (Fa)</option>
        <option value="F#">F# / G‚ô≠</option>
        <option value="G">G (Sol)</option>
        <option value="G#">G# / A‚ô≠</option>
        <option value="A">A (La)</option>
        <option value="A#">A# / B‚ô≠</option>
        <option value="B">B (Ti)</option>
      </select>
    </div>

    <!-- Musical Intervals -->
    <div class="section">
      <h2>üéº Musical Intervals</h2>
      <label for="interval-root" style="color:var(--light-yellow);font-size:0.82em;display:block;margin-bottom:2px;">Root Note</label>
      <select id="interval-root" onchange="onIntervalChange()" aria-label="Interval root note">
        <option value="C">C</option><option value="C#">C# / D‚ô≠</option>
        <option value="D">D</option><option value="D#">D# / E‚ô≠</option>
        <option value="E">E</option><option value="F">F</option>
        <option value="F#">F# / G‚ô≠</option><option value="G">G</option>
        <option value="G#">G# / A‚ô≠</option><option value="A">A</option>
        <option value="A#">A# / B‚ô≠</option><option value="B">B</option>
      </select>
      <label for="interval-type" style="color:var(--light-yellow);font-size:0.82em;display:block;margin:6px 0 2px;">Interval</label>
      <select id="interval-type" onchange="onIntervalChange()" aria-label="Interval type">
        <option value="">‚Äî Choose Interval ‚Äî</option>
        <option value="0">Unison (1:1)</option>
        <option value="1">Minor 2nd ‚Äî m2</option>
        <option value="2">Major 2nd ‚Äî M2</option>
        <option value="3">Minor 3rd ‚Äî m3</option>
        <option value="4">Major 3rd ‚Äî M3 (5:4)</option>
        <option value="5">Perfect 4th ‚Äî P4 (4:3)</option>
        <option value="6">Tritone ‚Äî TT (‚àö2:1)</option>
        <option value="7">Perfect 5th ‚Äî P5 (3:2)</option>
        <option value="8">Minor 6th ‚Äî m6</option>
        <option value="9">Major 6th ‚Äî M6</option>
        <option value="10">Minor 7th ‚Äî m7</option>
        <option value="11">Major 7th ‚Äî M7</option>
        <option value="12">Octave ‚Äî P8 (2:1)</option>
      </select>
      <div class="info-box" style="margin-top:8px;">
        <p id="interval-info">Select a root and interval to play</p>
      </div>
    </div>

    <!-- Chords -->
    <div class="section">
      <h2>üéπ Chords</h2>
      <label for="chord-root" style="color:var(--light-yellow);font-size:0.82em;display:block;margin-bottom:2px;">Root Note</label>
      <select id="chord-root" onchange="onChordChange()" aria-label="Chord root note">
        <option value="C">C</option><option value="C#">C# / D‚ô≠</option>
        <option value="D">D</option><option value="D#">D# / E‚ô≠</option>
        <option value="E">E</option><option value="F">F</option>
        <option value="F#">F# / G‚ô≠</option><option value="G">G</option>
        <option value="G#">G# / A‚ô≠</option><option value="A">A</option>
        <option value="A#">A# / B‚ô≠</option><option value="B">B</option>
      </select>
      <label for="chord-type" style="color:var(--light-yellow);font-size:0.82em;display:block;margin:6px 0 2px;">Chord Type</label>
      <select id="chord-type" onchange="onChordChange()" aria-label="Chord type">
        <option value="">‚Äî Choose Chord ‚Äî</option>
        <optgroup label="‚îÄ‚îÄ Triads ‚îÄ‚îÄ">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
          <option value="augmented">Augmented</option>
          <option value="diminished">Diminished</option>
          <option value="sus2">Suspended 2nd</option>
          <option value="sus4">Suspended 4th</option>
        </optgroup>
        <optgroup label="‚îÄ‚îÄ 7th Chords ‚îÄ‚îÄ">
          <option value="maj7">Major 7th</option>
          <option value="dom7">Dominant 7th</option>
          <option value="min7">Minor 7th</option>
          <option value="minmaj7">Minor-Major 7th</option>
          <option value="dim7">Diminished 7th</option>
          <option value="halfdim7">Half-Diminished 7th (m7‚ô≠5)</option>
          <option value="aug7">Augmented 7th</option>
          <option value="augmaj7">Augmented Major 7th</option>
        </optgroup>
        <optgroup label="‚îÄ‚îÄ 9th Chords ‚îÄ‚îÄ">
          <option value="maj9">Major 9th</option>
          <option value="dom9">Dominant 9th</option>
          <option value="min9">Minor 9th</option>
          <option value="add9">Add 9</option>
          <option value="dom7b9">Dominant 7‚ô≠9</option>
          <option value="dom7s9">Dominant 7‚ôØ9</option>
        </optgroup>
        <optgroup label="‚îÄ‚îÄ 11th Chords ‚îÄ‚îÄ">
          <option value="maj11">Major 11th</option>
          <option value="dom11">Dominant 11th</option>
          <option value="min11">Minor 11th</option>
          <option value="dom7s11">Dominant 7‚ôØ11 (Lydian)</option>
        </optgroup>
        <optgroup label="‚îÄ‚îÄ 13th Chords ‚îÄ‚îÄ">
          <option value="maj13">Major 13th</option>
          <option value="dom13">Dominant 13th</option>
          <option value="min13">Minor 13th</option>
          <option value="dom13b9">Dominant 13‚ô≠9</option>
        </optgroup>
      </select>
      <div class="info-box" style="margin-top:8px;">
        <p id="chord-info">All chords use the <strong>selected octave</strong> ‚Äî no jumping!</p>
      </div>
    </div>

    <!-- Plate Shape -->
    <div class="section">
      <h2>üìê Plate Shape</h2>
      <label for="plate-shape-select" class="sr-only">Select plate shape</label>
      <select id="plate-shape-select" onchange="setPlateShape(this.value)" aria-label="Select plate shape">
        <option value="square">Square Plate</option>
        <option value="circle">Circular Plate</option>
      </select>
      <div class="info-box">
        <p>Different shapes create different resonance patterns</p>
      </div>
    </div>

    <!-- Controls Info -->
    <div class="section">
      <h2>üéÆ 3D Controls</h2>
      <div class="info-box">
        <p><strong>Rotate:</strong> Drag canvas<br>
        <strong>Zoom:</strong> Scroll wheel<br>
        <strong>Pan:</strong> Right-drag<br>
        Click any note on piano, fretboard, staff, or circle to play!</p>
      </div>
    </div>

  </aside>

  <!-- Visualization Area -->
  <div class="viz-area">
    <canvas id="cymatics-canvas" aria-label="3D cymatics visualization showing sound wave patterns" role="img" tabindex="0"></canvas>

    <!-- Active note status bar -->
    <div class="active-note-bar" role="status" aria-live="polite" aria-label="Currently playing notes">
      <span class="label">Now Playing:</span>
      <span id="active-note-badges">Select a note, interval, or chord</span>
    </div>

    <!-- Music Theory Panels -->
    <div class="theory-panels">

      <!-- Piano -->
      <div class="panel">
        <h3>üéπ Piano Keyboard <small style="font-size:0.8em;color:#aac;">(click keys to play)</small></h3>
        <div class="piano-wrapper">
          <div class="piano" id="piano" role="group" aria-label="Piano keyboard"></div>
        </div>
      </div>

      <!-- Guitar Fretboard -->
      <div class="panel">
        <h3>üé∏ Guitar Fretboard <small style="font-size:0.8em;color:#aac;">(click frets to play)</small></h3>
        <div class="fretboard-controls">
          <label for="fret-count-select">View:</label>
          <select id="fret-count-select" onchange="changeFretCount(this.value)" aria-label="Number of frets to display">
            <option value="3">3 Frets</option>
            <option value="5" selected>5 Frets</option>
            <option value="7">7 Frets</option>
            <option value="12">12 Frets</option>
          </select>
        </div>
        <div class="fretboard-outer">
          <div id="fretboard" class="fretboard" role="group" aria-label="Guitar fretboard"></div>
        </div>
      </div>

      <!-- Chromatic Circle -->
      <div class="panel">
        <h3>‚≠ï Chromatic Circle <small style="font-size:0.8em;color:#aac;">(click notes to play)</small></h3>
        <div class="circle-canvas-wrap">
          <canvas class="circle-of-fifths" id="circle-canvas" tabindex="0" role="img" aria-label="Chromatic circle - click to play notes"></canvas>
        </div>
      </div>

      <!-- Staff Notation -->
      <div class="panel">
        <h3>üéº Staff Notation <small style="font-size:0.8em;color:#aac;">(click notes to play)</small></h3>
        <div class="staff-wrap" id="staff-wrap" tabindex="0" role="group" aria-label="Musical staff notation">
          <div class="staff-lines" id="staff-lines"></div>
          <!-- Treble clef SVG -->
          <svg class="treble-clef-svg" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M20 5 C20 5 14 20 14 40 C14 60 22 65 22 75 C22 90 10 95 10 95 C6 98 8 110 20 110 C30 110 34 100 30 90 C26 82 18 80 18 75 C18 65 28 58 28 42 C28 25 22 8 20 5Z" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round"/>
            <circle cx="18" cy="78" r="4" fill="#333"/>
          </svg>
        </div>
      </div>

      <!-- Guitar TAB -->
      <div class="panel">
        <h3>üé∏ Guitar TAB</h3>
        <pre class="tab" id="tab" aria-label="Guitar tablature notation">e|-----|
B|-----|
G|-----|
D|-----|
A|-----|
E|-----|</pre>
      </div>

      <!-- Wave Analysis -->
      <div class="panel">
        <h3>üìä Wave Analysis</h3>
        <ul id="wave-list" aria-live="polite" aria-label="Sound frequency analysis">
          <li>Select a note, interval, or chord to see analysis</li>
        </ul>
      </div>

    </div>

    <!-- Educational section -->
    <section class="theory-info" aria-labelledby="theory-heading">
      <h3 id="theory-heading">üß† Why This Matters: The Geometry of Music</h3>
      <ul>
        <li><strong>Notes:</strong> Single frequencies create simple, stable standing waves with defined nodes</li>
        <li><strong>Intervals:</strong> Frequency ratios create geometric patterns ‚Äî consonance = symmetry</li>
        <li><strong>Chords:</strong> Multiple frequencies interfere, forming complex lattices or chaotic motion</li>
        <li><strong>Harmony isn't subjective ‚Äî it's geometric!</strong> Cymatics proves music theory is physics</li>
        <li><strong>Application:</strong> Understanding wave mechanics prepares you for Unity, VR, and sound installations</li>
      </ul>
    </section>
  </div>

</div>
</main>

<!-- ============ FOOTER ============ -->
<footer class="site-footer" role="contentinfo">
  <div class="footer-grid">
    <div class="footer-col">
      <h4>Keys, Codes &amp; Modes</h4>
      <p>A visual approach to understanding music theory ‚Äî connecting sound, geometry, and harmony through interactive tools and educational resources.</p>
    </div>
    <div class="footer-col">
      <h4>Apps &amp; Tools</h4>
      <ul>
        <li><a href="https://keyscodesandmodes.com/apps/kcm-cymatics-visualizer">Cymatics Visualizer</a></li>
        <li><a href="https://keyscodesandmodes.com/apps/music-theory-explorer">Music Theory Explorer Pro</a></li>
        <li><a href="https://keyscodesandmodes.com/apps">All Apps</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Resources</h4>
      <ul>
        <li><a href="https://axexel.myshopify.com/collections/keys-codes-and-modes-book-the-book-that-changes-everything">Keys, Codes &amp; Modes Book</a></li>
        <li><a href="https://keyscodesandmodes.com/freestyle">FreeStyle¬Æ Musical Device</a></li>
        <li><a href="https://keyscodesandmodes.com/lessons">Music Theory Lessons</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Connect</h4>
      <ul>
        <li><a href="https://keyscodesandmodes.com/about">About Ben Ryan</a></li>
        <li><a href="https://keyscodesandmodes.com/contact">Contact</a></li>
        <li><a href="https://keyscodesandmodes.com/privacy">Privacy Policy</a></li>
        <li><a href="https://keyscodesandmodes.com/sitemap.xml">Sitemap</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <p>¬© <span id="footer-year"></span> Keys, Codes &amp; Modes ¬∑ Ben Ryan ¬∑ FreeStyle¬Æ is a registered trademark ¬∑
    <a href="https://keyscodesandmodes.com/privacy">Privacy</a> ¬∑
    <a href="https://keyscodesandmodes.com/sitemap.xml">Sitemap</a></p>
  </div>
</footer>

<!-- Three.js via ESM -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// ============================================================
// CONSTANTS & NOTE DATA
// ============================================================

const CHROMATIC_NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

// Spectrum-based chromatic color wheel (consistent with KCM standard)
const NOTE_COLORS = {
  'C':  '#FFFF00',  // Yellow
  'C#': '#FFC400',  // Yellow-Orange
  'D':  '#FF8000',  // Orange
  'D#': '#FF4000',  // Red-Orange
  'E':  '#FF0000',  // Red
  'F':  '#C4007F',  // Red-Purple
  'F#': '#8000FF',  // Purple
  'G':  '#4000FF',  // Blue-Purple
  'G#': '#0000FF',  // Blue
  'A':  '#007FFF',  // Blue-Green (Cyan)
  'A#': '#00FF80',  // Green
  'B':  '#80FF00'   // Yellow-Green
};

// Base frequencies for octave 4
const BASE_FREQS = {
  'C':261.63,'C#':277.18,'D':293.66,'D#':311.13,
  'E':329.63,'F':349.23,'F#':369.99,'G':392.00,
  'G#':415.30,'A':440.00,'A#':466.16,'B':493.88
};

function getNoteFreq(note, octave) {
  return BASE_FREQS[note] * Math.pow(2, octave - 4);
}

// Guitar standard tuning: E2 A2 D3 G3 B3 E4 (low to high)
const STRING_TUNING = [
  { note: 'E', octave: 2, label: 'E' },
  { note: 'A', octave: 2, label: 'A' },
  { note: 'D', octave: 3, label: 'D' },
  { note: 'G', octave: 3, label: 'G' },
  { note: 'B', octave: 3, label: 'B' },
  { note: 'E', octave: 4, label: 'e' }
];

// ============================================================
// STAFF NOTATION ‚Äî correct treble clef positions
//
// Staff wrap height = 200px
// 5 staff lines, spaced 10px apart (one step = 5px)
// Lines at top (px): 70, 80, 90, 100, 110
//
// Bottom line up = E4 (110), G4 (100), B4 (90), D5 (80), F5 (70)
// Each step UP = 5px LESS (notes rise = y decreases)
//
// Full map (note ‚Üí top px of note head centre):
//   Below staff:
//     D4 = 115  (space below line 1)
//     C4 = 120  (ledger line ‚Äî Middle C)
//     B3 = 125  (below ledger)
//   On/in staff:
//     E4 = 110  (line 1)
//     F4 = 105  (space 1)
//     G4 = 100  (line 2)
//     A4 = 95   (space 2)
//     B4 = 90   (line 3)
//     C5 = 85   (space 3)
//     D5 = 80   (line 4)
//     E5 = 75   (space 4)
//     F5 = 70   (line 5)
//   Above staff:
//     G5 = 65   (space above line 5)
//     A5 = 60   (ledger line)
//     B5 = 55   (above ledger)
//     C6 = 50   (ledger line)
// ============================================================

const STAFF_LINE_Y = [70, 80, 90, 100, 110]; // top px of each staff line

// Returns the y-centre (in px) for a given note+octave on treble clef
// Each diatonic step = 5px; we compute from a reference point.
// Reference: C4 (Middle C) = 120px, each step up = -5px
const DIATONIC_STEPS = { 'C':0,'D':1,'E':2,'F':3,'G':4,'A':5,'B':6 };
const C4_Y = 120; // Middle C ledger line y-centre
const STEP_PX = 5; // px per diatonic step

function getNoteStaffY(noteName, octave) {
  // Get the natural note (strip #)
  const natural = noteName.replace('#','');
  const dStep = DIATONIC_STEPS[natural];
  if (dStep === undefined) return 90; // fallback

  // Steps above C4: each octave = 7 diatonic steps
  const stepsAboveC4 = (octave - 4) * 7 + dStep;
  return C4_Y - (stepsAboveC4 * STEP_PX);
}

// Which y-values need ledger lines drawn (outside the 5 staff lines)
// Staff lines at 70,80,90,100,110. Spaces inside: 75,85,95,105.
// Ledger lines needed if note y <= 65 or >= 115, on even multiples of 10 from lines
function getLedgerLines(noteY) {
  const ledgers = [];
  if (noteY >= 115) {
    // Below staff ‚Äî ledger lines at 120 (C4 ledger), 130, etc.
    for (let y = 120; y <= noteY + 1; y += 10) ledgers.push(y);
  } else if (noteY <= 65) {
    // Above staff ‚Äî ledger lines at 60 (A5/B5 area), 50, etc.
    for (let y = 60; y >= noteY - 1; y -= 10) ledgers.push(y);
  }
  return ledgers;
}

function buildStaffLines() {
  const staffLines = document.getElementById('staff-lines');
  staffLines.innerHTML = '';
  STAFF_LINE_Y.forEach(y => {
    const line = document.createElement('div');
    line.className = 'staff-line-el';
    line.style.top = y + 'px';
    staffLines.appendChild(line);
  });
}

function updateStaff() {
  const wrap = document.getElementById('staff-wrap');
  // Remove only dynamic elements (keep staff-lines div and treble clef SVG)
  wrap.querySelectorAll('.staff-note-marker,.staff-ledger,.staff-accidental,.staff-note-name,.staff-note-stem').forEach(el => el.remove());

  if (!currentNotes.length) return;

  // We need the actual octave for each note as played.
  // currentNotes = note names; we derive octave from currentFreqs by matching.
  // Build a list of {note, octave} pairs.
  const noteOctavePairs = currentNotes.map((noteName, i) => {
    // Find the octave by reverse-lookup from the played frequency
    const freq = currentFreqs[i];
    let bestOct = currentOctave;
    if (freq) {
      // Try octaves 2-7, pick closest match
      let minDiff = Infinity;
      for (let oct = 2; oct <= 7; oct++) {
        const diff = Math.abs(getNoteFreq(noteName, oct) - freq);
        if (diff < minDiff) { minDiff = diff; bestOct = oct; }
      }
    }
    return { note: noteName, octave: bestOct };
  });

  // X positions: start after treble clef, spread notes horizontally
  // Clef takes ~52px. Each note gets ~28px spacing.
  const xStart = 60;
  const xStep  = 28;

  noteOctavePairs.forEach(({ note, octave }, idx) => {
    const noteY  = getNoteStaffY(note, octave);
    const xBase  = xStart + idx * xStep;
    const col    = NOTE_COLORS[note];
    const isSharp = note.includes('#');

    // ‚îÄ‚îÄ Ledger lines ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    getLedgerLines(noteY).forEach(ly => {
      const ledger = document.createElement('div');
      ledger.className = 'staff-ledger';
      ledger.style.top    = (ly - 1) + 'px';
      ledger.style.left   = (xBase - 12) + 'px';
      ledger.style.width  = '26px';
      wrap.appendChild(ledger);
    });

    // ‚îÄ‚îÄ Accidental (sharp sign) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (isSharp) {
      const acc = document.createElement('div');
      acc.className   = 'staff-accidental';
      acc.textContent = '‚ôØ';
      acc.style.top   = (noteY - 10) + 'px';
      acc.style.left  = (xBase - 18) + 'px';
      acc.style.color = col;
      wrap.appendChild(acc);
    }

    // ‚îÄ‚îÄ Stem ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Stems go up if note is below middle line (B4=90), down if above
    const stemUp   = noteY >= 90;
    const stemLen  = 32;
    const stem = document.createElement('div');
    stem.className      = 'staff-note-stem';
    stem.style.width    = '2px';
    stem.style.background = '#222';
    if (stemUp) {
      stem.style.top    = (noteY - stemLen) + 'px';
      stem.style.height = stemLen + 'px';
      stem.style.left   = (xBase + 7) + 'px'; // right side of head
    } else {
      stem.style.top    = noteY + 'px';
      stem.style.height = stemLen + 'px';
      stem.style.left   = (xBase - 9) + 'px'; // left side of head
    }
    wrap.appendChild(stem);

    // ‚îÄ‚îÄ Note head ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const marker = document.createElement('div');
    marker.className = 'staff-note-marker';
    marker.style.background  = col;
    marker.style.boxShadow   = `0 0 10px ${col}99`;
    marker.style.top         = (noteY - 6) + 'px';  // centre vertically on noteY
    marker.style.left        = (xBase - 9) + 'px';
    marker.setAttribute('aria-label', `${note}${octave} ‚Äî click to play`);
    marker.setAttribute('role',    'button');
    marker.setAttribute('tabindex','0');
    marker.title = `${note}${octave}`;
    marker.onclick   = () => playNote(note, octave);
    marker.onkeydown = (e) => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); playNote(note,octave); } };
    wrap.appendChild(marker);

    // ‚îÄ‚îÄ Note name label inside head ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const nameLabel = document.createElement('div');
    nameLabel.className = 'staff-note-name';
    nameLabel.textContent = note.replace('#','');
    nameLabel.style.top   = (noteY - 4) + 'px';
    nameLabel.style.left  = (xBase - 4) + 'px';
    nameLabel.style.color = '#000';
    nameLabel.style.width = '10px';
    wrap.appendChild(nameLabel);
  });
}

// ============================================================
// STATE
// ============================================================

let currentOctave = 4;
let currentFretCount = 5;
let currentNotes = [];     // note names e.g. ['C','E','G']
let currentFreqs = [];     // frequencies
let currentLabel = '';

// ============================================================
// AUDIO
// ============================================================

let audioCtx;
let activeOscs = [];

function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function stopSound() {
  activeOscs.forEach(o => { try { o.stop(); } catch(e){} });
  activeOscs = [];
}

function playSound(freqs, duration = 2.0) {
  initAudio();
  stopSound();
  freqs.forEach(freq => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.18, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
    activeOscs.push(osc);
  });
}

// ============================================================
// CORE PLAY FUNCTIONS
// ============================================================

function playNote(noteName, octave) {
  octave = octave ?? currentOctave;
  const freq = getNoteFreq(noteName, octave);
  currentNotes = [noteName];
  currentFreqs = [freq];
  currentLabel = `${noteName}${octave}`;
  playSound([freq]);
  updateAll();
  updateWaveInfo([{ note: noteName + octave, freq: freq.toFixed(2), type: 'Single Note' }]);
}

// ============================================================
// ALL INTERVAL SEMITONE DEFINITIONS
// ============================================================
const INTERVAL_DEFS = {
  '0':  { name: 'Unison',           semitones: 0,  ratio: '1:1'   },
  '1':  { name: 'Minor 2nd',        semitones: 1,  ratio: '16:15' },
  '2':  { name: 'Major 2nd',        semitones: 2,  ratio: '9:8'   },
  '3':  { name: 'Minor 3rd',        semitones: 3,  ratio: '6:5'   },
  '4':  { name: 'Major 3rd',        semitones: 4,  ratio: '5:4'   },
  '5':  { name: 'Perfect 4th',      semitones: 5,  ratio: '4:3'   },
  '6':  { name: 'Tritone',          semitones: 6,  ratio: '‚àö2:1'  },
  '7':  { name: 'Perfect 5th',      semitones: 7,  ratio: '3:2'   },
  '8':  { name: 'Minor 6th',        semitones: 8,  ratio: '8:5'   },
  '9':  { name: 'Major 6th',        semitones: 9,  ratio: '5:3'   },
  '10': { name: 'Minor 7th',        semitones: 10, ratio: '16:9'  },
  '11': { name: 'Major 7th',        semitones: 11, ratio: '15:8'  },
  '12': { name: 'Octave',           semitones: 12, ratio: '2:1'   }
};

// ============================================================
// ALL CHORD SEMITONE DEFINITIONS
// Semitones are always relative to root (0)
// ============================================================
const CHORD_DEFS = {
  // Triads
  'major':     { name: 'Major',              semitones: [0, 4, 7] },
  'minor':     { name: 'Minor',              semitones: [0, 3, 7] },
  'augmented': { name: 'Augmented',          semitones: [0, 4, 8] },
  'diminished':{ name: 'Diminished',         semitones: [0, 3, 6] },
  'sus2':      { name: 'Sus2',               semitones: [0, 2, 7] },
  'sus4':      { name: 'Sus4',               semitones: [0, 5, 7] },
  // 7ths
  'maj7':      { name: 'Major 7th',          semitones: [0, 4, 7, 11] },
  'dom7':      { name: 'Dominant 7th',       semitones: [0, 4, 7, 10] },
  'min7':      { name: 'Minor 7th',          semitones: [0, 3, 7, 10] },
  'minmaj7':   { name: 'Minor-Major 7th',    semitones: [0, 3, 7, 11] },
  'dim7':      { name: 'Diminished 7th',     semitones: [0, 3, 6, 9]  },
  'halfdim7':  { name: 'Half-Dim 7th (m7‚ô≠5)',semitones: [0, 3, 6, 10] },
  'aug7':      { name: 'Augmented 7th',      semitones: [0, 4, 8, 10] },
  'augmaj7':   { name: 'Augmented Major 7th',semitones: [0, 4, 8, 11] },
  // 9ths
  'maj9':      { name: 'Major 9th',          semitones: [0, 4, 7, 11, 14] },
  'dom9':      { name: 'Dominant 9th',       semitones: [0, 4, 7, 10, 14] },
  'min9':      { name: 'Minor 9th',          semitones: [0, 3, 7, 10, 14] },
  'add9':      { name: 'Add 9',              semitones: [0, 4, 7, 14]     },
  'dom7b9':    { name: 'Dom 7‚ô≠9',            semitones: [0, 4, 7, 10, 13] },
  'dom7s9':    { name: 'Dom 7‚ôØ9',            semitones: [0, 4, 7, 10, 15] },
  // 11ths
  'maj11':     { name: 'Major 11th',         semitones: [0, 4, 7, 11, 14, 17] },
  'dom11':     { name: 'Dominant 11th',      semitones: [0, 4, 7, 10, 14, 17] },
  'min11':     { name: 'Minor 11th',         semitones: [0, 3, 7, 10, 14, 17] },
  'dom7s11':   { name: 'Dom 7‚ôØ11 (Lydian)',  semitones: [0, 4, 7, 10, 14, 18] },
  // 13ths
  'maj13':     { name: 'Major 13th',         semitones: [0, 4, 7, 11, 14, 17, 21] },
  'dom13':     { name: 'Dominant 13th',      semitones: [0, 4, 7, 10, 14, 17, 21] },
  'min13':     { name: 'Minor 13th',         semitones: [0, 3, 7, 10, 14, 17, 21] },
  'dom13b9':   { name: 'Dom 13‚ô≠9',           semitones: [0, 4, 7, 10, 13, 17, 21] }
};

// Helper: get note name and octave from root + semitones offset
function getNoteFromSemitones(rootNote, rootOctave, semitones) {
  const rootIdx = CHROMATIC_NOTES.indexOf(rootNote);
  const totalSemitones = rootIdx + semitones;
  const noteIdx = totalSemitones % 12;
  const octShift = Math.floor(totalSemitones / 12);
  return {
    note: CHROMATIC_NOTES[noteIdx],
    octave: rootOctave + octShift
  };
}

// Called when either interval dropdown changes
function onIntervalChange() {
  const root = document.getElementById('interval-root').value;
  const type = document.getElementById('interval-type').value;
  if (!type) return;
  playIntervalFromRoot(root, type);
}

function playIntervalFromRoot(rootNote, intervalKey) {
  const def = INTERVAL_DEFS[intervalKey];
  if (!def) return;

  const rootFreq = getNoteFreq(rootNote, currentOctave);

  if (def.semitones === 0) {
    // Unison ‚Äî just the single note
    currentNotes = [rootNote];
    currentFreqs = [rootFreq];
    currentLabel = `${rootNote} Unison`;
    playSound([rootFreq]);
    updateAll();
    updateWaveInfo([{ note: `${rootNote}${currentOctave}`, freq: rootFreq.toFixed(2), type: 'Unison (1:1)' }]);
    document.getElementById('interval-info').innerHTML = `<strong>${rootNote} ${def.name}</strong> ‚Äî ${def.ratio}`;
    return;
  }

  const upper = getNoteFromSemitones(rootNote, currentOctave, def.semitones);
  const upperFreq = getNoteFreq(upper.note, upper.octave);

  currentNotes = [rootNote, upper.note];
  currentFreqs = [rootFreq, upperFreq];
  currentLabel = `${rootNote}‚Äì${upper.note} ${def.name}`;

  playSound([rootFreq, upperFreq]);
  updateAll();
  updateWaveInfo([
    { note: `${rootNote}${currentOctave}`, freq: rootFreq.toFixed(2), type: 'Root' },
    { note: `${upper.note}${upper.octave}`, freq: upperFreq.toFixed(2), type: `${def.name} (${def.ratio})` }
  ]);
  document.getElementById('interval-info').innerHTML =
    `<strong>${rootNote}‚Äì${upper.note}</strong> &nbsp;${def.name} &nbsp;<em>${def.ratio}</em>`;
}

// Called when either chord dropdown changes
function onChordChange() {
  const root = document.getElementById('chord-root').value;
  const type = document.getElementById('chord-type').value;
  if (!type) return;
  playChordFromRoot(root, type);
}

function playChordFromRoot(rootNote, chordKey) {
  const def = CHORD_DEFS[chordKey];
  if (!def) return;

  const rootFreq = getNoteFreq(rootNote, currentOctave);

  const notes = def.semitones.map(st => getNoteFromSemitones(rootNote, currentOctave, st));
  const freqs  = notes.map(n => getNoteFreq(n.note, n.octave));
  const noteNames = notes.map(n => n.note);

  currentNotes = noteNames;
  currentFreqs = freqs;
  currentLabel = `${rootNote} ${def.name}`;

  playSound(freqs, 2.5);
  updateAll();

  const waveData = notes.map((n, i) => ({
    note: `${n.note}${n.octave}`,
    freq: freqs[i].toFixed(2),
    type: i === 0 ? 'Root' : `Tone ${i + 1}`
  }));
  updateWaveInfo(waveData);

  document.getElementById('chord-info').innerHTML =
    `<strong>${rootNote} ${def.name}</strong><br>${noteNames.join(' ‚Äì ')}`;
}

// Legacy wrappers kept for any remaining references
function playInterval(type) {
  const legacyMap = { 'octave':'12','fifth':'7','fourth':'5','major-third':'4','tritone':'6' };
  playIntervalFromRoot('C', legacyMap[type] || '7');
}
function playChord(chordType) {
  const legacyRootMap = {
    'C-major':'C','C-minor':'C','A-major':'A','A-minor':'A','G7':'G','diminished':'C'
  };
  const legacyTypeMap = {
    'C-major':'major','C-minor':'minor','A-major':'major','A-minor':'minor',
    'G7':'dom7','diminished':'diminished'
  };
  playChordFromRoot(legacyRootMap[chordType] || 'C', legacyTypeMap[chordType] || 'major');
}

function changeOctave(val) {
  currentOctave = parseInt(val);
  document.getElementById('current-octave').textContent = `Octave ${currentOctave}`;
  document.getElementById('octave-range').textContent = `C${currentOctave}‚ÄìB${currentOctave}`;
  rebuildPiano();
  updateAll();
}

function playSelectedNote(val) {
  if (!val) return;
  playNote(val, currentOctave);
  setTimeout(() => { document.getElementById('note-select').value = ''; }, 80);
}

// ============================================================
// UPDATE ACTIVE NOTE BADGES
// ============================================================

function updateBadges() {
  const container = document.getElementById('active-note-badges');
  if (!currentNotes.length) { container.textContent = 'Select a note, interval, or chord'; return; }
  container.innerHTML = currentNotes.map(n => {
    const col = NOTE_COLORS[n];
    return `<span class="note-badge" style="background:${col};"><span class="note-swatch" style="background:${col};border-color:rgba(0,0,0,0.3);"></span>${n}</span>`;
  }).join(' ');
}

// ============================================================
// WAVE INFO
// ============================================================

function updateWaveInfo(items) {
  const list = document.getElementById('wave-list');
  list.innerHTML = items.map(it =>
    `<li><strong>${it.note}</strong>: ${it.freq} Hz <span class="wave-type">${it.type}</span></li>`
  ).join('');
}

// ============================================================
// UPDATE ALL VISUALS
// ============================================================

function updateAll() {
  updateBadges();
  updateMeshColor();
  updatePianoHighlights();
  updateFretboardHighlights();
  updateChromaticCircle();
  updateStaff();
  updateTAB();
}

// ============================================================
// 3D CYMATICS
// ============================================================

let scene, camera, renderer, mesh, controls;
let cymaticsTime = 0;
let cymaticsFreqs = [];
let plateShape = 'square';

function initCymatics() {
  const canvas = document.getElementById('cymatics-canvas');
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x080810);

  camera = new THREE.PerspectiveCamera(45, canvas.offsetWidth / (canvas.offsetHeight || 400), 0.1, 100);
  camera.position.set(0, 3.5, 5.5);

  renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(canvas.offsetWidth, canvas.offsetHeight || 400);
  renderer.setPixelRatio(window.devicePixelRatio);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minDistance = 2; controls.maxDistance = 12;

  createPlate();

  scene.add(new THREE.DirectionalLight(0xffffff, 1.2).position.set(2, 5, 3) && new THREE.DirectionalLight(0xffffff, 1.2));
  const dl2 = new THREE.DirectionalLight(0x4A7BA7, 0.6);
  dl2.position.set(-2, 3, -3); scene.add(dl2);
  scene.add(new THREE.AmbientLight(0x303040, 0.8));

  const grid = new THREE.GridHelper(12, 24, 0x4A7BA7, 0x1a2d3f);
  grid.position.y = -0.6; scene.add(grid);

  window.addEventListener('resize', onCymaticsResize);
  animateCymatics();
}

function createPlate() {
  if (mesh) scene.remove(mesh);
  const segments = 120;
  const geo = plateShape === 'circle'
    ? new THREE.CircleGeometry(2, segments)
    : new THREE.PlaneGeometry(4, 4, segments, segments);
  const mat = new THREE.MeshStandardMaterial({
    color: 0xF4D03F, wireframe: true, side: THREE.DoubleSide,
    emissive: 0x4A7BA7, emissiveIntensity: 0.25
  });
  mesh = new THREE.Mesh(geo, mat);
  mesh.rotation.x = -Math.PI / 2;
  scene.add(mesh);
}

function updateMeshColor() {
  if (!mesh || !currentNotes.length) return;
  const col = new THREE.Color(NOTE_COLORS[currentNotes[0]]);
  mesh.material.color = col;
  const emissive = col.clone().multiplyScalar(0.35);
  mesh.material.emissive = emissive;
  mesh.material.emissiveIntensity = 0.6;
}

function updateCymaticsWaves() {
  if (!mesh) return;
  const pos = mesh.geometry.attributes.position;
  const freqsToUse = cymaticsFreqs.length ? cymaticsFreqs : [261.63];
  for (let i = 0; i < pos.count; i++) {
    const x = pos.getX(i), y = pos.getY(i);
    let z = 0;
    freqsToUse.forEach(f => {
      const k = (f / 130) * 0.8;
      z += Math.sin(k * x + cymaticsTime) * Math.sin(k * y + cymaticsTime * 0.7);
    });
    pos.setZ(i, z * 0.18);
  }
  pos.needsUpdate = true;
}

function animateCymatics() {
  requestAnimationFrame(animateCymatics);
  cymaticsTime += 0.018;
  cymaticsFreqs = currentFreqs.length ? currentFreqs : [];
  updateCymaticsWaves();
  controls.update();
  renderer.render(scene, camera);
}

function onCymaticsResize() {
  const canvas = document.getElementById('cymatics-canvas');
  camera.aspect = canvas.offsetWidth / canvas.offsetHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
}

// ============================================================
// PIANO KEYBOARD (2 octaves starting at currentOctave)
// ============================================================

const WHITE_NOTES = ['C','D','E','F','G','A','B'];
// Black key positions: fraction of white key width, slot index in white keys
const BLACK_KEY_CONFIG = [
  { note: 'C#', afterWhite: 0 },
  { note: 'D#', afterWhite: 1 },
  { note: 'F#', afterWhite: 3 },
  { note: 'G#', afterWhite: 4 },
  { note: 'A#', afterWhite: 5 }
];

function rebuildPiano() {
  const piano = document.getElementById('piano');
  piano.innerHTML = '';
  piano.style.position = 'relative';

  // 2 octaves: currentOctave and currentOctave+1
  const octaves = [currentOctave, currentOctave + 1];
  const totalWhite = WHITE_NOTES.length * octaves.length; // 14 white keys
  const whiteKeyW = 100 / totalWhite; // % width per white key

  // White keys ‚Äî 2 octaves
  octaves.forEach((oct) => {
    WHITE_NOTES.forEach((note) => {
      const key = document.createElement('div');
      key.className = 'white-key';
      key.setAttribute('data-note', note);
      key.setAttribute('data-octave', oct);
      key.setAttribute('aria-label', `${note}${oct}`);
      key.setAttribute('role', 'button');
      key.setAttribute('tabindex', '0');
      const col = NOTE_COLORS[note];
      key.style.setProperty('--active-glow', col);
      key.innerHTML = `<span class="key-label" style="font-size:8px;">${note}<br><span style="font-size:7px;opacity:0.6;">${oct}</span></span>`;
      key.onclick = () => playNote(note, oct);
      key.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); playNote(note, oct); } };
      piano.appendChild(key);
    });
  });

  // Black keys ‚Äî 2 octaves
  // afterWhite is the 0-based index into the full 14-white-key array
  octaves.forEach((oct, oIdx) => {
    BLACK_KEY_CONFIG.forEach(({ note, afterWhite }) => {
      const globalAfterWhite = oIdx * WHITE_NOTES.length + afterWhite;
      const key = document.createElement('div');
      key.className = 'black-key';
      key.setAttribute('data-note', note);
      key.setAttribute('data-octave', oct);
      key.setAttribute('aria-label', `${note}${oct}`);
      key.setAttribute('role', 'button');
      key.setAttribute('tabindex', '0');
      const col = NOTE_COLORS[note];
      key.style.setProperty('--active-glow', col);
      // Centre black key on the border between white keys
      key.style.left = `calc(${(globalAfterWhite + 1) * whiteKeyW}% - 9px)`;
      key.style.width = `calc(${whiteKeyW * 0.65}%)`;
      key.innerHTML = `<span class="key-label" style="font-size:7px;">${note}</span>`;
      key.onclick = () => playNote(note, oct);
      key.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); playNote(note, oct); } };
      piano.appendChild(key);
    });
  });
}

function updatePianoHighlights() {
  document.querySelectorAll('#piano .white-key, #piano .black-key').forEach(key => {
    const note = key.getAttribute('data-note');
    const isActive = currentNotes.includes(note);
    key.classList.toggle('active', isActive);
    if (isActive) {
      const col = NOTE_COLORS[note];
      key.style.background = key.classList.contains('black-key')
        ? col
        : `linear-gradient(180deg, ${col} 0%, ${col}cc 100%)`;
      key.style.setProperty('--active-glow', col);
    } else {
      key.style.background = '';
    }
  });
}

// ============================================================
// GUITAR FRETBOARD
//
// LAYOUT:
//   COLUMNS (West ‚Üí East) = 6 STRINGS:  E  A  D  G  B  e
//                            (String 6 bass left ‚Üí String 1 treble right)
//   ROWS (North ‚Üí South)  = FRET POSITIONS:
//     Row 0 = NUT / OPEN  (combined, always visible, lights up when played)
//     Row 1 = Fret 1
//     Row 2 = Fret 2  ‚Ä¶ etc.
// ============================================================

function buildFretboard() {
  const fb = document.getElementById('fretboard');
  fb.innerHTML = '';

  const inlayFrets  = new Set([3, 5, 7, 9, 12, 15]);
  const doubleInlay = new Set([12]);

  // ‚îÄ‚îÄ HEADER ROW: string names across the top ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const headerRow = document.createElement('div');
  headerRow.className = 'fb-header-row';

  // spacer to align with row labels
  const hSpacer = document.createElement('div');
  hSpacer.className = 'fb-header-spacer';
  headerRow.appendChild(hSpacer);

  // STRING_TUNING order: [0]=E2, [1]=A2, [2]=D3, [3]=G3, [4]=B3, [5]=E4
  // = E  A  D  G  B  e  left to right ‚úì
  STRING_TUNING.forEach((strData, sIdx) => {
    const th = document.createElement('div');
    th.className = 'fb-string-header';
    th.textContent = strData.label;
    // colour the header in that string's open note colour
    th.style.color = NOTE_COLORS[strData.note];
    th.style.textShadow = `0 0 8px ${NOTE_COLORS[strData.note]}88, 0 1px 4px rgba(0,0,0,0.9)`;
    headerRow.appendChild(th);
  });
  fb.appendChild(headerRow);

  // ‚îÄ‚îÄ FRET ROWS (one per fret position, fret 0 = NUT/OPEN) ‚îÄ‚îÄ‚îÄ‚îÄ
  for (let f = 0; f <= currentFretCount; f++) {
    const row = document.createElement('div');
    row.className = 'fb-fret-row';
    row.setAttribute('data-fret', f);

    // Row label (left side): "NUT" for fret 0, number for rest
    const rowLabel = document.createElement('div');
    rowLabel.className = 'fb-row-label';
    rowLabel.textContent = f === 0 ? 'NUT' : f;
    row.appendChild(rowLabel);

    // One cell per string
    STRING_TUNING.forEach((strData, sIdx) => {
      const startIdx = CHROMATIC_NOTES.indexOf(strData.note);
      const noteIdx  = (startIdx + f) % 12;
      const noteName = CHROMATIC_NOTES[noteIdx];
      const octShift = Math.floor((startIdx + f) / 12);
      const noteOct  = strData.octave + octShift;
      const noteFreq = getNoteFreq(noteName, noteOct);
      const col      = NOTE_COLORS[noteName];

      const cell = document.createElement('div');
      cell.className = 'fb-cell';
      cell.setAttribute('data-fret',       f);
      cell.setAttribute('data-string',     sIdx);
      cell.setAttribute('data-note',       noteName);
      cell.setAttribute('data-note-octave',noteOct);
      cell.setAttribute('aria-label',      `${noteName}${noteOct}, ${f === 0 ? 'open' : 'fret ' + f}, ${strData.label} string`);
      cell.setAttribute('role',   'button');
      cell.setAttribute('tabindex','0');
      cell.style.setProperty('--dot-glow', col);

      // Note dot ‚Äî always rendered; NUT row shown at low opacity, others hidden until active
      const dot = document.createElement('div');
      dot.className = 'fb-dot';
      dot.textContent = noteName;
      dot.style.background = col;
      dot.style.color = '#000';
      cell.appendChild(dot);

      cell.onclick   = () => playNote(noteName, noteOct);
      cell.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); playNote(noteName, noteOct); }
      };

      row.appendChild(cell);
    });

    fb.appendChild(row);
  }

  // ‚îÄ‚îÄ INLAY DOT ROW (below all fret rows) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const inlayRow = document.createElement('div');
  inlayRow.className = 'fb-inlay-row';

  const inlaySpacer = document.createElement('div');
  inlaySpacer.className = 'fb-inlay-spacer';
  inlayRow.appendChild(inlaySpacer);

  // One inlay cell per fret COLUMN... wait ‚Äî inlays mark fret positions,
  // so we need one cell per string column but mark based on fret row.
  // Simpler: just show inlay markers as a row below, one cell per fret row.
  // Re-do: inlay row has one cell per fret (0..currentFretCount) shown as column
  // But our columns are strings not frets now. Inlays should appear between
  // specific fret rows. We'll add inlay markers as small dots inside the fret row label area.
  // For simplicity: add inlay dots at the end of each fret row label for marked frets.
  // Already handled ‚Äî let's add dots to the row labels of inlay frets.
  fb.appendChild(inlayRow); // empty row for spacing

  // Add inlay markers to the row labels
  for (let f = 0; f <= currentFretCount; f++) {
    if (inlayFrets.has(f)) {
      const row = fb.querySelector(`.fb-fret-row[data-fret="${f}"]`);
      if (row) {
        const label = row.querySelector('.fb-row-label');
        if (label) {
          const dot = document.createElement('span');
          dot.style.cssText = `
            display:inline-block; width:7px; height:7px; border-radius:50%;
            background:radial-gradient(circle,rgba(244,208,63,0.8) 0%,rgba(244,208,63,0.2) 100%);
            border:1px solid rgba(255,255,255,0.3); margin-left:4px; vertical-align:middle;
          `;
          label.appendChild(dot);
          if (doubleInlay.has(f)) {
            const dot2 = dot.cloneNode(true);
            label.appendChild(dot2);
          }
        }
      }
    }
  }
}

function updateFretboardHighlights() {
  document.querySelectorAll('#fretboard .fb-cell').forEach(cell => {
    const note    = cell.getAttribute('data-note');
    const isActive = currentNotes.includes(note);
    cell.classList.toggle('active', isActive);
    if (isActive) {
      const col = NOTE_COLORS[note];
      cell.style.setProperty('--dot-glow', col);
      const dot = cell.querySelector('.fb-dot');
      if (dot) { dot.style.background = col; dot.style.color = '#000'; }
    }
  });
}

function changeFretCount(n) {
  currentFretCount = parseInt(n);
  buildFretboard();
  updateFretboardHighlights();
}

// ============================================================
// CHROMATIC CIRCLE
// ============================================================

function updateChromaticCircle() {
  const canvas = document.getElementById('circle-canvas');
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width || 280;
  canvas.height = rect.height || 280;
  const ctx = canvas.getContext('2d');
  const cx = canvas.width / 2, cy = canvas.height / 2;
  const R = Math.min(cx, cy) - 38;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Outer ring
  ctx.beginPath();
  ctx.arc(cx, cy, R + 14, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(74,123,167,0.2)';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Connections between active notes
  if (currentNotes.length > 1) {
    ctx.save();
    ctx.globalAlpha = 0.35;
    for (let i = 0; i < currentNotes.length; i++) {
      for (let j = i + 1; j < currentNotes.length; j++) {
        const ai = CHROMATIC_NOTES.indexOf(currentNotes[i]);
        const aj = CHROMATIC_NOTES.indexOf(currentNotes[j]);
        const ax = cx + R * Math.cos((ai * 30 - 90) * Math.PI / 180);
        const ay = cy + R * Math.sin((ai * 30 - 90) * Math.PI / 180);
        const bx = cx + R * Math.cos((aj * 30 - 90) * Math.PI / 180);
        const by = cy + R * Math.sin((aj * 30 - 90) * Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(ax, ay); ctx.lineTo(bx, by);
        ctx.strokeStyle = NOTE_COLORS[currentNotes[i]];
        ctx.lineWidth = 2.5;
        ctx.stroke();
      }
    }
    ctx.restore();
  }

  // Draw each note
  CHROMATIC_NOTES.forEach((note, i) => {
    const angle = (i * 30 - 90) * Math.PI / 180;
    const x = cx + R * Math.cos(angle);
    const y = cy + R * Math.sin(angle);
    const isActive = currentNotes.includes(note);
    const r = isActive ? 28 : 20;
    const col = NOTE_COLORS[note];

    if (isActive) {
      // Glow
      ctx.save();
      ctx.shadowBlur = 22;
      ctx.shadowColor = col;
      ctx.beginPath();
      ctx.arc(x, y, r + 6, 0, Math.PI * 2);
      ctx.strokeStyle = col;
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.restore();
    }

    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = col;
    ctx.fill();
    ctx.strokeStyle = isActive ? '#fff' : 'rgba(0,0,0,0.3)';
    ctx.lineWidth = isActive ? 3 : 1.5;
    ctx.stroke();

    // Note name
    ctx.fillStyle = '#000';
    ctx.font = `${isActive ? 'bold 13px' : 'bold 11px'} Arial, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(note, x, isActive ? y - 4 : y);

    if (isActive) {
      const freq = getNoteFreq(note, currentOctave);
      ctx.font = '8px Arial, sans-serif';
      ctx.fillText(`${Math.round(freq)}Hz`, x, y + 8);
    }
  });

  // Center label
  if (currentLabel) {
    ctx.font = 'bold 11px Arial, sans-serif';
    ctx.fillStyle = 'rgba(244,208,63,0.9)';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(currentLabel, cx, cy);
  }
}

// (Staff notation functions defined above near NOTE_STAFF_POS)

// ============================================================
// GUITAR TAB
// ============================================================

function updateTAB() {
  const tabEl = document.getElementById('tab');
  if (!currentNotes.length) {
    tabEl.textContent = 'e|---|\nB|---|\nG|---|\nD|---|\nA|---|\nE|---|';
    return;
  }

  // Standard TAB display: high e on top ‚Üí low E on bottom
  // STRING_TUNING: [0]=E2, [1]=A2, [2]=D3, [3]=G3, [4]=B3, [5]=E4
  // Display order (top‚Üíbottom in TAB): 5(e), 4(B), 3(G), 2(D), 1(A), 0(E)
  const displayOrder = [5, 4, 3, 2, 1, 0];

  // For each string, find the LOWEST fret within currentFretCount
  // that matches one of the currentNotes.
  // If not found within range ‚Üí show 'X' (not playable in this view)
  const stringResults = displayOrder.map(sIdx => {
    const strData = STRING_TUNING[sIdx];
    const startIdx = CHROMATIC_NOTES.indexOf(strData.note);

    let bestFret = null;
    let bestNote = null;
    let bestOct  = null;

    for (let f = 0; f <= currentFretCount; f++) {
      const noteIdx  = (startIdx + f) % 12;
      const fretNote = CHROMATIC_NOTES[noteIdx];
      const octShift = Math.floor((startIdx + f) / 12);
      const noteOct  = strData.octave + octShift;

      if (currentNotes.includes(fretNote)) {
        bestFret = f;
        bestNote = fretNote;
        bestOct  = noteOct;
        break; // lowest fret wins
      }
    }

    return { sIdx, strData, fret: bestFret, note: bestNote, octave: bestOct };
  });

  // Build the TAB as interactive spans inside the <pre>
  tabEl.innerHTML = '';

  stringResults.forEach(({ sIdx, strData, fret, note, octave }, i) => {
    const line = document.createElement('span');
    line.style.display = 'block';
    line.style.cursor  = fret !== null ? 'pointer' : 'default';

    // Format fret number: 1 digit ‚Üí '-N-', 2 digits ‚Üí 'NN-', X ‚Üí '-X-'
    let fretStr;
    if (fret === null) {
      fretStr = '-X-'; // not available in current fret view
    } else if (fret === 0) {
      fretStr = '-0-';
    } else if (fret < 10) {
      fretStr = `-${fret}-`;
    } else {
      fretStr = `${fret}-`;
    }

    const label = strData.label;
    line.textContent = `${label}|${fretStr}|`;

    // Colour the fret number in note colour if active
    if (fret !== null && note) {
      const col = NOTE_COLORS[note];
      line.style.color = col;
      line.style.textShadow = `0 0 6px ${col}88`;
      line.style.fontWeight = '800';
      line.title = `${note}${octave} ‚Äî fret ${fret}, ${strData.label} string ‚Äî click to play`;

      line.onclick = () => {
        // Play this specific string/fret note and highlight it
        const freq = getNoteFreq(note, octave);
        // Temporarily set currentNotes to just this note so all visuals sync
        currentNotes = [note];
        currentFreqs = [freq];
        currentLabel = `${note}${octave}`;
        playSound([freq]);
        updateAll();
        updateWaveInfo([{ note: `${note}${octave}`, freq: freq.toFixed(2), type: `String ${strData.label}, Fret ${fret}` }]);
      };
    } else {
      line.style.color = '#888';
      line.style.fontWeight = '400';
      line.title = `Not available in current ${currentFretCount}-fret view`;
    }

    if (i < stringResults.length - 1) {
      line.style.marginBottom = '1px';
    }

    tabEl.appendChild(line);
  });
}

// ============================================================
// INIT & EXPOSE
// ============================================================

window.playNote = playNote;
window.playInterval = playInterval;
window.playChord = playChord;
window.onIntervalChange = onIntervalChange;
window.onChordChange = onChordChange;
window.playIntervalFromRoot = playIntervalFromRoot;
window.playChordFromRoot = playChordFromRoot;
window.changeOctave = changeOctave;
window.playSelectedNote = playSelectedNote;
window.changeFretCount = changeFretCount;
window.setPlateShape = (shape) => { plateShape = shape; createPlate(); };

window.addEventListener('DOMContentLoaded', () => {
  // Footer year
  document.getElementById('footer-year').textContent = new Date().getFullYear();

  initCymatics();
  buildStaffLines();
  rebuildPiano();
  buildFretboard();
  updateChromaticCircle();

  // Chromatic circle click handler
  const circleCanvas = document.getElementById('circle-canvas');
  circleCanvas.addEventListener('click', (e) => {
    const rect = circleCanvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (circleCanvas.width / rect.width);
    const my = (e.clientY - rect.top) * (circleCanvas.height / rect.height);
    const cx = circleCanvas.width / 2, cy = circleCanvas.height / 2;
    const R = Math.min(cx, cy) - 38;
    CHROMATIC_NOTES.forEach((note, i) => {
      const angle = (i * 30 - 90) * Math.PI / 180;
      const nx = cx + R * Math.cos(angle);
      const ny = cy + R * Math.sin(angle);
      if (Math.hypot(mx - nx, my - ny) < 30) {
        playNote(note, currentOctave);
      }
    });
  });

  circleCanvas.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') circleCanvas.click();
  });
});

</script>
</body>
</html>
