<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keys, Codes & Modes - Cymatics Music Theory Visualizer</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --ocean-blue: #4A7BA7;
    --deep-navy: #2a4d6f;
    --golden-yellow: #F4D03F;
    --light-yellow: #E8D77F;
    --mystic-purple: #8B6BA3;
    --teal: #6FA5A5;
    --coral: #CF7A5A;
    --sage-green: #9AAF7A;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    color: white;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    background: linear-gradient(90deg, var(--deep-navy) 0%, var(--ocean-blue) 100%);
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }

  .logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
  }

  .logo {
    width: 60px;
    height: 60px;
  }

  h1 {
    color: var(--golden-yellow);
    font-size: 2em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }

  .subtitle {
    color: var(--light-yellow);
    font-size: 1.1em;
    margin-top: 5px;
  }

  /* Main Layout */
  .main-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    min-height: calc(100vh - 120px);
    gap: 0;
  }

  /* Control Panel */
  .control-panel {
    background: rgba(42, 77, 111, 0.9);
    padding: 20px;
    overflow-y: auto;
    box-shadow: 4px 0 20px rgba(0,0,0,0.3);
  }

  .section {
    margin-bottom: 25px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    border-left: 4px solid var(--golden-yellow);
  }

  .section h3 {
    color: var(--golden-yellow);
    margin-bottom: 12px;
    font-size: 1.1em;
  }

  button {
    width: 100%;
    padding: 12px;
    margin: 6px 0;
    background: linear-gradient(135deg, var(--ocean-blue) 0%, var(--teal) 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95em;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(244, 208, 63, 0.3);
    background: linear-gradient(135deg, var(--teal) 0%, var(--ocean-blue) 100%);
  }

  button.active {
    background: linear-gradient(135deg, var(--golden-yellow) 0%, var(--coral) 100%);
    box-shadow: 0 4px 16px rgba(244, 208, 63, 0.5);
  }

  select {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    background: var(--deep-navy);
    color: white;
    border: 2px solid var(--ocean-blue);
    border-radius: 6px;
    font-size: 0.95em;
    cursor: pointer;
  }

  .info-box {
    background: rgba(74, 123, 167, 0.2);
    padding: 12px;
    border-radius: 6px;
    border: 1px solid var(--ocean-blue);
    margin-top: 10px;
  }

  .info-box p {
    font-size: 0.85em;
    line-height: 1.5;
    color: var(--light-yellow);
  }

  /* Visualization Area */
  .viz-area {
    display: flex;
    flex-direction: column;
    background: #0a0a0a;
  }

  /* 3D Cymatics Canvas */
  #cymatics-canvas {
    width: 100%;
    height: 50vh;
    display: block;
    background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);
  }

  /* Music Theory Panels */
  .theory-panels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    padding: 20px;
    background: rgba(26, 26, 46, 0.8);
  }

  .panel {
    background: rgba(42, 77, 111, 0.3);
    padding: 15px;
    border-radius: 8px;
    border: 2px solid var(--ocean-blue);
  }

  .panel h4 {
    color: var(--golden-yellow);
    margin-bottom: 10px;
    font-size: 1em;
  }

  /* Piano Keyboard */
  .piano {
    display: flex;
    height: 120px;
    position: relative;
  }

  .white-key {
    flex: 1;
    background: white;
    border: 2px solid #333;
    border-radius: 0 0 4px 4px;
    position: relative;
    cursor: pointer;
    transition: all 0.1s;
  }

  .white-key:hover {
    background: #f0f0f0;
  }

  .white-key.active {
    background: var(--golden-yellow);
    box-shadow: 0 0 20px var(--golden-yellow);
  }

  .black-key {
    width: 30px;
    height: 70px;
    background: #222;
    border: 2px solid #000;
    border-radius: 0 0 4px 4px;
    position: absolute;
    cursor: pointer;
    z-index: 2;
    transition: all 0.1s;
  }

  .black-key:hover {
    background: #444;
  }

  .black-key.active {
    background: var(--coral);
    box-shadow: 0 0 20px var(--coral);
  }

  /* Guitar Fretboard - MUSIC THEORY EXPLORER PRO STYLE */
  .fretboard-container {
    background: linear-gradient(135deg, rgba(42, 77, 111, 0.3) 0%, rgba(26, 26, 46, 0.5) 100%);
    padding: 20px;
    border-radius: 12px;
    border: 2px solid var(--ocean-blue);
  }

  .fretboard-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
  }

  .fretboard-controls label {
    color: var(--golden-yellow);
    font-weight: bold;
  }

  .fretboard-controls select {
    width: auto;
    padding: 8px 12px;
  }

  .fretboard {
    display: flex;
    flex-direction: row;
    gap: 0;
    min-height: 350px;
    position: relative;
    background: linear-gradient(90deg, #2a2420 0%, #3a3430 50%, #2a2420 100%);
    border-radius: 8px;
    padding: 50px 20px 20px 60px;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
  }

  .fret-numbers {
    position: absolute;
    left: 10px;
    top: 50px;
    display: flex;
    flex-direction: column;
    height: calc(100% - 70px);
  }

  .fret-number {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--light-yellow);
    font-weight: bold;
    font-size: 0.85em;
    opacity: 0.8;
  }

  .string-header {
    position: absolute;
    top: 15px;
    left: 60px;
    right: 20px;
    display: flex;
    gap: 0;
  }

  .string-label-top {
    flex: 1;
    text-align: center;
    color: var(--golden-yellow);
    font-weight: bold;
    font-size: 1.1em;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  }

  .string {
    display: flex;
    flex-direction: column;
    flex: 1;
    background: linear-gradient(180deg, #c9c5c1 0%, #8a8580 50%, #c9c5c1 100%);
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
  }

  .string:nth-child(1) { 
    background: linear-gradient(180deg, #d4d0cc 0%, #9a9590 50%, #d4d0cc 100%);
    flex: 1.2;
  }
  .string:nth-child(2) { flex: 1.15; }
  .string:nth-child(3) { flex: 1.1; }
  .string:nth-child(4) { flex: 1.05; }
  .string:nth-child(5) { 
    background: linear-gradient(180deg, #b9b5b1 0%, #7a7570 50%, #b9b5b1 100%);
    flex: 1;
  }
  .string:nth-child(6) { 
    background: linear-gradient(180deg, #a9a5a1 0%, #6a6560 50%, #a9a5a1 100%);
    flex: 0.95;
  }

  .fret {
    flex: 1;
    border-bottom: 4px solid #999;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    background: transparent;
  }

  .fret:first-child {
    border-bottom: 6px solid #444;
    background: rgba(244, 208, 63, 0.05);
  }

  .fret:hover {
    background: rgba(74, 123, 167, 0.35);
  }

  .fret.active {
    background: var(--golden-yellow);
  }

  .fret.active::after {
    content: '';
    width: 24px;
    height: 24px;
    background: var(--coral);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 20px var(--golden-yellow), 0 2px 8px rgba(0,0,0,0.4);
    z-index: 10;
  }

  .fret.same-note {
    background: rgba(244, 208, 63, 0.25);
  }

  .fret.same-note::after {
    content: '';
    width: 18px;
    height: 18px;
    background: rgba(244, 208, 63, 0.7);
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.6);
  }

  /* Fret markers (inlays) */
  .fret-marker-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    background: radial-gradient(circle, rgba(244, 208, 63, 0.6) 0%, rgba(244, 208, 63, 0.2) 100%);
    border-radius: 50%;
    pointer-events: none;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .fret:nth-child(3) .fret-marker-dot,
  .fret:nth-child(5) .fret-marker-dot,
  .fret:nth-child(7) .fret-marker-dot,
  .fret:nth-child(9) .fret-marker-dot {
    display: block;
  }

  .fret:nth-child(12) .fret-marker-dot {
    display: block;
  }

  .fret:nth-child(12) .fret-marker-dot:first-of-type {
    transform: translateX(-8px);
  }

  .fret:nth-child(12) .fret-marker-dot:last-of-type {
    transform: translateX(8px);
  }

  /* Circle of Fifths */
  .circle-of-fifths {
    width: 100%;
    height: 300px;
    position: relative;
    cursor: pointer;
  }

  /* Staff Notation */
  .staff {
    width: 100%;
    height: 150px;
    background: white;
    border-radius: 4px;
    position: relative;
    padding: 20px;
  }

  .staff-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: #333;
    left: 0;
  }

  .ledger-line {
    position: absolute;
    height: 2px;
    background: #333;
    z-index: 5;
  }

  .note {
    position: absolute;
    width: 20px;
    height: 16px;
    background: #000;
    border-radius: 50%;
    border: 2px solid white;
    transition: all 0.2s;
  }

  /* TAB Notation */
  .tab {
    background: white;
    color: #000;
    padding: 15px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.8;
  }

  /* Theory Info Display */
  .theory-info {
    background: rgba(74, 123, 167, 0.2);
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--golden-yellow);
    margin-top: 15px;
  }

  .theory-info h4 {
    color: var(--golden-yellow);
    margin-bottom: 10px;
  }

  .theory-info ul {
    list-style: none;
    padding-left: 0;
  }

  .theory-info li {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .theory-info li:last-child {
    border-bottom: none;
  }

  .wave-type {
    display: inline-block;
    padding: 3px 10px;
    background: var(--mystic-purple);
    border-radius: 4px;
    font-size: 0.85em;
    margin-left: 10px;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .main-container {
      grid-template-columns: 1fr;
    }
    
    .control-panel {
      max-height: 300px;
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo-container">
    <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <circle cx="100" cy="100" r="98" fill="#4A7BA7" stroke="#2a4d6f" stroke-width="1"/>
      <polygon points="100,15 185,185 15,185" fill="#F4D03F" opacity="0.85"/>
      <polygon points="100,15 15,185 15,55" fill="#8B6BA3" opacity="0.75"/>
      <polygon points="100,15 185,55 185,185" fill="#6FA5A5" opacity="0.75"/>
      <polygon points="15,55 100,100 15,185" fill="#CF7A5A" opacity="0.65"/>
      <polygon points="185,55 100,100 185,185" fill="#9AAF7A" opacity="0.65"/>
      <polygon points="100,55 145,100 100,145 55,100" fill="#E8D77F" opacity="0.6"/>
      <circle cx="100" cy="100" r="50" fill="none" stroke="#2a4d6f" stroke-width="2.5"/>
      <circle cx="100" cy="100" r="7" fill="#2a4d6f"/>
      <line x1="40" y1="40" x2="160" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
      <line x1="160" y1="40" x2="40" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
      <line x1="100" y1="20" x2="100" y2="180" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
      <line x1="20" y1="100" x2="180" y2="100" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
    </svg>
    <div>
      <h1>Cymatics Music Theory Visualizer</h1>
      <div class="subtitle">See the Geometry of Sound | Keys, Codes & Modes</div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="main-container">
  
  <!-- Control Panel -->
  <div class="control-panel">
    
    <!-- Octave Register Selection -->
    <div class="section">
      <h3>üéöÔ∏è Octave Register</h3>
      <select id="octave-select" onchange="changeOctave(this.value)">
        <option value="1">Octave 1 (Low)</option>
        <option value="2">Octave 2</option>
        <option value="3">Octave 3</option>
        <option value="4" selected>Octave 4 (Middle C)</option>
        <option value="5">Octave 5</option>
        <option value="6">Octave 6</option>
        <option value="7">Octave 7 (High)</option>
      </select>
      <div class="info-box">
        <p><strong>Current:</strong> <span id="current-octave">Octave 4</span><br>
        <strong>Range:</strong> <span id="octave-range">C4-B4</span></p>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="section">
      <h3>üéµ Single Notes</h3>
      <label style="color: var(--light-yellow); font-size: 0.9em;">Select Note:</label>
      <select id="note-select" onchange="playSelectedNote(this.value)" style="font-size: 1em; font-weight: bold;">
        <option value="">-- Choose a Note --</option>
        <option value="C">C (Do)</option>
        <option value="C#">C# / Db</option>
        <option value="D">D (Re)</option>
        <option value="D#">D# / Eb</option>
        <option value="E">E (Mi)</option>
        <option value="F">F (Fa)</option>
        <option value="F#">F# / Gb</option>
        <option value="G">G (Sol)</option>
        <option value="G#">G# / Ab</option>
        <option value="A">A (La)</option>
        <option value="A#">A# / Bb</option>
        <option value="B">B (Ti)</option>
      </select>
      <div class="info-box">
        <p><strong>Complete Chromatic Scale:</strong> All 12 notes available. Single frequency creates simple, stable standing waves.</p>
      </div>
    </div>

    <!-- Intervals Section -->
    <div class="section">
      <h3>üéº Musical Intervals</h3>
      <button onclick="playInterval('octave')">Octave (2:1)</button>
      <button onclick="playInterval('fifth')">Perfect 5th (3:2)</button>
      <button onclick="playInterval('fourth')">Perfect 4th (4:3)</button>
      <button onclick="playInterval('major-third')">Major 3rd (5:4)</button>
      <button onclick="playInterval('tritone')">Tritone (‚àö2:1)</button>
      <div class="info-box">
        <p><strong>Octave:</strong> Same pattern, denser<br>
        <strong>Fifth:</strong> Strong symmetry<br>
        <strong>Tritone:</strong> Broken geometry</p>
      </div>
    </div>

    <!-- Chords Section -->
    <div class="section">
      <h3>üéπ Chords</h3>
      <button onclick="playChord('A-major')">A Major (A-C#-E)</button>
      <button onclick="playChord('A-minor')">A Minor (A-C-E)</button>
      <button onclick="playChord('C-major')">C Major (C-E-G)</button>
      <button onclick="playChord('G7')">G7 (G-B-D-F)</button>
      <button onclick="playChord('diminished')">Diminished (C-Eb-Gb)</button>
      <div class="info-box">
        <p><strong>Stable chords:</strong> Ordered lattices<br>
        <strong>Dissonance:</strong> Chaotic motion<br>
        <strong>Truth:</strong> Harmony is geometric!</p>
      </div>
    </div>

    <!-- Plate Shape -->
    <div class="section">
      <h3>üìê Plate Shape</h3>
      <select onchange="setPlateShape(this.value)">
        <option value="square">Square Plate</option>
        <option value="circle">Circular Plate</option>
      </select>
      <div class="info-box">
        <p>Different shapes create different resonance patterns</p>
      </div>
    </div>

    <!-- Controls Info -->
    <div class="section">
      <h3>üéÆ Controls</h3>
      <div class="info-box">
        <p><strong>Rotate:</strong> Drag with mouse<br>
        <strong>Zoom:</strong> Mouse wheel<br>
        <strong>Reset:</strong> Double-click</p>
      </div>
    </div>

  </div>

  <!-- Visualization Area -->
  <div class="viz-area">
    
    <!-- 3D Cymatics Visualization -->
    <canvas id="cymatics-canvas"></canvas>

    <!-- Music Theory Panels -->
    <div class="theory-panels">
      
      <!-- Piano Keyboard -->
      <div class="panel">
        <h4>üéπ Piano Keyboard</h4>
        <div class="piano" id="piano"></div>
      </div>

      <!-- Guitar Fretboard -->
      <div class="panel">
        <h4>üé∏ Guitar Fretboard</h4>
        <div class="fretboard-container">
          <div class="fretboard-controls">
            <label>Frets:</label>
            <select id="fret-count-select" onchange="changeFretCount(this.value)">
              <option value="3">3 Frets</option>
              <option value="5" selected>5 Frets</option>
              <option value="12">12 Frets</option>
              <option value="15">15 Frets</option>
            </select>
          </div>
          <div id="fretboard" class="fretboard"></div>
        </div>
      </div>

      <!-- Chromatic Circle -->
      <div class="panel">
        <h4>‚≠ï Chromatic Circle</h4>
        <canvas class="circle-of-fifths" id="circle-canvas"></canvas>
      </div>

      <!-- Staff Notation -->
      <div class="panel">
        <h4>üéº Staff Notation</h4>
        <div class="staff" id="staff">
          <div class="staff-line" style="top: 30px;"></div>
          <div class="staff-line" style="top: 50px;"></div>
          <div class="staff-line" style="top: 70px;"></div>
          <div class="staff-line" style="top: 90px;"></div>
          <div class="staff-line" style="top: 110px;"></div>
        </div>
      </div>

      <!-- Guitar TAB -->
      <div class="panel">
        <h4>üé∏ Guitar TAB</h4>
        <div class="tab" id="tab">
e|-------------------<br>
B|-------------------<br>
G|-------------------<br>
D|-------------------<br>
A|-------------------<br>
E|-------------------
        </div>
      </div>

      <!-- Theory Info -->
      <div class="panel">
        <h4>üìö Current Wave Analysis</h4>
        <div id="wave-info">
          <ul id="wave-list">
            <li>Select a note, interval, or chord to see analysis</li>
          </ul>
        </div>
      </div>

    </div>

    <!-- Educational Theory Section -->
    <div class="theory-info">
      <h4>üß† Why This Matters: The Geometry of Music</h4>
      <ul>
        <li><strong>Notes:</strong> Single frequencies create simple, stable standing waves with few nodes</li>
        <li><strong>Intervals:</strong> Frequency ratios create geometric patterns - consonance = symmetry</li>
        <li><strong>Chords:</strong> Multiple frequencies interfere to create complex lattices or chaos</li>
        <li><strong>Harmony isn't subjective ‚Äî it's geometric!</strong> This visualization proves music theory is physics</li>
        <li><strong>Application:</strong> Understanding wave mechanics prepares you for Unity, VR, and sound installations</li>
      </ul>
    </div>

  </div>

</div>

<!-- Three.js - ES6 Module -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
// Import Three.js and OrbitControls using ES6 modules
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// ============================================
// WEB AUDIO API - SOUND GENERATION
// ============================================

let audioContext;
let activeOscillators = [];

function initAudio() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
}

function playSound(frequencies, duration = 1.5) {
  if (!audioContext) initAudio();
  
  // Stop any currently playing oscillators
  stopSound();
  
  frequencies.forEach(freq => {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
    
    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
    
    activeOscillators.push(oscillator);
  });
}

function stopSound() {
  activeOscillators.forEach(osc => {
    try { osc.stop(); } catch(e) {}
  });
  activeOscillators = [];
}

// ============================================
// MUSIC THEORY DATA
// ============================================

let currentOctave = 4; // Middle C octave
let currentFretCount = 5; // Default fret view

// Base frequencies for octave 4 (Middle C = C4)
const baseNoteFrequencies = {
  'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
  'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
  'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
};

// Function to get frequency for any note in any octave
function getNoteFrequency(noteName, octave) {
  const baseFreq = baseNoteFrequencies[noteName];
  const octaveDiff = octave - 4;
  return baseFreq * Math.pow(2, octaveDiff);
}

const noteFrequencies = baseNoteFrequencies; // For backward compatibility

// Chromatic circle - starting with C = Yellow
const chromaticNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

// MIDI note numbers for reference (C4 = Middle C = MIDI 60)
const midiNumbers = {
  'C': 60, 'C#': 61, 'D': 62, 'D#': 63,
  'E': 64, 'F': 65, 'F#': 66, 'G': 67,
  'G#': 68, 'A': 69, 'A#': 70, 'B': 71
};

// Spectrum-based chromatic color wheel
const noteColors = {
  'C': '#FFFF00',   // Yellow (MIDI 60)
  'C#': '#FFC400',  // Yellow-Orange (MIDI 61)
  'D': '#FF8000',   // Orange (MIDI 62)
  'D#': '#FF4000',  // Red-Orange (MIDI 63)
  'E': '#FF0000',   // Red (MIDI 64)
  'F': '#C4007F',   // Red-Purple (MIDI 65)
  'F#': '#8000FF',  // Purple (MIDI 66)
  'G': '#4000FF',   // Blue-Purple (MIDI 67)
  'G#': '#0000FF',  // Blue (MIDI 68)
  'A': '#007FFF',   // Blue-Green (MIDI 69)
  'A#': '#00FF80',  // Green (MIDI 70)
  'B': '#80FF00'    // Yellow-Green (MIDI 71)
};

const intervalRatios = {
  'octave': 2,
  'fifth': 1.5,
  'fourth': 1.333,
  'major-third': 1.25,
  'tritone': 1.414
};

const chordFrequencies = {
  'A-major': { notes: ['A', 'C#', 'E'], freqs: [440, 554.37, 659.25] },
  'A-minor': { notes: ['A', 'C', 'E'], freqs: [440, 523.25, 659.25] },
  'C-major': { notes: ['C', 'E', 'G'], freqs: [261.63, 329.63, 392] },
  'G7': { notes: ['G', 'B', 'D', 'F'], freqs: [392, 493.88, 587.33, 698.46] },
  'diminished': { notes: ['C', 'D#', 'F#'], freqs: [261.63, 311.13, 369.99] }
};

// ============================================
// 3D CYMATICS VISUALIZATION
// ============================================

let scene, camera, renderer, mesh, controls;
let frequencies = [];
let time = 0;
let plateType = "square";
let currentNotes = [];

function initCymatics() {
  const canvas = document.getElementById('cymatics-canvas');
  
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a0a);

  camera = new THREE.PerspectiveCamera(45, canvas.offsetWidth / canvas.offsetHeight, 0.1, 100);
  camera.position.set(0, 3, 5);

  renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
  renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
  renderer.setPixelRatio(window.devicePixelRatio);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minDistance = 2;
  controls.maxDistance = 10;

  createPlate();

  // Lighting
  const light1 = new THREE.DirectionalLight(0xffffff, 1);
  light1.position.set(2, 5, 3);
  scene.add(light1);

  const light2 = new THREE.DirectionalLight(0x4A7BA7, 0.5);
  light2.position.set(-2, 3, -3);
  scene.add(light2);

  scene.add(new THREE.AmbientLight(0x404040, 0.5));

  // Grid helper
  const gridHelper = new THREE.GridHelper(10, 20, 0x4A7BA7, 0x2a4d6f);
  gridHelper.position.y = -0.5;
  scene.add(gridHelper);

  window.addEventListener('resize', onResize);
  animate();
}

function createPlate() {
  if (mesh) scene.remove(mesh);

  const segments = 140;
  let geo;
  
  if (plateType === "circle") {
    // Use CircleGeometry for true circular plate
    geo = new THREE.CircleGeometry(2, segments);
  } else {
    // Square plate
    geo = new THREE.PlaneGeometry(4, 4, segments, segments);
  }
  
  const mat = new THREE.MeshStandardMaterial({
    color: 0xF4D03F,
    wireframe: true,
    side: THREE.DoubleSide,
    emissive: 0x4A7BA7,
    emissiveIntensity: 0.2
  });

  mesh = new THREE.Mesh(geo, mat);
  mesh.rotation.x = -Math.PI / 2;

  scene.add(mesh);
}

function updateMeshColor() {
  if (!mesh || currentNotes.length === 0) return;
  
  // Get the color of the first note
  const primaryNote = currentNotes[0];
  const hexColor = noteColors[primaryNote];
  
  // Convert hex to THREE.Color
  const color = new THREE.Color(hexColor);
  
  // Update mesh material colors
  mesh.material.color = color;
  
  // Set emissive to a darker version for glow effect
  const emissiveColor = new THREE.Color(hexColor);
  emissiveColor.multiplyScalar(0.3);
  mesh.material.emissive = emissiveColor;
  mesh.material.emissiveIntensity = 0.5;
}

function updateWaves() {
  if (!mesh || frequencies.length === 0) return;

  const pos = mesh.geometry.attributes.position;

  for (let i = 0; i < pos.count; i++) {
    const x = pos.getX(i);
    const y = pos.getY(i);

    let z = 0;
    frequencies.forEach(f => {
      const k = f / 120;
      z += Math.sin(k * x + time) * Math.sin(k * y + time);
    });

    pos.setZ(i, z * 0.2);
  }

  pos.needsUpdate = true;
}

function animate() {
  requestAnimationFrame(animate);
  time += 0.02;

  updateWaves();
  controls.update();
  renderer.render(scene, camera);
}

function onResize() {
  const canvas = document.getElementById('cymatics-canvas');
  camera.aspect = canvas.offsetWidth / canvas.offsetHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
}

// ============================================
// PLAYBACK FUNCTIONS - EXPOSED GLOBALLY
// ============================================

function playNote(noteName, freq) {
  frequencies = [freq];
  currentNotes = [noteName];
  playSound([freq]);
  updateAllVisualizations();
  updateWaveInfo([{note: noteName, freq: freq, type: 'Single Note'}]);
}

function playInterval(intervalType) {
  const baseFreq = 440; // A
  const ratio = intervalRatios[intervalType];
  frequencies = [baseFreq, baseFreq * ratio];
  
  playSound(frequencies);
  updateAllVisualizations();
  updateWaveInfo([
    {note: 'A', freq: baseFreq, type: 'Base'},
    {note: intervalType, freq: (baseFreq * ratio).toFixed(2), type: 'Interval'}
  ]);
}

function playChord(chordType) {
  const chord = chordFrequencies[chordType];
  frequencies = chord.freqs;
  currentNotes = chord.notes;
  
  playSound(frequencies);
  updateAllVisualizations();
  
  const chordInfo = chord.notes.map((note, i) => ({
    note: note,
    freq: chord.freqs[i].toFixed(2),
    type: `Chord tone ${i+1}`
  }));
  
  updateWaveInfo(chordInfo);
}

function changeOctave(octave) {
  currentOctave = parseInt(octave);
  document.getElementById('current-octave').textContent = `Octave ${currentOctave}`;
  
  const firstNote = chromaticNotes[0];
  const lastNote = chromaticNotes[chromaticNotes.length - 1];
  document.getElementById('octave-range').textContent = `${firstNote}${currentOctave}-${lastNote}${currentOctave}`;
  
  // Rebuild piano and update visualizations
  rebuildPiano();
  updateAllVisualizations();
}

function playSelectedNote(noteName) {
  if (noteName === '') return; // Don't play if nothing selected
  
  const freq = getNoteFrequency(noteName, currentOctave);
  playNote(noteName, freq);
  
  // Reset dropdown to placeholder after playing
  setTimeout(() => {
    document.getElementById('note-select').value = '';
  }, 100);
}

function updateWaveInfo(notes) {
  const waveList = document.getElementById('wave-list');
  waveList.innerHTML = '';
  
  notes.forEach(note => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${note.note}</strong>: ${note.freq} Hz <span class="wave-type">${note.type}</span>`;
    waveList.appendChild(li);
  });
}

// ============================================
// VISUAL SYNCHRONIZATION
// ============================================

function updateAllVisualizations() {
  updateMeshColor();
  updatePiano();
  updateFretboard();
  updateChromaticCircle();
  updateStaff();
  updateTAB();
}

function updatePiano() {
  // Clear all active states
  document.querySelectorAll('.white-key, .black-key').forEach(key => {
    key.classList.remove('active');
  });
  
  // Highlight current notes
  currentNotes.forEach(note => {
    const keyElement = document.querySelector(`[data-note="${note}"]`);
    if (keyElement) {
      keyElement.classList.add('active');
    }
  });
}

function updateFretboard() {
  // Clear all active and same-note states
  document.querySelectorAll('.fret').forEach(fret => {
    fret.classList.remove('active', 'same-note');
  });
  
  // Highlight ALL occurrences of current notes on fretboard
  currentNotes.forEach(note => {
    document.querySelectorAll(`[data-fret-note="${note}"]`).forEach(fret => {
      fret.classList.add('same-note');
    });
  });
  
  // Make the first occurrence of each note "active" (primary highlight)
  currentNotes.forEach(note => {
    const firstOccurrence = document.querySelector(`[data-fret-note="${note}"]`);
    if (firstOccurrence) {
      firstOccurrence.classList.remove('same-note');
      firstOccurrence.classList.add('active');
    }
  });
}

function updateChromaticCircle() {
  const canvas = document.getElementById('circle-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 40;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Draw connecting circle
  ctx.strokeStyle = 'rgba(74, 123, 167, 0.3)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
  ctx.stroke();
  
  // Draw connecting lines between notes
  ctx.strokeStyle = 'rgba(74, 123, 167, 0.15)';
  ctx.lineWidth = 1;
  chromaticNotes.forEach((note, i) => {
    const angle1 = (i * 30 - 90) * Math.PI / 180;
    const x1 = centerX + radius * Math.cos(angle1);
    const y1 = centerY + radius * Math.sin(angle1);
    
    const angle2 = ((i + 1) * 30 - 90) * Math.PI / 180;
    const x2 = centerX + radius * Math.cos(angle2);
    const y2 = centerY + radius * Math.sin(angle2);
    
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  });
  
  // Draw each note in the chromatic circle
  chromaticNotes.forEach((note, i) => {
    const angle = (i * 30 - 90) * Math.PI / 180;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);
    
    const isActive = currentNotes.includes(note);
    const noteSize = isActive ? 32 : 24;
    
    // Draw glow for active notes
    if (isActive) {
      ctx.shadowBlur = 25;
      ctx.shadowColor = noteColors[note];
      
      // Outer glow ring
      ctx.beginPath();
      ctx.arc(x, y, noteSize + 8, 0, Math.PI * 2);
      ctx.strokeStyle = noteColors[note];
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
    
    // Draw note circle
    ctx.beginPath();
    ctx.arc(x, y, noteSize, 0, Math.PI * 2);
    ctx.fillStyle = noteColors[note];
    ctx.fill();
    ctx.strokeStyle = isActive ? '#fff' : '#2a4d6f';
    ctx.lineWidth = isActive ? 4 : 2.5;
    ctx.stroke();
    
    // Add subtle gradient for 3D effect
    if (!isActive) {
      const gradient = ctx.createRadialGradient(x - 5, y - 5, 0, x, y, noteSize);
      gradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
      gradient.addColorStop(1, 'rgba(0, 0, 0, 0.1)');
      ctx.beginPath();
      ctx.arc(x, y, noteSize, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
    }
    
    // Note label
    ctx.fillStyle = isActive ? '#000' : '#000';
    ctx.font = isActive ? 'bold 16px Arial' : 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowBlur = 0;
    ctx.fillText(note, x, y);
    
    // Add frequency label for active notes
    if (isActive) {
      ctx.font = 'bold 10px Arial';
      ctx.fillStyle = '#000';
      const freq = getNoteFrequency(note, currentOctave);
      ctx.fillText(`${freq.toFixed(0)}Hz`, x, y + 15);
    }
  });
}

function updateStaff() {
  const staff = document.getElementById('staff');
  // Clear existing notes and ledger lines
  staff.querySelectorAll('.note, .ledger-line').forEach(n => n.remove());
  
  // Treble clef staff positions (line positions from top to bottom)
  // Staff lines are at: 30, 50, 70, 90, 110
  const staffLinePositions = [30, 50, 70, 90, 110];
  
  // Note positions for treble clef (middle C = C4)
  // Each step is 10px (space between lines)
  const notePositions = {
    // Below staff
    'C3': 150, 'D3': 140, 'E3': 130, 'F3': 120, 'G3': 110,
    'A3': 100, 'B3': 90,
    // On/in staff  
    'C4': 110, // Middle C - BELOW staff (ledger line needed)
    'D4': 100, 'E4': 90, 'F4': 80, 'G4': 70,
    'A4': 60, 'B4': 50, 'C5': 40, 'D5': 30,
    // Above staff
    'E5': 20, 'F5': 10, 'G5': 0
  };
  
  // Add notes for current frequencies
  currentNotes.forEach((note, i) => {
    const noteBase = note.replace('#', '');
    const noteKey = `${noteBase}${currentOctave}`;
    
    // Get position (default to middle of staff if not in our map)
    let position = notePositions[noteKey] || 70;
    
    // Create note element
    const noteElement = document.createElement('div');
    noteElement.className = 'note';
    noteElement.style.left = `${50 + i * 50}px`;
    noteElement.style.top = `${position}px`;
    noteElement.style.background = noteColors[note];
    noteElement.style.boxShadow = `0 0 10px ${noteColors[note]}`;
    noteElement.style.zIndex = '10';
    staff.appendChild(noteElement);
    
    // Add ledger lines if note is outside staff
    // Middle C (C4) needs a ledger line at position 110
    if (position >= 110) {
      // Below staff - need ledger lines
      for (let ledgerPos = 110; ledgerPos <= position; ledgerPos += 20) {
        if (ledgerPos > 110 || position === 110) { // Always show for middle C
          const ledgerLine = document.createElement('div');
          ledgerLine.className = 'ledger-line';
          ledgerLine.style.position = 'absolute';
          ledgerLine.style.left = `${40 + i * 50}px`;
          ledgerLine.style.top = `${ledgerPos}px`;
          ledgerLine.style.width = '30px';
          ledgerLine.style.height = '2px';
          ledgerLine.style.background = '#333';
          ledgerLine.style.zIndex = '5';
          staff.appendChild(ledgerLine);
        }
      }
    } else if (position <= 30) {
      // Above staff - need ledger lines
      for (let ledgerPos = 30; ledgerPos >= position; ledgerPos -= 20) {
        if (ledgerPos < 30) {
          const ledgerLine = document.createElement('div');
          ledgerLine.className = 'ledger-line';
          ledgerLine.style.position = 'absolute';
          ledgerLine.style.left = `${40 + i * 50}px`;
          ledgerLine.style.top = `${ledgerPos}px`;
          ledgerLine.style.width = '30px';
          ledgerLine.style.height = '2px';
          ledgerLine.style.background = '#333';
          ledgerLine.style.zIndex = '5';
          staff.appendChild(ledgerLine);
        }
      }
    }
  });
}

function updateTAB() {
  const tab = document.getElementById('tab');
  
  // Standard tuning: E(low) A D G B E(high)
  const stringTuning = [
    {note: 'E', octave: 4, label: 'e'},  // High E (shown on top in TAB)
    {note: 'B', octave: 3, label: 'B'},
    {note: 'G', octave: 3, label: 'G'},
    {note: 'D', octave: 3, label: 'D'},
    {note: 'A', octave: 2, label: 'A'},
    {note: 'E', octave: 2, label: 'E'}   // Low E (shown on bottom in TAB)
  ];
  
  let tabText = '';
  
  // Build TAB for each string
  stringTuning.forEach(stringData => {
    tabText += `${stringData.label}|`;
    
    let foundNote = false;
    
    // Check if any current note can be played on this string
    currentNotes.forEach(note => {
      // Find all frets on this string that match the note
      const matchingFrets = [];
      
      for (let fret = 0; fret <= currentFretCount; fret++) {
        const semitones = fret;
        const startNoteIndex = chromaticNotes.indexOf(stringData.note);
        const fretNoteIndex = (startNoteIndex + semitones) % 12;
        const fretNote = chromaticNotes[fretNoteIndex];
        
        if (fretNote === note) {
          matchingFrets.push(fret);
        }
      }
      
      // Use the first matching fret (lowest position)
      if (matchingFrets.length > 0 && !foundNote) {
        const fretNum = matchingFrets[0];
        if (fretNum === 0) {
          tabText += '--0--';
        } else if (fretNum < 10) {
          tabText += `--${fretNum}--`;
        } else {
          tabText += `-${fretNum}-`;
        }
        foundNote = true;
      }
    });
    
    // If no note found on this string, show empty
    if (!foundNote) {
      tabText += '-----';
    }
    
    tabText += '|<br>';
  });
  
  tab.innerHTML = tabText;
}

// ============================================
// EXPOSE FUNCTIONS TO GLOBAL SCOPE
// ============================================

window.playNote = playNote;
window.playInterval = playInterval;
window.playChord = playChord;
window.changeOctave = changeOctave;
window.changeFretCount = changeFretCount;
window.getNoteFrequency = getNoteFrequency;
window.playSelectedNote = playSelectedNote;
window.setPlateShape = function(shape) {
  plateType = shape;
  createPlate();
};

// Function to rebuild piano with current octave
function rebuildPiano() {
  const piano = document.getElementById('piano');
  piano.innerHTML = ''; // Clear existing keys
  
  const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
  const blackKeys = {
    'C#': 1, 'D#': 2, 'F#': 4, 'G#': 5, 'A#': 6
  };
  
  // Create white keys
  whiteKeys.forEach((note, i) => {
    const key = document.createElement('div');
    key.className = 'white-key';
    key.setAttribute('data-note', note);
    const freq = getNoteFrequency(note, currentOctave);
    key.onclick = () => playNote(note, freq);
    piano.appendChild(key);
  });
  
  // Create black keys
  Object.entries(blackKeys).forEach(([note, position]) => {
    const key = document.createElement('div');
    key.className = 'black-key';
    key.setAttribute('data-note', note);
    key.style.left = `${position * 14.28 - 3}%`;
    const freq = getNoteFrequency(note, currentOctave);
    key.onclick = () => playNote(note, freq);
    piano.appendChild(key);
  });
}

// Function to build/rebuild fretboard with current fret count
function buildFretboard() {
  const fretboard = document.getElementById('fretboard');
  fretboard.innerHTML = ''; // Clear existing
  
  // Standard tuning: E(low) A D G B E(high) - left to right
  const stringTuning = [
    {note: 'E', octave: 2, label: 'E'},  // Low E
    {note: 'A', octave: 2, label: 'A'},
    {note: 'D', octave: 3, label: 'D'},
    {note: 'G', octave: 3, label: 'G'},
    {note: 'B', octave: 3, label: 'B'},
    {note: 'E', octave: 4, label: 'E'}   // High E
  ];
  
  // Create string header (E A D G B E at top)
  const stringHeader = document.createElement('div');
  stringHeader.className = 'string-header';
  stringTuning.forEach(string => {
    const label = document.createElement('div');
    label.className = 'string-label-top';
    label.textContent = string.label;
    stringHeader.appendChild(label);
  });
  fretboard.appendChild(stringHeader);
  
  // Create fret numbers on left side
  const fretNumbers = document.createElement('div');
  fretNumbers.className = 'fret-numbers';
  for (let i = 0; i <= currentFretCount; i++) {
    const fretNum = document.createElement('div');
    fretNum.className = 'fret-number';
    fretNum.textContent = i;
    fretNumbers.appendChild(fretNum);
  }
  fretboard.appendChild(fretNumbers);
  
  // Build strings
  stringTuning.forEach((stringData, stringIndex) => {
    const string = document.createElement('div');
    string.className = 'string';
    
    // Build frets (0 through currentFretCount)
    for (let fret = 0; fret <= currentFretCount; fret++) {
      const fretDiv = document.createElement('div');
      fretDiv.className = 'fret';
      
      // Calculate note at this fret
      const semitones = fret;
      const startNoteIndex = chromaticNotes.indexOf(stringData.note);
      const fretNoteIndex = (startNoteIndex + semitones) % 12;
      const fretNote = chromaticNotes[fretNoteIndex];
      
      // Calculate octave (changes after B wraps to C)
      let fretOctave = stringData.octave;
      if (startNoteIndex + semitones >= 12) {
        fretOctave += Math.floor((startNoteIndex + semitones) / 12);
      }
      
      const fretFreq = getNoteFrequency(fretNote, fretOctave);
      
      fretDiv.setAttribute('data-fret-note', fretNote);
      fretDiv.setAttribute('data-fret-octave', fretOctave);
      fretDiv.setAttribute('data-fret-number', fret);
      fretDiv.setAttribute('data-string-index', stringIndex);
      fretDiv.onclick = () => playNote(fretNote, fretFreq);
      
      // Add marker dots at specific frets
      if ((fret === 3 || fret === 5 || fret === 7 || fret === 9) && stringIndex === 2) {
        const dot = document.createElement('div');
        dot.className = 'fret-marker-dot';
        fretDiv.appendChild(dot);
      }
      
      // Double dots at 12th fret
      if (fret === 12 && (stringIndex === 1 || stringIndex === 4)) {
        const dot = document.createElement('div');
        dot.className = 'fret-marker-dot';
        fretDiv.appendChild(dot);
      }
      
      // 15th fret marker
      if (fret === 15 && stringIndex === 2) {
        const dot = document.createElement('div');
        dot.className = 'fret-marker-dot';
        fretDiv.appendChild(dot);
      }
      
      string.appendChild(fretDiv);
    }
    
    fretboard.appendChild(string);
  });
}

// Function to change fret count view
function changeFretCount(count) {
  currentFretCount = parseInt(count);
  buildFretboard();
  updateAllVisualizations();
}

// ============================================
// INITIALIZATION
// ============================================

window.addEventListener('DOMContentLoaded', () => {
  initCymatics();
  updateChromaticCircle();
  
  // Build piano keyboard with current octave
  rebuildPiano();
  buildFretboard();
  
  
  // Make chromatic circle interactive
  const circleCanvas = document.getElementById('circle-canvas');
  
  // Add hover cursor
  circleCanvas.style.cursor = 'pointer';
  
  circleCanvas.addEventListener('click', (e) => {
    const rect = circleCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const centerX = circleCanvas.width / 2;
    const centerY = circleCanvas.height / 2;
    const radius = Math.min(centerX, centerY) - 40;
    
    chromaticNotes.forEach((note, i) => {
      const angle = (i * 30 - 90) * Math.PI / 180;
      const nx = centerX + radius * Math.cos(angle);
      const ny = centerY + radius * Math.sin(angle);
      
      const distance = Math.sqrt((x - nx) ** 2 + (y - ny) ** 2);
      if (distance < 32) {
        const freq = getNoteFrequency(note, currentOctave);
        playNote(note, freq);
      }
    });
  });
});

</script>

</body>
</html>