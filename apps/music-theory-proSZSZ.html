<!--
================================================================================
COPYRIGHT NOTICE - LEGAL WARNING
Last Updated: February 2026
================================================================================
¬© 2026 Keys, Codes & Modes‚Ñ¢ | Benjamin Ryan | All Rights Reserved

This website and all content, code, design, applications, and materials are the
exclusive intellectual property of Benjamin Ryan and Keys, Codes & Modes‚Ñ¢.

STRICTLY PROHIBITED: Copying, reproducing, duplicating, distributing, or any
unauthorized use of these Works is STRICTLY PROHIBITED without express written
permission. VIOLATORS WILL BE PROSECUTED TO THE FULLEST EXTENT OF THE LAW.

Protected by U.S. Copyright Law (17 U.S.C. ¬ß 101 et seq.)
FreeStyle¬Æ is a registered trademark. U.S. Patents.
For licensing: https://keyscodesandmodes.com/contact.html
Santa Barbara, California | All Rights Reserved
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
<!-- Cookie Consent CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<style>
.cc-window { font-family: 'Montserrat', sans-serif !important; background: #0a0a15 !important; border: 2px solid #008080 !important; box-shadow: 0 8px 30px rgba(0,217,255,0.3) !important; }
.cc-btn { background: linear-gradient(135deg, #008080 0%, #8B6BA3 100%) !important; border: none !important; padding: 0.75rem 2rem !important; font-weight: 600 !important; transition: all 0.3s ease !important; }
.cc-btn:hover { transform: translateY(-2px) !important; box-shadow: 0 5px 15px rgba(0,128,128,0.4) !important; }
.cc-link { color: #F4D03F !important; }
.cc-link:hover { color: #008080 !important; }
</style>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
<script>
window.addEventListener('load', function() {
  window.cookieconsent.initialise({
    palette: { popup: { background: "#0a0a15", text: "#E8E8E8" }, button: { background: "#008080", text: "#ffffff" } },
    theme: "classic", position: "bottom", type: "opt-in", revokable: true, animateRevokable: false,
    content: { message: "We use cookies to enhance your experience. By clicking Accept, you consent to our use of cookies.", dismiss: "Accept", deny: "Decline", link: "Privacy", href: "/privacy-policy.html" },
    onStatusChange: function(status) { if (this.hasConsented()) loadGoogleAnalytics(); },
    onInitialise: function(status) { if (this.hasConsented()) loadGoogleAnalytics(); }
  });
});
function loadGoogleAnalytics() {
  if (window.gaLoaded) return; window.gaLoaded = true;
  var s = document.createElement('script'); s.async = true; s.src = 'https://www.googletagmanager.com/gtag/js?id=G-6EGC5ZNZPF'; document.head.appendChild(s);
  window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); gtag('config', 'G-6EGC5ZNZPF', {'anonymize_ip': true, 'allow_google_signals': false, 'allow_ad_personalization_signals': false});
  gtag('consent', 'default', {'ad_storage': 'denied', 'analytics_storage': 'granted'});
}
function trackEvent(n,p){if(typeof gtag==='function')gtag('event',n,p);}
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#008080">
<title>Music Theory Explorer Pro | Keys, Codes & Modes</title>
<meta name="description" content="Interactive music theory learning ‚Äî chromatic circle, piano keyboard, guitar fretboard, ear training & MIDI support. Part of Keys, Codes & Modes by Benjamin Ryan.">
<meta name="author" content="Benjamin Ryan">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://keyscodesandmodes.com/music-theory-pro.html">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Keys, Codes & Modes">
<meta property="og:title" content="Music Theory Explorer Pro | Keys, Codes & Modes">
<meta property="og:description" content="Interactive music theory ‚Äî chromatic circle, piano, guitar, ear training & MIDI. By Benjamin Ryan.">
<meta property="og:url" content="https://keyscodesandmodes.com/music-theory-pro.html">
<meta property="og:image" content="https://keyscodesandmodes.com/images/kcm-social-share.jpg">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* ============================================================
   KCM MASTER VARIABLES
   ============================================================ */
:root {
    --primary-teal:   #008080;
    --primary-gold:   #F4D03F;
    --primary-purple: #8B6BA3;
    --primary-coral:  #CF7A5A;
    --dark-bg:        #0a0a15;
    --darker-bg:      #050508;
    --panel-bg:       rgba(26, 61, 95, 0.25);
    --light-text:     #E8E8E8;
    --font-display:   'Cinzel', serif;
    --font-body:      'Montserrat', sans-serif;
    --teal-glow:      0 0 20px rgba(0,128,128,0.4);
    --gold-glow:      0 0 20px rgba(244,208,63,0.4);
}

/* ============================================================
   RESET & BASE
   ============================================================ */
*, *::before, *::after {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-user-select: none;
    user-select: none;
    margin: 0; padding: 0;
}

body {
    font-family: var(--font-body);
    background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a15 100%);
    color: var(--light-text);
    line-height: 1.6;
    min-height: 100vh;
    touch-action: manipulation;
}

/* ============================================================
   SITE HEADER (matches keyscodesandmodes.com)
   ============================================================ */
.site-header {
    background: linear-gradient(135deg, rgba(0,128,128,0.2) 0%, rgba(139,107,163,0.2) 100%);
    border-bottom: 2px solid var(--primary-teal);
    box-shadow: 0 4px 30px rgba(0,217,255,0.2);
    backdrop-filter: blur(10px);
    padding: 1.25rem 2rem;
    position: sticky; top: 0; z-index: 1000;
}
.site-header-inner {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}
.logo-text h1 {
    font-family: var(--font-display);
    font-size: 1.4rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-gold) 50%, var(--primary-purple) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 2px;
}
.logo-text p {
    font-size: 0.7rem;
    color: rgba(232,232,232,0.6);
    letter-spacing: 1px;
    -webkit-text-fill-color: rgba(232,232,232,0.6);
}
nav ul { list-style: none; display: flex; gap: 1.75rem; flex-wrap: wrap; }
nav a {
    color: var(--light-text);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s;
    letter-spacing: 0.5px;
}
nav a:hover { color: var(--primary-gold); }
nav a.active { color: var(--primary-teal); }

/* ============================================================
   APP TITLE BANNER
   ============================================================ */
.app-title-banner {
    text-align: center;
    padding: 2rem 2rem 1.5rem;
    background: linear-gradient(180deg, rgba(0,128,128,0.1) 0%, transparent 100%);
    border-bottom: 1px solid rgba(0,128,128,0.2);
}
.app-title-banner h2 {
    font-family: var(--font-display);
    font-size: 2.2rem;
    font-weight: 900;
    background: linear-gradient(135deg, #00d9d9 0%, var(--primary-gold) 50%, var(--primary-purple) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 2px;
    margin-bottom: 0.5rem;
}
.app-title-banner p {
    color: rgba(232,232,232,0.75);
    font-size: 0.95rem;
    font-weight: 500;
}

/* ============================================================
   MAIN APP CONTAINER
   ============================================================ */
.app-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem 1.5rem 3rem;
}

/* ============================================================
   START AUDIO BUTTON
   ============================================================ */
#startAudio {
    display: block;
    margin: 1.5rem auto;
    padding: 1.1rem 3.5rem;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50px;
    color: white;
    cursor: pointer;
    font-weight: 800;
    font-family: var(--font-body);
    touch-action: manipulation;
    box-shadow: 0 6px 25px rgba(231,76,60,0.5);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    transition: all 0.3s;
}
#startAudio:hover { transform: translateY(-3px); box-shadow: 0 10px 35px rgba(231,76,60,0.6); }
#startAudio:disabled { cursor: default; }

/* ============================================================
   VIEW TOGGLE BUTTONS
   ============================================================ */
.view-toggle {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 1.25rem;
}
.view-btn {
    padding: 0.7rem 1.4rem;
    background: rgba(0,128,128,0.15);
    border: 2px solid rgba(0,128,128,0.3);
    border-radius: 10px;
    color: var(--light-text);
    cursor: pointer;
    font-weight: 700;
    font-size: 0.82rem;
    font-family: var(--font-body);
    transition: all 0.3s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}
.view-btn:hover {
    background: rgba(0,128,128,0.3);
    border-color: var(--primary-teal);
    transform: translateY(-2px);
}
.view-btn.active {
    background: linear-gradient(135deg, var(--primary-teal) 0%, #006666 100%);
    border-color: var(--primary-teal);
    box-shadow: var(--teal-glow);
    transform: scale(1.04);
}

/* ============================================================
   LEVEL SELECTOR
   ============================================================ */
.level-selector {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 0.75rem auto 1.25rem;
    flex-wrap: wrap;
    background: rgba(0,0,0,0.4);
    padding: 1.25rem 1.5rem;
    border-radius: 16px;
    border: 2px solid rgba(0,128,128,0.2);
    backdrop-filter: blur(10px);
    max-width: 1050px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}
.level-btn {
    padding: 0.65rem 1.1rem;
    background: rgba(255,255,255,0.08);
    border: 2px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    color: var(--light-text);
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 700;
    font-family: var(--font-body);
    transition: all 0.3s;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    min-width: 90px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}
.level-btn:hover {
    background: rgba(244,208,63,0.15);
    border-color: var(--primary-gold);
    transform: translateY(-2px);
}
.level-btn.active {
    background: linear-gradient(135deg, var(--primary-gold) 0%, #e6c62f 100%);
    border-color: var(--primary-gold);
    color: #1a1a2e;
    box-shadow: var(--gold-glow);
    transform: scale(1.06);
}

/* ============================================================
   PLAY BUTTONS
   ============================================================ */
.play-btn {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    padding: 0.7rem 1.2rem;
    font-size: 0.78rem;
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-family: var(--font-body);
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}
.play-btn:hover {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46,204,113,0.4);
}

/* ============================================================
   INFO / CONTROL PANELS
   ============================================================ */
.info-panel {
    background: var(--panel-bg);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    backdrop-filter: blur(10px);
    max-width: 1000px;
    margin: 1.25rem auto;
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    border: 2px solid rgba(0,128,128,0.2);
}
.control-group {
    margin-bottom: 1.1rem;
    background: rgba(0,0,0,0.3);
    padding: 0.85rem 1.1rem;
    border-radius: 10px;
    border: 2px solid rgba(0,128,128,0.15);
}
.control-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 700;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--primary-gold);
}
select {
    padding: 0.65rem 1rem;
    border: 2px solid rgba(0,128,128,0.3);
    border-radius: 8px;
    background: rgba(0,128,128,0.1);
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-family: var(--font-body);
    width: 100%;
    font-size: 0.88rem;
    transition: all 0.3s;
}
select:focus {
    outline: none;
    border-color: var(--primary-teal);
    box-shadow: var(--teal-glow);
}
select option { background: #1a1a2e; color: white; }

/* ============================================================
   STATUS BAR
   ============================================================ */
#status {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 1.25rem;
    padding: 0.85rem 1.25rem;
    background: rgba(0,128,128,0.1);
    border-radius: 10px;
    border: 2px solid rgba(0,128,128,0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--primary-gold);
    animation: statusGlow 3s ease-in-out infinite;
}
@keyframes statusGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(0,128,128,0.2); }
    50% { box-shadow: 0 0 20px rgba(0,128,128,0.5); }
}

/* ============================================================
   OCTAVE / TEMPO CONTROLS
   ============================================================ */
.octave-btn {
    background: linear-gradient(135deg, var(--primary-teal) 0%, #006666 100%);
    padding: 0.75rem 1.2rem;
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-family: var(--font-body);
    font-size: 0.78rem;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}
.octave-btn:hover { background: linear-gradient(135deg, #00a0a0 0%, var(--primary-teal) 100%); transform: translateY(-2px); }

.octave-display {
    font-size: 0.78rem;
    font-weight: 700;
    min-width: 170px;
    text-align: center;
    background: rgba(0,128,128,0.1);
    padding: 0.75rem 1.1rem;
    border-radius: 10px;
    border: 2px solid rgba(0,128,128,0.3);
    min-height: 44px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* ============================================================
   CHROMATIC CIRCLE
   ============================================================ */
#chromaticCircle {
    position: relative;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, #1a1a2e 0%, #0a0a15 100%);
    border-radius: 50%;
    border: 4px solid rgba(0,128,128,0.4);
    box-shadow: 0 0 40px rgba(0,128,128,0.2), inset 0 0 40px rgba(0,0,0,0.5);
    margin: 1rem auto;
}

/* ============================================================
   STAFF NOTATION (center of circle)
   ============================================================ */
#staffNotation {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 240px;
    height: 200px;
    background: rgba(255,255,255,0.97);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 35px rgba(0,0,0,0.7);
    pointer-events: none;
    border: 3px solid var(--primary-teal);
    z-index: 10;
}
#staffNotation svg { width: 100%; height: 100%; }

/* ============================================================
   PIANO KEYBOARD
   ============================================================ */
#pianoKeyboard {
    display: none;
    background: rgba(0,0,0,0.4);
    padding: 2rem;
    border-radius: 16px;
    margin-top: 1rem;
    border: 2px solid rgba(0,128,128,0.2);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}
.piano-container {
    position: relative;
    height: 200px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
}
.white-key {
    width: 50px; height: 200px;
    background: linear-gradient(to bottom, #fff 0%, #f0f0f0 100%);
    border: 2px solid #333;
    cursor: pointer;
    position: relative;
    transition: all 0.15s;
    touch-action: manipulation;
}
.white-key:hover { background: linear-gradient(to bottom, #f5f5f5 0%, #e0e0e0 100%); transform: translateY(-2px); }
.white-key.playing { transform: translateY(3px); box-shadow: inset 0 4px 8px rgba(0,0,0,0.3); }
.black-key {
    width: 32px; height: 120px;
    background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
    border: 2px solid #000;
    cursor: pointer;
    position: absolute;
    z-index: 2;
    transition: all 0.15s;
    touch-action: manipulation;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
}
.black-key:hover { background: linear-gradient(180deg, #2a2a2a 0%, #111 100%); transform: translateY(-2px); }
.black-key.playing { transform: translateY(3px); box-shadow: inset 0 4px 8px rgba(0,0,0,0.7); }
.key-label {
    position: absolute;
    bottom: 10px;
    width: 100%;
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    pointer-events: none;
    font-family: var(--font-body);
}
.black-key .key-label { bottom: 5px; font-size: 9px; line-height: 1.2; color: white; }

/* ============================================================
   GUITAR FRETBOARD
   ============================================================ */
#guitarFretboard {
    display: none;
    background: rgba(0,0,0,0.4);
    padding: 2rem;
    border-radius: 16px;
    max-width: 1100px;
    margin-top: 1rem;
    border: 2px solid rgba(0,128,128,0.2);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    overflow-y: auto;
    max-height: 90vh;
}
.fretboard-container {
    position: relative;
    background: linear-gradient(to bottom, #8B4513 0%, #A0522D 100%);
    border-radius: 3px;
    padding: 5px 10px 1px 10px;
    margin-bottom: 1.25rem;
    display: flex;
    justify-content: center;
}
.fretboard {
    position: relative;
    width: 180px;
    height: 400px;
    background: linear-gradient(to right, #D2691E 0%, #8B4513 50%, #654321 100%);
    border-radius: 2px;
    border: 1px solid #654321;
    cursor: pointer;
}
.guitar-string {
    position: absolute;
    height: 100%;
    width: 2px;
    background: linear-gradient(to bottom, #C0C0C0 0%, #808080 100%);
    top: 0;
}
.fret-wire {
    position: absolute;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #888 0%, #aaa 50%, #888 100%);
    left: 0;
}
.note-dot {
    position: absolute;
    width: 30px; height: 30px;
    border-radius: 50%;
    border: 2px solid white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    font-family: var(--font-body);
    cursor: pointer;
    transform: translate(-15px, -15px);
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    touch-action: manipulation;
}
.note-dot:hover { transform: translate(-15px, -15px) scale(1.2); }
.note-dot.playing { transform: translate(-15px, -15px) scale(1.4); border-color: #fff; border-width: 4px; }
.string-label {
    position: absolute;
    top: -60px;
    font-weight: bold;
    font-size: 32px;
    color: white;
    text-align: center;
    width: 40px; height: 40px;
    cursor: pointer;
    z-index: 500;
    transition: color 0.3s, transform 0.3s, text-shadow 0.3s;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}
.string-label:hover { color: var(--primary-gold); transform: scale(1.35); }

/* ============================================================
   EAR TRAINING
   ============================================================ */
#earTraining {
    display: none;
    background: rgba(0,0,0,0.4);
    padding: 2rem;
    border-radius: 16px;
    max-width: 750px;
    text-align: center;
    margin: 0 auto;
    border: 2px solid rgba(0,128,128,0.2);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}
.quiz-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 1.25rem 0;
    justify-content: center;
}
.quiz-btn {
    padding: 0.8rem 1.4rem;
    background: linear-gradient(135deg, var(--primary-teal) 0%, #006666 100%);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    color: white;
    font-weight: 700;
    font-family: var(--font-body);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}
.quiz-btn:hover { background: linear-gradient(135deg, #00a0a0 0%, var(--primary-teal) 100%); transform: translateY(-2px); }
.quiz-btn.correct { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); box-shadow: 0 6px 20px rgba(39,174,96,0.6); }
.quiz-btn.incorrect { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); box-shadow: 0 6px 20px rgba(231,76,60,0.6); }

/* ============================================================
   SPHERES (chromatic circle notes)
   ============================================================ */
.sphere {
    position: absolute;
    width: 70px; height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 15px;
    font-family: var(--font-body);
    cursor: pointer;
    border: 4px solid rgba(255,255,255,0.5);
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    transition: transform 0.2s;
    touch-action: manipulation;
}
.sphere:hover { transform: scale(1.15); }
.sphere.active { border-color: var(--primary-gold); box-shadow: 0 0 25px rgba(244,208,63,0.8); transform: scale(1.25); }
.sphere.included { opacity: 1; transform: scale(1.1); }
.sphere.excluded { opacity: 0.3; filter: grayscale(90%) brightness(0.5); }
.sphere.playing { border-color: #ffffff; box-shadow: 0 0 35px rgba(255,255,255,1); transform: scale(1.35); }
.sphere.freeplay-inactive { opacity: 1; filter: none; transform: scale(1); }

/* ============================================================
   NOTE LIST BADGES
   ============================================================ */
.note-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 1rem;
    justify-content: center;
}
.note-badge {
    padding: 0.55rem 1rem;
    border-radius: 20px;
    background: rgba(0,128,128,0.2);
    font-size: 0.82rem;
    font-weight: 700;
    border: 2px solid rgba(0,128,128,0.3);
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: var(--font-body);
}

/* ============================================================
   PROGRESSION CONTROLS
   ============================================================ */
.progression-controls {
    display: none;
    background: rgba(0,0,0,0.5);
    padding: 1.5rem 1.75rem;
    border-radius: 16px;
    margin: 1rem auto;
    max-width: 1000px;
    border: 2px solid rgba(244,208,63,0.3);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
}
.progression-controls h4 {
    margin: 0 0 1rem 0;
    text-align: center;
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--primary-gold);
}
.progression-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
}
.octave-btn.prog-btn {
    background: linear-gradient(135deg, var(--primary-purple) 0%, #6a4f8c 100%);
    font-size: 0.7rem;
    min-height: 44px;
    padding: 0.65rem 1rem;
}

/* ============================================================
   FREE PLAY HINT
   ============================================================ */
.freeplay-hint {
    background: linear-gradient(135deg, rgba(244,208,63,0.2) 0%, rgba(207,122,90,0.2) 100%);
    border: 2px solid rgba(244,208,63,0.4);
    padding: 1rem 1.25rem;
    border-radius: 10px;
    margin-bottom: 1.25rem;
    text-align: center;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--primary-gold);
}

/* ============================================================
   RECORDING STUDIO
   ============================================================ */
.rec-btn {
    padding: 0.75rem 1.2rem;
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-family: var(--font-body);
    font-size: 0.75rem;
    background: linear-gradient(135deg, var(--primary-teal) 0%, #006666 100%);
    min-height: 44px;
    touch-action: manipulation;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-transform: uppercase;
}
.rec-btn:hover { transform: translateY(-2px); }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.rec-btn.recording {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    animation: pulse 1.5s infinite;
}

/* ============================================================
   KEYBOARD SHORTCUTS PANEL
   ============================================================ */
.shortcuts-panel {
    background: rgba(0,0,0,0.3);
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1.25rem;
    border: 1px solid rgba(0,128,128,0.2);
}
.shortcuts-panel h5 {
    margin: 0 0 0.6rem 0;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--primary-gold);
    font-family: var(--font-display);
}
.shortcuts-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap: 6px;
    font-size: 0.75rem;
}
.shortcut-item { display: flex; gap: 8px; align-items: center; }
.shortcut-key {
    background: rgba(0,128,128,0.2);
    border: 1px solid rgba(0,128,128,0.4);
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: bold;
    min-width: 38px;
    text-align: center;
    color: var(--primary-gold);
}

/* ============================================================
   SITE FOOTER
   ============================================================ */
.site-footer {
    text-align: center;
    padding: 2.5rem 2rem;
    background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.5) 100%);
    border-top: 1px solid rgba(0,128,128,0.3);
    margin-top: 2rem;
}
.site-footer p { color: rgba(232,232,232,0.5); margin: 0.4rem 0; font-size: 0.85rem; }
.site-footer a { color: var(--primary-teal); text-decoration: none; margin: 0 8px; transition: color 0.3s; }
.site-footer a:hover { color: var(--primary-gold); }

/* ============================================================
   TEMPO SLIDER
   ============================================================ */
input[type="range"] {
    -webkit-appearance: none;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--primary-teal), var(--primary-gold));
    outline: none;
    cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: var(--primary-gold);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 767px) {
    .site-header { padding: 1rem; }
    .site-header-inner { flex-direction: column; text-align: center; gap: 0.6rem; }
    nav ul { gap: 1rem; justify-content: center; }
    nav a { font-size: 0.82rem; }
    .app-title-banner h2 { font-size: 1.5rem; }
    .app-container { padding: 1rem 0.75rem 2rem; }
    #chromaticCircle { width: 340px; height: 340px; }
    .sphere { width: 50px; height: 50px; font-size: 11px; }
    .view-btn { font-size: 0.72rem; padding: 0.55rem 0.85rem; }
    .level-btn { font-size: 0.65rem; min-width: 75px; padding: 0.5rem 0.65rem; }
    .info-panel { padding: 1.25rem 1rem; }
}
@media (max-width: 479px) {
    .logo-text h1 { font-size: 1rem; }
    nav ul { gap: 0.6rem; }
    nav a { font-size: 0.75rem; }
    #chromaticCircle { width: 300px; height: 300px; }
    .sphere { width: 44px; height: 44px; font-size: 10px; }
}
@media (prefers-reduced-motion: reduce) {
    * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; }
}
@media (hover: none) and (pointer: coarse) {
    .sphere:hover { transform: none; }
}
@media print {
    .site-header, .site-footer, #startAudio, .view-toggle, .level-selector { display: none; }
    body { background: white; color: black; }
}
</style>
</head>
<body>

<!-- SKIP LINK -->
<a href="#main-content" style="position:absolute;top:-40px;left:0;background:var(--primary-gold);color:#0a0a15;padding:8px 16px;text-decoration:none;font-weight:bold;z-index:10000;font-family:var(--font-body);" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>

<!-- ============================================================
     SITE HEADER
     ============================================================ -->
<header class="site-header" role="banner">
    <div class="site-header-inner">
        <div class="logo-text">
            <h1>KEYS, CODES & MODES</h1>
            <p>A Visual Approach to Understanding Music</p>
        </div>
        <nav role="navigation" aria-label="Main navigation">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="insights.html">All Apps</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </div>
</header>

<!-- ============================================================
     APP TITLE BANNER
     ============================================================ -->
<div class="app-title-banner">
    <h2>üéµ Music Theory Explorer Pro</h2>
    <p>Interactive Music Learning ¬∑ Chromatic Circle ¬∑ Piano ¬∑ Guitar ¬∑ Ear Training ¬∑ MIDI Support</p>
</div>

<!-- ============================================================
     MAIN APP
     ============================================================ -->
<div class="app-container" id="main-content" role="main">

    <button id="startAudio" aria-label="Start audio engine">üîä START AUDIO ENGINE</button>

    <!-- VIEW TOGGLE -->
    <div class="view-toggle" role="group" aria-label="View selector">
        <button class="view-btn active" data-view="circle">‚≠ï Chromatic Circle</button>
        <button class="view-btn" data-view="guitar">üé∏ Guitar Fretboard</button>
        <button class="view-btn" data-view="keyboard">üéπ Piano Keyboard</button>
        <button class="view-btn" data-view="ear">üëÇ Ear Training</button>
    </div>

    <!-- LEVEL SELECTOR -->
    <div class="level-selector" role="group" aria-label="Learning mode selector">
        <button class="level-btn active" data-level="1">Single Note</button>
        <button class="level-btn" data-level="2">Intervals</button>
        <button class="level-btn" data-level="3">Triads</button>
        <button class="level-btn" data-level="4">7th Chords</button>
        <button class="level-btn" data-level="5">Pentatonic</button>
        <button class="level-btn" data-level="7">Major Scale</button>
        <button class="level-btn" data-level="minor">Minor Scales</button>
        <button class="level-btn" data-level="modes">Modes</button>
        <button class="level-btn" data-level="harmMajor">Harmonized Major</button>
        <button class="level-btn" data-level="harmMinor">Harmonized Minor</button>
        <button class="level-btn" data-level="freeplay">Free Play</button>
    </div>

    <!-- PROGRESSION CONTROLS -->
    <div class="progression-controls" id="progressionControls" aria-live="polite">
        <h4>üéº Chord Progressions in Key of <span id="progressionKey">C</span></h4>
        <div style="text-align:center; font-size:0.75rem; opacity:0.8; margin-bottom:0.85rem; font-weight:600;">
            Using <span id="progressionChordType">Triads</span> ¬∑ Scale: <span id="progressionScaleType">Major</span>
        </div>
        <div style="text-align:center; margin-bottom:0.85rem;">
            <button class="play-btn" id="playAllChordsBtn" style="margin:0 auto; display:inline-flex;">üéπ Play All Scale Chords</button>
        </div>
        <div class="progression-buttons" id="progressionButtons"></div>
    </div>

    <!-- MAIN CONTROLS PANEL -->
    <div class="info-panel">

        <div id="freeplayHint" class="freeplay-hint" style="display:none;" aria-live="polite">
            üé® FREE PLAY MODE ‚Äî Click multiple notes to select them, then use the buttons below to play as CHORD (simultaneous) or SEQUENCE (one by one)!
        </div>

        <!-- OCTAVE & TEMPO -->
        <div style="display:flex; gap:12px; justify-content:center; margin-bottom:1.1rem; flex-wrap:wrap; align-items:center;">
            <button class="octave-btn" id="octaveDown" aria-label="Lower octave">‚óÄ Lower</button>
            <div class="octave-display" aria-live="polite">
                <div style="font-size:0.65rem; opacity:0.7; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">Octave / Register</div>
                <div id="octaveLabel" style="font-size:0.9rem; color:var(--primary-gold);">Octave 4 (Middle C)</div>
            </div>
            <button class="octave-btn" id="octaveUp" aria-label="Raise octave">Higher ‚ñ∂</button>
        </div>

        <!-- TEMPO SLIDER -->
        <div style="display:flex; gap:12px; justify-content:center; margin-bottom:1.1rem; flex-wrap:wrap;">
            <div style="background:rgba(0,128,128,0.1); padding:1rem 1.25rem; border-radius:10px; border:2px solid rgba(0,128,128,0.2); min-width:300px;">
                <div style="font-size:0.65rem; opacity:0.8; text-align:center; margin-bottom:0.5rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--primary-gold);">‚è± Playback Speed</div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.7rem; font-weight:700; min-width:38px;">SLOW</span>
                    <input type="range" id="tempoSlider" min="40" max="240" value="120" step="10" style="flex:1;" aria-label="Tempo in BPM">
                    <span style="font-size:0.7rem; font-weight:700; min-width:38px; text-align:right;">FAST</span>
                </div>
                <div style="text-align:center; margin-top:4px; font-size:1.1rem; font-weight:800; color:var(--primary-gold);"><span id="bpmDisplay">120</span> BPM</div>
            </div>
        </div>

        <!-- PLAY BUTTONS -->
        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:1.25rem; flex-wrap:wrap;">
            <button class="play-btn" id="playUpBtn" style="flex:1; max-width:160px;">‚Üë Ascending</button>
            <button class="play-btn" id="playDownBtn" style="flex:1; max-width:160px;">‚Üì Descending</button>
            <button class="play-btn" id="playScaleBtn" style="flex:1; max-width:160px;">‚ô´ Full Scale</button>
            <button class="play-btn" id="playChordBtn" style="flex:1; max-width:160px;">‚ô™ Play Chord</button>
        </div>

        <!-- VIEWS CONTAINER -->
        <div style="display:flex; flex-direction:column; gap:1.25rem; background:rgba(0,0,0,0.35); padding:1.75rem; border-radius:14px; border:1px solid rgba(0,128,128,0.15);">

            <!-- CHROMATIC CIRCLE -->
            <div id="chromaticCircle" style="margin:0 auto; display:block;" role="region" aria-label="Chromatic circle">
                <div id="staffNotation" aria-label="Staff notation" role="img">
                    <div style="background:linear-gradient(135deg, var(--primary-teal), #006666); color:white; padding:6px; border-radius:8px 8px 0 0; margin:-15px -15px 6px -15px; text-align:center; font-size:0.75rem; font-weight:800; letter-spacing:1px; font-family:var(--font-display);">
                        üéº STAFF NOTATION
                    </div>
                    <svg id="staffSVG" viewBox="0 0 220 135" aria-hidden="true"></svg>
                </div>
            </div>

            <!-- PIANO KEYBOARD -->
            <div id="pianoKeyboard" style="margin:0 auto;" role="region" aria-label="Piano keyboard">
                <h3 style="text-align:center; margin:0 0 1.1rem 0; font-family:var(--font-display); font-size:1.2rem; font-weight:800; color:var(--primary-gold);">üéπ Piano Keyboard</h3>
                <div class="piano-container" id="pianoContainer"></div>
            </div>

            <!-- GUITAR FRETBOARD -->
            <div id="guitarFretboard" style="margin:0 auto;" role="region" aria-label="Guitar fretboard">
                <h3 style="text-align:center; margin:0 0 0.85rem 0; font-family:var(--font-display); font-size:1.2rem; font-weight:800; color:var(--primary-gold);">üé∏ Guitar Fretboard ‚Äî Standard Tuning</h3>
                <div style="display:flex; justify-content:center; margin-bottom:1.1rem;">
                    <div style="display:flex; gap:6px; background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:10px;">
                        <button class="level-btn active" id="fret5Btn" style="padding:8px 16px; font-size:0.7rem; min-width:80px;">5 Frets</button>
                        <button class="level-btn" id="fret12Btn" style="padding:8px 16px; font-size:0.7rem; min-width:80px;">12 Frets</button>
                    </div>
                </div>
                <div style="text-align:center; margin-bottom:3.5rem;">
                    <p style="color:#4CAF50; font-weight:bold; font-size:0.82rem;">Active notes light up in color ¬∑ Click dots or open strings to play</p>
                    <div style="color:white; font-weight:bold; font-size:0.82rem; margin-top:0.25rem;">OPEN STRINGS (0 fret)</div>
                </div>
                <div class="fretboard-container">
                    <div class="fretboard" id="fretboard"></div>
                </div>
            </div>

            <!-- EAR TRAINING -->
            <div id="earTraining" role="region" aria-label="Ear training quiz">
                <h2 id="quizQuestion" style="font-family:var(--font-display); font-size:1.3rem; font-weight:800; color:var(--primary-gold); margin-bottom:1rem;">Click "New Question" to start</h2>
                <div class="quiz-options" id="quizOptions" role="group" aria-label="Answer options"></div>
                <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:0.75rem 0;">
                    <button class="play-btn" id="playQuizBtn">üîä Replay Sound</button>
                    <button class="play-btn" id="newQuizBtn" style="background:linear-gradient(135deg, var(--primary-purple) 0%, #6a4f8c 100%);">üîÑ New Question</button>
                </div>
                <p id="quizScore" style="margin-top:1.25rem; font-family:var(--font-display); font-size:1.2rem; font-weight:700; color:var(--primary-gold);" aria-live="polite">Score: 0/0</p>
            </div>

        </div><!-- end views container -->
    </div><!-- end info-panel -->

    <!-- STATUS & CONTROLS PANEL -->
    <div class="info-panel">
        <h3 id="status" role="status" aria-live="polite">Click START AUDIO ENGINE to begin!</h3>
        <div id="controls"></div>
        <div class="note-list" id="noteList" aria-live="polite"></div>

        <!-- RECORDING STUDIO -->
        <div style="background:rgba(0,0,0,0.4); padding:1.5rem; border-radius:12px; margin-top:1.5rem; border:2px solid rgba(0,128,128,0.2);">
            <h4 style="margin:0 0 1rem 0; text-align:center; font-family:var(--font-display); font-size:1rem; font-weight:700; color:var(--primary-gold); text-transform:uppercase; letter-spacing:1px;">üéôÔ∏è Recording Studio</h4>
            <div style="display:flex; gap:10px; margin-bottom:1rem; flex-wrap:wrap; justify-content:center;">
                <button class="rec-btn" id="recordBtn" aria-pressed="false">‚è∫ Record</button>
                <button class="rec-btn" id="playRecBtn">‚ñ∂ Playback</button>
                <button class="rec-btn" id="clearRecBtn" style="background:linear-gradient(135deg, #e67e22 0%, #d35400 100%);">üóë Clear</button>
                <button class="rec-btn" id="downloadRecBtn" style="background:linear-gradient(135deg, var(--primary-purple) 0%, #6a4f8c 100%);">üíæ Download MIDI</button>
            </div>
            <div id="recordingStatus" style="text-align:center; min-height:1.25rem; font-size:0.82rem;" aria-live="polite"></div>
        </div>

        <!-- KEYBOARD SHORTCUTS -->
        <div class="shortcuts-panel">
            <h5>‚å®Ô∏è Keyboard Shortcuts</h5>
            <div class="shortcuts-list">
                <div class="shortcut-item"><span class="shortcut-key">Space</span> Play Chord</div>
                <div class="shortcut-item"><span class="shortcut-key">‚Üë/‚Üì</span> Change Octave</div>
                <div class="shortcut-item"><span class="shortcut-key">‚Üê/‚Üí</span> Change Root</div>
                <div class="shortcut-item"><span class="shortcut-key">1‚Äì9</span> Select Mode</div>
                <div class="shortcut-item"><span class="shortcut-key">R</span> Record Toggle</div>
                <div class="shortcut-item"><span class="shortcut-key">P</span> Playback</div>
            </div>
        </div>
    </div>

</div><!-- end app-container -->

<!-- ============================================================
     SITE FOOTER
     ============================================================ -->
<footer class="site-footer" role="contentinfo">
    <p>¬© 2026 Keys, Codes & Modes‚Ñ¢ | Benjamin Ryan | All Rights Reserved</p>
    <p>1187 Coast Village Rd #110 ¬∑ Santa Barbara, CA 93108</p>
    <p style="font-size:0.8rem; margin-top:8px; color:rgba(232,232,232,0.4);">
        FreeStyle¬Æ is a registered trademark. U.S. Patents. |
        <a href="privacy-policy.html">Privacy Policy</a> |
        <a href="terms.html">Terms of Service</a> |
        <a href="contact.html">Contact</a>
    </p>
</footer>

<!-- ============================================================
     JAVASCRIPT ‚Äî ALL FEATURES
     ============================================================ -->
<script>
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Global error:', {msg, url, lineNo, columnNo, error});
    return true;
};
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled rejection:', event.reason);
    event.preventDefault();
});

(function() {
    'use strict';

    try {
        // ‚îÄ‚îÄ Global state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let audioContext, audioReady = false, currentLevel = '1', currentView = 'circle', rootNote = 0;
        let selectedNotes = new Set([0]), multiSelectNotes = new Set(), currentOctave = 4;
        let currentWaveform = 'sine', currentBPM = 120, currentModeSelection = 'ionian';
        let currentTriadSelection = 'major', currentExtendedSelection = 'major7';
        let currentMinorType = 'naturalMinor', currentHarmDegree = 0, currentHarmChordType = 'triad';
        let quizCorrect = 0, quizTotal = 0, currentQuiz = null;
        let isRecording = false, recordedNotes = [], recordingStartTime = 0;
        let guitarFretCount = 5;

        // ‚îÄ‚îÄ Musical data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const noteNames      = ['C','C#/Db','D','D#/Eb','E','F','F#/Gb','G','G#/Ab','A','A#/Bb','B'];
        const noteNamesShort = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const enharmonicNames= ['C','C#\nDb','D','D#\nEb','E','F','F#\nGb','G','G#\nAb','A','A#\nBb','B'];

        const colors     = ['#FFFF00','#FFC400','#FF8000','#FF4000','#FF0000','#C4007F','#8000FF','#4000FF','#0000FF','#007FFF','#00FF80','#80FF00'];
        const textColors = ['#000','#000','#000','#fff','#fff','#fff','#fff','#fff','#fff','#fff','#000','#000'];

        const triads = { major:[0,4,7], minor:[0,3,7], diminished:[0,3,6], augmented:[0,4,8] };
        const extended = {
            major7:[0,4,7,11], dominant7:[0,4,7,10], minor7:[0,3,7,10],
            diminished7:[0,3,6,9], augmented7:[0,4,8,10], halfDiminished7:[0,3,6,10],
            minorMajor7:[0,3,7,11], augmentedMajor7:[0,4,8,11]
        };
        const scales = {
            majorPentatonic:[0,2,4,7,9], minorPentatonic:[0,3,5,7,10],
            major:[0,2,4,5,7,9,11], naturalMinor:[0,2,3,5,7,8,10],
            harmonicMinor:[0,2,3,5,7,8,11], melodicMinor:[0,2,3,5,7,9,11]
        };
        const modes = {
            ionian:[0,2,4,5,7,9,11], dorian:[0,2,3,5,7,9,10],
            phrygian:[0,1,3,5,7,8,10], lydian:[0,2,4,6,7,9,11],
            mixolydian:[0,2,4,5,7,9,10], aeolian:[0,2,3,5,7,8,10], locrian:[0,1,3,5,6,8,10]
        };

        const harmonizedMajorTriads = [
            {name:'I',quality:'Major',intervals:[0,4,7]},{name:'ii',quality:'minor',intervals:[2,5,9]},
            {name:'iii',quality:'minor',intervals:[4,7,11]},{name:'IV',quality:'Major',intervals:[5,9,12]},
            {name:'V',quality:'Major',intervals:[7,11,14]},{name:'vi',quality:'minor',intervals:[9,12,16]},
            {name:'vii¬∞',quality:'dim',intervals:[11,14,17]}
        ];
        const harmonizedMajor7ths = [
            {name:'Imaj7',quality:'Maj7',intervals:[0,4,7,11]},{name:'ii7',quality:'m7',intervals:[2,5,9,12]},
            {name:'iii7',quality:'m7',intervals:[4,7,11,14]},{name:'IVmaj7',quality:'Maj7',intervals:[5,9,12,16]},
            {name:'V7',quality:'Dom7',intervals:[7,11,14,17]},{name:'vi7',quality:'m7',intervals:[9,12,16,19]},
            {name:'vii√∏7',quality:'m7‚ô≠5',intervals:[11,14,17,21]}
        ];
        const harmonizedMinorTriads = [
            {name:'i',quality:'minor',intervals:[0,3,7]},{name:'ii¬∞',quality:'dim',intervals:[2,5,8]},
            {name:'III',quality:'Major',intervals:[3,7,10]},{name:'iv',quality:'minor',intervals:[5,8,12]},
            {name:'v',quality:'minor',intervals:[7,10,14]},{name:'VI',quality:'Major',intervals:[8,12,15]},
            {name:'VII',quality:'Major',intervals:[10,14,17]}
        ];
        const harmonizedMinor7ths = [
            {name:'im7',quality:'m7',intervals:[0,3,7,10]},{name:'ii√∏7',quality:'m7‚ô≠5',intervals:[2,5,8,12]},
            {name:'IIImaj7',quality:'Maj7',intervals:[3,7,10,14]},{name:'ivm7',quality:'m7',intervals:[5,8,12,15]},
            {name:'vm7',quality:'m7',intervals:[7,10,14,17]},{name:'VImaj7',quality:'Maj7',intervals:[8,12,15,19]},
            {name:'VII7',quality:'Dom7',intervals:[10,14,17,20]}
        ];

        const intervalNames = {
            0:'Unison (P1)',1:'Minor 2nd (m2)',2:'Major 2nd (M2)',3:'Minor 3rd (m3)',
            4:'Major 3rd (M3)',5:'Perfect 4th (P4)',6:'Tritone (TT/A4/d5)',7:'Perfect 5th (P5)',
            8:'Minor 6th (m6)',9:'Major 6th (M6)',10:'Minor 7th (m7)',11:'Major 7th (M7)'
        };
        const intervalDescriptions = {
            0:'Same note ‚Äî No interval',1:'Half step ‚Äî Very dissonant, creates tension',
            2:'Whole step ‚Äî Common in melodies, slightly tense',3:'Sad, melancholic sound ‚Äî Minor chord base',
            4:'Happy, bright sound ‚Äî Major chord base',5:'Very consonant ‚Äî Strong, stable sound',
            6:'Most dissonant ‚Äî Divides octave in half',7:'Most consonant after octave ‚Äî Power chord',
            8:'Somewhat dissonant ‚Äî Inverted Major 3rd',9:'Smooth, pleasant ‚Äî Common in melodies',
            10:'Bluesy, jazzy ‚Äî Dominant 7th chord',11:'Dissonant, leading ‚Äî Major 7th chord'
        };
        const keySignatures = {
            0:{sharps:0,flats:0,name:'C major'},1:{sharps:0,flats:5,name:'Db major'},
            2:{sharps:2,flats:0,name:'D major'},3:{sharps:0,flats:3,name:'Eb major'},
            4:{sharps:4,flats:0,name:'E major'},5:{sharps:0,flats:1,name:'F major'},
            6:{sharps:6,flats:0,name:'F# major'},7:{sharps:1,flats:0,name:'G major'},
            8:{sharps:0,flats:4,name:'Ab major'},9:{sharps:3,flats:0,name:'A major'},
            10:{sharps:0,flats:2,name:'Bb major'},11:{sharps:5,flats:0,name:'B major'}
        };

        window.playSelection = playSelection;
        window.playNote = playNote;

        // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function init() {
            try {
                window.currentPatternIntervals = [];
                createSpheres();
                createPiano();
                createGuitar();
                updateDisplay();
                updateView();
                updateOctaveDisplay();
                setupEventListeners();
                setupKeyboardShortcuts();
                initMIDI();
                setTimeout(() => updateStaffNotation(Array.from(selectedNotes)), 100);
            } catch(e) { console.error('Init error:', e); }
        }

        // ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setupEventListeners() {
            try {
                const startBtn = document.getElementById('startAudio');
                if (startBtn) startBtn.onclick = initAudio;

                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.onclick = function() {
                        document.querySelector('.view-btn.active').classList.remove('active');
                        this.classList.add('active');
                        currentView = this.dataset.view;
                        updateView();
                        try { trackEvent('view_change', {view: currentView}); } catch(e) {}
                    };
                });

                document.querySelectorAll('.level-btn[data-level]').forEach(btn => {
                    btn.onclick = function() {
                        document.querySelector('.level-btn.active')?.classList.remove('active');
                        this.classList.add('active');
                        currentLevel = this.dataset.level;
                        const freeplayHint = document.getElementById('freeplayHint');
                        if (freeplayHint) freeplayHint.style.display = currentLevel === 'freeplay' ? 'block' : 'none';
                        const progressionControls = document.getElementById('progressionControls');
                        if ((currentLevel === 'harmMajor' || currentLevel === 'harmMinor') && currentView !== 'ear') {
                            progressionControls.style.display = 'block';
                            updateProgressionButtons();
                            const keySpan = document.getElementById('progressionKey');
                            const typeSpan = document.getElementById('progressionChordType');
                            const scaleSpan = document.getElementById('progressionScaleType');
                            if (keySpan) keySpan.textContent = noteNames[rootNote];
                            if (typeSpan) typeSpan.textContent = currentHarmChordType === '7th' ? 'Seventh Chords (4-note)' : 'Triads (3-note)';
                            if (scaleSpan) scaleSpan.textContent = currentLevel === 'harmMinor' ? 'Natural Minor' : 'Major';
                        } else {
                            progressionControls.style.display = 'none';
                        }
                        if (currentLevel === 'freeplay') {
                            multiSelectNotes.clear(); selectedNotes = new Set(); window.currentPatternIntervals = [];
                        } else if (currentLevel === '2') {
                            selectedNotes = new Set([0, 7]); window.currentPatternIntervals = [0, 7];
                        } else if (currentLevel === 'harmMajor' || currentLevel === 'harmMinor') {
                            currentHarmDegree = 0; currentHarmChordType = 'triad';
                        }
                        updateDisplay(); updateView();
                        try { trackEvent('level_change', {level: currentLevel}); } catch(e) {}
                    };
                });

                const el = (id) => document.getElementById(id);
                if (el('playUpBtn')) el('playUpBtn').onclick = () => playSelection('up');
                if (el('playDownBtn')) el('playDownBtn').onclick = () => playSelection('down');
                if (el('playScaleBtn')) el('playScaleBtn').onclick = () => playSelection('scale');
                if (el('playChordBtn')) el('playChordBtn').onclick = () => playSelection('chord');
                if (el('octaveDown')) el('octaveDown').onclick = () => { if (currentOctave > 0) { currentOctave--; updateOctaveDisplay(); }};
                if (el('octaveUp')) el('octaveUp').onclick = () => { if (currentOctave < 8) { currentOctave++; updateOctaveDisplay(); }};
                if (el('playQuizBtn')) el('playQuizBtn').onclick = playQuizSound;
                if (el('newQuizBtn')) el('newQuizBtn').onclick = generateQuiz;
                if (el('recordBtn')) el('recordBtn').onclick = startRecording;
                if (el('playRecBtn')) el('playRecBtn').onclick = playbackRecording;
                if (el('clearRecBtn')) el('clearRecBtn').onclick = () => { recordedNotes = []; const s = el('recordingStatus'); if (s) s.textContent = 'üóë Recording cleared'; };
                if (el('downloadRecBtn')) el('downloadRecBtn').onclick = downloadMIDI;
                const tempoSlider = el('tempoSlider');
                if (tempoSlider) tempoSlider.oninput = function() { currentBPM = parseInt(this.value); const d = el('bpmDisplay'); if (d) d.textContent = currentBPM; };
                if (el('fret5Btn')) el('fret5Btn').onclick = () => { guitarFretCount = 5; el('fret5Btn').classList.add('active'); el('fret12Btn').classList.remove('active'); createGuitar(); setTimeout(() => { updateSphereDisplay(); updateStringLabels(); }, 50); };
                if (el('fret12Btn')) el('fret12Btn').onclick = () => { guitarFretCount = 12; el('fret12Btn').classList.add('active'); el('fret5Btn').classList.remove('active'); createGuitar(); setTimeout(() => { updateSphereDisplay(); updateStringLabels(); }, 50); };
                setTimeout(() => { const playAllBtn = el('playAllChordsBtn'); if (playAllBtn) playAllBtn.onclick = playAllScaleChords; }, 100);
            } catch(e) { console.error('Event listeners error:', e); }
        }

        // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (!audioReady) return;
                try {
                    switch(e.key) {
                        case ' ': e.preventDefault(); playSelection('chord'); break;
                        case 'ArrowUp': e.preventDefault(); if (currentOctave < 8) { currentOctave++; updateOctaveDisplay(); } break;
                        case 'ArrowDown': e.preventDefault(); if (currentOctave > 0) { currentOctave--; updateOctaveDisplay(); } break;
                        case 'ArrowLeft': e.preventDefault(); rootNote = (rootNote - 1 + 12) % 12; updateDisplay(); break;
                        case 'ArrowRight': e.preventDefault(); rootNote = (rootNote + 1) % 12; updateDisplay(); break;
                        case 'r': case 'R': startRecording(); break;
                        case 'p': case 'P': playbackRecording(); break;
                    }
                    if (e.key >= '1' && e.key <= '9') {
                        const levels = ['1','2','3','4','5','7','minor','modes','harmMajor'];
                        const lIdx = parseInt(e.key) - 1;
                        if (lIdx < levels.length) {
                            document.querySelectorAll('.level-btn[data-level]').forEach(btn => {
                                if (btn.dataset.level === levels[lIdx]) btn.click();
                            });
                        }
                    }
                } catch(e) { console.error('Keyboard shortcut error:', e); }
            });
        }

        // ‚îÄ‚îÄ Audio init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initAudio() {
            try {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.resume().then(() => {
                    audioReady = true;
                    const btn = document.getElementById('startAudio');
                    if (btn) {
                        btn.textContent = '‚úì AUDIO READY';
                        btn.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                        btn.style.boxShadow = '0 6px 25px rgba(39,174,96,0.6)';
                        btn.disabled = true;
                    }
                    const status = document.getElementById('status');
                    if (status) status.textContent = '‚ú® Ready! Click notes or use controls';
                    setTimeout(() => playNote(0, 4, 0.3), 100);
                    try { trackEvent('audio_started', {}); } catch(e) {}
                });
            } catch(e) { console.error('Audio init error:', e); }
        }

        // ‚îÄ‚îÄ MIDI init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initMIDI() {
            try {
                if (navigator.requestMIDIAccess) {
                    navigator.requestMIDIAccess().then(access => {
                        for (let input of access.inputs.values()) {
                            input.onmidimessage = e => {
                                try {
                                    const [status, note, vel] = e.data;
                                    const cmd = status >> 4;
                                    if (cmd === 9 && vel > 0) { const n = note % 12, oct = Math.floor(note / 12) - 1; playNote(n, oct, 0.5); highlightNote(n, true); }
                                    else if (cmd === 8 || (cmd === 9 && vel === 0)) { highlightNote(note % 12, false); }
                                } catch(e) { console.error('MIDI msg error:', e); }
                            };
                        }
                    }).catch(e => console.log('MIDI not available:', e));
                }
            } catch(e) { console.error('MIDI init error:', e); }
        }

        // ‚îÄ‚îÄ Create spheres ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function createSpheres() {
            const circle = document.getElementById('chromaticCircle');
            if (!circle) return;
            const enharmonicLabels = ['C','C‚ôØ\nD‚ô≠','D','D‚ôØ\nE‚ô≠','E','F','F‚ôØ\nG‚ô≠','G','G‚ôØ\nA‚ô≠','A','A‚ôØ\nB‚ô≠','B'];
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30 - 90) * (Math.PI / 180);
                const radius = circle.offsetWidth > 340 ? 185 : 125;
                const cx = (circle.offsetWidth || 500) / 2;
                const x = cx + radius * Math.cos(angle);
                const y = cx + radius * Math.sin(angle);
                const s = document.createElement('div');
                s.className = 'sphere';
                s.style.left = (x - 35) + 'px';
                s.style.top  = (y - 35) + 'px';
                s.style.background = colors[i];
                s.style.color = textColors[i];
                s.style.fontSize = enharmonicLabels[i].includes('\n') ? '13px' : '16px';
                s.style.lineHeight = '1.2';
                s.style.whiteSpace = 'pre-line';
                s.style.textAlign = 'center';
                s.textContent = enharmonicLabels[i];
                s.dataset.note = i;
                s.setAttribute('role', 'button');
                s.setAttribute('tabindex', '0');
                s.setAttribute('aria-label', `Note ${noteNames[i]}`);
                s.onclick = () => handleNoteClick(i);
                s.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleNoteClick(i); }};
                circle.appendChild(s);
            }
        }

        // ‚îÄ‚îÄ Create piano ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function createPiano() {
            const container = document.getElementById('pianoContainer');
            if (!container) return;
            container.innerHTML = '';
            const whiteNotes = [0,2,4,5,7,9,11];
            const blackNotes = [{note:1,after:0},{note:3,after:2},{note:6,after:5},{note:8,after:7},{note:10,after:9}];
            whiteNotes.forEach((n) => {
                const k = document.createElement('div');
                k.className = 'white-key'; k.dataset.note = n;
                k.setAttribute('role','button'); k.setAttribute('tabindex','0');
                k.setAttribute('aria-label', `Piano key ${noteNames[n]}`);
                k.onclick = () => handleNoteClick(n);
                const l = document.createElement('div');
                l.className = 'key-label'; l.textContent = noteNamesShort[n]; l.style.color = '#333';
                k.appendChild(l); container.appendChild(k);
            });
            blackNotes.forEach(({note, after}) => {
                const k = document.createElement('div');
                k.className = 'black-key'; k.dataset.note = note;
                const afterIdx = whiteNotes.indexOf(after);
                k.style.left = ((afterIdx * 50) + 50 - 16) + 'px';
                k.setAttribute('role','button'); k.setAttribute('tabindex','0');
                k.setAttribute('aria-label', `Piano key ${noteNames[note]}`);
                k.onclick = () => handleNoteClick(note);
                const l = document.createElement('div');
                l.className = 'key-label'; l.textContent = enharmonicNames[note];
                k.appendChild(l); container.appendChild(k);
            });
        }

        // ‚îÄ‚îÄ Create guitar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function createGuitar() {
            const fb = document.getElementById('fretboard');
            if (!fb) return;
            fb.innerHTML = '';
            const tuning = [4,9,2,7,11,4];
            const names  = ['E','A','D','G','B','E'];
            const octs   = [3,3,4,4,4,5];
            const fretHeight = guitarFretCount === 12 ? 50 : 80;
            const totalHeight = guitarFretCount * fretHeight;
            fb.style.height = totalHeight + 'px'; fb.style.width = '180px';
            for (let s = 0; s < 6; s++) {
                const str = document.createElement('div');
                str.className = 'guitar-string';
                str.style.left = (30 * s + 15) + 'px';
                str.style.width = (s >= 4 ? '1px' : s >= 2 ? '2px' : '3px');
                str.style.height = '100%';
                fb.appendChild(str);
                const lbl = document.createElement('div');
                lbl.className = 'string-label'; lbl.textContent = names[s];
                lbl.style.left = (30 * s - 5) + 'px'; lbl.dataset.note = tuning[s];
                lbl.onclick = () => playNote(tuning[s], octs[s], 0.8);
                fb.appendChild(lbl);
            }
            for (let f = 1; f <= guitarFretCount; f++) {
                const fw = document.createElement('div');
                fw.className = 'fret-wire'; fw.style.top = (f * fretHeight) + 'px';
                fb.appendChild(fw);
            }
            const markerFrets = guitarFretCount === 12 ? [3,5,7,9,12] : [3,5];
            markerFrets.forEach(fret => {
                if (fret > guitarFretCount) return;
                if (fret === 12) {
                    [1.5,4.5].forEach(sp => {
                        const m = document.createElement('div');
                        m.style.cssText = `position:absolute;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.3);left:${30*sp}px;top:${fret*fretHeight-fretHeight/2}px;transform:translate(-4px,-4px);pointer-events:none;`;
                        fb.appendChild(m);
                    });
                } else {
                    const m = document.createElement('div');
                    m.style.cssText = `position:absolute;width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.3);left:90px;top:${fret*fretHeight-fretHeight/2}px;transform:translate(-5px,-5px);pointer-events:none;`;
                    fb.appendChild(m);
                }
            });
            for (let s = 0; s < 6; s++) {
                for (let f = 1; f <= guitarFretCount; f++) {
                    const n = (tuning[s] + f) % 12;
                    const dot = document.createElement('div');
                    dot.className = 'note-dot';
                    dot.style.left = (30 * s + 15) + 'px';
                    dot.style.top  = (f * fretHeight - fretHeight / 2) + 'px';
                    dot.style.background = colors[n]; dot.style.color = textColors[n];
                    dot.textContent = noteNamesShort[n];
                    dot.onclick = () => playNote(n, octs[s] + Math.floor((tuning[s] + f) / 12), 0.8);
                    fb.appendChild(dot);
                }
            }
            updateStringLabels();
        }

        // ‚îÄ‚îÄ Note click handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function handleNoteClick(noteIndex) {
            try {
                if (!audioReady) { alert('Please click START AUDIO ENGINE first!'); return; }
                if (typeof noteIndex !== 'number' || noteIndex < 0 || noteIndex > 11) return;

                if (currentLevel === 'freeplay') {
                    if (multiSelectNotes.has(noteIndex)) multiSelectNotes.delete(noteIndex);
                    else multiSelectNotes.add(noteIndex);
                    selectedNotes = new Set(multiSelectNotes);
                    window.currentPatternIntervals = [];
                    playNote(noteIndex); updateDisplay();
                } else if (currentLevel === '2') {
                    if (selectedNotes.size === 0 || selectedNotes.size === 2) {
                        rootNote = noteIndex; selectedNotes = new Set([noteIndex]);
                        window.currentPatternIntervals = [0]; playNote(noteIndex); updateDisplay();
                    } else if (selectedNotes.size === 1) {
                        selectedNotes.add(noteIndex);
                        const notes = Array.from(selectedNotes).sort((a,b)=>a-b);
                        const interval = (notes[1] - notes[0] + 12) % 12;
                        window.currentPatternIntervals = [0, interval];
                        updateDisplay();
                        playNote(notes[0], currentOctave, 0.8);
                        setTimeout(() => { playNote(notes[1], currentOctave, 0.8); setTimeout(() => showIntervalInfo(interval), 500); }, 600);
                    }
                } else {
                    rootNote = noteIndex; playNote(noteIndex); updateDisplay();
                }
            } catch(e) { console.error('Note click error:', e); }
        }

        // ‚îÄ‚îÄ Play note ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function playNote(n, oct = currentOctave, dur = 0.8) {
            try {
                if (!audioContext || !audioReady) return;
                const freqs = [261.63,277.18,293.66,311.13,329.63,349.23,369.99,392.00,415.30,440.00,466.16,493.88];
                const freq = freqs[n] * Math.pow(2, oct - 4);
                if (isRecording) recordedNotes.push({note:n, octave:oct, timestamp:Date.now()-recordingStartTime, duration:dur});
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain); gain.connect(audioContext.destination);
                osc.frequency.value = freq; osc.type = currentWaveform;
                const now = audioContext.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
                osc.start(now); osc.stop(now + dur);
                highlightNote(n, true);
                updateStaffNotation([n]);
                setTimeout(() => { highlightNote(n, false); updateStaffNotation(Array.from(selectedNotes)); }, dur * 1000);
            } catch(e) { console.error('Play note error:', e); }
        }

        // ‚îÄ‚îÄ Highlight note ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function highlightNote(n, on) {
            try {
                const sphere     = document.querySelector(`.sphere[data-note="${n}"]`);
                const whiteKey   = document.querySelector(`.white-key[data-note="${n}"]`);
                const blackKey   = document.querySelector(`.black-key[data-note="${n}"]`);
                const guitarDots = document.querySelectorAll('.note-dot');
                const stringLabels = document.querySelectorAll(`.string-label[data-note="${n}"]`);

                if (on) {
                    if (sphere) { sphere.classList.add('playing'); sphere.style.borderColor='#fff'; sphere.style.borderWidth='5px'; sphere.style.boxShadow=`0 0 35px ${colors[n]}, 0 0 60px ${colors[n]}`; }
                    if (whiteKey) { whiteKey.classList.add('playing'); whiteKey.style.background=colors[n]; whiteKey.style.boxShadow=`0 0 20px ${colors[n]}, inset 0 4px 8px rgba(0,0,0,0.3)`; }
                    if (blackKey) { blackKey.classList.add('playing'); blackKey.style.background=colors[n]; blackKey.style.boxShadow=`0 0 20px ${colors[n]}, inset 0 4px 8px rgba(0,0,0,0.7)`; }
                    guitarDots.forEach(dot => {
                        if (dot.textContent.trim() === noteNamesShort[n]) {
                            dot.classList.add('playing'); dot.style.borderColor='#fff'; dot.style.borderWidth='4px';
                            dot.style.boxShadow=`0 0 25px ${colors[n]}, 0 0 40px ${colors[n]}`; dot.style.transform='translate(-15px,-15px) scale(1.5)';
                        }
                    });
                    stringLabels.forEach(l => { l.style.color=colors[n]; l.style.textShadow=`0 0 20px ${colors[n]}, 2px 2px 4px rgba(0,0,0,0.8)`; l.style.transform='scale(1.5)'; });
                } else {
                    if (sphere) { sphere.classList.remove('playing'); sphere.style.borderColor=''; sphere.style.borderWidth=''; sphere.style.boxShadow=''; }
                    if (whiteKey) { whiteKey.classList.remove('playing'); whiteKey.style.background=''; whiteKey.style.boxShadow=''; }
                    if (blackKey) { blackKey.classList.remove('playing'); blackKey.style.background=''; blackKey.style.boxShadow=''; }
                    guitarDots.forEach(dot => { dot.classList.remove('playing'); dot.style.borderColor=''; dot.style.borderWidth=''; dot.style.boxShadow=''; dot.style.transform=''; });
                    stringLabels.forEach(l => { l.style.color=''; l.style.textShadow=''; l.style.transform=''; });
                }
            } catch(e) { console.error('Highlight note error:', e); }
        }

        // ‚îÄ‚îÄ Play selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function playSelection(mode) {
            try {
                if (!audioReady) { alert('Click START AUDIO ENGINE first!'); return; }
                let notes = Array.from(selectedNotes).sort((a,b)=>a-b);
                if (notes.length === 0) { alert('No notes selected! Click some notes first.'); return; }
                const beatDuration = 60000 / currentBPM;

                if (mode === 'chord') {
                    playChordNotes(notes, 1.5);
                } else if (mode === 'up' || mode === 'scale') {
                    const orderedNotes = [];
                    const rootIndex = notes.indexOf(rootNote);
                    if (rootIndex !== -1) {
                        for (let i = rootIndex; i < notes.length; i++) orderedNotes.push({note:notes[i], octave:currentOctave});
                        for (let i = 0; i < rootIndex; i++) orderedNotes.push({note:notes[i], octave:currentOctave+1});
                    } else { notes.forEach(n => orderedNotes.push({note:n, octave:currentOctave})); }
                    orderedNotes.forEach(({note, octave}, i) => { setTimeout(() => { playNote(note, octave, 0.6); highlightStaffNote(note, i); }, i * beatDuration); });
                    if (mode === 'scale') {
                        const reversed = [...orderedNotes].reverse();
                        reversed.forEach(({note, octave}, i) => { setTimeout(() => { playNote(note, octave, 0.6); }, (orderedNotes.length + i) * beatDuration); });
                    }
                    const total = mode === 'scale' ? orderedNotes.length * 2 : orderedNotes.length;
                    setTimeout(() => clearStaffHighlights(), (total * beatDuration) + 200);
                } else if (mode === 'down') {
                    const orderedNotes = [];
                    const rootIndex = notes.indexOf(rootNote);
                    if (rootIndex !== -1) {
                        for (let i = 0; i < rootIndex; i++) orderedNotes.push({note:notes[i], octave:currentOctave+1});
                        for (let i = rootIndex; i < notes.length; i++) orderedNotes.push({note:notes[i], octave:currentOctave});
                    } else { notes.forEach(n => orderedNotes.push({note:n, octave:currentOctave})); }
                    const reversed = [...orderedNotes].reverse();
                    reversed.forEach(({note, octave}, i) => { setTimeout(() => { playNote(note, octave, 0.6); }, i * beatDuration); });
                    setTimeout(() => clearStaffHighlights(), (reversed.length * beatDuration) + 200);
                }
            } catch(e) { console.error('Play selection error:', e); }
        }

        // ‚îÄ‚îÄ Play chord notes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function playChordNotes(chordNotes, duration) {
            try {
                if (!audioContext || !audioReady) return;
                let octaveOffset = 0;
                const notesToPlay = [];
                chordNotes.forEach((note, i) => {
                    if (i > 0 && note < chordNotes[i-1]) octaveOffset++;
                    notesToPlay.push({note, octave: currentOctave + octaveOffset});
                });
                updateStaffNotation(chordNotes);
                notesToPlay.forEach(({note}) => highlightNote(note, true));
                const now = audioContext.currentTime;
                const freqs = [261.63,277.18,293.66,311.13,329.63,349.23,369.99,392.00,415.30,440.00,466.16,493.88];
                notesToPlay.forEach(({note, octave}) => {
                    const freq = freqs[note] * Math.pow(2, octave - 4);
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain); gain.connect(audioContext.destination);
                    osc.frequency.value = freq; osc.type = currentWaveform;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.25, now + 0.015);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
                    osc.start(now); osc.stop(now + duration);
                });
                setTimeout(() => { notesToPlay.forEach(({note}) => highlightNote(note, false)); updateStaffNotation(Array.from(selectedNotes)); }, duration * 1000);
            } catch(e) { console.error('Play chord error:', e); }
        }

        // ‚îÄ‚îÄ Staff notation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function highlightStaffNote(noteValue, position) {
            try {
                const svg = document.getElementById('staffSVG');
                if (!svg) return;
                const noteHeads = svg.querySelectorAll('ellipse');
                if (position < 0 || position >= noteHeads.length) return;
                const nh = noteHeads[position];
                if (!nh) return;
                nh.setAttribute('stroke','#F4D03F'); nh.setAttribute('stroke-width','4');
                let defs = svg.querySelector('defs');
                if (!defs) {
                    defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
                    const filter = document.createElementNS('http://www.w3.org/2000/svg','filter');
                    filter.setAttribute('id','glow'); filter.setAttribute('x','-50%'); filter.setAttribute('y','-50%'); filter.setAttribute('width','200%'); filter.setAttribute('height','200%');
                    const fgb = document.createElementNS('http://www.w3.org/2000/svg','feGaussianBlur');
                    fgb.setAttribute('stdDeviation','3'); fgb.setAttribute('result','coloredBlur');
                    const fm = document.createElementNS('http://www.w3.org/2000/svg','feMerge');
                    const fn1 = document.createElementNS('http://www.w3.org/2000/svg','feMergeNode'); fn1.setAttribute('in','coloredBlur');
                    const fn2 = document.createElementNS('http://www.w3.org/2000/svg','feMergeNode'); fn2.setAttribute('in','SourceGraphic');
                    fm.appendChild(fn1); fm.appendChild(fn2); filter.appendChild(fgb); filter.appendChild(fm); defs.appendChild(filter); svg.insertBefore(defs, svg.firstChild);
                }
                nh.setAttribute('filter','url(#glow)');
            } catch(e) { console.error('Highlight staff note error:', e); }
        }

        function clearStaffHighlights() {
            try {
                const svg = document.getElementById('staffSVG');
                if (!svg) return;
                svg.querySelectorAll('ellipse').forEach(nh => { nh.setAttribute('stroke','#000'); nh.setAttribute('stroke-width','1'); nh.removeAttribute('filter'); });
            } catch(e) {}
        }

        function updateStaffNotation(notes) {
            try {
                const svg = document.getElementById('staffSVG');
                if (!svg) return;
                svg.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
                    line.setAttribute('x1','15'); line.setAttribute('y1',20+i*10); line.setAttribute('x2','205'); line.setAttribute('y2',20+i*10);
                    line.setAttribute('stroke','#000'); line.setAttribute('stroke-width','1.2'); svg.appendChild(line);
                }
                const clef = document.createElementNS('http://www.w3.org/2000/svg','text');
                clef.setAttribute('x','18'); clef.setAttribute('y','50'); clef.setAttribute('font-size','40'); clef.setAttribute('font-family','serif');
                clef.textContent = 'ùÑû'; clef.setAttribute('fill','#000'); svg.appendChild(clef);

                const keySig = keySignatures[rootNote];
                let sigX = 48;
                if (keySig.sharps > 0) {
                    const sharpPos = [20,35,15,50,25,60,40];
                    for (let i = 0; i < keySig.sharps; i++) {
                        const sharp = document.createElementNS('http://www.w3.org/2000/svg','text');
                        sharp.setAttribute('x',sigX); sharp.setAttribute('y',sharpPos[i]); sharp.setAttribute('font-size','22'); sharp.setAttribute('font-weight','bold'); sharp.setAttribute('font-family','serif');
                        sharp.textContent = '‚ôØ'; sharp.setAttribute('fill','#000'); svg.appendChild(sharp);
                        if (i === 2) { const led = document.createElementNS('http://www.w3.org/2000/svg','line'); led.setAttribute('x1',sigX-5); led.setAttribute('y1','15'); led.setAttribute('x2',sigX+10); led.setAttribute('y2','15'); led.setAttribute('stroke','#000'); led.setAttribute('stroke-width','1'); svg.appendChild(led); }
                        sigX += 10;
                    }
                } else if (keySig.flats > 0) {
                    const flatPos = [40,55,45,50,30,35,25];
                    for (let i = 0; i < keySig.flats; i++) {
                        const flat = document.createElementNS('http://www.w3.org/2000/svg','text');
                        flat.setAttribute('x',sigX); flat.setAttribute('y',flatPos[i]); flat.setAttribute('font-size','22'); flat.setAttribute('font-weight','bold'); flat.setAttribute('font-family','serif');
                        flat.textContent = '‚ô≠'; flat.setAttribute('fill','#000'); svg.appendChild(flat); sigX += 10;
                    }
                }

                const pos = {0:70,1:68,2:65,3:62,4:60,5:55,6:52,7:50,8:47,9:45,10:42,11:40};
                const sortedNotes = Array.from(new Set(notes)).sort((a,b)=>a-b);
                if (sortedNotes.length === 0) return;
                let x = Math.max(70, sigX + 12);
                const noteSpacing = Math.min(22, 140 / (sortedNotes.length || 1));

                sortedNotes.forEach(n => {
                    const y = pos[n];
                    if (y === 70) {
                        const led = document.createElementNS('http://www.w3.org/2000/svg','line');
                        led.setAttribute('x1',x-8); led.setAttribute('y1','70'); led.setAttribute('x2',x+8); led.setAttribute('y2','70');
                        led.setAttribute('stroke','#000'); led.setAttribute('stroke-width','1.2'); svg.appendChild(led);
                    }
                    const nh = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
                    nh.setAttribute('cx',x); nh.setAttribute('cy',y); nh.setAttribute('rx','6'); nh.setAttribute('ry','5');
                    nh.setAttribute('fill',colors[n]); nh.setAttribute('stroke','#000'); nh.setAttribute('stroke-width','1'); svg.appendChild(nh);
                    const stem = document.createElementNS('http://www.w3.org/2000/svg','line');
                    if (y > 42) { stem.setAttribute('x1',x+5.5); stem.setAttribute('y1',y); stem.setAttribute('x2',x+5.5); stem.setAttribute('y2',y-28); }
                    else { stem.setAttribute('x1',x-5.5); stem.setAttribute('y1',y); stem.setAttribute('x2',x-5.5); stem.setAttribute('y2',y+28); }
                    stem.setAttribute('stroke','#000'); stem.setAttribute('stroke-width','1.8'); svg.appendChild(stem);
                    const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
                    lbl.setAttribute('x',x); lbl.setAttribute('y','85'); lbl.setAttribute('font-size','10'); lbl.setAttribute('font-weight','bold');
                    lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('fill','#000'); lbl.textContent = noteNamesShort[n]; svg.appendChild(lbl);
                    x += noteSpacing;
                });

                if (sortedNotes.length >= 1) {
                    const tbg = document.createElementNS('http://www.w3.org/2000/svg','rect');
                    tbg.setAttribute('x','50'); tbg.setAttribute('y','100'); tbg.setAttribute('width','120'); tbg.setAttribute('height','28');
                    tbg.setAttribute('fill','rgba(0,128,128,0.15)'); tbg.setAttribute('rx','3'); svg.appendChild(tbg);
                    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
                    title.setAttribute('x','110'); title.setAttribute('y','113'); title.setAttribute('font-size','11'); title.setAttribute('font-weight','bold');
                    title.setAttribute('text-anchor','middle'); title.setAttribute('fill','#2c3e50');
                    let titleText = '';
                    if (currentLevel === '1') titleText = noteNames[rootNote];
                    else if (currentLevel === '2' && sortedNotes.length === 2) { const int = (sortedNotes[1]-sortedNotes[0]+12)%12; titleText = intervalNames[int]; }
                    else if (currentLevel === '3') titleText = `${noteNames[rootNote]} ${currentTriadSelection}`;
                    else if (currentLevel === '4') titleText = `${noteNames[rootNote]} ${currentExtendedSelection}`;
                    else if (currentLevel === '5') titleText = `${noteNames[rootNote]} Pentatonic`;
                    else if (currentLevel === '7') titleText = `${noteNames[rootNote]} Major`;
                    else if (currentLevel === 'minor') titleText = `${noteNames[rootNote]} ${currentMinorType}`;
                    else if (currentLevel === 'modes') titleText = `${noteNames[rootNote]} ${currentModeSelection}`;
                    else if (currentLevel === 'harmMajor') { const cd = currentHarmChordType==='7th'?harmonizedMajor7ths[currentHarmDegree]:harmonizedMajorTriads[currentHarmDegree]; titleText = `${cd.name} ${cd.quality}`; }
                    else if (currentLevel === 'harmMinor') { const cd = currentHarmChordType==='7th'?harmonizedMinor7ths[currentHarmDegree]:harmonizedMinorTriads[currentHarmDegree]; titleText = `${cd.name} ${cd.quality}`; }
                    else if (currentLevel === 'freeplay') titleText = 'Free Play';
                    title.textContent = titleText; svg.appendChild(title);
                    const keyInfo = document.createElementNS('http://www.w3.org/2000/svg','text');
                    keyInfo.setAttribute('x','110'); keyInfo.setAttribute('y','123'); keyInfo.setAttribute('font-size','8');
                    keyInfo.setAttribute('text-anchor','middle'); keyInfo.setAttribute('fill','#555');
                    keyInfo.textContent = `Key: ${keySig.name}`; svg.appendChild(keyInfo);
                }
            } catch(e) { console.error('Staff notation error:', e); }
        }

        // ‚îÄ‚îÄ Ear training ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generateQuiz() {
            try {
                const int = Math.floor(Math.random() * 12);
                currentQuiz = {type:'interval', correct:int, notes:[0, int]};
                const qEl = document.getElementById('quizQuestion');
                if (qEl) qEl.textContent = 'What interval do you hear?';
                const opts = document.getElementById('quizOptions');
                if (!opts) return;
                opts.innerHTML = '';
                const allIntervals = [0,1,2,3,4,5,6,7,8,9,10,11].sort(() => Math.random() - 0.5);
                const options = allIntervals.slice(0, 4);
                if (!options.includes(int)) options[Math.floor(Math.random()*4)] = int;
                options.forEach(i => {
                    const btn = document.createElement('button');
                    btn.className = 'quiz-btn'; btn.textContent = intervalNames[i];
                    btn.onclick = () => checkAnswer(i); opts.appendChild(btn);
                });
                playQuizSound();
                try { trackEvent('quiz_question', {}); } catch(e) {}
            } catch(e) { console.error('Generate quiz error:', e); }
        }

        function playQuizSound() {
            if (!currentQuiz || !audioReady) return;
            currentQuiz.notes.forEach((n, i) => setTimeout(() => playNote(n, 4, 0.8), i * 600));
        }

        function checkAnswer(ans) {
            try {
                if (!currentQuiz) return;
                const btns = document.querySelectorAll('.quiz-btn');
                quizTotal++;
                if (ans === currentQuiz.correct) { quizCorrect++; btns.forEach(btn => { if (btn.textContent === intervalNames[ans]) btn.classList.add('correct'); }); }
                else { btns.forEach(btn => { if (btn.textContent === intervalNames[ans]) btn.classList.add('incorrect'); if (btn.textContent === intervalNames[currentQuiz.correct]) btn.classList.add('correct'); }); }
                const scoreEl = document.getElementById('quizScore');
                if (scoreEl) scoreEl.textContent = `Score: ${quizCorrect}/${quizTotal} (${Math.round(quizCorrect/quizTotal*100)}%)`;
                try { trackEvent('quiz_answer', {correct: ans === currentQuiz.correct}); } catch(e) {}
                setTimeout(() => generateQuiz(), 2000);
            } catch(e) { console.error('Check answer error:', e); }
        }

        // ‚îÄ‚îÄ Recording ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function startRecording() {
            try {
                if (!audioReady) { alert('Click START AUDIO ENGINE first!'); return; }
                const btn = document.getElementById('recordBtn');
                const status = document.getElementById('recordingStatus');
                if (!isRecording) {
                    isRecording = true; recordedNotes = []; recordingStartTime = Date.now();
                    if (btn) { btn.textContent = '‚èπ Stop'; btn.classList.add('recording'); btn.setAttribute('aria-pressed','true'); }
                    if (status) status.textContent = '‚è∫ Recording...';
                } else {
                    isRecording = false;
                    if (btn) { btn.textContent = '‚è∫ Record'; btn.classList.remove('recording'); btn.setAttribute('aria-pressed','false'); }
                    if (status) status.textContent = `‚úì Recorded ${recordedNotes.length} notes`;
                }
            } catch(e) { console.error('Recording error:', e); }
        }

        function playbackRecording() {
            try {
                if (!audioReady || recordedNotes.length === 0) { alert('No recording to play!'); return; }
                const status = document.getElementById('recordingStatus');
                if (status) status.textContent = '‚ñ∂ Playing...';
                recordedNotes.forEach(d => setTimeout(() => playNote(d.note, d.octave, d.duration), d.timestamp));
                const last = recordedNotes[recordedNotes.length - 1];
                setTimeout(() => { if (status) status.textContent = `‚úì ${recordedNotes.length} notes recorded`; }, last.timestamp + 1000);
            } catch(e) { console.error('Playback error:', e); }
        }

        function downloadMIDI() {
            try {
                if (recordedNotes.length === 0) { alert('No recording to download!'); return; }
                const midiData = {
                    tracks: [{name:'Keys Codes Modes Recording', notes: recordedNotes.map(n => ({pitch: n.note+(n.octave*12), time: n.timestamp/1000, duration: n.duration, velocity: 80}))}],
                    tempo: currentBPM
                };
                const blob = new Blob([JSON.stringify(midiData, null, 2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `kcm_recording_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
                a.click(); URL.revokeObjectURL(url);
                const status = document.getElementById('recordingStatus');
                if (status) status.textContent = 'üíæ Downloaded as JSON';
            } catch(e) { console.error('Download error:', e); }
        }

        // ‚îÄ‚îÄ Interval popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showIntervalInfo(interval) {
            try {
                if (typeof interval !== 'number' || interval < 0 || interval > 11) return;
                let popup = document.getElementById('intervalPopup');
                if (!popup) {
                    popup = document.createElement('div'); popup.id = 'intervalPopup';
                    popup.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a2e 0%,#0a0a15 100%);color:var(--light-text);padding:2rem 2.5rem;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.7);z-index:10000;text-align:center;border:3px solid var(--primary-teal);max-width:500px;font-family:var(--font-body);`;
                    document.body.appendChild(popup);
                }
                let icon = 'üéµ';
                if (interval===0) icon='üéØ'; else if(interval===5||interval===7) icon='‚ú®'; else if(interval===4||interval===9) icon='üòä'; else if(interval===3||interval===8||interval===10) icon='üòî'; else if(interval===6) icon='‚ö°';
                popup.innerHTML = `
                    <div style="font-size:3.5rem;margin-bottom:0.5rem;">${icon}</div>
                    <div style="font-family:var(--font-display);font-size:1.6rem;font-weight:900;margin-bottom:0.85rem;color:var(--primary-gold);">${intervalNames[interval]}</div>
                    <div style="font-size:1rem;font-weight:600;margin-bottom:0.5rem;opacity:0.9;line-height:1.5;">${intervalDescriptions[interval]}</div>
                    <div style="font-size:0.82rem;opacity:0.7;margin-bottom:1.25rem;font-style:italic;">${interval===0?'0 semitones':interval===1?'1 semitone':interval+' semitones'} apart</div>
                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                        <button onclick="document.getElementById('intervalPopup').style.display='none'" style="padding:0.7rem 1.5rem;background:rgba(0,128,128,0.2);border:2px solid var(--primary-teal);border-radius:10px;color:white;font-weight:700;cursor:pointer;font-size:0.85rem;font-family:var(--font-body);">‚úì Got It</button>
                        <button onclick="try{if(window.playSelection)window.playSelection('up');}catch(e){}" style="padding:0.7rem 1.5rem;background:rgba(0,128,128,0.2);border:2px solid var(--primary-teal);border-radius:10px;color:white;font-weight:700;cursor:pointer;font-size:0.85rem;font-family:var(--font-body);">üîä Play Again</button>
                    </div>`;
                popup.style.display = 'block';
                setTimeout(() => { if (popup && popup.style.display === 'block') { popup.style.opacity='0'; popup.style.transition='opacity 0.5s'; setTimeout(()=>{ popup.style.display='none'; popup.style.opacity='1'; popup.style.transition=''; }, 500); }}, 10000);
            } catch(e) { console.error('Interval popup error:', e); }
        }

        // ‚îÄ‚îÄ Update pattern ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updatePattern() {
            try {
                if (currentLevel === 'freeplay' || currentLevel === '2') return;
                let pattern = [], currentIntervals = [];
                switch(currentLevel) {
                    case '1': pattern = [rootNote]; currentIntervals = [0]; break;
                    case '3': currentIntervals = triads[currentTriadSelection]; pattern = currentIntervals.map(i=>(rootNote+i)%12); break;
                    case '4': currentIntervals = extended[currentExtendedSelection]; pattern = currentIntervals.map(i=>(rootNote+i)%12); break;
                    case '5': currentIntervals = scales.majorPentatonic; pattern = currentIntervals.map(i=>(rootNote+i)%12); break;
                    case '7': currentIntervals = scales.major; pattern = currentIntervals.map(i=>(rootNote+i)%12); break;
                    case 'minor': currentIntervals = scales[currentMinorType]; pattern = currentIntervals.map(i=>(rootNote+i)%12); break;
                    case 'modes': currentIntervals = modes[currentModeSelection]; pattern = currentIntervals.map(i=>(rootNote+i)%12); break;
                    case 'harmMajor': { const cd = currentHarmChordType==='7th'?harmonizedMajor7ths[currentHarmDegree]:harmonizedMajorTriads[currentHarmDegree]; currentIntervals = cd.intervals; pattern = cd.intervals.map(iv=>(rootNote+iv)%12); break; }
                    case 'harmMinor': { const cd = currentHarmChordType==='7th'?harmonizedMinor7ths[currentHarmDegree]:harmonizedMinorTriads[currentHarmDegree]; currentIntervals = cd.intervals; pattern = cd.intervals.map(iv=>(rootNote+iv)%12); break; }
                }
                if (pattern.length > 0) { selectedNotes = new Set(pattern); window.currentPatternIntervals = currentIntervals; }
            } catch(e) { console.error('Update pattern error:', e); }
        }

        // ‚îÄ‚îÄ Update sphere display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateSphereDisplay() {
            try {
                document.querySelectorAll('.sphere').forEach((s, i) => {
                    s.classList.remove('active','included','excluded','freeplay-inactive','playing');
                    if (currentLevel === 'freeplay') {
                        s.classList.add('freeplay-inactive');
                        if (selectedNotes.has(i)) { s.style.border=`4px solid ${colors[i]}`; s.style.transform='scale(1.15)'; }
                        else { s.style.border=''; s.style.transform=''; }
                    } else if (selectedNotes.has(i)) {
                        s.classList.add('included');
                        if (i === rootNote && currentLevel !== '2') s.classList.add('active');
                        s.style.border=''; s.style.transform='';
                    } else {
                        s.classList.add('excluded'); s.style.border=''; s.style.transform='';
                    }
                });
                updatePianoDisplay(); updateGuitarDisplay();
            } catch(e) { console.error('Sphere display error:', e); }
        }

        function updatePianoDisplay() {
            document.querySelectorAll('.white-key,.black-key').forEach(key => {
                const n = parseInt(key.dataset.note);
                if (selectedNotes.has(n)) { key.style.borderColor=colors[n]; key.style.borderWidth='4px'; key.style.boxShadow=`0 0 10px ${colors[n]}`; }
                else { key.style.borderColor=key.classList.contains('white-key')?'#333':'#000'; key.style.borderWidth='2px'; key.style.boxShadow=''; }
            });
        }

        function updateGuitarDisplay() {
            document.querySelectorAll('.note-dot').forEach(dot => {
                const n = noteNamesShort.indexOf(dot.textContent.trim());
                if (n !== -1 && selectedNotes.has(n)) {
                    dot.style.opacity='1'; dot.style.transform='translate(-15px,-15px) scale(1.15)';
                    dot.style.borderWidth='3px'; dot.style.boxShadow=`0 0 12px ${colors[n]}`; dot.style.filter='none';
                } else {
                    dot.style.opacity='0.15'; dot.style.transform='translate(-15px,-15px) scale(0.7)';
                    dot.style.borderWidth='1px'; dot.style.boxShadow='none'; dot.style.filter='grayscale(100%)';
                }
            });
            updateStringLabels();
        }

        function updateStringLabels() {
            document.querySelectorAll('.string-label').forEach(label => {
                const n = parseInt(label.dataset.note);
                if (selectedNotes.has(n)) { label.style.color=colors[n]; label.style.textShadow=`0 0 10px ${colors[n]}, 2px 2px 4px rgba(0,0,0,0.8)`; label.style.transform='scale(1.3)'; label.style.opacity='1'; }
                else { label.style.color='rgba(255,255,255,0.2)'; label.style.textShadow='2px 2px 4px rgba(0,0,0,0.8)'; label.style.transform='scale(1)'; label.style.opacity='0.3'; }
            });
        }

        // ‚îÄ‚îÄ Update controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateControls() {
            try {
                const c = document.getElementById('controls');
                if (!c) return;
                c.innerHTML = '';
                if (currentLevel !== 'freeplay' && currentLevel !== '2') {
                    const g = document.createElement('div'); g.className = 'control-group';
                    g.innerHTML = `<label>Root Note:</label><select id="rootSelect">${noteNames.map((n,i)=>`<option value="${i}"${i===rootNote?' selected':''}>${n}</option>`).join('')}</select>`;
                    c.appendChild(g);
                    setTimeout(() => { const rs = document.getElementById('rootSelect'); if (rs) rs.onchange = e => { rootNote = parseInt(e.target.value); updateDisplay(); if (currentView==='circle') setTimeout(()=>playSelection('chord'),100); }; }, 0);
                }
                if (currentLevel === '3') {
                    const g = document.createElement('div'); g.className = 'control-group';
                    g.innerHTML = `<label>Triad Type:</label><select id="triadSelect"><option value="major">Major</option><option value="minor">Minor</option><option value="diminished">Diminished</option><option value="augmented">Augmented</option></select>`;
                    c.appendChild(g);
                    setTimeout(() => { const ts = document.getElementById('triadSelect'); if (ts) { ts.value=currentTriadSelection; ts.onchange=function(){currentTriadSelection=this.value; updateDisplay(); setTimeout(()=>playSelection('chord'),200);}; }}, 0);
                }
                if (currentLevel === '4') {
                    const g = document.createElement('div'); g.className = 'control-group';
                    g.innerHTML = `<label>7th Chord Type:</label><select id="extendedSelect"><option value="major7">Major 7th (Maj7)</option><option value="dominant7">Dominant 7th (7)</option><option value="minor7">Minor 7th (m7)</option><option value="diminished7">Diminished 7th (dim7)</option><option value="augmented7">Augmented 7th (aug7)</option><option value="halfDiminished7">Half-Diminished 7th (√∏7)</option><option value="minorMajor7">Minor Major 7th (mMaj7)</option><option value="augmentedMajor7">Augmented Major 7th (augMaj7)</option></select>`;
                    c.appendChild(g);
                    setTimeout(() => { const es = document.getElementById('extendedSelect'); if (es) { es.value=currentExtendedSelection; es.onchange=function(){currentExtendedSelection=this.value; updateDisplay(); setTimeout(()=>playSelection('chord'),200);}; }}, 0);
                }
                if (currentLevel === 'minor') {
                    const g = document.createElement('div'); g.className = 'control-group';
                    g.innerHTML = `<label>Minor Scale Type:</label><select id="minorTypeSelect"><option value="naturalMinor">Natural Minor</option><option value="harmonicMinor">Harmonic Minor</option><option value="melodicMinor">Melodic Minor</option></select>`;
                    c.appendChild(g);
                    setTimeout(() => { const ms = document.getElementById('minorTypeSelect'); if (ms) { ms.value=currentMinorType; ms.onchange=function(){currentMinorType=this.value; updateDisplay(); setTimeout(()=>playSelection('scale'),200);}; }}, 0);
                }
                if (currentLevel === 'modes') {
                    const g = document.createElement('div'); g.className = 'control-group';
                    g.innerHTML = `<label>Mode:</label><select id="modeSelect"><option value="ionian">Ionian (Major)</option><option value="dorian">Dorian</option><option value="phrygian">Phrygian</option><option value="lydian">Lydian</option><option value="mixolydian">Mixolydian</option><option value="aeolian">Aeolian (Natural Minor)</option><option value="locrian">Locrian</option></select>`;
                    c.appendChild(g);
                    setTimeout(() => { const msel = document.getElementById('modeSelect'); if (msel) { msel.value=currentModeSelection; msel.onchange=function(){currentModeSelection=this.value; updateDisplay(); setTimeout(()=>playSelection('scale'),200);}; }}, 0);
                }
                if (currentLevel === 'harmMajor' || currentLevel === 'harmMinor') {
                    const isMinor = currentLevel === 'harmMinor';
                    const degLabels = isMinor ?
                        ['i - Tonic','ii¬∞ - Supertonic','III - Mediant','iv - Subdominant','v - Dominant','VI - Submediant','VII - Subtonic'] :
                        ['I - Tonic','ii - Supertonic','iii - Mediant','IV - Subdominant','V - Dominant','vi - Submediant','vii¬∞ - Leading Tone'];
                    const g1 = document.createElement('div'); g1.className = 'control-group';
                    g1.innerHTML = `<label>Scale Degree:</label><select id="harmDegreeSelect">${degLabels.map((l,i)=>`<option value="${i}">${l}</option>`).join('')}</select>`;
                    const g2 = document.createElement('div'); g2.className = 'control-group';
                    g2.innerHTML = `<label>Chord Type:</label><select id="harmTypeSelect"><option value="triad">Triads (3-note)</option><option value="7th">Seventh Chords (4-note)</option></select>`;
                    c.appendChild(g1); c.appendChild(g2);
                    setTimeout(() => {
                        const hds = document.getElementById('harmDegreeSelect');
                        const hts = document.getElementById('harmTypeSelect');
                        if (hds) { hds.value=currentHarmDegree; hds.onchange=function(){currentHarmDegree=parseInt(this.value); updateDisplay(); setTimeout(()=>playSelection('chord'),200);}; }
                        if (hts) { hts.value=currentHarmChordType; hts.onchange=function(){currentHarmChordType=this.value; updateDisplay(); setTimeout(()=>playSelection('chord'),200);}; }
                    }, 0);
                }
                const wg = document.createElement('div'); wg.className = 'control-group';
                wg.innerHTML = `<label>Waveform:</label><select id="waveformSelect"><option value="sine">Sine (Pure)</option><option value="square">Square (Hollow)</option><option value="sawtooth">Sawtooth (Bright)</option><option value="triangle">Triangle (Soft)</option></select>`;
                c.appendChild(wg);
                setTimeout(() => { const ws = document.getElementById('waveformSelect'); if (ws) { ws.value=currentWaveform; ws.onchange=e=>currentWaveform=e.target.value; }}, 0);
            } catch(e) { console.error('Update controls error:', e); }
        }

        // ‚îÄ‚îÄ Update note list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateNoteList() {
            try {
                const list = document.getElementById('noteList');
                if (!list) return;
                let notes = Array.from(selectedNotes).sort((a,b)=>a-b);
                if (currentLevel === 'freeplay' && notes.length === 0) {
                    list.innerHTML = '<span class="note-badge">Click notes to select!</span>';
                } else if (notes.length === 2 && currentLevel === '2') {
                    const int = (notes[1]-notes[0]+12)%12;
                    list.innerHTML = `<span class="note-badge" style="background:${colors[notes[0]]};color:${textColors[notes[0]]};">${noteNames[notes[0]]}</span><span class="note-badge" style="background:rgba(0,128,128,0.3);font-size:0.95rem;padding:0.55rem 1.1rem;">‚Üí ${intervalNames[int]} ‚Üí</span><span class="note-badge" style="background:${colors[notes[1]]};color:${textColors[notes[1]]};">${noteNames[notes[1]]}</span>`;
                } else {
                    list.innerHTML = notes.map(n=>`<span class="note-badge" style="background:${colors[n]};color:${textColors[n]};">${noteNames[n]}${n===rootNote&&currentLevel!=='freeplay'&&currentLevel!=='2'?' (Root)':''}</span>`).join('');
                }
            } catch(e) { console.error('Note list error:', e); }
        }

        // ‚îÄ‚îÄ Update view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateView() {
            try {
                const el = (id) => document.getElementById(id);
                if (el('chromaticCircle')) el('chromaticCircle').style.display = currentView==='circle' ? 'block' : 'none';
                if (el('pianoKeyboard')) el('pianoKeyboard').style.display = currentView==='keyboard' ? 'block' : 'none';
                if (el('guitarFretboard')) el('guitarFretboard').style.display = currentView==='guitar' ? 'block' : 'none';
                if (el('earTraining')) el('earTraining').style.display = currentView==='ear' ? 'block' : 'none';
                updateStaffNotation(Array.from(selectedNotes));
                const pc = el('progressionControls');
                if ((currentLevel==='harmMajor'||currentLevel==='harmMinor') && currentView!=='ear') {
                    if (pc) { pc.style.display='block'; updateProgressionButtons(); }
                } else { if (pc) pc.style.display='none'; }
            } catch(e) { console.error('Update view error:', e); }
        }

        // ‚îÄ‚îÄ Octave display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateOctaveDisplay() {
            const octNames = {0:'Octave 0 (Sub-Contra)',1:'Octave 1 (Contra)',2:'Octave 2 (Great)',3:'Octave 3 (Small)',4:'Octave 4 (Middle C)',5:'Octave 5 (Treble)',6:'Octave 6 (High)',7:'Octave 7 (Very High)',8:'Octave 8 (Highest)'};
            const label = document.getElementById('octaveLabel');
            if (label) label.textContent = octNames[currentOctave];
        }

        // ‚îÄ‚îÄ Main display update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateDisplay() {
            try {
                updatePattern(); updateSphereDisplay(); updateControls(); updateNoteList(); updateStaffNotation(Array.from(selectedNotes));
                const status = document.getElementById('status');
                if (!status) return;
                if (currentLevel === 'harmMajor') {
                    const cd = currentHarmChordType==='7th'?harmonizedMajor7ths[currentHarmDegree]:harmonizedMajorTriads[currentHarmDegree];
                    status.textContent = `üéµ Harmonized ${noteNames[rootNote]} Major: ${cd.name} chord (${cd.quality})`;
                } else if (currentLevel === 'harmMinor') {
                    const cd = currentHarmChordType==='7th'?harmonizedMinor7ths[currentHarmDegree]:harmonizedMinorTriads[currentHarmDegree];
                    status.textContent = `üéµ Harmonized ${noteNames[rootNote]} Natural Minor: ${cd.name} chord (${cd.quality})`;
                } else if (currentLevel === 'freeplay') {
                    const nc = selectedNotes.size;
                    status.textContent = `üéπ Free Play ‚Äî ${nc} note${nc!==1?'s':''} selected ‚Äî Use buttons to play as CHORD or SEQUENCE!`;
                } else if (currentLevel === '2') {
                    if (selectedNotes.size === 2) { const n = Array.from(selectedNotes).sort((a,b)=>a-b); const int=(n[1]-n[0]+12)%12; status.textContent=`üéº Interval: ${intervalNames[int]}`; }
                    else if (selectedNotes.size === 1) { status.textContent=`üéº First note: ${noteNames[rootNote]} ‚Äî Click second note`; }
                    else { status.textContent='üéº Intervals ‚Äî Click two notes'; }
                } else {
                    status.textContent = `üéµ Root Note: ${noteNames[rootNote]} ‚Äî Click note to change`;
                }
            } catch(e) { console.error('Update display error:', e); }
        }

        // ‚îÄ‚îÄ Progression controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateProgressionButtons() {
            try {
                const container = document.getElementById('progressionButtons');
                if (!container) return;
                const isMajor = currentLevel === 'harmMajor';
                const progressions = isMajor ? [
                    {name:'I-IV-V-I',degrees:[0,3,4,0],desc:'Classic Rock'},{name:'I-V-vi-IV',degrees:[0,4,5,3],desc:'Pop Anthem'},
                    {name:'I-vi-IV-V',degrees:[0,5,3,4],desc:'50s Doo-Wop'},{name:'ii-V-I',degrees:[1,4,0],desc:'Jazz Cadence'},
                    {name:'vi-IV-I-V',degrees:[5,3,0,4],desc:'Emotional'},{name:'I-IV-vi-V',degrees:[0,3,5,4],desc:'Sensitive'}
                ] : [
                    {name:'i-iv-v',degrees:[0,3,4],desc:'Minor Blues'},{name:'i-VI-VII',degrees:[0,5,6],desc:'Natural Minor'},
                    {name:'i-iv-VII',degrees:[0,3,6],desc:'Dorian Feel'},{name:'i-III-VI-VII',degrees:[0,2,5,6],desc:'Dark Journey'},
                    {name:'i-VI-III-VII',degrees:[0,5,2,6],desc:'Epic Minor'},{name:'i-v-VI-iv',degrees:[0,4,5,3],desc:'Melancholic'}
                ];
                container.innerHTML = '';
                progressions.forEach(prog => {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.style.cssText = 'padding:8px 14px;font-size:0.68rem;min-width:auto;';
                    btn.innerHTML = `${prog.name}<br><small style="opacity:0.75;font-size:0.58rem;">${prog.desc}</small>`;
                    btn.onclick = () => playProgression(prog.degrees); container.appendChild(btn);
                });
            } catch(e) { console.error('Progression buttons error:', e); }
        }

        function playProgression(degrees) {
            try {
                if (!audioReady) { alert('Click START AUDIO ENGINE first!'); return; }
                const isMajor = currentLevel === 'harmMajor';
                const use7th = currentHarmChordType === '7th';
                const chordData = isMajor ? (use7th?harmonizedMajor7ths:harmonizedMajorTriads) : (use7th?harmonizedMinor7ths:harmonizedMinorTriads);
                const chordDur = 60000 / currentBPM;
                degrees.forEach((degree, index) => {
                    setTimeout(() => {
                        currentHarmDegree = degree;
                        const chord = chordData[degree];
                        const pitchClasses = chord.intervals.map(iv=>(rootNote+iv)%12);
                        selectedNotes = new Set(pitchClasses);
                        updateSphereDisplay(); updateNoteList(); updateStaffNotation(pitchClasses);
                        const statusEl = document.getElementById('status');
                        if (statusEl) statusEl.textContent = `üéµ Playing: ${chord.name} (${chord.quality}) ‚Äî Chord ${index+1}/${degrees.length}`;
                        playChordNotesWithIntervals(chord.intervals, chordDur/1000*0.9);
                    }, index * chordDur);
                });
            } catch(e) { console.error('Play progression error:', e); }
        }

        function playChordNotesWithIntervals(intervals, duration) {
            try {
                if (!audioContext || !audioReady) return;
                const freqs = [261.63,277.18,293.66,311.13,329.63,349.23,369.99,392.00,415.30,440.00,466.16,493.88];
                const notesToPlay = intervals.map(iv => ({note:(rootNote+iv)%12, octave:currentOctave+Math.floor(iv/12)}));
                const unique = [...new Set(notesToPlay.map(n=>n.note))];
                updateStaffNotation(unique);
                unique.forEach(n => highlightNote(n, true));
                const now = audioContext.currentTime;
                notesToPlay.forEach(({note, octave}) => {
                    const freq = freqs[note] * Math.pow(2, octave-4);
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain); gain.connect(audioContext.destination);
                    osc.frequency.value = freq; osc.type = currentWaveform;
                    gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.25, now+0.015); gain.gain.exponentialRampToValueAtTime(0.01, now+duration);
                    osc.start(now); osc.stop(now+duration);
                });
                setTimeout(() => unique.forEach(n => highlightNote(n, false)), duration*1000);
            } catch(e) { console.error('Play chord with intervals error:', e); }
        }

        function playAllScaleChords() {
            try {
                if (!audioReady) { alert('Click START AUDIO ENGINE first!'); return; }
                playProgression([0,1,2,3,4,5,6]);
            } catch(e) { console.error('Play all chords error:', e); }
        }

        // ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();

    } catch(e) {
        console.error('Global script error:', e);
        alert('Application error. Please refresh. Error: ' + e.message);
    }
})();
</script>
</body>
</html>
