<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EGC5ZNZPF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-6EGC5ZNZPF', { page_title: 'Chromatic Roulette Wheel', page_location: window.location.href });
</script>

<!-- Core Meta -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Chromatic Roulette Wheel | Keys, Codes &amp; Modes â€” Interactive Music Theory</title>
<meta name="description" content="Spin the Chromatic Roulette Wheel to explore major scales, triads, and intervals on a color-coded guitar fretboard. Interactive music theory trainer from Keys, Codes &amp; Modes.">
<meta name="keywords" content="chromatic roulette, music theory, guitar fretboard, major scale, music education, keys codes modes, interactive music, circle of fifths, chromatic scale, guitar training">
<meta name="author" content="Ben Ryan â€” Keys, Codes &amp; Modes">
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#0f1b2d">
<link rel="canonical" href="https://keyscodesandmodes.com/chromatic-roulette.html">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="Keys, Codes &amp; Modes">
<meta property="og:title" content="Chromatic Roulette Wheel â€” Interactive Music Theory Trainer">
<meta property="og:description" content="Spin, drag, and explore every key on the guitar fretboard. Visual color-coded music theory for all levels.">
<meta property="og:url" content="https://keyscodesandmodes.com/chromatic-roulette.html">
<meta property="og:image" content="https://keyscodesandmodes.com/images/chromatic-roulette-og.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:locale" content="en_US">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Chromatic Roulette Wheel | Keys, Codes &amp; Modes">
<meta name="twitter:description" content="Spin to any key. See it on the guitar. Hear it played. Color-coded music theory.">
<meta name="twitter:image" content="https://keyscodesandmodes.com/images/chromatic-roulette-og.png">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Chromatic Roulette Wheel",
  "url": "https://keyscodesandmodes.com/chromatic-roulette.html",
  "description": "Interactive chromatic roulette wheel for learning music theory.",
  "applicationCategory": "EducationalApplication",
  "operatingSystem": "Any",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "creator": { "@type": "Person", "name": "Ben Ryan", "url": "https://keyscodesandmodes.com" }
}
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/*
  KEYS, CODES & MODES â€” CHROMATIC ROULETTE WHEEL
  C=#FFFF00  C#=#FFC400  D=#FF8000  D#=#FF4000  E=#FF0000
  F=#C4007F  F#=#8000FF  G=#4000FF  Ab=#0000FF
  A=#007FFF  Bb=#00FF80  B=#80FF00
*/
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }

body {
  font-family: 'Rajdhani', Arial, sans-serif;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  color: white;
  min-height: 100vh;
  min-height: 100dvh;
  padding: clamp(12px, 2.5vw, 24px);
  overscroll-behavior: contain;
}

/* â”€â”€ Header â”€â”€ */
.site-header { text-align:center; margin-bottom:clamp(14px,2.5vw,26px); }

h1 {
  font-family:'Rajdhani',sans-serif;
  font-size:clamp(1.2rem,3.5vw,1.8rem);
  font-weight:900;
  letter-spacing:3px;
  text-transform:uppercase;
  background:linear-gradient(90deg,#FFFF00,#FF8000,#FF0000,#8000FF,#0000FF,#00FF80);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin-bottom:4px;
}
.app-title {
  font-family:'Rajdhani',sans-serif;
  font-size:clamp(1.4rem,4vw,2.2rem);
  font-weight:700;
  color:#fff;
  letter-spacing:1px;
  margin-bottom:4px;
  text-shadow:0 2px 10px rgba(255,255,255,0.2);
}
.subtitle {
  font-family:'Space Mono',monospace;
  font-size:clamp(0.62rem,1.7vw,0.78rem);
  color:#777;
  letter-spacing:1px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN 2-COLUMN LAYOUT
   Col 1 (left)  = Guitar Fretboard
   Col 2 (right) = Wheel + Controls
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-grid {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: clamp(16px, 2.5vw, 40px);
  align-items: start;
  max-width: 1400px;
  margin: 0 auto;
}

@media (max-width: 820px) {
  .main-grid { grid-template-columns: 1fr; }
  .guitar-col   { order: 2; }
  .controls-col { order: 1; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEFT COL â€” Guitar Fretboard
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.guitar-col {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}
.guitar-title {
  font-family:'Rajdhani',sans-serif;
  font-size:clamp(1rem,2.5vw,1.4rem);
  font-weight:700;
  letter-spacing:1px;
  text-align:center;
}

/* Fret view buttons */
.fret-panel {
  display:flex;
  gap:7px;
  justify-content:center;
  flex-wrap:wrap;
}

/* Brown fretboard pane â€” tight fit to content */
#fretboard {
  width: fit-content;
  margin: 0 auto;
  background: linear-gradient(180deg, #4a3620 0%, #5d4e37 50%, #4a3620 100%);
  border-radius: 10px;
  padding: 12px 8px;
  position: relative;
  max-height: 760px;
  overflow-y: auto;
  border: 1px solid rgba(120,90,40,0.5);
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
}
#fretboard::-webkit-scrollbar { width:6px; }
#fretboard::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); border-radius:6px; }
#fretboard::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.22); border-radius:6px; }

/* String name labels â€” exact same widths & gap as columns */
.fb-label-row {
  display:flex;
  gap:3px;
  margin-bottom:6px;
}
.fb-label-cell {
  width:36px;
  flex-shrink:0;
  text-align:center;
  font-family:'Space Mono',monospace;
  font-size:0.67rem;
  font-weight:700;
  color:rgba(255,210,120,0.75);
}

.fb-strings-row {
  display:flex;
  gap:3px;
  position:relative;
}
.fb-string-col {
  position:relative;
  width:36px;
  flex-shrink:0;
}

/* Vertical string line */
.fb-vline {
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:2px;
  bottom:0;
  background:linear-gradient(180deg, rgba(200,170,100,0.6), rgba(150,120,60,0.25));
}

/* Horizontal fret lines */
.fb-fret-line {
  position:absolute;
  left:-3px; right:-3px;
  height:1px;
  background:rgba(180,140,80,0.3);
  pointer-events:none;
}

/* Fret position marker dots */
.fb-fret-marker {
  position:absolute;
  width:13px; height:13px;
  border-radius:50%;
  background:rgba(255,255,255,0.1);
  left:50%;
  transform:translateX(-50%);
  pointer-events:none;
  z-index:1;
}

/* â”€â”€ NOTE DOTS â”€â”€ */
.note-dot {
  position:absolute;
  width:26px; height:26px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:'Space Mono',monospace;
  font-size:6px;
  font-weight:700;
  color:#000;
  cursor:pointer;
  left:50%;
  transform:translateX(-50%);
  border:2px solid rgba(0,0,0,0.4);
  /* All dim by default */
  opacity:0.12;
  transition:opacity 0.1s, transform 0.1s, box-shadow 0.1s;
  z-index:2;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
}
/* Active notes in current mode */
.note-dot.active  { opacity:0.72; }
/* Root note */
.note-dot.root {
  opacity:0.9;
  border:2.5px solid rgba(255,255,255,0.9);
  box-shadow:0 0 8px rgba(255,255,255,0.5);
}
/* Inactive notes */
.note-dot.inactive { opacity:0.1; }
/* Hover */
.note-dot:hover {
  opacity:1 !important;
  transform:translateX(-50%) scale(1.2) !important;
  z-index:20;
  box-shadow:0 0 12px rgba(255,255,255,0.5) !important;
}

/* â”€â”€ PLAYING STATE â”€â”€
   body.is-playing dims everything; only .playing shines */
body.is-playing .note-dot {
  opacity:0.07 !important;
  box-shadow:none !important;
}
body.is-playing .note-dot.playing {
  opacity:1 !important;
  box-shadow:0 0 0 3px rgba(255,255,255,0.9),
             0 0 20px 5px rgba(255,255,255,0.65) !important;
  transform:translateX(-50%) scale(1.2) !important;
  z-index:50;
  animation:pop-dot 0.2s ease-out;
}
body.is-playing #rouletteWheel path:not(.playing-highlight) {
  opacity:0.1 !important;
  transition:opacity 0.1s;
}
@keyframes pop-dot {
  0%   { box-shadow:0 0 0 6px rgba(255,255,255,1), 0 0 28px 8px rgba(255,255,255,0.8); }
  100% { box-shadow:0 0 0 3px rgba(255,255,255,0.9), 0 0 20px 5px rgba(255,255,255,0.65); }
}
.playing-highlight {
  filter:brightness(1.7) drop-shadow(0 0 10px currentColor) !important;
}

/* Legend */
.legend {
  padding:10px 12px;
  background:rgba(0,0,0,0.3);
  border-radius:8px;
  font-family:'Space Mono',monospace;
  font-size:clamp(0.58rem,1.5vw,0.7rem);
  color:#777;
  line-height:1.85;
  width:fit-content;
  margin:0 auto;
}
.legend span { color:#ccc; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHT COL â€” Controls
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.controls-col {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
}

/* Root note badge */
.root-display { text-align:center; }
.root-label {
  font-family:'Space Mono',monospace;
  font-size:0.68rem;
  color:#666;
  letter-spacing:2px;
  text-transform:uppercase;
  margin-bottom:6px;
}
.root-note {
  display:inline-block;
  font-family:'Rajdhani',sans-serif;
  font-size:clamp(2rem,5vw,2.8rem);
  font-weight:700;
  padding:8px 26px;
  border-radius:12px;
  color:#000;
  min-width:108px;
  text-align:center;
  letter-spacing:1px;
  box-shadow:0 6px 20px rgba(0,0,0,0.4);
  transition:background-color 0.2s;
}

/* Wheel */
.wheel-wrap {
  position:relative;
  width:min(320px,85vw);
  height:min(320px,85vw);
}
#rouletteWheel {
  width:100%; height:100%;
  cursor:grab;
  touch-action:none;
  filter:drop-shadow(0 10px 24px rgba(0,0,0,0.55));
}
#rouletteWheel:active { cursor:grabbing; }

/* Spin buttons */
.spin-controls {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}

/* Mode panel */
.mode-panel {
  background:rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;
  padding:14px 12px;
  width:100%;
  max-width:min(320px,90vw);
}
.mode-panel-title {
  font-family:'Space Mono',monospace;
  font-size:0.67rem;
  letter-spacing:2px;
  text-transform:uppercase;
  color:#666;
  text-align:center;
  margin-bottom:10px;
}
.mode-buttons {
  display:flex;
  gap:7px;
  flex-wrap:wrap;
  justify-content:center;
}

/* â”€â”€ Shared buttons â”€â”€ */
.btn {
  font-family:'Rajdhani',sans-serif;
  font-size:0.95rem;
  font-weight:700;
  letter-spacing:0.5px;
  padding:10px 18px;
  border:none;
  border-radius:9px;
  cursor:pointer;
  transition:transform 0.15s, box-shadow 0.15s, opacity 0.15s;
  -webkit-tap-highlight-color:transparent;
}
.btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 5px 14px rgba(0,0,0,0.35); }
.btn:active:not(:disabled) { transform:translateY(0); }
.btn:disabled { opacity:0.4; cursor:not-allowed; }

.btn-spin { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; }

.btn-mode {
  flex:1;
  min-width:88px;
  padding:11px 8px;
  background:rgba(255,255,255,0.07);
  color:#ccc;
  border:1px solid rgba(255,255,255,0.1);
  border-radius:9px;
  font-size:0.9rem;
}
.btn-mode.active {
  background:linear-gradient(135deg,#11998e,#38ef7d);
  color:#000;
  border-color:transparent;
}

.btn-fret {
  padding:9px 16px;
  background:rgba(255,255,255,0.07);
  color:#ccc;
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;
  font-size:0.88rem;
}
.btn-fret.active {
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  border-color:transparent;
}

/* â”€â”€ Footer â”€â”€ */
.site-footer {
  text-align:center;
  margin-top:clamp(20px,3vw,36px);
  font-family:'Space Mono',monospace;
  font-size:0.63rem;
  color:#444;
  letter-spacing:1px;
}
.site-footer a { color:#444; text-decoration:none; }
.site-footer a:hover { color:#aaa; }

:focus-visible { outline:2px solid #FFD700; outline-offset:2px; }
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:rgba(0,0,0,0.15); border-radius:6px; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.18); border-radius:6px; }
</style>
</head>

<body>

<header class="site-header" role="banner">
  <h1 aria-label="Keys Codes and Modes">Keys, Codes &amp; Modes</h1>
  <div class="app-title">Chromatic Roulette Wheel</div>
  <p class="subtitle">Spin to a key Â· Select a mode Â· Hear it play</p>
</header>

<main role="main">
  <div class="main-grid">

    <!-- â•â• LEFT COLUMN â€” Guitar Fretboard â•â• -->
    <section class="guitar-col" aria-label="Guitar fretboard">

      <h2 class="guitar-title">ğŸ¸ Guitar Fretboard</h2>

      <div class="fret-panel" role="group" aria-label="Fret view">
        <button class="btn btn-fret" data-frets="3"  aria-pressed="false">3 Frets</button>
        <button class="btn btn-fret active" data-frets="5"  aria-pressed="true">5 Frets</button>
        <button class="btn btn-fret" data-frets="15" aria-pressed="false">15 Frets</button>
      </div>

      <div id="fretboard" role="img" aria-label="Guitar fretboard â€” active notes shown"></div>

      <div class="legend" aria-live="polite">
        <div>Root: <span id="legendRoot">C</span> &nbsp;|&nbsp; Mode: <span id="legendMode">C Major Scale</span></div>
        <div>Bright = playing now &nbsp;|&nbsp; Click any dot to hear it</div>
      </div>

    </section>

    <!-- â•â• RIGHT COLUMN â€” Controls â•â• -->
    <section class="controls-col" aria-label="Roulette wheel and controls">

      <div class="root-display">
        <div class="root-label">Root Note</div>
        <div class="root-note" id="rootNote" aria-live="polite" aria-atomic="true">C</div>
      </div>

      <div class="wheel-wrap">
        <svg id="rouletteWheel"
             viewBox="0 0 400 400"
             role="img"
             aria-label="Chromatic roulette wheel â€” drag or use buttons to spin"
             tabindex="0"></svg>
      </div>

      <div class="spin-controls" role="group" aria-label="Spin controls">
        <button class="btn btn-spin" id="spinCCW"    aria-label="Spin counter-clockwise">â†º CCW</button>
        <button class="btn btn-spin" id="spinRandom" aria-label="Random spin">ğŸ² Spin</button>
        <button class="btn btn-spin" id="spinCW"     aria-label="Spin clockwise">CW â†»</button>
      </div>

      <div class="mode-panel" role="group" aria-label="Mode selection">
        <div class="mode-panel-title">Select &amp; Play Mode</div>
        <div class="mode-buttons">
          <button class="btn btn-mode active" data-mode="scale"     aria-pressed="true">Major Scale</button>
          <button class="btn btn-mode"         data-mode="triad"     aria-pressed="false">Major Triad</button>
          <button class="btn btn-mode"         data-mode="intervals" aria-pressed="false">Chromatic</button>
        </div>
      </div>

    </section>

  </div>
</main>

<footer class="site-footer" role="contentinfo">
  <p>Â© <span id="yr"></span> <a href="https://keyscodesandmodes.com" rel="noopener">Keys, Codes &amp; Modes</a> â€” All rights reserved.</p>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYS, CODES & MODES â€” CHROMATIC ROULETTE WHEEL
//  Â© Ben Ryan | keyscodesandmodes.com
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('yr').textContent = new Date().getFullYear();

// â”€â”€ Brand Color System â”€â”€
const notes  = ['C','C#/Db','D','D#/Eb','E','F','F#/Gb','G','G#/Ab','A','A#/Bb','B'];
const colors = [
  '#FFFF00','#FFC400','#FF8000','#FF4000','#FF0000',
  '#C4007F','#8000FF','#4000FF','#0000FF','#007FFF','#00FF80','#80FF00'
];

const MIDI_C4       = 60;
const guitarStrings = [40, 45, 50, 55, 59, 64]; // E2 A2 D3 G3 B3 E4
const stringNames   = ['E','A','D','G','B','E'];

const patterns = {
  scale:     [0,2,4,5,7,9,11],
  triad:     [0,4,7],
  intervals: [0,1,2,3,4,5,6,7,8,9,10,11]
};
const modeNames = { scale:'Major Scale', triad:'Major Triad', intervals:'Chromatic' };

// â”€â”€ State â”€â”€
let audioCtx     = null;
let currentRot   = 60;   // starts with C at 12 o'clock
let selectedNote = 0;
let isSpinning   = false;
let spinSpeed    = 0;
let currentMode  = 'scale';
let fretView     = 5;
let playTimers   = [];

// â”€â”€ Audio â”€â”€
function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playNote(midi, dur = 0.35) {
  if (!Number.isFinite(midi) || midi < 0 || midi > 127) return;
  initAudio();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = 440 * Math.pow(2, (midi - 69) / 12);
  osc.type = 'sine';
  const t = audioCtx.currentTime;
  gain.gain.setValueAtTime(0.32, t);
  gain.gain.exponentialRampToValueAtTime(0.001, t + dur);
  osc.start(t);
  osc.stop(t + dur);
}

// â”€â”€ Playback State Management â”€â”€
function clearPlayState() {
  playTimers.forEach(clearTimeout);
  playTimers = [];
  document.body.classList.remove('is-playing');
  document.querySelectorAll('.note-dot.playing').forEach(d => d.classList.remove('playing'));
  document.querySelectorAll('#rouletteWheel path.playing-highlight').forEach(p => p.classList.remove('playing-highlight'));
}

function lightUpNote(ni, dur) {
  // Wheel segment
  document.querySelectorAll('#rouletteWheel path[data-note]').forEach(seg => {
    if (parseInt(seg.getAttribute('data-note')) === ni) {
      seg.classList.add('playing-highlight');
      playTimers.push(setTimeout(() => seg.classList.remove('playing-highlight'), dur));
    }
  });
  // Fretboard dots
  document.querySelectorAll(`.note-dot[data-ni="${ni}"]`).forEach(dot => {
    dot.classList.add('playing');
    playTimers.push(setTimeout(() => dot.classList.remove('playing'), dur));
  });
}

function playSelection() {
  clearPlayState();
  initAudio();
  document.body.classList.add('is-playing');

  const root    = MIDI_C4 + selectedNote;
  const pattern = patterns[currentMode];

  if (currentMode === 'triad') {
    // All 3 notes simultaneously
    pattern.forEach(iv => {
      const ni = (selectedNote + iv) % 12;
      playNote(root + iv, 1.1);
      lightUpNote(ni, 1100);
    });
    playTimers.push(setTimeout(clearPlayState, 1250));

  } else {
    // Sequential â€” one note at a time, rest fully dimmed
    const stepMs  = 300;
    const noteDur = 0.42;
    pattern.forEach((iv, i) => {
      playTimers.push(setTimeout(() => {
        // Clear previous step
        document.querySelectorAll('.note-dot.playing').forEach(d => d.classList.remove('playing'));
        document.querySelectorAll('#rouletteWheel path.playing-highlight').forEach(p => p.classList.remove('playing-highlight'));
        const ni = (selectedNote + iv) % 12;
        playNote(root + iv, noteDur);
        lightUpNote(ni, stepMs - 40);
      }, i * stepMs));
    });
    playTimers.push(setTimeout(clearPlayState, pattern.length * stepMs + 250));
  }
}

// â”€â”€ Wheel Drawing â”€â”€
function getActiveNotes() {
  return patterns[currentMode].map(iv => (selectedNote + iv) % 12);
}

function drawWheel() {
  const svg = document.getElementById('rouletteWheel');
  svg.innerHTML = '';
  const cx = 200, cy = 200, R = 150;
  const active = getActiveNotes();

  for (let i = 0; i < 12; i++) {
    const a0 = ((i * 30) - 90 - currentRot + 45) * Math.PI / 180;
    const a1 = a0 + 30 * Math.PI / 180;
    const x1 = cx + R * Math.cos(a0), y1 = cy + R * Math.sin(a0);
    const x2 = cx + R * Math.cos(a1), y2 = cy + R * Math.sin(a1);

    const seg = document.createElementNS('http://www.w3.org/2000/svg','path');
    seg.setAttribute('d', `M${cx} ${cy} L${x1} ${y1} A${R} ${R} 0 0 1 ${x2} ${y2}Z`);
    seg.setAttribute('fill', colors[i]);
    seg.setAttribute('stroke', '#000');
    seg.setAttribute('stroke-width', '1.5');
    seg.setAttribute('opacity', active.includes(i) ? '1' : '0.28');
    seg.setAttribute('data-note', i);
    svg.appendChild(seg);

    // Label
    const mid = (a0 + a1) / 2;
    const lx = cx + 108 * Math.cos(mid), ly = cy + 108 * Math.sin(mid);
    const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x', lx); txt.setAttribute('y', ly);
    txt.setAttribute('text-anchor','middle');
    txt.setAttribute('dominant-baseline','middle');
    txt.setAttribute('fill','#000');
    txt.setAttribute('font-weight','bold');
    txt.setAttribute('font-size','12');
    txt.setAttribute('font-family','Space Mono, monospace');
    txt.textContent = notes[i];
    svg.appendChild(txt);
  }

  // Center disc
  const disc = document.createElementNS('http://www.w3.org/2000/svg','circle');
  disc.setAttribute('cx',cx); disc.setAttribute('cy',cy); disc.setAttribute('r','38');
  disc.setAttribute('fill','#1a2340');
  disc.setAttribute('stroke', colors[selectedNote]);
  disc.setAttribute('stroke-width','4');
  svg.appendChild(disc);

  // Pointer
  const ptr = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  ptr.setAttribute('points','200,16 190,38 210,38');
  ptr.setAttribute('fill','#FFD700');
  svg.appendChild(ptr);
}

// â”€â”€ Fretboard Drawing â”€â”€
function drawFretboard() {
  const fb = document.getElementById('fretboard');
  fb.innerHTML = '';
  const active = getActiveNotes();

  const DOT   = 26;   // dot diameter in px
  const fretH = 52;   // px per fret cell
  const COL_W = 36;   // column width (matches CSS .fb-string-col)
  const totalH = DOT + fretH * fretView;

  // Label row â€” same widths & gap as string columns
  const lblRow = document.createElement('div');
  lblRow.className = 'fb-label-row';
  stringNames.forEach(n => {
    const lbl = document.createElement('div');
    lbl.className = 'fb-label-cell';
    lbl.textContent = n;
    lblRow.appendChild(lbl);
  });
  fb.appendChild(lblRow);

  // String columns
  const strRow = document.createElement('div');
  strRow.className = 'fb-strings-row';

  guitarStrings.forEach((openMidi, si) => {
    const col = document.createElement('div');
    col.className = 'fb-string-col';
    col.style.height = totalH + 'px';
    col.style.width  = COL_W + 'px';

    // String line â€” starts at centre of fret-0 dot
    const vline = document.createElement('div');
    vline.className = 'fb-vline';
    vline.style.top = (DOT / 2) + 'px';
    col.appendChild(vline);

    // Horizontal fret lines
    for (let f = 1; f <= fretView; f++) {
      const fl = document.createElement('div');
      fl.className = 'fb-fret-line';
      fl.style.top = (DOT + (f - 1) * fretH) + 'px';
      col.appendChild(fl);
    }

    // Position marker dots (on D string = index 2)
    if (si === 2) {
      [3,5,7,9,12,15].forEach(f => {
        if (f <= fretView) {
          const mk = document.createElement('div');
          mk.className = 'fb-fret-marker';
          mk.style.top = (DOT + (f-1)*fretH + fretH/2 - 7) + 'px';
          col.appendChild(mk);
        }
      });
    }

    // Note dots
    for (let fret = 0; fret <= fretView; fret++) {
      const midi     = openMidi + fret;
      const ni       = midi % 12;
      const isActive = active.includes(ni);
      const isRoot   = ni === selectedNote;

      const dot = document.createElement('div');
      dot.className = 'note-dot';
      dot.setAttribute('data-midi', midi);
      dot.setAttribute('data-ni', ni);
      dot.setAttribute('role', 'button');
      dot.setAttribute('tabindex', isActive ? '0' : '-1');
      dot.setAttribute('aria-label', `${notes[ni]} â€” ${stringNames[si]} string fret ${fret}`);

      if (isActive) dot.classList.add('active');
      else          dot.classList.add('inactive');
      if (isRoot)   dot.classList.add('root');

      dot.style.backgroundColor = colors[ni];

      // Fret 0: flush at top (nut); fret n: centred in fret cell
      const topPx = fret === 0
        ? 0
        : DOT + (fret - 1) * fretH + (fretH - DOT) / 2;
      dot.style.top = topPx + 'px';
      dot.textContent = notes[ni];

      dot.addEventListener('click', () => {
        if (Number.isFinite(midi)) playNote(midi, 0.55);
      });
      dot.addEventListener('keydown', e => {
        if (e.key==='Enter'||e.key===' ') { e.preventDefault(); playNote(midi, 0.55); }
      });

      col.appendChild(dot);
    }
    strRow.appendChild(col);
  });

  fb.appendChild(strRow);
}

// â”€â”€ Update All Display â”€â”€
function updateDisplay(redrawFret = true) {
  const rn = document.getElementById('rootNote');
  rn.textContent = notes[selectedNote];
  rn.style.backgroundColor = colors[selectedNote];
  rn.style.color = '#000';
  document.getElementById('legendRoot').textContent = notes[selectedNote];
  document.getElementById('legendMode').textContent  = notes[selectedNote] + ' ' + modeNames[currentMode];
  drawWheel();
  if (redrawFret) drawFretboard();
}

// â”€â”€ Spin â”€â”€
let isDragging = false, lastDragAngle = 0, dragSpeed = 0;

function getWheelAngle(x, y) {
  const r = document.getElementById('rouletteWheel').getBoundingClientRect();
  return Math.atan2(y - (r.top + r.height/2), x - (r.left + r.width/2)) * 180 / Math.PI;
}

function setSpinBtns(dis) {
  ['spinCCW','spinCW','spinRandom'].forEach(id => document.getElementById(id).disabled = dis);
}

function spin(dir) {
  if (isSpinning) return;
  clearPlayState();
  initAudio();
  spinSpeed = dir * (14 + Math.random() * 10);
  isSpinning = true;
  setSpinBtns(true);
  animateSpin();
}

function animateSpin() {
  if (!isSpinning) return;
  currentRot = ((currentRot + spinSpeed) % 360 + 360) % 360;
  const np = Math.round(((currentRot - 60) / 30 % 12 + 12) % 12);
  if (np !== selectedNote) {
    selectedNote = np;
    playNote(MIDI_C4 + selectedNote, 0.08);
    updateDisplay(false);
  }
  spinSpeed *= 0.963;
  drawWheel();
  if (Math.abs(spinSpeed) < 0.18) {
    isSpinning = false; spinSpeed = 0;
    currentRot = Math.round(currentRot / 30) * 30;
    setSpinBtns(false);
    updateDisplay(true);
  } else {
    requestAnimationFrame(animateSpin);
  }
}

// Drag to spin
const wheel = document.getElementById('rouletteWheel');
wheel.addEventListener('mousedown', e => {
  if (isSpinning) return;
  isDragging = true; dragSpeed = 0;
  lastDragAngle = getWheelAngle(e.clientX, e.clientY);
});
wheel.addEventListener('touchstart', e => {
  if (isSpinning) return;
  isDragging = true; dragSpeed = 0;
  lastDragAngle = getWheelAngle(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });
document.addEventListener('mousemove', e => { if (isDragging) doDrag(e.clientX, e.clientY); });
document.addEventListener('touchmove', e => {
  if (!isDragging) return;
  e.preventDefault();
  doDrag(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });
document.addEventListener('mouseup', endDrag);
document.addEventListener('touchend', endDrag);

function doDrag(x, y) {
  const cur = getWheelAngle(x, y);
  let d = cur - lastDragAngle;
  if (d > 180) d -= 360; if (d < -180) d += 360;
  currentRot = ((currentRot + d) % 360 + 360) % 360;
  dragSpeed = d; lastDragAngle = cur;
  const np = Math.round(((currentRot - 60) / 30 % 12 + 12) % 12);
  if (np !== selectedNote) {
    selectedNote = np;
    playNote(MIDI_C4 + selectedNote, 0.08);
    updateDisplay(false);
  }
  drawWheel();
}

function endDrag() {
  if (!isDragging) return;
  isDragging = false;
  if (Math.abs(dragSpeed) > 1.8) {
    clearPlayState();
    spinSpeed = dragSpeed * 1.4; isSpinning = true;
    setSpinBtns(true); animateSpin();
  } else {
    currentRot = Math.round(currentRot / 30) * 30;
    updateDisplay(true);
  }
}

// Keyboard on wheel
wheel.addEventListener('keydown', e => {
  if (e.key==='ArrowLeft')  { e.preventDefault(); spin(-1); }
  if (e.key==='ArrowRight') { e.preventDefault(); spin(1); }
  if (e.key===' ')          { e.preventDefault(); spin(Math.random()<0.5?-1:1); }
});

// â”€â”€ All Button Listeners â”€â”€
document.getElementById('spinCCW').addEventListener('click',    () => spin(-1));
document.getElementById('spinCW').addEventListener('click',     () => spin(1));
document.getElementById('spinRandom').addEventListener('click', () => spin(Math.random()<0.5?-1:1));

document.querySelectorAll('.btn-mode').forEach(btn => {
  btn.addEventListener('click', e => {
    clearPlayState(); initAudio();
    document.querySelectorAll('.btn-mode').forEach(b => {
      b.classList.remove('active'); b.setAttribute('aria-pressed','false');
    });
    e.currentTarget.classList.add('active');
    e.currentTarget.setAttribute('aria-pressed','true');
    currentMode = e.currentTarget.dataset.mode;
    updateDisplay(true);
    playSelection();
  });
});

document.querySelectorAll('.btn-fret').forEach(btn => {
  btn.addEventListener('click', e => {
    clearPlayState();
    document.querySelectorAll('.btn-fret').forEach(b => {
      b.classList.remove('active'); b.setAttribute('aria-pressed','false');
    });
    e.currentTarget.classList.add('active');
    e.currentTarget.setAttribute('aria-pressed','true');
    fretView = parseInt(e.currentTarget.dataset.frets);
    updateDisplay(true);
  });
});

// â”€â”€ Init â”€â”€
updateDisplay(true);
</script>
</body>
</html>
