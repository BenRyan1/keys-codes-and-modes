<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EGC5ZNZPF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-6EGC5ZNZPF');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keys, Codes & Modes - Chromatic Roulette Wheel</title>
    <style>
        /* 
        KEYS, CODES & MODES - CHROMATIC ROULETTE WHEEL
        Official Brand Color System:
        C = Yellow (#FFFF00), C#/Db = Yellow-Orange (#FFC400), D = Orange (#FF8000),
        D#/Eb = Red-Orange (#FF4000), E = Red (#FF0000), F = Red-Purple (#C4007F),
        F#/Gb = Purple (#8000FF), G = Blue-Purple (#4000FF), G#/Ab = Blue (#0000FF),
        A = Blue-Green (#007FFF), A#/Bb = Green (#00FF80), B = Yellow-Green (#80FF00)
        */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 5px;
            /* Official Keys, Codes & Modes chromatic gradient: Yellow â†’ Red â†’ Purple â†’ Blue */
            background: linear-gradient(90deg, #FFFF00, #FF8000, #FF0000, #8000FF, #0000FF, #00FF80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .app-title {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 10px;
            color: #fff;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(255,255,255,0.3);
        }
        
        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 40px;
            align-items: start;
        }
        
        /* Left Column - Roulette with buttons beside it */
        .roulette-section {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .wheel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .root-display {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .root-label {
            font-size: 1em;
            margin-bottom: 8px;
            color: #ddd;
        }
        
        .root-note {
            font-size: 3em;
            font-weight: bold;
            padding: 15px 35px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        #rouletteWheel {
            margin-bottom: 15px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            cursor: grab;
            touch-action: none;
        }
        
        #rouletteWheel:active {
            cursor: grabbing;
        }
        
        .spin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-spin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .mode-controls {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .mode-title {
            font-size: 1.1em;
            margin-bottom: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .btn-mode {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: all 0.3s;
        }
        
        .btn-mode.active {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-fret {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: all 0.3s;
        }
        
        .btn-fret.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Right Column - Guitar */
        .guitar-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
        }
        
        .guitar-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        #fretboard {
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
            background: #5d4e37;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            max-height: 700px;
            overflow-y: auto;
        }
        
        #fretboard::-webkit-scrollbar {
            width: 8px;
        }
        
        #fretboard::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        #fretboard::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        #fretboard::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .fret-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            opacity: 0.2;
            pointer-events: none;
        }
        
        .string-line {
            height: 2px;
            background: #888;
            margin: 15px 0;
            position: relative;
        }
        
        .note-dot {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #000;
            line-height: 1;
        }
        
        .note-dot:hover {
            transform: scale(1.2);
            z-index: 10;
        }
        
        .note-dot.active {
            opacity: 1;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        
        .note-dot.inactive {
            opacity: 0.2;
        }
        
        .note-dot.root {
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        
        .note-dot.playing {
            box-shadow: 0 0 20px rgba(255,255,255,0.9);
            filter: brightness(1.5);
            z-index: 100;
        }
        
        .playing-highlight {
            filter: brightness(1.5) drop-shadow(0 0 15px currentColor);
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .legend-item {
            margin: 5px 0;
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .roulette-section {
                flex-direction: column;
            }
            
            .mode-controls {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Keys, Codes & Modes</h1>
        <div class="app-title">Chromatic Roulette Wheel</div>
        <p class="subtitle">Spin the wheel, press a mode button to hear it play!</p>
        
        <div class="main-grid">
            <!-- Left: Roulette Wheel + Controls -->
            <div class="roulette-section">
                <div class="wheel-container">
                    <div class="root-display">
                        <div class="root-label">Root Note</div>
                        <div class="root-note" id="rootNote">C</div>
                    </div>
                    
                    <svg id="rouletteWheel" width="350" height="350" viewBox="0 0 400 400"></svg>
                    
                    <div class="spin-controls">
                        <button class="btn btn-spin" id="spinCCW" style="padding: 10px 20px; font-size: 0.9em;">â†º CCW</button>
                        <button class="btn btn-spin" id="spinRandom" style="padding: 10px 20px; font-size: 0.9em;">ðŸŽ²</button>
                        <button class="btn btn-spin" id="spinCW" style="padding: 10px 20px; font-size: 0.9em;">CW â†»</button>
                    </div>
                </div>
                
                <!-- Mode Controls - Beside the wheel -->
                <div class="mode-controls" style="width: 150px; padding: 15px;">
                    <div class="mode-title" style="font-size: 1.1em; margin-bottom: 12px;">Mode</div>
                    <div class="mode-buttons" style="gap: 8px;">
                        <button class="btn btn-mode active" data-mode="scale" style="padding: 10px; font-size: 0.9em;">Major Scale</button>
                        <button class="btn btn-mode" data-mode="triad" style="padding: 10px; font-size: 0.9em;">Major Triad</button>
                        <button class="btn btn-mode" data-mode="intervals" style="padding: 10px; font-size: 0.9em;">Chromatic</button>
                    </div>
                </div>
            </div>
            
            <!-- Right: Guitar Fretboard -->
            <div class="guitar-section">
                <h2 class="guitar-title">ðŸŽ¸ Guitar Fretboard</h2>
                
                <!-- Fret View Selector -->
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-fret" data-frets="3" style="padding: 8px 20px; font-size: 0.9em;">3 Frets</button>
                    <button class="btn btn-fret active" data-frets="5" style="padding: 8px 20px; font-size: 0.9em;">5 Frets</button>
                    <button class="btn btn-fret" data-frets="15" style="padding: 8px 20px; font-size: 0.9em;">15 Frets</button>
                </div>
                
                <div id="fretboard"></div>
                <div class="legend">
                    <div class="legend-item">â¬œ Root: <span id="legendRoot">C</span> | ðŸŽµ Mode: <span id="legendMode">C Major Scale</span></div>
                    <div class="legend-item">âœ¨ Bright = Active notes | ðŸ’¡ Extra bright = Playing now</div>
                    <div class="legend-item">ðŸ‘† Click any note to hear it | Press mode button to play</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const notes = ['C', 'C#/Db', 'D', 'D#/Eb', 'E', 'F', 'F#/Gb', 'G', 'G#/Ab', 'A', 'A#/Bb', 'B'];
        
        // OFFICIAL KEYS, CODES & MODES CHROMATIC COLOR SYSTEM
        // This color scheme is used consistently across all Keys, Codes & Modes applications
        const colors = [
            '#FFFF00',  // 1. C - Yellow
            '#FFC400',  // 2. C#/Db - Yellow-Orange
            '#FF8000',  // 3. D - Orange
            '#FF4000',  // 4. D#/Eb - Red-Orange
            '#FF0000',  // 5. E - Red
            '#C4007F',  // 6. F - Red-Purple
            '#8000FF',  // 7. F#/Gb - Purple
            '#4000FF',  // 8. G - Blue-Purple
            '#0000FF',  // 9. G#/Ab - Blue
            '#007FFF',  // 10. A - Blue-Green
            '#00FF80',  // 11. A#/Bb - Green
            '#80FF00'   // 12. B - Yellow-Green
        ];
        
        const midiBase = 60; // C4 (Middle C)
        
        // Guitar strings in standard tuning (MIDI numbers from bass to treble)
        const guitarStrings = [40, 45, 50, 55, 59, 64]; // E2, A2, D3, G3, B3, E4
        const stringNames = ['E', 'A', 'D', 'G', 'B', 'E'];
        
        // Scale patterns (semitones from root)
        const patterns = {
            scale: [0, 2, 4, 5, 7, 9, 11], // Major scale
            triad: [0, 4, 7],              // Major triad
            intervals: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] // All notes
        };
        
        // ===== STATE =====
        let audioContext = null;
        let currentRotation = 60; // Start with C at 12 o'clock position
        let selectedNote = 0;
        let isSpinning = false;
        let spinSpeed = 0;
        let currentMode = 'scale';
        let fretView = 5; // Default to 5 frets view
        
        // ===== AUDIO =====
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playNote(midiNote, duration = 0.3) {
            // Validate MIDI note
            if (!midiNote || !isFinite(midiNote) || midiNote < 0 || midiNote > 127) {
                console.error('Invalid MIDI note:', midiNote);
                return;
            }
            
            initAudio();
            const ctx = audioContext;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            const freq = 440 * Math.pow(2, (midiNote - 69) / 12);
            
            // Validate frequency
            if (!isFinite(freq) || freq <= 0) {
                console.error('Invalid frequency calculated:', freq, 'from MIDI:', midiNote);
                return;
            }
            
            osc.frequency.value = freq;
            osc.type = 'sine';
            
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + duration);
        }
        
        // ===== ROULETTE WHEEL =====
        function drawWheel() {
            const svg = document.getElementById('rouletteWheel');
            svg.innerHTML = '';
            
            const cx = 200, cy = 200, radius = 150;
            const activeNotes = getActiveNotes();
            
            // Draw segments (rotated 45 degrees so C is centered at 12 o'clock)
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30) - 90 - currentRotation + 45;
                const startAngle = angle * Math.PI / 180;
                const endAngle = (angle + 30) * Math.PI / 180;
                
                const x1 = cx + radius * Math.cos(startAngle);
                const y1 = cy + radius * Math.sin(startAngle);
                const x2 = cx + radius * Math.cos(endAngle);
                const y2 = cy + radius * Math.sin(endAngle);
                
                const isActive = activeNotes.includes(i);
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z`);
                path.setAttribute('fill', colors[i]);
                path.setAttribute('stroke', '#000');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('opacity', isActive ? '1' : '0.3');
                svg.appendChild(path);
                
                // Note labels
                const labelAngle = (angle + 15) * Math.PI / 180;
                const labelX = cx + 110 * Math.cos(labelAngle);
                const labelY = cy + 110 * Math.sin(labelAngle);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', labelX);
                text.setAttribute('y', labelY);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', '#000');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('font-size', '14');
                text.textContent = notes[i];
                svg.appendChild(text);
            }
            
            // Center circle
            const center = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            center.setAttribute('cx', cx);
            center.setAttribute('cy', cy);
            center.setAttribute('r', '40');
            center.setAttribute('fill', '#333');
            center.setAttribute('stroke', '#FFD700');
            center.setAttribute('stroke-width', '4');
            svg.appendChild(center);
            
            // Pointer at 12 o'clock
            const pointer = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            pointer.setAttribute('points', '200,20 190,40 210,40');
            pointer.setAttribute('fill', '#FFD700');
            svg.appendChild(pointer);
        }
        
        // ===== SPINNING =====
        let targetRotation = null;
        let isDragging = false;
        let lastAngle = 0;
        let dragSpeed = 0;
        
        function spin(direction) {
            if (isSpinning) return;
            initAudio();
            
            // Random spin: 3-7 full rotations plus random final position
            const fullRotations = (3 + Math.random() * 4) * 360;
            const randomFinalNote = Math.floor(Math.random() * 12);
            const finalPosition = randomFinalNote * 30 + 60; // +60 for the offset
            
            targetRotation = currentRotation + (direction * fullRotations) + finalPosition;
            spinSpeed = direction * 20;
            isSpinning = true;
            animateSpin();
        }
        
        function animateSpin() {
            if (!isSpinning) return;
            
            // Disable buttons during spin
            document.getElementById('spinCCW').disabled = true;
            document.getElementById('spinCW').disabled = true;
            document.getElementById('spinRandom').disabled = true;
            
            currentRotation += spinSpeed;
            currentRotation = ((currentRotation % 360) + 360) % 360;
            
            // Update selected note (accounting for 45-degree display offset)
            const notePosition = (currentRotation - 60) / 30;
            const newNote = (Math.round(notePosition) % 12 + 12) % 12;
            if (newNote !== selectedNote) {
                selectedNote = newNote;
                playNote(midiBase + selectedNote, 0.1);
                updateDisplay();
            }
            
            // Slow down with easing
            spinSpeed *= 0.96;
            
            if (Math.abs(spinSpeed) < 0.2) {
                isSpinning = false;
                spinSpeed = 0;
                // Snap to nearest 30-degree position
                currentRotation = Math.round(currentRotation / 30) * 30;
                targetRotation = null;
                // Re-enable buttons
                document.getElementById('spinCCW').disabled = false;
                document.getElementById('spinCW').disabled = false;
                document.getElementById('spinRandom').disabled = false;
                updateDisplay();
            } else {
                requestAnimationFrame(animateSpin);
            }
            
            drawWheel();
        }
        
        // ===== FREE SPIN WITH DRAG =====
        function getAngle(x, y) {
            const svg = document.getElementById('rouletteWheel');
            const rect = svg.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
        }
        
        function startDrag(e) {
            if (isSpinning) return;
            isDragging = true;
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const y = e.clientY || (e.touches && e.touches[0].clientY);
            lastAngle = getAngle(x, y);
            dragSpeed = 0;
        }
        
        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const y = e.clientY || (e.touches && e.touches[0].clientY);
            const currentAngle = getAngle(x, y);
            
            let deltaAngle = currentAngle - lastAngle;
            
            // Handle angle wrapping
            if (deltaAngle > 180) deltaAngle -= 360;
            if (deltaAngle < -180) deltaAngle += 360;
            
            currentRotation += deltaAngle;
            dragSpeed = deltaAngle;
            lastAngle = currentAngle;
            
            // Update selected note
            currentRotation = ((currentRotation % 360) + 360) % 360;
            const notePosition = (currentRotation - 60) / 30;
            const newNote = (Math.round(notePosition) % 12 + 12) % 12;
            if (newNote !== selectedNote) {
                selectedNote = newNote;
                playNote(midiBase + selectedNote, 0.1);
                updateDisplay();
            }
            
            drawWheel();
        }
        
        function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            
            // Add momentum to the wheel
            if (Math.abs(dragSpeed) > 2) {
                initAudio();
                spinSpeed = dragSpeed * 1.5;
                isSpinning = true;
                animateSpin();
            } else {
                // Snap to nearest position
                currentRotation = Math.round(currentRotation / 30) * 30;
                updateDisplay();
            }
        }
        
        // ===== NOTE LOGIC =====
        function getActiveNotes() {
            const pattern = patterns[currentMode];
            return pattern.map(interval => (selectedNote + interval) % 12);
        }
        
        function isNoteActive(noteIndex) {
            return getActiveNotes().includes(noteIndex % 12);
        }
        
        // ===== FRETBOARD =====
        function drawFretboard() {
            const fretboard = document.getElementById('fretboard');
            fretboard.innerHTML = '';
            
            const numFrets = fretView;
            const fretHeight = 50;
            const activeNotes = getActiveNotes();
            
            // String labels
            const stringLabels = document.createElement('div');
            stringLabels.style.cssText = 'display: flex; justify-content: space-around; margin-bottom: 10px; font-weight: bold; font-size: 0.85em;';
            stringNames.forEach(name => {
                const label = document.createElement('div');
                label.textContent = name;
                label.style.width = '38px';
                label.style.textAlign = 'center';
                stringLabels.appendChild(label);
            });
            fretboard.appendChild(stringLabels);
            
            // Container for all strings
            const stringsContainer = document.createElement('div');
            stringsContainer.style.cssText = 'display: flex; position: relative;';
            
            // Draw fret markers only if they're within the view range
            const singleMarkerFrets = [3, 5, 7, 9];
            const doubleMarkerFrets = [12, 15];
            
            singleMarkerFrets.forEach(fret => {
                if (fret <= numFrets) {
                    const marker = document.createElement('div');
                    marker.className = 'fret-marker';
                    marker.style.cssText = `position: absolute; left: 50%; top: ${fret * fretHeight + 10}px; transform: translateX(-50%);`;
                    stringsContainer.appendChild(marker);
                }
            });
            
            doubleMarkerFrets.forEach(fret => {
                if (fret <= numFrets) {
                    const marker1 = document.createElement('div');
                    marker1.className = 'fret-marker';
                    marker1.style.cssText = `position: absolute; left: 35%; top: ${fret * fretHeight + 10}px;`;
                    stringsContainer.appendChild(marker1);
                    
                    const marker2 = document.createElement('div');
                    marker2.className = 'fret-marker';
                    marker2.style.cssText = `position: absolute; left: 65%; top: ${fret * fretHeight + 10}px;`;
                    stringsContainer.appendChild(marker2);
                }
            });
            
            // Draw strings with notes
            guitarStrings.forEach((stringMidi, stringIndex) => {
                const stringContainer = document.createElement('div');
                stringContainer.style.cssText = `position: relative; height: ${fretHeight * numFrets}px; width: 38px; margin-right: 2px;`;
                
                // String line
                const line = document.createElement('div');
                line.className = 'string-line';
                line.style.cssText = 'position: absolute; left: 50%; transform: translateX(-50%); width: 2px; height: 100%; background: #888;';
                stringContainer.appendChild(line);
                
                // Draw notes
                for (let fret = 0; fret <= numFrets; fret++) {
                    const noteMidi = stringMidi + fret;
                    const noteIndex = noteMidi % 12;
                    const isActive = activeNotes.includes(noteIndex);
                    const isRoot = noteIndex === selectedNote;
                    
                    const dot = document.createElement('div');
                    dot.className = 'note-dot';
                    dot.setAttribute('data-midi', noteMidi);
                    if (isActive) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.add('inactive');
                    }
                    if (isRoot) {
                        dot.classList.add('root');
                    }
                    
                    dot.style.backgroundColor = colors[noteIndex];
                    dot.style.left = '50%';
                    dot.style.transform = 'translateX(-50%)';
                    dot.style.top = `${fret === 0 ? 5 : fret * fretHeight - 12}px`;
                    dot.textContent = notes[noteIndex];
                    dot.onclick = () => {
                        if (isFinite(noteMidi) && noteMidi >= 0 && noteMidi <= 127) {
                            playNote(noteMidi, 0.5);
                        }
                    };
                    
                    stringContainer.appendChild(dot);
                }
                
                stringsContainer.appendChild(stringContainer);
            });
            
            fretboard.appendChild(stringsContainer);
        }
        
        // ===== UPDATE DISPLAY =====
        function updateDisplay() {
            // Update root note display
            const rootNoteEl = document.getElementById('rootNote');
            rootNoteEl.textContent = notes[selectedNote];
            rootNoteEl.style.backgroundColor = colors[selectedNote];
            
            // Update legend
            document.getElementById('legendRoot').textContent = notes[selectedNote];
            const modeNames = {
                scale: 'Major Scale',
                triad: 'Major Triad',
                intervals: 'Chromatic'
            };
            document.getElementById('legendMode').textContent = notes[selectedNote] + ' ' + modeNames[currentMode];
            
            // Redraw everything
            drawWheel();
            drawFretboard();
        }
        
        // ===== PLAY SELECTION =====
        function highlightNote(noteIndex, duration = 500) {
            // Validate noteIndex
            if (!isFinite(noteIndex) || noteIndex < 0 || noteIndex > 11) {
                console.error('Invalid note index:', noteIndex);
                return;
            }
            
            // Highlight on wheel
            const wheelSegments = document.querySelectorAll('#rouletteWheel path');
            if (wheelSegments[noteIndex]) {
                wheelSegments[noteIndex].classList.add('playing-highlight');
                setTimeout(() => {
                    wheelSegments[noteIndex].classList.remove('playing-highlight');
                }, duration);
            }
            
            // Highlight on fretboard
            const fretboardDots = document.querySelectorAll('.note-dot');
            fretboardDots.forEach(dot => {
                const midiAttr = dot.getAttribute('data-midi');
                if (midiAttr) {
                    const dotMidi = parseInt(midiAttr, 10);
                    if (isFinite(dotMidi) && dotMidi % 12 === noteIndex) {
                        dot.classList.add('playing');
                        setTimeout(() => {
                            dot.classList.remove('playing');
                        }, duration);
                    }
                }
            });
        }
        
        function playSelection() {
            initAudio();
            const rootMidi = midiBase + selectedNote;
            const pattern = patterns[currentMode];
            
            if (currentMode === 'triad') {
                // Play chord - all notes simultaneously with visual feedback
                pattern.forEach(interval => {
                    const noteIndex = (selectedNote + interval) % 12;
                    playNote(rootMidi + interval, 1.0);
                    highlightNote(noteIndex, 1000);
                });
            } else {
                // Play scale/intervals - sequential with visual feedback
                pattern.forEach((interval, i) => {
                    setTimeout(() => {
                        const noteIndex = (selectedNote + interval) % 12;
                        playNote(rootMidi + interval, 0.5);
                        highlightNote(noteIndex, 500);
                    }, i * 300);
                });
            }
        }
        
        // ===== EVENT LISTENERS =====
        document.getElementById('spinCCW').addEventListener('click', () => spin(-1));
        document.getElementById('spinCW').addEventListener('click', () => spin(1));
        document.getElementById('spinRandom').addEventListener('click', () => {
            const randomDirection = Math.random() < 0.5 ? -1 : 1;
            spin(randomDirection);
        });
        
        // Drag/touch events for free spin
        const wheel = document.getElementById('rouletteWheel');
        wheel.addEventListener('mousedown', startDrag);
        wheel.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
        
        document.querySelectorAll('.btn-mode').forEach(btn => {
            btn.addEventListener('click', (e) => {
                initAudio(); // Ensure audio is initialized
                document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentMode = e.target.dataset.mode;
                updateDisplay();
                // Auto-play immediately when mode button is pressed
                playSelection();
            });
        });
        
        document.querySelectorAll('.btn-fret').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.btn-fret').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                fretView = parseInt(e.target.dataset.frets);
                updateDisplay();
            });
        });
        
        // ===== INITIALIZE =====
        updateDisplay();
    </script>
</body>
</html>