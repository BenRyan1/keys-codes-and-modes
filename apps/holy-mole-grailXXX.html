<!DOCTYPE html>
<html lang="en" dir="ltr" itemscope itemtype="https://schema.org/WebApplication">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- PRIMARY SEO -->
    <title>Holy Grail Chromatic Wheel | Keys, Codes &amp; Modes - Interactive Music Theory</title>
    <meta name="description" content="Interactive chromatic music theory wheel visualizing all 12 keys, scales, modes, and chords with color-coded audio playback. Created by Benjamin Ryan. Keys, Codes &amp; Modes - Santa Barbara, California.">
    <meta name="keywords" content="music theory, chromatic wheel, circle of fifths, scales, modes, chords, interactive music education, keys codes modes, Benjamin Ryan, FreeStyle musical device, Santa Barbara">
    <meta name="author" content="Benjamin Ryan">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">
    <meta name="theme-color" content="#0f0e17">
    <meta name="color-scheme" content="dark">
    <link rel="canonical" href="https://www.keyscodesandmodes.com/holy-grail">

    <!-- OPEN GRAPH -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Keys, Codes &amp; Modes">
    <meta property="og:title" content="Holy Grail Chromatic Wheel - Interactive Music Theory">
    <meta property="og:description" content="Explore all 12 keys, scales, modes, and chords on an interactive color-coded chromatic wheel. Visual music education by Benjamin Ryan.">
    <meta property="og:url" content="https://www.keyscodesandmodes.com/holy-grail">
    <meta property="og:image" content="https://www.keyscodesandmodes.com/images/holy-grail-og.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Keys, Codes and Modes chromatic wheel showing all 12 notes in rainbow colors">
    <meta property="og:locale" content="en_US">

    <!-- TWITTER / X CARD -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@keyscodesandmodes">
    <meta name="twitter:creator" content="@keyscodesandmodes">
    <meta name="twitter:title" content="Holy Grail Chromatic Wheel - Keys, Codes &amp; Modes">
    <meta name="twitter:description" content="Interactive chromatic music theory wheel. All 12 keys, scales, modes and chords with color-coded audio.">
    <meta name="twitter:image" content="https://www.keyscodesandmodes.com/images/holy-grail-og.jpg">
    <meta name="twitter:image:alt" content="Chromatic wheel visualization with 12 color-coded notes">

    <!-- STRUCTURED DATA JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Holy Grail Chromatic Wheel",
      "description": "Interactive chromatic music theory wheel for visualizing scales, modes, chords, and keys with color-coded audio playback.",
      "url": "https://www.keyscodesandmodes.com/holy-grail",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web Browser",
      "inLanguage": "en-US",
      "isAccessibleForFree": true,
      "creator": {
        "@type": "Person",
        "name": "Benjamin Ryan",
        "sameAs": ["https://www.linkedin.com/in/ben-ryan-guitar-freestyle/","https://x.com/keyscodesandmodes"]
      },
      "publisher": {
        "@type": "Organization",
        "name": "Keys, Codes and Modes",
        "url": "https://www.keyscodesandmodes.com",
        "sameAs": ["https://www.facebook.com/KeysCodesModes","https://x.com/keyscodesandmodes","https://www.instagram.com/keyscodesandmodes/","https://www.tiktok.com/@keyscodesandmodes","https://www.linkedin.com/in/ben-ryan-guitar-freestyle/"]
      },
      "copyrightYear": "2026",
      "educationalUse": "Music Theory Visualization",
      "audience": { "@type": "Audience", "audienceType": "Musicians, Music Students, Music Educators" }
    }
    </script>

    <!-- PRELOAD TONE.JS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" as="script" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0e17 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 2rem 2rem;
            border-bottom: 3px solid #0f3460;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .hero-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .hero-logo-img {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0 20px rgba(233, 69, 96, 0.4));
        }
        
        .hero-logo-img svg {
            width: 100%;
            height: 100%;
        }
        
        .brand-text {
            text-align: center;
            margin-left: 1.5rem;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(90deg, #e94560, #0f3460, #16213e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #e94560;
            font-size: 1rem;
            font-weight: 600;
            margin: 0.5rem 0 0 0;
            letter-spacing: 1px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 150px);
            min-height: 700px;
        }
        
        .controls-panel {
            background: linear-gradient(135deg, rgba(10,12,28,0.97) 0%, rgba(18,22,45,0.97) 100%);
            border-radius: 16px;
            padding: 1.2rem;
            border: 2px solid rgba(233,69,96,0.5);
            box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 30px rgba(233,69,96,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        /* ‚îÄ‚îÄ AUDIO BUTTON ‚îÄ‚îÄ */
        #audioBtn {
            width: 100%;
            padding: 0.85rem;
            font-size: 1rem;
            font-weight: 900;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: #fff;
            letter-spacing: 1px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231,76,60,0.4);
        }
        #audioBtn:hover { background: linear-gradient(135deg, #e74c3c, #ff6b6b); transform: translateY(-1px); }
        #audioBtn.success { background: linear-gradient(135deg, #27ae60, #2ecc71); box-shadow: 0 4px 15px rgba(46,204,113,0.4); }

        /* ‚îÄ‚îÄ DROPDOWN GROUPS ‚îÄ‚îÄ */
        .dd-group {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            overflow: hidden;
        }
        .dd-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.65rem 0.9rem;
            cursor: pointer;
            background: linear-gradient(90deg, rgba(233,69,96,0.15), rgba(233,69,96,0.05));
            border-bottom: 1px solid rgba(233,69,96,0.2);
            user-select: none;
            transition: background 0.2s;
        }
        .dd-header:hover { background: linear-gradient(90deg, rgba(233,69,96,0.28), rgba(233,69,96,0.1)); }
        .dd-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #e94560;
        }
        .dd-arrow {
            font-size: 0.7rem;
            color: #e94560;
            transition: transform 0.3s;
        }
        .dd-group.open .dd-arrow { transform: rotate(180deg); }
        .dd-body {
            display: none;
            padding: 0.7rem;
            flex-direction: column;
            gap: 0.4rem;
        }
        .dd-group.open .dd-body { display: flex; }

        /* ‚îÄ‚îÄ COOL SELECT ‚îÄ‚îÄ */
        .cool-select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            font-size: 0.95rem;
            font-weight: 700;
            border-radius: 8px;
            border: 2px solid rgba(233,69,96,0.5);
            background: linear-gradient(135deg, rgba(22,33,62,0.95), rgba(15,20,45,0.95));
            color: #fff;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23e94560' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            padding-right: 2.2rem;
            transition: all 0.2s;
        }
        .cool-select:hover, .cool-select:focus {
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233,69,96,0.2);
            outline: none;
        }
        .cool-select option { background: #1a1a2e; color: #fff; }

        /* ‚îÄ‚îÄ KEY DISPLAY ‚îÄ‚îÄ */
        .key-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0.5rem 0.8rem;
            background: rgba(233,69,96,0.08);
            border-radius: 8px;
            border: 1px solid rgba(233,69,96,0.3);
        }
        .key-display-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        #currentKeyText { font-size: 1.6rem; font-weight: 900; color: #e94560; line-height: 1; }

        /* ‚îÄ‚îÄ ROTATE GRID ‚îÄ‚îÄ */
        .rotate-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
        }

        /* ‚îÄ‚îÄ COOL BUTTONS ‚îÄ‚îÄ */
        .cool-btn {
            padding: 0.6rem 0.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.12);
            background: linear-gradient(135deg, rgba(40,50,70,0.9), rgba(25,35,55,0.9));
            color: #ddd;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }
        .cool-btn:hover {
            background: linear-gradient(135deg, rgba(60,75,100,0.95), rgba(40,55,80,0.95));
            border-color: #F4D03F;
            color: #F4D03F;
            transform: translateY(-1px);
        }
        .cool-btn.active {
            background: linear-gradient(135deg, #F4D03F, #f39c12);
            color: #000;
            border-color: #F4D03F;
            font-weight: 900;
        }
        .cool-btn.wide { grid-column: span 2; }

        /* ‚îÄ‚îÄ SPEED SLIDER ‚îÄ‚îÄ */
        .speed-wrap { padding: 0.2rem 0; }
        .speed-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: #666; margin-bottom: 0.3rem; }
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg, #e94560, #F4D03F);
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; height: 16px;
            border-radius: 50%;
            background: #F4D03F;
            cursor: pointer;
            box-shadow: 0 0 6px rgba(244,208,63,0.6);
        }
        #speedDisplay { text-align: center; font-size: 0.72rem; color: #e94560; margin-top: 0.3rem; font-weight: 700; }

        /* ‚îÄ‚îÄ PLAY BUTTONS ROW ‚îÄ‚îÄ */
        .play-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
        .play-row .cool-btn.span1 { grid-column: span 1; }

        /* ‚îÄ‚îÄ STENCIL PILLS ‚îÄ‚îÄ */
        .pill-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
        .pill {
            padding: 0.35rem 0.7rem;
            border-radius: 20px;
            border: 1px solid rgba(233,69,96,0.4);
            background: rgba(233,69,96,0.08);
            color: #ccc;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .pill:hover { background: rgba(233,69,96,0.25); border-color: #e94560; color: #fff; transform: translateY(-1px); }
        .pill.active { background: linear-gradient(135deg, #e94560, #c0392b); border-color: #e94560; color: #fff; box-shadow: 0 3px 10px rgba(233,69,96,0.4); }

        /* hide old section-title / help-text */
        .section-title, .help-text { display: none; }
        .rotate-controls { display: none; }
        
        /* LAYER 1: Panel container */
        .wheel-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 700px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 50% 50%, rgba(22, 33, 62, 0.3) 0%, rgba(15, 14, 23, 0.6) 100%);
            border-radius: 24px;
            border: 3px solid #e94560;
            box-shadow: 0 0 40px rgba(233, 69, 96, 0.3);
            overflow: visible;
            padding: 0;
            margin: 0;
        }
        
        /* LAYER 2: Subdued circle background */
        .wheel-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 470px;
            height: 470px;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 50%, rgba(10, 15, 26, 0.9) 0%, rgba(26, 35, 50, 0.5) 100%);
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        
        /* LAYER 3: SVG with notes/spokes/wedges - ABSOLUTELY LOCKED */
        #holyGrailSVG {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            display: block;
            margin: 0;
            padding: 0;
        }
        
        .section-title {
            color: #e94560;
            font-size: 0.9rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 1.2rem 0 0.6rem 0;
            padding-bottom: 0.4rem;
            border-bottom: 2px solid #e94560;
            text-align: center;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        button {
            background: linear-gradient(135deg, #2a3a4f 0%, #1a2a3f 100%);
            color: #fff;
            border: 2px solid #3a4a5f;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        button:hover {
            background: linear-gradient(135deg, #3a4a5f 0%, #2a3a4f 100%);
            border-color: #FFFF00;
        }
        
        button.active {
            background: linear-gradient(135deg, #FFFF00 0%, #FFD700 100%);
            color: #000;
            border-color: #FFFF00;
            font-weight: 900;
        }
        
        button.primary {
            background: linear-gradient(135deg, #FFFF00 0%, #FFD700 100%);
            color: #000;
            font-weight: 900;
            font-size: 1rem;
            padding: 0.9rem;
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
        }
        
        .help-text {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid rgba(233, 69, 96, 0.3);
            padding: 0.7rem;
            border-radius: 8px;
            color: #e94560;
            font-size: 0.82rem;
            line-height: 1.3;
            margin: 0.8rem 0;
            text-align: center;
        }
        
        .note-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .note-node:hover {
            filter: brightness(1.2);
        }
        
        .note-node.active {
            filter: brightness(1.8) drop-shadow(0 0 8px currentColor);
            stroke: #ffffff;
            stroke-width: 2; /* Thicker outline instead of scaling */
            /* NO transform - prevents jumping! */
        }
        
        .note-node.playing {
            filter: brightness(2.5) drop-shadow(0 0 12px currentColor);
            stroke: #ffffff;
            stroke-width: 3; /* Thicker outline for playing */
            transition: all 0.1s ease-out;
            /* NO transform - prevents jumping! */
        }
        
        .note-label {
            pointer-events: none;
            user-select: none;
        }
        
        .rotate-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        footer {
            background: linear-gradient(135deg, rgba(15,15,30,0.98), rgba(26,26,46,0.98));
            border-top: 3px solid #008080;
            padding: 2rem;
            margin-top: 0;
            text-align: center;
        }
        .footer-inner {
            max-width: 900px;
            margin: 0 auto;
        }
        .footer-brand {
            margin-bottom: 1.2rem;
        }
        .footer-brand-name {
            font-size: 1.1rem;
            font-weight: 800;
            color: #F4D03F;
            letter-spacing: 1px;
        }
        .footer-tagline {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 0.2rem;
        }
        .footer-social {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.2rem 0;
        }
        .footer-social a {
            display: flex;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(0,128,128,0.2), rgba(0,128,128,0.1));
            border: 2px solid #008080;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            text-decoration: none;
        }
        .footer-social a:hover {
            background: linear-gradient(135deg, rgba(0,128,128,0.5), rgba(0,128,128,0.3));
            border-color: #F4D03F;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,128,128,0.4);
        }
        .footer-social svg {
            fill: #E8E8E8;
            transition: fill 0.3s;
        }
        .footer-social a:hover svg { fill: #F4D03F; }
        .footer-divider {
            border: none;
            border-top: 1px solid rgba(0,128,128,0.3);
            margin: 1rem 0;
        }
        .footer-copy {
            font-size: 0.82rem;
            color: #bbb;
            line-height: 1.7;
        }
        .footer-copy .highlight { color: #F4D03F; font-weight: 600; }
        .footer-copy .freestyle { color: #00BFFF; }
        
                /* === ADA / WCAG 2.1 AA === */
        .skip-nav {
            position: absolute;
            top: -100px;
            left: 1rem;
            background: #F4D03F;
            color: #000;
            font-weight: 900;
            padding: 0.6rem 1.2rem;
            border-radius: 0 0 8px 8px;
            z-index: 9999;
            text-decoration: none;
            font-size: 0.9rem;
            transition: top 0.2s;
        }
        .skip-nav:focus { top: 0; outline: 3px solid #e94560; }
        :focus-visible { outline: 3px solid #F4D03F; outline-offset: 3px; border-radius: 4px; }
        button:focus-visible, select:focus-visible, input[type=range]:focus-visible { outline: 3px solid #F4D03F; outline-offset: 2px; }
        a:focus-visible { outline: 3px solid #F4D03F; outline-offset: 4px; border-radius: 50%; }
        :focus:not(:focus-visible) { outline: none; }
        button, .pill, .cool-btn { min-height: 44px; }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
        }
        @media (forced-colors: active) {
            button, .pill, .cool-btn { border: 2px solid ButtonText; }
        }
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; height: auto; }
            .wheel-container { min-height: 400px; }
            h1 { font-size: 1.6rem; }
        }
        @media (max-width: 480px) {
            header { padding: 1rem; }
            .hero-brand { flex-direction: column; gap: 1rem; }
            .container { padding: 0.75rem; gap: 0.75rem; }
        }
        @media print {
            .controls-panel, #audioBtn, .footer-social { display: none; }
            body { background: white; color: black; }
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a2a3f;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #FFFF00;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Skip Navigation - WCAG 2.4.1 -->
    <a href="#main-content" class="skip-nav">Skip to main content</a>
    <a href="#controls-panel" class="skip-nav" style="left:12rem;">Skip to controls</a>

    <header role="banner" aria-label="Keys, Codes and Modes application header">
        <div class="hero-brand">
            <div class="hero-logo-img" role="img" aria-label="Keys, Codes and Modes logo">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                    <circle cx="100" cy="100" r="98" fill="#4A7BA7" stroke="#2a4d6f" stroke-width="1"/>
                    <polygon points="100,15 185,185 15,185" fill="#F4D03F" opacity="0.85"/>
                    <polygon points="100,15 15,185 15,55" fill="#8B6BA3" opacity="0.75"/>
                    <polygon points="100,15 185,55 185,185" fill="#6FA5A5" opacity="0.75"/>
                    <polygon points="15,55 100,100 15,185" fill="#CF7A5A" opacity="0.65"/>
                    <polygon points="185,55 100,100 185,185" fill="#9AAF7A" opacity="0.65"/>
                    <polygon points="100,55 145,100 100,145 55,100" fill="#E8D77F" opacity="0.6"/>
                    <circle cx="100" cy="100" r="50" fill="none" stroke="#2a4d6f" stroke-width="2.5"/>
                    <circle cx="100" cy="100" r="7" fill="#2a4d6f"/>
                    <line x1="40" y1="40" x2="160" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                    <line x1="160" y1="40" x2="40" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                    <line x1="100" y1="20" x2="100" y2="180" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                    <line x1="20" y1="100" x2="180" y2="100" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                </svg>
            </div>
            <div class="brand-text">
                <h1 itemprop="name">KEYS, CODES &amp; MODES</h1>
                <p class="subtitle" itemprop="description">The Holy Grail ‚Äî Chromatic Visualization</p>
            </div>
        </div>
    </header>

    <main id="main-content" role="main" aria-label="Holy Grail chromatic music theory wheel application">
    <div class="container">
        <!-- WHEEL - LEFT -->
        <div class="wheel-container">
            <svg id="holyGrailSVG" width="450" height="450" viewBox="0 0 450 450"></svg>
        </div>

        <!-- CONTROLS - RIGHT -->
        <div class="controls-panel">
            <!-- AUDIO -->
            <button id="audioBtn" aria-label="Start audio engine ‚Äî required before playing notes" aria-pressed="false">üî¥ START AUDIO</button>

            <!-- KEY + DISPLAY -->
            <div class="dd-group open" id="dd-key">
                <div class="dd-header" onclick="toggleDD('dd-key')" aria-expanded="true" aria-controls="dd-key-body" id="dd-key-header">
                    <span class="dd-header-left">üéπ Select Key</span>
                    <span class="dd-arrow">‚ñº</span>
                </div>
                <div class="dd-body">
                    <select id="keySelector" class="cool-select" aria-label="Select root key to display at 12 o'clock position">
                        <option value="0">C</option>
                        <option value="1">C‚ôØ / D‚ô≠</option>
                        <option value="2">D</option>
                        <option value="3">D‚ôØ / E‚ô≠</option>
                        <option value="4">E</option>
                        <option value="5">F</option>
                        <option value="6">F‚ôØ / G‚ô≠</option>
                        <option value="7">G</option>
                        <option value="8">G‚ôØ / A‚ô≠</option>
                        <option value="9">A</option>
                        <option value="10">A‚ôØ / B‚ô≠</option>
                        <option value="11">B</option>
                    </select>
                    <div class="key-display">
                        <span class="key-display-label">12 O'Clock ‚ñ∏</span>
                        <span id="currentKeyText">C</span>
                    </div>
                </div>
            </div>

            <!-- ROTATE -->
            <div class="dd-group open" id="dd-rotate">
                <div class="dd-header" onclick="toggleDD('dd-rotate')" aria-expanded="true" aria-controls="dd-rotate-body" id="dd-rotate-header">
                    <span class="dd-header-left">üîÑ Rotate</span>
                    <span class="dd-arrow">‚ñº</span>
                </div>
                <div class="dd-body">
                    <div class="rotate-grid">
                        <button id="rotateLeftBtn" class="cool-btn" aria-label="Rotate wheel left ‚Äî move previous note to 12 o'clock">‚óÄ Left</button>
                        <button id="rotateRightBtn" class="cool-btn" aria-label="Rotate wheel right ‚Äî move next note to 12 o'clock">Right ‚ñ∂</button>
                        <button id="autoRotateBtn" class="cool-btn" aria-label="Toggle automatic rotation" aria-pressed="false">üîÑ Auto</button>
                        <button id="resetBtn" class="cool-btn" aria-label="Reset wheel to C at 12 o'clock">‚≠ï Reset</button>
                    </div>
                </div>
            </div>

            <!-- PLAYBACK -->
            <div class="dd-group open" id="dd-play">
                <div class="dd-header" onclick="toggleDD('dd-play')" aria-expanded="true" aria-controls="dd-play-body" id="dd-play-header">
                    <span class="dd-header-left">‚ñ∂Ô∏è Playback</span>
                    <span class="dd-arrow">‚ñº</span>
                </div>
                <div class="dd-body">
                    <div class="rotate-grid">
                        <button id="autoPlayChordBtn" class="cool-btn active" aria-label="Auto-play mode: chord ‚Äî play all pattern notes simultaneously" aria-pressed="true">üéπ Chord</button>
                        <button id="autoPlayArpeggioBtn" class="cool-btn" aria-label="Auto-play mode: arpeggio ‚Äî play pattern notes sequentially" aria-pressed="false">üéµ Arpeggio</button>
                        <button id="playBtn" class="cool-btn" aria-label="Play selected notes as a chord">‚ñ∂ Play</button>
                        <button id="arpeggioBtn" class="cool-btn" aria-label="Play selected notes as ascending arpeggio">‚Üë Arp Up</button>
                        <button id="arpeggioDownBtn" class="cool-btn" aria-label="Play selected notes as descending arpeggio">‚Üì Arp Down</button>
                        <button id="clearBtn" class="cool-btn" aria-label="Clear all selected notes and reset pattern">‚úñ Clear</button>
                    </div>
                    <div class="speed-wrap">
                        <div class="speed-labels"><span>‚óÄ Slow</span><span>Fast ‚ñ∂</span></div>
                        <input type="range" id="speedControl" min="50" max="400" value="300" step="10" aria-label="Playback speed" aria-valuemin="50" aria-valuemax="400" aria-valuenow="300" aria-valuetext="150 milliseconds per note">
                        <div id="speedDisplay">150ms / note</div>
                    </div>
                </div>
            </div>

            <!-- SCALES -->
            <div class="dd-group open" id="dd-scales">
                <div class="dd-header" onclick="toggleDD('dd-scales')" aria-expanded="true" aria-controls="dd-scales-body" id="dd-scales-header">
                    <span class="dd-header-left">üéº Scales</span>
                    <span class="dd-arrow">‚ñº</span>
                </div>
                <div class="dd-body">
                    <div class="pill-grid">
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="major">Major</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="minor">Minor</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="harmonic">Harmonic</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="melodic">Melodic</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="pentatonic">Pentatonic</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="blues">Blues</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="chromatic">Chromatic</button>
                    </div>
                </div>
            </div>

            <!-- MODES -->
            <div class="dd-group open" id="dd-modes">
                <div class="dd-header" onclick="toggleDD('dd-modes')" aria-expanded="true" aria-controls="dd-modes-body" id="dd-modes-header">
                    <span class="dd-header-left">üéµ Modes</span>
                    <span class="dd-arrow">‚ñº</span>
                </div>
                <div class="dd-body">
                    <div class="pill-grid">
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="ionian">Ionian</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="dorian">Dorian</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="phrygian">Phrygian</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="lydian">Lydian</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="mixolydian">Mixolydian</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="aeolian">Aeolian</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="locrian">Locrian</button>
                    </div>
                </div>
            </div>

            <!-- CHORDS -->
            <div class="dd-group open" id="dd-chords">
                <div class="dd-header" onclick="toggleDD('dd-chords')" aria-expanded="true" aria-controls="dd-chords-body" id="dd-chords-header">
                    <span class="dd-header-left">üé∏ Chords</span>
                    <span class="dd-arrow">‚ñº</span>
                </div>
                <div class="dd-body">
                    <div class="pill-grid">
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="major-chord">Major</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="minor-chord">Minor</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="dim">Dim</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="aug">Aug</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="dom7">Dom 7</button>
                        <button class="pill stencil-btn" aria-pressed="false" data-pattern="maj7">Maj 7</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <footer role="contentinfo" aria-label="Footer">
        <div class="footer-inner">
            <div class="footer-brand">
                <div class="footer-brand-name">KEYS, CODES &amp; MODES</div>
                <div class="footer-tagline" itemprop="description">Santa Barbara, California &nbsp;‚Ä¢&nbsp; Based on the book <em>"Keys, Codes, and Modes"</em></div>
            </div>

            <div class="footer-social">
                <!-- X / Twitter -->
                <a href="https://x.com/keyscodesandmodes" target="_blank" rel="noopener noreferrer" aria-label="Follow on X">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>
                <!-- Facebook -->
                <a href="https://www.facebook.com/KeysCodesModes" target="_blank" rel="noopener noreferrer" aria-label="Follow on Facebook">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                </a>
                <!-- Instagram -->
                <a href="https://www.instagram.com/keyscodesandmodes/" target="_blank" rel="noopener noreferrer" aria-label="Follow on Instagram">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                </a>
                <!-- TikTok -->
                <a href="https://www.tiktok.com/@keyscodesandmodes" target="_blank" rel="noopener noreferrer" aria-label="Follow on TikTok">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                </a>
                <!-- LinkedIn -->
                <a href="https://www.linkedin.com/in/ben-ryan-guitar-freestyle/" target="_blank" rel="noopener noreferrer" aria-label="Connect on LinkedIn">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                </a>
            </div>

            <!-- Keyboard shortcuts legend ‚Äî ADA -->
            <div style="margin: 0.8rem 0; font-size: 0.72rem; color: #777; line-height: 1.8;" role="note" aria-label="Keyboard navigation instructions">
                <strong style="color:#aaa;">‚å®Ô∏è Keyboard:</strong>&nbsp;
                <kbd style="background:rgba(255,255,255,0.1);padding:0.1rem 0.4rem;border-radius:3px;border:1px solid #555;">Tab</kbd> navigate &nbsp;
                <kbd style="background:rgba(255,255,255,0.1);padding:0.1rem 0.4rem;border-radius:3px;border:1px solid #555;">Enter</kbd>/<kbd style="background:rgba(255,255,255,0.1);padding:0.1rem 0.4rem;border-radius:3px;border:1px solid #555;">Space</kbd> select note &nbsp;
                <kbd style="background:rgba(255,255,255,0.1);padding:0.1rem 0.4rem;border-radius:3px;border:1px solid #555;">‚Üê‚Üí</kbd> adjust slider
            </div>

            <!-- Footer nav -->
            <nav aria-label="Footer navigation" style="margin: 0.5rem 0;">
                <ul style="list-style:none;display:flex;flex-wrap:wrap;justify-content:center;gap:1rem 1.5rem;padding:0;margin:0;font-size:0.78rem;">
                    <li><a href="https://www.keyscodesandmodes.com" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">Home</a></li>
                    <li><a href="https://www.keyscodesandmodes.com/apps" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">All Apps</a></li>
                    <li><a href="https://www.keyscodesandmodes.com/about" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">About</a></li>
                    <li><a href="https://www.keyscodesandmodes.com/contact" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">Contact</a></li>
                    <li><a href="https://www.keyscodesandmodes.com/privacy" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">Privacy Policy</a></li>
                    <li><a href="https://www.keyscodesandmodes.com/terms" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">Terms of Service</a></li>
                    <li><a href="https://www.keyscodesandmodes.com/accessibility" style="color:#888;text-decoration:none;" onmouseover="this.style.color='#F4D03F'" onmouseout="this.style.color='#888'">Accessibility</a></li>
                </ul>
            </nav>

            <hr class="footer-divider">

            <div class="footer-copy">
                <p>Created by <span class="highlight">Benjamin Ryan</span> &nbsp;‚Ä¢&nbsp; <span class="freestyle">FreeStyle<sup style="font-size:0.65em">¬Æ</sup></span> Musical Device</p>
                <p style="margin-top:0.3rem; opacity:0.7;">¬© 2026 Keys, Codes &amp; Modes‚Ñ¢ &nbsp;|&nbsp; All rights reserved &nbsp;|&nbsp; Santa Barbara, California</p>
            </div>
        </div>
    </footer>
    
    <script>
        const chromaticNotes = [
            { name: 'C', color: '#FFFF00', midi: 60 },      // 0: Yellow
            { name: 'C#', color: '#FFC400', midi: 61 },     // 1: Yellow-Orange
            { name: 'D', color: '#FF8000', midi: 62 },      // 2: Orange
            { name: 'D#', color: '#FF4000', midi: 63 },     // 3: Red-Orange
            { name: 'E', color: '#FF0000', midi: 64 },      // 4: Red
            { name: 'F', color: '#C4007F', midi: 65 },      // 5: Red-Purple
            { name: 'F#', color: '#8000FF', midi: 66 },     // 6: Purple
            { name: 'G', color: '#4000FF', midi: 67 },      // 7: Blue-Purple
            { name: 'G#', color: '#0000FF', midi: 68 },     // 8: Blue
            { name: 'A', color: '#007FFF', midi: 69 },      // 9: Blue-Green
            { name: 'A#', color: '#00FF80', midi: 70 },     // 10: Green
            { name: 'B', color: '#80FF00', midi: 71 }       // 11: Yellow-Green
        ];
        
        const SLATE_COLOR = '#2a3a4f';
        
        // Function to get which chromatic note is currently at 12 o'clock
        function getNoteAt12OClock() {
            // With -15¬∞ initial rotation, wedge 0 (C) is at 12 o'clock
            // Right button: -30¬∞ brings next wedge (C#, D, D#, etc.) to 12 o'clock
            // Left button: +30¬∞ brings previous wedge (B, A#, A, etc.) to 12 o'clock
            const normalizedRotation = ((currentRotation + 15) % 360 + 360) % 360;
            const steps = Math.round(normalizedRotation / 30);
            const noteIndex = (12 - steps) % 12;
            return noteIndex;
        }
        
        function updateCurrentKeyDisplay() {
            const noteIndex = getNoteAt12OClock();
            const keyDisplay = document.getElementById('currentKeyText');
            const keySelector = document.getElementById('keySelector');
            if (keyDisplay) {
                keyDisplay.textContent = chromaticNotes[noteIndex].name;
                keyDisplay.style.color = chromaticNotes[noteIndex].color;
                announce(`Key changed to ${chromaticNotes[noteIndex].name}`);
            }
            // Sync the dropdown selector
            if (keySelector) {
                keySelector.value = noteIndex;
            }
        }
        
        // MUSICALLY VERIFIED PATTERNS - ALL CORRECT!
        // Each pattern uses semitone intervals from the root note
        // Scales: Major, Minor (Natural, Harmonic, Melodic), Pentatonic, Blues
        // Modes: Ionian, Dorian, Phrygian, Lydian, Mixolydian, Aeolian, Locrian
        // Chords: Major, Minor, Diminished, Augmented, Dominant 7th, Major 7th
        const stencilPatterns = {
            // SCALES (8 total)
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],  // All 12 semitones
            'major': [0, 2, 4, 5, 7, 9, 11, 12],  // W-W-H-W-W-W-H
            'minor': [0, 2, 3, 5, 7, 8, 10, 12],  // Natural Minor: W-H-W-W-H-W-W
            'harmonic': [0, 2, 3, 5, 7, 8, 11, 12],  // Harmonic Minor: raises 7th
            'melodic': [0, 2, 3, 5, 7, 9, 11, 12],  // Melodic Minor: raises 6th & 7th
            'pentatonic': [0, 2, 4, 7, 9, 12],  // Major Pentatonic: 5 notes
            'blues': [0, 3, 5, 6, 7, 10, 12],  // Blues scale with blue note (b5)
            
            // MODES (7 total) - Church modes
            'ionian': [0, 2, 4, 5, 7, 9, 11, 12],  // Same as Major
            'dorian': [0, 2, 3, 5, 7, 9, 10, 12],  // Minor with raised 6th
            'phrygian': [0, 1, 3, 5, 7, 8, 10, 12],  // Minor with lowered 2nd
            'lydian': [0, 2, 4, 6, 7, 9, 11, 12],  // Major with raised 4th
            'mixolydian': [0, 2, 4, 5, 7, 9, 10, 12],  // Major with lowered 7th
            'aeolian': [0, 2, 3, 5, 7, 8, 10, 12],  // Same as Natural Minor
            'locrian': [0, 1, 3, 5, 6, 8, 10, 12],  // Diminished scale
            
            // CHORDS (6 total) - Triads (1-3-5) and 7th chords (1-3-5-7)
            'major-chord': [0, 4, 7],  // Major triad: Root, Major 3rd, Perfect 5th
            'minor-chord': [0, 3, 7],  // Minor triad: Root, Minor 3rd, Perfect 5th
            'dim': [0, 3, 6],  // Diminished triad: Root, Minor 3rd, Diminished 5th
            'aug': [0, 4, 8],  // Augmented triad: Root, Major 3rd, Augmented 5th
            'dom7': [0, 4, 7, 10],  // Dominant 7th: Major triad + Minor 7th
            'maj7': [0, 4, 7, 11]  // Major 7th: Major triad + Major 7th
        };
        
        let synth = null;
        let activeNodes = new Set();
        let currentRotation = -15; // C at 12 o'clock (original position)
        let isAutoRotating = false;
        let rotationInterval = null;
        let currentPattern = null; // Track which pattern is active
        let playbackSpeed = 150; // Milliseconds per note (adjustable with slider)
        
        // CLEAN, SMOOTH SOUND - Like Circle of Fifths
        document.getElementById('audioBtn').addEventListener('click', async function() {
            if (!synth) {
                await Tone.start();
                
                // Enhanced synth with richer sound - like Circle of Fifths quality
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { 
                        type: 'sine',
                        partialCount: 0  // Pure sine wave
                    },
                    envelope: {
                        attack: 0.005,   // Quick attack for clarity
                        decay: 0.1,
                        sustain: 0.5,    // Longer sustain for chords
                        release: 0.8     // Gentle release
                    },
                    volume: -6  // Slightly louder for better audibility
                }).toDestination();
                
                this.textContent = 'üü¢ AUDIO READY';
                this.classList.remove('danger');
                this.classList.add('success');
                this.setAttribute('aria-pressed', 'true');
                this.setAttribute('aria-label', 'Audio is active and ready');
            }
        });
        
        // ‚ïê‚ïê‚ïê SCREEN READER ANNOUNCEMENTS ‚ïê‚ïê‚ïê
        function announce(msg, priority = 'polite') {
            const el = document.getElementById(priority === 'assertive' ? 'aria-alert' : 'aria-status');
            if (el) { el.textContent = ''; setTimeout(() => { el.textContent = msg; }, 50); }
        }

        function toggleDD(id) {
            const group = document.getElementById(id);
            group.classList.toggle('open');
            const header = group.querySelector('.dd-header');
            if (header) {
                const isOpen = group.classList.contains('open');
                header.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            }
        }

        function drawHolyGrail() {
            const svg = document.getElementById('holyGrailSVG');
            svg.innerHTML = '';
            // Accessibility title and desc for screen readers
            const svgTitle = document.createElementNS('http://www.w3.org/2000/svg', 'title');
            svgTitle.textContent = 'Chromatic Music Theory Wheel';
            svg.appendChild(svgTitle);
            const svgDesc = document.createElementNS('http://www.w3.org/2000/svg', 'desc');
            svgDesc.textContent = 'Interactive circular diagram showing all 12 chromatic notes in color-coded spokes. C=Yellow, C#=Yellow-Orange, D=Orange, D#=Red-Orange, E=Red, F=Red-Purple, F#=Purple, G=Blue-Purple, G#=Blue, A=Blue-Green, A#=Green, B=Yellow-Green. Click any circle to select and play that note.';
            svg.appendChild(svgDesc);
            
            // 450px wheel - centered at (225, 225)
            const centerX = 225;
            const centerY = 225;
            const circles = 13;
            const wedges = 12;
            const minRadius = 30;  // Smaller center
            const maxRadius = 210;  // Larger outer
            const radiusStep = (maxRadius - minRadius) / circles;  // ~13.8px steps - BIGGER!
            
            // BACKGROUND CIRCLE - Makes the wheel visible and contained
            const backgroundCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            backgroundCircle.setAttribute('cx', centerX);
            backgroundCircle.setAttribute('cy', centerY);
            backgroundCircle.setAttribute('r', maxRadius + 20);
            backgroundCircle.setAttribute('fill', '#000000'); // Pure black background
            backgroundCircle.setAttribute('stroke', '#e94560');
            backgroundCircle.setAttribute('stroke-width', '3');
            backgroundCircle.setAttribute('opacity', '1'); // Solid
            svg.appendChild(backgroundCircle);
            
            // Create rotating group - circles will be on this rotating element
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.id = 'rotatingGroup';
            g.setAttribute('transform', `rotate(${currentRotation} 225 225)`);
            
            // Static text group - appended to SVG AFTER rotating group, text never rotates
            const textGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            textGroup.id = 'staticTextGroup';
            
            // Calculate which wedge is at 12 o'clock (in pie window)
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            const rotationSteps = Math.round(normalizedRotation / 30);
            const wedgeAt12OClock = (12 - rotationSteps) % 12;
            
            for (let circleIdx = 0; circleIdx < circles; circleIdx++) {
                const radius = minRadius + (circleIdx * radiusStep);
                const nextRadius = radius + radiusStep;
                
                for (let wedgeIdx = 0; wedgeIdx < wedges; wedgeIdx++) {
                    // CORRECT CHROMATIC STRUCTURE: Each spoke ascends chromatically from its root
                    // Spoke 0 (C): C, C#, D, D#, E, F, F#, G, G#, A, A#, B, C (straight up!)
                    // Spoke 1 (C#): C#, D, D#, E, F, F#, G, G#, A, A#, B, C, C# (straight up!)
                    
                    // Each circle represents the next semitone up from the spoke's root
                    const rootNoteIdx = wedgeIdx;  // Root note for this spoke
                    const currentNoteIdx = (rootNoteIdx + circleIdx) % 12;  // Chromatic note at this circle
                    const note = chromaticNotes[currentNoteIdx];  // Get correct chromatic note
                    const midiValue = chromaticNotes[rootNoteIdx].midi + circleIdx;  // MIDI from root
                    
                    const startAngle = (wedgeIdx * 30 - 90) * Math.PI / 180;
                    const endAngle = ((wedgeIdx + 1) * 30 - 90) * Math.PI / 180;
                    
                    const x1 = centerX + radius * Math.cos(startAngle);
                    const y1 = centerY + radius * Math.sin(startAngle);
                    const x2 = centerX + nextRadius * Math.cos(startAngle);
                    const y2 = centerY + nextRadius * Math.sin(startAngle);
                    const x3 = centerX + nextRadius * Math.cos(endAngle);
                    const y3 = centerY + nextRadius * Math.sin(endAngle);
                    const x4 = centerX + radius * Math.cos(endAngle);
                    const y4 = centerY + radius * Math.sin(endAngle);
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} L ${x2} ${y2} A ${nextRadius} ${nextRadius} 0 0 1 ${x3} ${y3} L ${x4} ${y4} A ${radius} ${radius} 0 0 0 ${x1} ${y1}`;
                    path.setAttribute('d', d);
                    path.setAttribute('fill', 'none'); // TRANSPARENT - let circles show!
                    path.setAttribute('pointer-events', 'none'); // Don't block circles!
                    
                    // Use pre-calculated wedgeAt12OClock
                    const isInPieWindow = wedgeIdx === wedgeAt12OClock;
                    
                    path.setAttribute('stroke', isInPieWindow ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.02)');
                    path.setAttribute('stroke-width', '1');
                    g.appendChild(path);
                    
                    const midAngle = (wedgeIdx * 30 + 15 - 90) * Math.PI / 180;
                    const midRadius = radius + radiusStep / 2;
                    const circleX = centerX + midRadius * Math.cos(midAngle);
                    const circleY = centerY + midRadius * Math.sin(midAngle);
                    const circleRadius = radiusStep * 0.42; // BIGGER circles - better fit!
                    
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', circleX);
                    circle.setAttribute('cy', circleY);
                    circle.setAttribute('r', circleRadius);
                    circle.setAttribute('fill', note.color);  // Chromatic color
                    circle.setAttribute('stroke', 'none'); // NO white stroke
                    circle.setAttribute('class', 'note-node');
                    circle.setAttribute('data-wedge', wedgeIdx);
                    circle.setAttribute('data-circle', circleIdx);
                    circle.setAttribute('data-midi', midiValue);
                    circle.setAttribute('data-note-name', note.name);
                    
                    // SUBDUED SYSTEM: Only 12 o'clock bright, others lightened up for visibility
                    const isInPieWindowCircle = wedgeIdx === wedgeAt12OClock;
                    const opacity = isInPieWindowCircle ? '1' : '0.45'; // Lightened for chromatic visibility!
                    circle.setAttribute('opacity', opacity);
                    
                    circle.setAttribute('tabindex', '0');
                    circle.setAttribute('role', 'button');
                    circle.setAttribute('aria-label', `Note ${note.name}, spoke ${circleIdx + 1} of 13`);
                    circle.onclick = () => toggleNode(wedgeIdx, circleIdx);
                    circle.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleNode(wedgeIdx, circleIdx); } };
                    g.appendChild(circle);
                    
                    // Compute absolute (screen) position of this circle by applying wheel rotation
                    const rotRad = currentRotation * Math.PI / 180;
                    const dx = circleX - centerX;
                    const dy = circleY - centerY;
                    const absX = centerX + dx * Math.cos(rotRad) - dy * Math.sin(rotRad);
                    const absY = centerY + dx * Math.sin(rotRad) + dy * Math.cos(rotRad);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', absX);
                    text.setAttribute('y', absY);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('dominant-baseline', 'middle');
                    text.setAttribute('class', 'note-label');
                    text.setAttribute('fill', 'white');
                    text.setAttribute('font-weight', '900');
                    text.setAttribute('font-size', isInPieWindowCircle ? '7.5' : '5.5');
                    text.setAttribute('stroke', 'black');
                    text.setAttribute('stroke-width', '0.5');
                    text.setAttribute('opacity', opacity);
                    // No rotation transform needed - text group is static
                    text.setAttribute('data-wedge', wedgeIdx);
                    text.setAttribute('data-circle', circleIdx);
                    text.textContent = note.name;
                    textGroup.appendChild(text);
                }
            }
            
            // CONCENTRIC CIRCLES - Make them prominent and visible!
            for (let circleIdx = 0; circleIdx <= circles; circleIdx++) {
                const radius = minRadius + (circleIdx * radiusStep);
                const concentricCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                concentricCircle.setAttribute('cx', centerX);
                concentricCircle.setAttribute('cy', centerY);
                concentricCircle.setAttribute('r', radius);
                concentricCircle.setAttribute('fill', 'none');
                concentricCircle.setAttribute('stroke', 'rgba(255, 255, 255, 0.35)');
                concentricCircle.setAttribute('stroke-width', '1.5');
                concentricCircle.setAttribute('pointer-events', 'none');
                g.appendChild(concentricCircle);
            }
            
            // Center circle - no stroke to avoid white circle artifact
            const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            centerCircle.setAttribute('cx', centerX);
            centerCircle.setAttribute('cy', centerY);
            centerCircle.setAttribute('r', minRadius);
            centerCircle.setAttribute('fill', '#0a0f1a');
            g.appendChild(centerCircle);
            
            // Center ring (Hero brand color)
            const centerRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            centerRing.setAttribute('cx', centerX);
            centerRing.setAttribute('cy', centerY);
            centerRing.setAttribute('r', minRadius - 2);
            centerRing.setAttribute('fill', 'none');
            centerRing.setAttribute('stroke', '#e94560');
            centerRing.setAttribute('stroke-width', '2.5');
            g.appendChild(centerRing);
            
            svg.appendChild(g);
            svg.appendChild(textGroup); // Static text on top of rotating group
            
            // BLACKOUT OVERLAY GROUP - Black circles on top to hide non-pattern notes
            const blackoutGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            blackoutGroup.id = 'blackoutGroup';
            blackoutGroup.setAttribute('transform', `rotate(${currentRotation} 225 225)`); // Rotates with wheel
            svg.appendChild(blackoutGroup);
            
            // PIE WINDOW STENCIL - ON TOP! (Added after blackout group)
            const pieWindowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            pieWindowGroup.id = 'pieWindowGroup';
            
            // Main pie slice boundary - BOLD RED DASHED BORDER
            const pieSlice = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const sliceAngle = 30;
            const sliceStartAngle = (-90 - sliceAngle/2) * Math.PI / 180;
            const sliceEndAngle = (-90 + sliceAngle/2) * Math.PI / 180;
            const sliceRadius = maxRadius + 15;
            
            const sx1 = centerX;
            const sy1 = centerY;
            const sx2 = centerX + sliceRadius * Math.cos(sliceStartAngle);
            const sy2 = centerY + sliceRadius * Math.sin(sliceStartAngle);
            const sx3 = centerX + sliceRadius * Math.cos(sliceEndAngle);
            const sy3 = centerY + sliceRadius * Math.sin(sliceEndAngle);
            
            const pieSlicePath = `M ${sx1} ${sy1} L ${sx2} ${sy2} A ${sliceRadius} ${sliceRadius} 0 0 1 ${sx3} ${sy3} Z`;
            pieSlice.setAttribute('d', pieSlicePath);
            pieSlice.setAttribute('fill', 'none'); // Transparent - see through
            pieSlice.setAttribute('stroke', '#e94560'); // Hero red
            pieSlice.setAttribute('stroke-width', '6'); // Extra thick
            pieSlice.setAttribute('opacity', '1'); // Fully visible
            pieSlice.setAttribute('pointer-events', 'none');
            pieSlice.setAttribute('stroke-dasharray', '15,8'); // Bold dashes
            pieWindowGroup.appendChild(pieSlice);
            
            // Create chromatic reference circles on LEFT
            const referenceCircleRadius = 8;
            const referenceX = centerX - maxRadius - 30;
            
            for (let i = 0; i <= 12; i++) {
                const referenceY = centerY + maxRadius - (i * (maxRadius * 2) / 12) - maxRadius/12;
                const noteIdx = i % 12;
                
                const refCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                refCircle.setAttribute('cx', referenceX);
                refCircle.setAttribute('cy', referenceY);
                refCircle.setAttribute('r', referenceCircleRadius);
                refCircle.setAttribute('fill', chromaticNotes[noteIdx].color);
                refCircle.setAttribute('stroke', '#000'); // Black outline
                refCircle.setAttribute('stroke-width', '1');
                refCircle.setAttribute('opacity', '1');
                pieWindowGroup.appendChild(refCircle);
                
                const refLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                refLabel.setAttribute('x', referenceX - referenceCircleRadius - 5);
                refLabel.setAttribute('y', referenceY);
                refLabel.setAttribute('text-anchor', 'end');
                refLabel.setAttribute('dominant-baseline', 'middle');
                refLabel.setAttribute('font-size', '11');
                refLabel.setAttribute('font-weight', '900');
                refLabel.setAttribute('fill', chromaticNotes[noteIdx].color);
                refLabel.setAttribute('stroke', '#000');
                refLabel.setAttribute('stroke-width', '0.5');
                refLabel.textContent = `${i}:${chromaticNotes[noteIdx].name}`;
                pieWindowGroup.appendChild(refLabel);
            }
            
            svg.appendChild(pieWindowGroup); // STENCIL ON TOP!
            
            // FIXED 12 O'CLOCK MARKER - Shows the activity window (never rotates!)
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const markerSize = 20;
            const markerY = centerY - maxRadius - 25;
            const markerPath = `M ${centerX} ${markerY + markerSize} 
                                L ${centerX - markerSize/2} ${markerY} 
                                L ${centerX + markerSize/2} ${markerY} Z`;
            marker.setAttribute('d', markerPath);
            marker.setAttribute('fill', '#e94560');
            marker.setAttribute('stroke', '#ffffff');
            marker.setAttribute('stroke-width', '2');
            marker.setAttribute('opacity', '0.9');
            svg.appendChild(marker);
            
            // FIXED 12 O'CLOCK LABEL
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', centerX);
            label.setAttribute('y', markerY - 5);
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('font-size', '12');
            label.setAttribute('font-weight', '900');
            label.setAttribute('fill', '#e94560');
            label.textContent = 'PIE WINDOW';
            svg.appendChild(label);
            
            // FIXED CENTER DOT - Hero brand color, never rotates!
            const fixedCenterDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            fixedCenterDot.setAttribute('cx', centerX);
            fixedCenterDot.setAttribute('cy', centerY);
            fixedCenterDot.setAttribute('r', '5');
            fixedCenterDot.setAttribute('fill', '#e94560');
            fixedCenterDot.setAttribute('stroke', '#000000');
            fixedCenterDot.setAttribute('stroke-width', '2');
            fixedCenterDot.setAttribute('opacity', '0.8');
            svg.appendChild(fixedCenterDot);
        }
        
        function toggleNode(wedgeIdx, circleIdx) {
            const nodeId = `${wedgeIdx}-${circleIdx}`;
            const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
            
            if (activeNodes.has(nodeId)) {
                activeNodes.delete(nodeId);
                node.classList.remove('active');
            } else {
                activeNodes.add(nodeId);
                node.classList.add('active');
            }
            
            if (synth) {
                const midi = parseInt(node.getAttribute('data-midi'));
                const freq = Tone.Frequency(midi, 'midi').toFrequency();
                synth.triggerAttackRelease([freq], '8n');
                
                node.classList.add('playing');
                setTimeout(() => node.classList.remove('playing'), 300);
            }
        }
        
        function applyStencil(pattern) {
            clearAll();
            currentPattern = pattern;
            const intervals = stencilPatterns[pattern];
            if (!intervals) return;
            
            // Calculate which wedge is at 12 o'clock
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            const rotationSteps = Math.round(normalizedRotation / 30);
            const wedgeAt12OClock = (12 - rotationSteps) % 12;
            
            // Get blackout group
            const blackoutGroup = document.getElementById('blackoutGroup');
            if (!blackoutGroup) return;
            
            // Clear previous blackout circles
            blackoutGroup.innerHTML = '';
            
            // Calculate circle parameters (same as in drawHolyGrail)
            const centerX = 225;
            const centerY = 225;
            const minRadius = 30;
            const maxRadius = 210;
            const radiusStep = (maxRadius - minRadius) / 13;
            
            // For each position in the 12 o'clock wedge
            for (let circleIdx = 0; circleIdx <= 12; circleIdx++) {
                const isInPattern = intervals.includes(circleIdx);
                
                const node = document.querySelector(`[data-wedge="${wedgeAt12OClock}"][data-circle="${circleIdx}"]`);
                if (!node) continue;
                
                if (isInPattern) {
                    // Pattern note: Add to active set and highlight
                    activeNodes.add(`${wedgeAt12OClock}-${circleIdx}`);
                    node.classList.add('active');
                    // Let CSS handle stroke and stroke-width via .active class
                } else {
                    // Non-pattern note: Create BLACK OVERLAY CIRCLE on top
                    const radius = minRadius + (circleIdx * radiusStep);
                    const midAngle = (wedgeAt12OClock * 30 + 15 - 90) * Math.PI / 180;
                    const midRadius = radius + radiusStep / 2;
                    const circleX = centerX + midRadius * Math.cos(midAngle);
                    const circleY = centerY + midRadius * Math.sin(midAngle);
                    const circleRadius = radiusStep * 0.42; // Same size as note circles
                    
                    // Create black circle overlay
                    const blackCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    blackCircle.setAttribute('cx', circleX);
                    blackCircle.setAttribute('cy', circleY);
                    blackCircle.setAttribute('r', circleRadius + 1); // Slightly larger to fully cover
                    blackCircle.setAttribute('fill', '#000000'); // Pure black
                    blackCircle.setAttribute('opacity', '1'); // Completely opaque
                    blackCircle.setAttribute('stroke', 'none');
                    blackCircle.setAttribute('pointer-events', 'none'); // Don't block clicks
                    blackoutGroup.appendChild(blackCircle);
                }
            }
        }
        
        function playActive() {
            if (!synth || activeNodes.size === 0) return;
            
            const freqs = [];
            const nodes = [];
            
            activeNodes.forEach(nodeId => {
                const [wedgeIdx, circleIdx] = nodeId.split('-').map(Number);
                const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                if (node) {
                    const midi = parseInt(node.getAttribute('data-midi'));
                    freqs.push(Tone.Frequency(midi, 'midi').toFrequency());
                    nodes.push(node);
                }
            });
            
            // Visual feedback - all notes pulse together
            nodes.forEach(node => node.classList.add('playing'));
            synth.triggerAttackRelease(freqs, '1n');
            
            setTimeout(() => {
                nodes.forEach(node => node.classList.remove('playing'));
            }, 300);
        }
        
        function playArpeggio() {
            if (!synth || activeNodes.size === 0) return;
            
            const notes = [];
            activeNodes.forEach(nodeId => {
                const [wedgeIdx, circleIdx] = nodeId.split('-').map(Number);
                const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                if (node) {
                    const midi = parseInt(node.getAttribute('data-midi'));
                    notes.push({ midi, node, circleIdx });
                }
            });
            
            // Sort by circle index ASCENDING (lowest to highest pitch)
            notes.sort((a, b) => a.circleIdx - b.circleIdx);
            
            const now = Tone.now();
            const noteDelay = playbackSpeed / 1000; // Use variable speed (convert ms to seconds)
            
            notes.forEach((note, idx) => {
                const freq = Tone.Frequency(note.midi, 'midi').toFrequency();
                synth.triggerAttackRelease([freq], '8n', now + idx * noteDelay);
                
                // Visual feedback - each note pulses in sequence
                setTimeout(() => {
                    note.node.classList.add('playing');
                    setTimeout(() => note.node.classList.remove('playing'), 300);
                }, idx * noteDelay * 1000);
            });
        }
        
        function playArpeggioDown() {
            if (!synth || activeNodes.size === 0) return;
            
            const notes = [];
            activeNodes.forEach(nodeId => {
                const [wedgeIdx, circleIdx] = nodeId.split('-').map(Number);
                const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                if (node) {
                    const midi = parseInt(node.getAttribute('data-midi'));
                    notes.push({ midi, node, circleIdx });
                }
            });
            
            // Sort by circle index DESCENDING (highest to lowest pitch)
            notes.sort((a, b) => b.circleIdx - a.circleIdx);
            
            const now = Tone.now();
            const noteDelay = playbackSpeed / 1000; // Use variable speed (convert ms to seconds)
            
            notes.forEach((note, idx) => {
                const freq = Tone.Frequency(note.midi, 'midi').toFrequency();
                synth.triggerAttackRelease([freq], '8n', now + idx * noteDelay);
                
                // Visual feedback - each note pulses in sequence
                setTimeout(() => {
                    note.node.classList.add('playing');
                    setTimeout(() => note.node.classList.remove('playing'), 300);
                }, idx * noteDelay * 1000);
            });
        }
        
        // NEW: Auto-play when stencil is applied
        async function playStencilPattern(playType = 'chord') {
            if (!synth) {
                await Tone.start();
            }
            
            // Wait a brief moment for visual update
            setTimeout(() => {
                if (playType === 'arpeggio') {
                    playArpeggio();
                } else {
                    playActive();
                }
            }, 100);
        }
        
        function clearAll() {
            currentPattern = null;
            activeNodes.clear();
            
            // Clear blackout overlay
            const blackoutGroup = document.getElementById('blackoutGroup');
            if (blackoutGroup) {
                blackoutGroup.innerHTML = '';
            }
            
            // Remove active class and white stroke from all nodes
            document.querySelectorAll('.note-node').forEach(n => {
                n.classList.remove('active');
                n.setAttribute('stroke', 'none'); // Remove white outline
            });
            
            document.querySelectorAll('.stencil-btn').forEach(b => b.classList.remove('active'));
            
            // Apply subdued system (only 12 o'clock bright)
            updateWedgeOpacity();
        }
        
        function rotateLeft() {
            // Left = Brings 1 o'clock spoke TO 12 o'clock position
            // This is CLOCKWISE rotation = -30¬∞
            currentRotation = (currentRotation - 30 + 360) % 360;
            updateRotation();
            updateCurrentKeyDisplay();
            if (currentPattern) {
                applyStencil(currentPattern);
                playStencilPattern(autoPlayMode);
            }
        }
        
        function rotateRight() {
            // Right = Brings 11 o'clock spoke TO 12 o'clock position
            // This is COUNTER-CLOCKWISE rotation = +30¬∞
            currentRotation = (currentRotation + 30) % 360;
            updateRotation();
            updateCurrentKeyDisplay();
            if (currentPattern) {
                applyStencil(currentPattern);
                playStencilPattern(autoPlayMode);
            }
        }
        
        function resetRotation() {
            currentRotation = -15; // Reset to C at 12 o'clock (original position)
            updateRotation();
            updateCurrentKeyDisplay();
            // Reapply the current pattern to the reset 12 o'clock position
            if (currentPattern) {
                applyStencil(currentPattern);
                // Play the pattern in the new key
                playStencilPattern(autoPlayMode);
            }
        }
        
        function updateRotation() {
            // Full redraw so static text group positions are recalculated correctly
            drawHolyGrail();
            updateWedgeOpacity();
        }
        
        function updateWedgeOpacity() {
            // Calculate which wedge is at 12 o'clock
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            const rotationSteps = Math.round(normalizedRotation / 30);
            const wedgeAt12OClock = (12 - rotationSteps) % 12;
            
            // If there's an active pattern, DON'T override the blackout/highlighting
            // Only update opacity for wedges that don't have a pattern applied
            if (currentPattern) {
                // Pattern is active - maintain blackout and highlighting
                return; // Don't override the pattern display
            }
            
            // NO pattern active - show normal subdued system
            for (let wedgeIdx = 0; wedgeIdx < 12; wedgeIdx++) {
                const isInPieWindow = wedgeIdx === wedgeAt12OClock;
                const opacity = isInPieWindow ? '1' : '0.45'; // Lightened for visibility!
                const fontSize = isInPieWindow ? '7.5' : '5.5';
                
                for (let circleIdx = 0; circleIdx < 13; circleIdx++) {
                    const circle = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                    if (circle) {
                        // Only update if not active
                        if (!circle.classList.contains('active')) {
                            circle.setAttribute('opacity', opacity);
                        }
                        
                        // Update text opacity AND font size using data attributes
                        const matchingText = document.querySelector(`.note-label[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                        if (matchingText) {
                            matchingText.setAttribute('opacity', opacity);
                            matchingText.setAttribute('font-size', fontSize);
                        }
                    }
                }
            }
        }
        
        function toggleAutoRotate() {
            isAutoRotating = !isAutoRotating;
            const btn = document.getElementById('autoRotateBtn');
            
            if (isAutoRotating) {
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                rotationInterval = setInterval(() => {
                    rotateRight();
                }, 2000);
            } else {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
                if (rotationInterval) {
                    clearInterval(rotationInterval);
                    rotationInterval = null;
                }
            }
        }
        
        document.getElementById('rotateLeftBtn').addEventListener('click', rotateLeft);
        document.getElementById('rotateRightBtn').addEventListener('click', rotateRight);
        document.getElementById('resetBtn').addEventListener('click', resetRotation);
        document.getElementById('autoRotateBtn').addEventListener('click', toggleAutoRotate);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('playBtn').addEventListener('click', playActive);
        document.getElementById('arpeggioBtn').addEventListener('click', playArpeggio);
        document.getElementById('arpeggioDownBtn').addEventListener('click', playArpeggioDown);
        
        // Auto-play mode controls
        document.getElementById('autoPlayChordBtn').addEventListener('click', function() {
            autoPlayMode = 'chord';
            document.getElementById('autoPlayChordBtn').classList.add('active');
            document.getElementById('autoPlayArpeggioBtn').classList.remove('active');
        });
        
        document.getElementById('autoPlayArpeggioBtn').addEventListener('click', function() {
            autoPlayMode = 'arpeggio';
            document.getElementById('autoPlayArpeggioBtn').classList.add('active');
            document.getElementById('autoPlayChordBtn').classList.remove('active');
        });
        
        // Key selector - jump to any key at 12 o'clock
        document.getElementById('keySelector').addEventListener('change', function() {
            const targetKey = parseInt(this.value);
            // Calculate rotation needed to bring this key to 12 o'clock
            // Key 0 (C) = -15¬∞, Key 1 (C#) = -45¬∞, Key 2 (D) = -75¬∞, etc.
            currentRotation = -15 - (targetKey * 30);
            // Normalize rotation
            currentRotation = ((currentRotation % 360) + 360) % 360;
            updateRotation();
            updateCurrentKeyDisplay();
            // Reapply pattern if one is active
            if (currentPattern) {
                applyStencil(currentPattern);
                playStencilPattern(autoPlayMode);
            }
        });
        
        let autoPlayMode = 'arpeggio'; // 'chord' or 'arpeggio'
        
        document.querySelectorAll('.stencil-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const patternName = this.getAttribute('data-pattern');
                applyStencil(patternName);
                document.querySelectorAll('.stencil-btn').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                this.classList.add('active');
                this.setAttribute('aria-pressed', 'true');
                announce(`${this.textContent.trim()} pattern applied`);
                
                // Auto-detect playback mode based on pattern type
                // Chords play as chords, scales/modes play as arpeggios
                const isChord = patternName.includes('chord') || patternName === 'dim' || patternName === 'aug' || patternName === 'dom7' || patternName === 'maj7';
                const playMode = isChord ? 'chord' : 'arpeggio';
                
                // Auto-play the pattern when selected
                playStencilPattern(playMode);
            });
        });
        
        // SPEED CONTROL - INVERTED (left=slow, right=fast)
        document.getElementById('speedControl').addEventListener('input', function() {
            // Invert: slider at max (400) = fast (50ms), slider at min (50) = slow (400ms)
            playbackSpeed = 450 - parseInt(this.value);
            document.getElementById('speedDisplay').textContent = `${playbackSpeed}ms / note`;
            this.setAttribute('aria-valuenow', this.value);
            this.setAttribute('aria-valuetext', `${playbackSpeed} milliseconds per note`);
        });
        
        drawHolyGrail();
        updateCurrentKeyDisplay(); // Initialize the current key display
        chromaticNotes.forEach((note, idx) => {
            });
        Object.entries(stencilPatterns).forEach(([name, intervals]) => {
            if (['chromatic', 'major', 'minor', 'harmonic', 'melodic', 'pentatonic', 'blues'].includes(name)) {
                const noteNames = intervals.map(i => chromaticNotes[i % 12].name).join('-');
                    }
        });
        Object.entries(stencilPatterns).forEach(([name, intervals]) => {
            if (['ionian', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'aeolian', 'locrian'].includes(name)) {
                const noteNames = intervals.map(i => chromaticNotes[i % 12].name).join('-');
                    }
        });
        Object.entries(stencilPatterns).forEach(([name, intervals]) => {
            if (['major-chord', 'minor-chord', 'dim', 'aug', 'dom7', 'maj7'].includes(name)) {
                const noteNames = intervals.map(i => chromaticNotes[i % 12].name).join('-');
                    }
        });
    </script>
    <!-- ‚ïê‚ïê‚ïê ARIA LIVE REGION ‚Äî screen reader announcements ‚ïê‚ïê‚ïê -->
    <div id="aria-status" role="status" aria-live="polite" aria-atomic="true"
         style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;">
    </div>
    <div id="aria-alert" role="alert" aria-live="assertive" aria-atomic="true"
         style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;">
    </div>

    <!-- ‚ïê‚ïê‚ïê NO-SCRIPT FALLBACK ‚ïê‚ïê‚ïê -->
    <noscript>
        <div style="position:fixed;top:0;left:0;right:0;background:#e94560;color:#fff;text-align:center;padding:1rem;font-weight:700;z-index:99999;">
            ‚ö†Ô∏è JavaScript is required for this interactive music theory application. Please enable JavaScript in your browser settings.
        </div>
    </noscript>

</body>
</html>