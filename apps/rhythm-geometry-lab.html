<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Geometry Lab | Keys, Codes & Modes</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-teal: #008080;
            --primary-gold: #F4D03F;
            --primary-purple: #8B6BA3;
            --primary-coral: #CF7A5A;
            --accent-blue: #4A7BA7;
            --dark-bg: #0f0f1e;
            --light-text: #E8E8E8;
            --font-display: 'Cinzel', serif;
            --font-body: 'Montserrat', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a15 100%);
            color: var(--light-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ==================== HEADER ==================== */
        .app-header {
            background: linear-gradient(135deg, rgba(15, 15, 30, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--primary-teal);
            padding: 0.8rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 128, 128, 0.2);
        }

        .app-header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-logo-section { display: flex; align-items: center; gap: 1rem; cursor: pointer; }
        .app-logo-svg { width: 45px; height: 45px; filter: drop-shadow(0 2px 8px rgba(244, 208, 63, 0.3)); transition: transform 0.3s; }
        .app-logo-section:hover .app-logo-svg { transform: scale(1.1) rotate(5deg); }

        .app-title {
            font-family: var(--font-display);
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-teal), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .app-nav-links { display: flex; gap: 1.2rem; align-items: center; }
        .app-nav-links a {
            color: var(--light-text);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s;
        }
        .app-nav-links a:hover { color: var(--primary-gold); background: rgba(0, 128, 128, 0.1); }
        .upgrade-link {
            background: linear-gradient(135deg, var(--primary-teal), #006666) !important;
            color: white !important;
            padding: 0.6rem 1.3rem !important;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 128, 128, 0.3);
        }

        /* ==================== UNIFIED WORKSPACE ==================== */
        .workspace {
            flex: 1;
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* TOP BAR - Transport & Global Controls in ONE LINE */
        .control-bar {
            background: linear-gradient(135deg, rgba(0,128,128,0.15), rgba(139,107,163,0.15));
            border: 2px solid rgba(0,128,128,0.4);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 25px rgba(0,128,128,0.2);
        }

        .transport-section {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .btn-transport {
            background: linear-gradient(135deg, var(--primary-teal), #006666);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.7rem 1.5rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: var(--font-body);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,128,128,0.4);
        }

        .btn-transport:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,128,128,0.6); }
        .btn-transport.playing {
            background: linear-gradient(135deg, var(--primary-coral), #a05a38);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(207,122,90,0.4); }
            50% { box-shadow: 0 8px 30px rgba(207,122,90,0.8); }
        }

        .btn-small {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            background: rgba(139,107,163,0.3);
            border: 2px solid rgba(139,107,163,0.5);
            color: var(--primary-purple);
        }

        .btn-small:hover { background: rgba(139,107,163,0.5); }

        .tempo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tempo-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 0.5rem 1.2rem;
            border-radius: 10px;
            border: 2px solid rgba(244,208,63,0.3);
        }

        .tempo-value {
            font-family: var(--font-display);
            font-size: 2.5rem;
            line-height: 1;
            color: var(--primary-gold);
            text-shadow: 0 0 20px rgba(244,208,63,0.6);
        }

        .tempo-label {
            font-size: 0.7rem;
            color: rgba(232,232,232,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quick-control {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .quick-label {
            font-size: 0.8rem;
            color: rgba(232,232,232,0.7);
            font-weight: 600;
            min-width: 60px;
        }

        .quick-value {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--primary-gold);
            min-width: 35px;
            text-align: center;
            font-weight: 700;
        }

        input[type=range] {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, rgba(0,128,128,0.3), rgba(139,107,163,0.3));
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-teal), var(--primary-gold));
            box-shadow: 0 0 10px rgba(0,128,128,0.8);
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); }

        /* MAIN WORKSPACE - Display + Controls SIDE BY SIDE */
        .main-workspace {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            gap: 1.5rem;
            flex: 1;
        }

        /* LEFT: VISUAL DISPLAY */
        .visual-zone {
            background: linear-gradient(135deg, rgba(0,128,128,0.08), rgba(139,107,163,0.08));
            border: 2px solid rgba(0,128,128,0.4);
            border-radius: 18px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0,128,128,0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .visual-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(0,128,128,0.1) 0%, transparent 70%);
            pointer-events: none;
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .mode-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .mode-tab {
            background: rgba(0,0,0,0.4);
            border: 2px solid rgba(0,128,128,0.3);
            color: rgba(232,232,232,0.6);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-tab:hover { background: rgba(0,128,128,0.2); transform: translateY(-2px); }
        .mode-tab.active {
            background: linear-gradient(135deg, rgba(0,128,128,0.4), rgba(139,107,163,0.4));
            border-color: var(--primary-teal);
            color: var(--primary-gold);
            box-shadow: 0 4px 15px rgba(0,128,128,0.5);
        }

        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        #canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
            cursor: crosshair;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .layer-legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0,0,0,0.5);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 2px solid rgba(0,128,128,0.3);
            transition: all 0.3s;
        }

        .legend-item:hover { background: rgba(0,128,128,0.2); transform: scale(1.05); }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 0 12px currentColor;
            animation: dotPulse 2s ease-in-out infinite;
        }

        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        .legend-text {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .help-hint {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(232,232,232,0.4);
            font-style: italic;
            margin-top: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* RIGHT: CONTROL PANEL */
        .control-zone {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            max-height: 75vh;
        }

        .control-group {
            background: linear-gradient(135deg, rgba(0,128,128,0.12), rgba(139,107,163,0.12));
            border: 2px solid rgba(0,128,128,0.35);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(8px);
        }

        .group-title {
            font-family: var(--font-display);
            font-size: 0.85rem;
            color: var(--primary-gold);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 0.8rem;
            padding-bottom: 0.4rem;
            border-bottom: 2px solid rgba(244,208,63,0.3);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .group-icon { font-size: 1.1rem; }

        /* PICKER GRIDS */
        .picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .picker-grid-2 { grid-template-columns: repeat(2, 1fr); }

        .picker-btn {
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(0,128,128,0.3);
            color: rgba(232,232,232,0.7);
            border-radius: 10px;
            padding: 0.8rem 0.4rem;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
        }

        .picker-btn:hover {
            background: rgba(0,128,128,0.25);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,128,128,0.3);
        }

        .picker-btn.active {
            background: linear-gradient(135deg, rgba(0,128,128,0.5), rgba(139,107,163,0.5));
            border-color: var(--primary-teal);
            color: var(--primary-gold);
            box-shadow: 0 4px 15px rgba(0,128,128,0.5);
            transform: scale(1.05);
        }

        /* HORIZONTAL NOTE BUTTONS */
        .picker-btn-horizontal {
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(0,128,128,0.3);
            color: rgba(232,232,232,0.7);
            border-radius: 8px;
            padding: 0.5rem 0.6rem;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .picker-btn-horizontal:hover {
            background: rgba(0,128,128,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,128,128,0.3);
        }

        .picker-btn-horizontal.active {
            background: linear-gradient(135deg, rgba(0,128,128,0.5), rgba(139,107,163,0.5));
            border-color: var(--primary-teal);
            color: var(--primary-gold);
            box-shadow: 0 4px 15px rgba(0,128,128,0.5);
        }

        .picker-icon-small {
            flex-shrink: 0;
        }

        .picker-label-inline {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .picker-icon {
            font-size: 2rem;
            line-height: 1;
        }

        .picker-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* LAYERS */
        .layer-list { display: flex; flex-direction: column; gap: 0.6rem; }

        .layer-item {
            background: rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 0.8rem;
            transition: all 0.3s;
        }

        .layer-item:hover {
            transform: translateX(5px);
            box-shadow: -5px 0 15px rgba(0,128,128,0.3);
        }

        .layer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .layer-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 0 12px currentColor;
            animation: dotPulse 2s ease-in-out infinite;
        }

        .layer-name {
            font-family: var(--font-display);
            font-size: 0.85rem;
            font-weight: 700;
        }

        .layer-btns {
            display: flex;
            gap: 0.3rem;
        }

        .layer-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(232,232,232,0.7);
            border-radius: 6px;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .layer-btn:hover { background: rgba(0,128,128,0.3); transform: scale(1.1); }
        .layer-btn.muted {
            background: rgba(207,122,90,0.4);
            border-color: var(--primary-coral);
            color: var(--primary-coral);
        }

        .layer-slider {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .layer-slider input[type=range] {
            flex: 1;
            width: auto;
        }

        .slider-val {
            font-family: var(--font-display);
            font-size: 0.9rem;
            color: var(--primary-gold);
            min-width: 30px;
            text-align: center;
            font-weight: 700;
        }

        .btn-add {
            width: 100%;
            background: rgba(0,128,128,0.2);
            border: 2px dashed rgba(0,128,128,0.5);
            color: var(--primary-teal);
            border-radius: 10px;
            padding: 0.7rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-add:hover {
            background: rgba(0,128,128,0.35);
            border-style: solid;
            transform: scale(1.02);
        }

        /* PRESETS */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .preset-btn {
            background: linear-gradient(135deg, rgba(139,107,163,0.25), rgba(139,107,163,0.35));
            border: 2px solid rgba(139,107,163,0.5);
            color: var(--light-text);
            border-radius: 10px;
            padding: 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preset-btn:hover {
            background: linear-gradient(135deg, rgba(139,107,163,0.45), rgba(139,107,163,0.55));
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(139,107,163,0.4);
        }

        /* FOOTER */
        .app-footer {
            background: linear-gradient(135deg, rgba(15, 15, 30, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(10px);
            border-top: 3px solid var(--primary-teal);
            padding: 2rem 2rem 1.5rem;
            margin-top: 2rem;
        }

        .app-footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .app-social-links {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .app-social-links a {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.2), rgba(139, 107, 163, 0.2));
            border: 2px solid rgba(0, 128, 128, 0.3);
            border-radius: 50%;
            color: var(--primary-gold);
            transition: all 0.3s;
            text-decoration: none;
        }

        .app-social-links a:hover {
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.4), rgba(139, 107, 163, 0.4));
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 128, 128, 0.5);
        }

        .app-social-links svg { width: 20px; height: 20px; fill: currentColor; }

        .app-copyright {
            text-align: center;
            color: rgba(232, 232, 232, 0.5);
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .app-copyright strong { color: var(--primary-gold); }

        .app-legal-links {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .app-legal-links a {
            color: rgba(232, 232, 232, 0.4);
            text-decoration: none;
            font-size: 0.8rem;
            transition: color 0.3s;
        }

        .app-legal-links a:hover { color: var(--primary-gold); }

        .app-divider {
            width: 100%;
            max-width: 500px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(0, 128, 128, 0.3), transparent);
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: linear-gradient(135deg, rgba(0,128,128,0.95), rgba(0,102,102,0.95));
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9999;
            border: 2px solid var(--primary-teal);
            box-shadow: 0 8px 30px rgba(0,128,128,0.5);
        }

        .toast.show { transform: translateX(-50%) translateY(0); }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .main-workspace { grid-template-columns: 1fr; }
            .control-zone { max-height: none; }
        }

        @media (max-width: 768px) {
            .control-bar { flex-direction: column; align-items: stretch; }
            .transport-section, .tempo-section { justify-content: center; }
            .picker-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .control-zone::-webkit-scrollbar { width: 5px; }
        .control-zone::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .control-zone::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-teal), var(--primary-purple));
            border-radius: 3px;
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
    <div class="app-header-content">
        <div class="app-logo-section" onclick="window.location.href='../index.html'">
            <svg class="app-logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="98" fill="#4A7BA7" stroke="#008080" stroke-width="2"/>
                <polygon points="100,15 185,185 15,185" fill="#F4D03F" opacity="0.9"/>
                <polygon points="100,15 15,185 15,55" fill="#8B6BA3" opacity="0.75"/>
                <polygon points="100,15 185,55 185,185" fill="#6FA5A5" opacity="0.75"/>
                <circle cx="100" cy="100" r="50" fill="none" stroke="#008080" stroke-width="3"/>
                <circle cx="100" cy="100" r="7" fill="#F4D03F"/>
            </svg>
            <h1 class="app-title">KEYS, CODES & MODES ‚Äî Rhythm Geometry Lab</h1>
        </div>
        <nav class="app-nav-links">
            <a href="/auth/offerings.html">Control Panel</a>
            <a href="/pricing.html" class="upgrade-link">Upgrade</a>
        </nav>
    </div>
</header>

<!-- WORKSPACE -->
<div class="workspace">

    <!-- TOP CONTROL BAR - Everything in One Place -->
    <div class="control-bar">
        <div class="transport-section">
            <button class="btn-transport" id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
            <button class="btn-transport btn-small" onclick="stopReset()">‚ñ† Stop</button>
            <button class="btn-transport btn-small" onclick="resetRot()">‚Üª Reset</button>
        </div>

        <div class="tempo-section">
            <div class="tempo-display">
                <div class="tempo-value" id="tempoDisplay">110</div>
                <div class="tempo-label">BPM</div>
            </div>
            <div class="quick-control">
                <input type="range" id="tempoSlider" min="40" max="240" value="110" oninput="setTempo(this.value)">
            </div>
        </div>

        <div class="quick-control">
            <span class="quick-label">Steps</span>
            <input type="range" id="stepsSlider" min="4" max="32" value="16" oninput="setSteps(this.value)">
            <span class="quick-value" id="stepsVal">16</span>
        </div>

        <div class="quick-control">
            <span class="quick-label">Volume</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="70" oninput="setVolume(this.value)">
            <span class="quick-value" id="volumeVal">70</span>
        </div>
    </div>

    <!-- MAIN WORKSPACE -->
    <div class="main-workspace">

        <!-- LEFT: VISUAL DISPLAY -->
        <div class="visual-zone">
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="setMode('geometry')" id="tab-geo">‚¨¢ Geometry</button>
                <button class="mode-tab" onclick="setMode('dots')" id="tab-dots">‚óè Dots</button>
                <button class="mode-tab" onclick="setMode('notation')" id="tab-note">‚ô™ Notes</button>
                <button class="mode-tab" onclick="setMode('spiral')" id="tab-spiral">üåÄ Spiral</button>
            </div>

            <div class="canvas-area">
                <canvas id="canvas" width="650" height="650"></canvas>
            </div>

            <div class="layer-legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background:#F4D03F;color:#F4D03F"></div>
                    <span class="legend-text" id="info1">Layer 1: 5 in 16</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background:#008080;color:#008080"></div>
                    <span class="legend-text" id="info2">Layer 2: 3 in 16</span>
                </div>
            </div>

            <div class="help-hint">
                üí° Click canvas to toggle beats ‚Ä¢ Shift+Click for Layer 2 ‚Ä¢ Ctrl+Click for Layer 3
            </div>
        </div>

        <!-- RIGHT: CONTROL PANEL -->
        <div class="control-zone">

            <!-- NOTE VALUES & RESTS -->
            <div class="control-group">
                <div class="group-title">
                    <span class="group-icon">‚ô™</span>
                    Note Values & Rests
                </div>
                
                <!-- Row 1: Whole -->
                <div style="display:flex;gap:0.4rem;margin-bottom:0.5rem;align-items:center;">
                    <button class="picker-btn-horizontal" onclick="setNoteValue('whole')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <ellipse cx="20" cy="45" rx="10" ry="7" fill="none" stroke="currentColor" stroke-width="2.5"/>
                        </svg>
                        <span class="picker-label-inline">Whole</span>
                    </button>
                    <button class="picker-btn-horizontal" onclick="setNoteValue('whole-rest')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <rect x="12" y="25" width="16" height="6" fill="currentColor"/>
                        </svg>
                        <span class="picker-label-inline">W Rest</span>
                    </button>
                </div>
                
                <!-- Row 2: Half -->
                <div style="display:flex;gap:0.4rem;margin-bottom:0.5rem;align-items:center;">
                    <button class="picker-btn-horizontal" onclick="setNoteValue('half')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <ellipse cx="15" cy="50" rx="10" ry="7" fill="none" stroke="currentColor" stroke-width="2.5"/>
                            <line x1="25" y1="50" x2="25" y2="15" stroke="currentColor" stroke-width="2.5"/>
                        </svg>
                        <span class="picker-label-inline">Half</span>
                    </button>
                    <button class="picker-btn-horizontal" onclick="setNoteValue('half-rest')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <rect x="12" y="32" width="16" height="6" fill="currentColor"/>
                        </svg>
                        <span class="picker-label-inline">H Rest</span>
                    </button>
                </div>
                
                <!-- Row 3: Quarter -->
                <div style="display:flex;gap:0.4rem;margin-bottom:0.5rem;align-items:center;">
                    <button class="picker-btn-horizontal active" onclick="setNoteValue('quarter')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <ellipse cx="15" cy="50" rx="10" ry="7" fill="currentColor"/>
                            <line x1="25" y1="50" x2="25" y2="15" stroke="currentColor" stroke-width="2.5"/>
                        </svg>
                        <span class="picker-label-inline">Quarter</span>
                    </button>
                    <button class="picker-btn-horizontal" onclick="setNoteValue('quarter-rest')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <path d="M15,15 Q18,25 15,35 Q12,45 15,55" stroke="currentColor" stroke-width="2.5" fill="none"/>
                            <circle cx="18" cy="20" r="2.5" fill="currentColor"/>
                            <circle cx="12" cy="50" r="2.5" fill="currentColor"/>
                        </svg>
                        <span class="picker-label-inline">Q Rest</span>
                    </button>
                </div>
                
                <!-- Row 4: Eighth -->
                <div style="display:flex;gap:0.4rem;align-items:center;">
                    <button class="picker-btn-horizontal" onclick="setNoteValue('eighth')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <ellipse cx="15" cy="50" rx="10" ry="7" fill="currentColor"/>
                            <line x1="25" y1="50" x2="25" y2="15" stroke="currentColor" stroke-width="2.5"/>
                            <path d="M25,15 Q30,17 28,22" stroke="currentColor" stroke-width="2.5" fill="none"/>
                        </svg>
                        <span class="picker-label-inline">Eighth</span>
                    </button>
                    <button class="picker-btn-horizontal" onclick="setNoteValue('eighth-rest')" style="flex:1;">
                        <svg class="picker-icon-small" viewBox="0 0 40 60" style="width:28px;height:42px;">
                            <path d="M18,28 Q22,32 18,36" stroke="currentColor" stroke-width="2.5" fill="none"/>
                            <circle cx="21" cy="30" r="2.5" fill="currentColor"/>
                        </svg>
                        <span class="picker-label-inline">8th Rest</span>
                    </button>
                </div>
            </div>

            <!-- POLYGON SHAPES -->
            <div class="control-group">
                <div class="group-title">
                    <span class="group-icon">‚¨¢</span>
                    Polygon Shapes
                </div>
                <div class="picker-grid">
                    <button class="picker-btn" onclick="setPolygon(2)">
                        <div class="picker-icon">‚óè‚Äî‚óè</div>
                        <div class="picker-label">2</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(3)">
                        <div class="picker-icon">‚ñ≥</div>
                        <div class="picker-label">3</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(4)">
                        <div class="picker-icon">‚óª</div>
                        <div class="picker-label">4</div>
                    </button>
                    <button class="picker-btn active" onclick="setPolygon(5)">
                        <div class="picker-icon">‚¨ü</div>
                        <div class="picker-label">5</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(6)">
                        <div class="picker-icon">‚¨°</div>
                        <div class="picker-label">6</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(7)">
                        <div class="picker-icon">‚¨¢</div>
                        <div class="picker-label">7</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(8)">
                        <div class="picker-icon">‚ØÉ</div>
                        <div class="picker-label">8</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(9)">
                        <div class="picker-icon">‚óâ</div>
                        <div class="picker-label">9</div>
                    </button>
                    <button class="picker-btn" onclick="setPolygon(10)">
                        <div class="picker-icon">‚ú¶</div>
                        <div class="picker-label">10</div>
                    </button>
                </div>
            </div>

            <!-- LAYERS -->
            <div class="control-group">
                <div class="group-title">
                    <span class="group-icon">üéöÔ∏è</span>
                    Rhythm Layers
                </div>
                <div class="layer-list" id="layerList"></div>
                <button class="btn-add" onclick="addLayer()">+ Add Layer</button>
            </div>

            <!-- PRESETS -->
            <div class="control-group">
                <div class="group-title">
                    <span class="group-icon">üíæ</span>
                    Presets
                </div>
                <div class="preset-grid">
                    <button class="preset-btn" onclick="loadPreset('clave')">Clave</button>
                    <button class="preset-btn" onclick="loadPreset('bossa')">Bossa</button>
                    <button class="preset-btn" onclick="loadPreset('afro')">Afro</button>
                    <button class="preset-btn" onclick="loadPreset('poly32')">Poly 3:2</button>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- FOOTER -->
<footer class="app-footer">
    <div class="app-footer-content">
        <div class="app-social-links">
            <a href="https://x.com/keyscodesandmodes" target="_blank" rel="noopener" aria-label="X">
                <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </a>
            <a href="https://www.facebook.com/KeysCodesModes" target="_blank" rel="noopener" aria-label="Facebook">
                <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
            <a href="https://www.tiktok.com/@keyscodesandmodes" target="_blank" rel="noopener" aria-label="TikTok">
                <svg viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
            </a>
            <a href="https://www.instagram.com/keyscodesandmodes/" target="_blank" rel="noopener" aria-label="Instagram">
                <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            </a>
            <a href="https://www.linkedin.com/in/ben-ryan-guitar-freestyle/" target="_blank" rel="noopener" aria-label="LinkedIn">
                <svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
        </div>
        <div class="app-divider"></div>
        <div class="app-copyright">
            <p>&copy; 2026 <strong>Keys, Codes & Modes‚Ñ¢</strong> | Created by <strong>Benjamin Ryan</strong></p>
            <p>Based on "Keys, Codes, and Modes: A Visual Approach to Understanding Music" | Santa Barbara, California</p>
        </div>
        <div class="app-legal-links">
            <a href="/privacy.html">Privacy</a>
            <a href="/terms.html">Terms</a>
            <a href="../refund-policy.html">Refund Policy</a>
            <a href="/contact.html">Contact</a>
        </div>
    </div>
</footer>

<div class="toast" id="toast"></div>

<script>
// STATE
const State = {
    playing: false,
    currentStep: 0,
    tempo: 110,
    globalSteps: 16,
    noteValue: 'quarter',
    selectedPolygon: 5,
    rotationOffset: 0,
    rotationSpeed: 0.006,
    playheadAngle: -Math.PI / 2,  // Start at top (12 o'clock)
    volume: 0.7,
    displayMode: 'geometry',
    layers: [],
    audioCtx: null,
    masterGain: null,
    schedulerTimer: null,
    animFrame: null,
    nextNoteTime: 0,
    scheduleAheadTime: 0.1,
    lookAhead: 25,
    activeBeats: new Set()  // Track which beats just fired for visual feedback
};

const LAYER_COLORS = ['#F4D03F','#008080','#CF7A5A','#8B6BA3','#4A7BA7','#9AAF7A'];
const LAYER_SOUNDS = ['click','kick','hihat','tone','wood','rim'];
let layerIdCounter = 0;

// AUDIO
function initAudio() {
    if (State.audioCtx) return;
    State.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    State.masterGain = State.audioCtx.createGain();
    State.masterGain.gain.value = State.volume;
    State.masterGain.connect(State.audioCtx.destination);
}

function playSound(type, when) {
    if (!State.audioCtx) return;
    const ctx = State.audioCtx;
    const now = when || ctx.currentTime;
    if (type === 'click' || type === 'rim') {
        const buf = ctx.createBuffer(1, ctx.sampleRate * 0.05, ctx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.01));
        const src = ctx.createBufferSource();
        src.buffer = buf;
        const g = ctx.createGain();
        g.gain.value = type === 'rim' ? 0.4 : 0.7;
        src.connect(g); g.connect(State.masterGain);
        src.start(now);
    } else if (type === 'kick') {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.frequency.setValueAtTime(120, now);
        osc.frequency.exponentialRampToValueAtTime(30, now + 0.12);
        g.gain.setValueAtTime(0.9, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(g); g.connect(State.masterGain);
        osc.start(now); osc.stop(now + 0.22);
    } else if (type === 'tone') {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.frequency.value = 440;
        g.gain.setValueAtTime(0.35, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
        osc.connect(g); g.connect(State.masterGain);
        osc.start(now); osc.stop(now + 0.14);
    } else if (type === 'hihat' || type === 'wood') {
        const buf = ctx.createBuffer(1, ctx.sampleRate * 0.04, ctx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.008));
        const src = ctx.createBufferSource();
        src.buffer = buf;
        const filt = ctx.createBiquadFilter();
        filt.type = type === 'hihat' ? 'highpass' : 'bandpass';
        filt.frequency.value = type === 'hihat' ? 8000 : 600;
        const g = ctx.createGain();
        g.gain.value = 0.5;
        src.connect(filt); filt.connect(g); g.connect(State.masterGain);
        src.start(now);
    }
}

// EUCLIDEAN
function bjorklund(steps, pulses) {
    if (pulses <= 0) return new Array(steps).fill(0);
    if (pulses >= steps) return new Array(steps).fill(1);
    let pattern = [];
    let counts = [];
    let remainders = [];
    let divisor = steps - pulses;
    remainders.push(pulses);
    let level = 0;
    while (true) {
        counts.push(Math.floor(divisor / remainders[level]));
        remainders.push(divisor % remainders[level]);
        divisor = remainders[level];
        level++;
        if (remainders[level] <= 1) break;
    }
    counts.push(divisor);
    function build(lv) {
        if (lv === -1) pattern.push(0);
        else if (lv === -2) pattern.push(1);
        else {
            for (let i = 0; i < counts[lv]; i++) build(lv - 1);
            if (remainders[lv] !== 0) build(lv - 2);
        }
    }
    build(level);
    return pattern.reverse();
}

// LAYERS
function createLayer(steps, pulses, colorIdx, soundType) {
    const id = ++layerIdCounter;
    const color = LAYER_COLORS[colorIdx % LAYER_COLORS.length];
    return {
        id, steps: steps || State.globalSteps, pulses: pulses || State.selectedPolygon,
        pattern: bjorklund(steps || State.globalSteps, pulses || State.selectedPolygon),
        color, rotationSpeed: 1.0, soundType: soundType || LAYER_SOUNDS[colorIdx % LAYER_SOUNDS.length], muted: false
    };
}

function addLayer() {
    if (State.layers.length >= 6) { showToast('‚ö†Ô∏è Max 6 layers'); return; }
    const idx = State.layers.length;
    State.layers.push(createLayer(State.globalSteps, State.selectedPolygon, idx, LAYER_SOUNDS[idx]));
    renderLayers();
    showToast('‚úÖ Layer ' + (idx + 1) + ' added');
}

function removeLayer(id) {
    State.layers = State.layers.filter(l => l.id !== id);
    renderLayers();
    showToast('üóëÔ∏è Layer removed');
}

function muteLayer(id) {
    const l = State.layers.find(l => l.id === id);
    if (l) { l.muted = !l.muted; renderLayers(); showToast(l.muted ? 'üîá Muted' : 'üîä Unmuted'); }
}

function updateLayerPulses(id, val) {
    const l = State.layers.find(l => l.id === id);
    if (l) {
        l.pulses = parseInt(val);
        l.pattern = bjorklund(l.steps, Math.min(l.pulses, l.steps));
        document.getElementById(`lpv-${id}`).textContent = l.pulses;
    }
}

function renderLayers() {
    const container = document.getElementById('layerList');
    container.innerHTML = '';
    State.layers.forEach((layer, idx) => {
        const card = document.createElement('div');
        card.className = 'layer-item';
        card.style.background = `linear-gradient(135deg, ${layer.color}18, ${layer.color}08)`;
        card.style.borderColor = layer.muted ? 'rgba(255,255,255,0.08)' : `${layer.color}55`;
        card.innerHTML = `
            <div class="layer-header">
                <div class="layer-info">
                    <div class="layer-dot" style="background:${layer.color};color:${layer.color}"></div>
                    <span class="layer-name" style="color:${layer.color}">Layer ${idx+1}</span>
                </div>
                <div class="layer-btns">
                    <button class="layer-btn ${layer.muted?'muted':''}" onclick="muteLayer(${layer.id})">${layer.muted?'üîá':'üîä'}</button>
                    <button class="layer-btn" onclick="removeLayer(${layer.id})">√ó</button>
                </div>
            </div>
            <div class="layer-slider">
                <span style="font-size:0.75rem;color:rgba(232,232,232,0.6);min-width:50px">Pulses</span>
                <input type="range" min="1" max="${layer.steps}" value="${layer.pulses}" step="1"
                    oninput="updateLayerPulses(${layer.id},this.value)" style="accent-color:${layer.color}">
                <span class="slider-val" id="lpv-${layer.id}" style="color:${layer.color}">${layer.pulses}</span>
            </div>
        `;
        container.appendChild(card);
    });
}

// PLAYBACK
function scheduler() {
    while (State.nextNoteTime < State.audioCtx.currentTime + State.scheduleAheadTime) {
        scheduleNote(State.currentStep, State.nextNoteTime);
        advanceStep();
    }
    State.schedulerTimer = setTimeout(scheduler, State.lookAhead);
}

function scheduleNote(step, time) {
    State.layers.forEach((layer, layerIdx) => {
        if (layer.muted) return;
        const layerStep = step % layer.steps;
        if (layer.pattern[layerStep] === 1) {
            playSound(layer.soundType, time);
            
            // Calculate when this note will actually play
            const delayMs = (time - State.audioCtx.currentTime) * 1000;
            
            // Mark this beat as active at the RIGHT TIME
            const beatKey = `${layerIdx}-${layerStep}`;
            setTimeout(() => {
                State.activeBeats.add(beatKey);
                // Clear after 150ms
                setTimeout(() => State.activeBeats.delete(beatKey), 150);
            }, Math.max(0, delayMs));
        }
    });
}

function advanceStep() {
    const secondsPerBeat = 60.0 / State.tempo;
    const noteValueMultiplier = { 
        'whole': 4, 'half': 2, 'quarter': 1, 'eighth': 0.5, '16th': 0.25, '32nd': 0.125,
        'whole-rest': 4, 'half-rest': 2, 'quarter-rest': 1, 'eighth-rest': 0.5
    };
    State.nextNoteTime += (secondsPerBeat / 4) * noteValueMultiplier[State.noteValue];
    State.currentStep = (State.currentStep + 1) % State.globalSteps;
}

function togglePlay() {
    initAudio();
    if (!State.playing) {
        if (State.audioCtx.state === 'suspended') State.audioCtx.resume();
        State.playing = true;
        State.nextNoteTime = State.audioCtx.currentTime;
        scheduler();
        document.getElementById('playBtn').textContent = '‚è∏ Pause';
        document.getElementById('playBtn').classList.add('playing');
        showToast('‚ñ∂Ô∏è Playing');
    } else {
        State.playing = false;
        clearTimeout(State.schedulerTimer);
        document.getElementById('playBtn').textContent = '‚ñ∂ Play';
        document.getElementById('playBtn').classList.remove('playing');
        showToast('‚è∏ Paused');
    }
}

function stopReset() {
    State.playing = false;
    State.currentStep = 0;
    State.playheadAngle = -Math.PI / 2;  // Reset to 12 o'clock
    clearTimeout(State.schedulerTimer);
    document.getElementById('playBtn').textContent = '‚ñ∂ Play';
    document.getElementById('playBtn').classList.remove('playing');
    showToast('‚ñ† Stopped & Reset');
}

function resetRot() { 
    State.rotationOffset = 0; 
    State.playheadAngle = -Math.PI / 2;  // Reset playhead
    showToast('‚Üª Reset'); 
}

// UI CONTROLS
function setTempo(val) {
    State.tempo = parseInt(val);
    document.getElementById('tempoDisplay').textContent = val;
}

function setSteps(val) {
    State.globalSteps = parseInt(val);
    document.getElementById('stepsVal').textContent = val;
}

function setVolume(val) {
    State.volume = parseInt(val) / 100;
    document.getElementById('volumeVal').textContent = val;
    if (State.masterGain) State.masterGain.gain.value = State.volume;
}

function setNoteValue(val) {
    State.noteValue = val;
    // Remove active from both old grid-2 buttons and new horizontal buttons
    document.querySelectorAll('.picker-btn, .picker-btn-horizontal').forEach(b => b.classList.remove('active'));
    event.target.closest('button').classList.add('active');
    const isRest = val.includes('rest');
    showToast((isRest ? 'ùÑΩ ' : '‚ô™ ') + val.replace('-', ' ').toUpperCase());
}

function setPolygon(num) {
    State.selectedPolygon = num;
    document.querySelectorAll('.picker-grid .picker-btn').forEach(b => b.classList.remove('active'));
    event.target.closest('.picker-btn').classList.add('active');
    State.layers.forEach(l => { l.pulses = Math.min(num, l.steps); l.pattern = bjorklund(l.steps, l.pulses); });
    renderLayers();
    showToast('‚¨¢ ' + num + '-sided');
}

function setMode(mode) {
    State.displayMode = mode;
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${mode === 'geometry' ? 'geo' : mode === 'dots' ? 'dots' : mode === 'notation' ? 'note' : 'spiral'}`).classList.add('active');
}

// CANVAS
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const CX = 325, CY = 325, R = 290;

function draw() {
    ctx.clearRect(0, 0, 650, 650);
    const bgGrad = ctx.createRadialGradient(CX, CY, 0, CX, CY, 325);
    bgGrad.addColorStop(0, 'rgba(0,128,128,0.05)');
    bgGrad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, 650, 650);

    if (State.displayMode === 'geometry') drawGeometry();
    else if (State.displayMode === 'dots') drawDots();
    else if (State.displayMode === 'notation') drawNotation();
    else if (State.displayMode === 'spiral') drawSpiral();

    // SYNC PLAYHEAD TO CURRENT STEP with smooth interpolation
    if (State.playing && State.audioCtx) {
        // Calculate how far through the current beat we are
        const secondsPerBeat = 60.0 / State.tempo;
        const noteValueMultiplier = { 
            'whole': 4, 'half': 2, 'quarter': 1, 'eighth': 0.5, '16th': 0.25, '32nd': 0.125,
            'whole-rest': 4, 'half-rest': 2, 'quarter-rest': 1, 'eighth-rest': 0.5
        };
        const beatDuration = (secondsPerBeat / 4) * noteValueMultiplier[State.noteValue];
        const currentTime = State.audioCtx.currentTime;
        const timeSinceLastBeat = currentTime - (State.nextNoteTime - beatDuration);
        const progress = Math.min(timeSinceLastBeat / beatDuration, 1);
        
        // Interpolate between current step and next step
        const currentAngle = (State.currentStep / State.globalSteps) * Math.PI * 2 - Math.PI / 2;
        const nextStep = (State.currentStep + 1) % State.globalSteps;
        const nextAngle = (nextStep / State.globalSteps) * Math.PI * 2 - Math.PI / 2;
        
        // Handle wrap-around at 360 degrees
        let angleDiff = nextAngle - currentAngle;
        if (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
        if (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
        
        State.playheadAngle = currentAngle + angleDiff * progress;
    }

    State.animFrame = requestAnimationFrame(draw);
    State.rotationOffset += State.rotationSpeed;  // Keep for spiral mode
}

function drawGeometry() {
    // STATIONARY CLOCK FACE
    // Outer circle
    ctx.strokeStyle = 'rgba(0,128,128,0.35)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(CX, CY, R, 0, Math.PI * 2);
    ctx.stroke();

    // Concentric guide rings
    for (let r = 60; r < R; r += 60) {
        ctx.strokeStyle = 'rgba(0,128,128,0.08)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(CX, CY, r, 0, Math.PI * 2);
        ctx.stroke();
    }

    // Step tick marks (STATIONARY)
    for (let i = 0; i < State.globalSteps; i++) {
        const angle = (i / State.globalSteps) * Math.PI * 2 - Math.PI / 2;
        const x1 = CX + Math.cos(angle) * (R - 12);
        const y1 = CY + Math.sin(angle) * (R - 12);
        const x2 = CX + Math.cos(angle) * (R + 12);
        const y2 = CY + Math.sin(angle) * (R + 12);
        ctx.strokeStyle = 'rgba(0,128,128,0.3)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }

    // Draw beat dots for each layer (STATIONARY - NO ROTATION!)
    State.layers.forEach((layer, layerIdx) => {
        if (layer.muted) return;
        const radius = R - 35 - layerIdx * 42;
        
        for (let i = 0; i < layer.steps; i++) {
            // STATIONARY angle - no rotation offset!
            const angle = (i / layer.steps) * Math.PI * 2 - Math.PI / 2;
            const x = CX + Math.cos(angle) * radius;
            const y = CY + Math.sin(angle) * radius;
            
            if (layer.pattern[i] === 1) {
                // Check if this beat is currently active (just fired)
                const beatKey = `${layerIdx}-${i}`;
                const isActive = State.activeBeats.has(beatKey);
                
                // GLOW when active
                if (isActive) {
                    const grad = ctx.createRadialGradient(x, y, 0, x, y, 28);
                    grad.addColorStop(0, '#FFFFFF');
                    grad.addColorStop(0.3, layer.color);
                    grad.addColorStop(1, 'transparent');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(x, y, 28, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Beat dot - WHITE when active, colored when inactive
                ctx.fillStyle = isActive ? '#FFFFFF' : layer.color;
                ctx.beginPath();
                ctx.arc(x, y, isActive ? 11 : 9, 0, Math.PI * 2);
                ctx.fill();
                
                // Ring around dot
                ctx.strokeStyle = isActive ? layer.color : 'rgba(255,255,255,0.4)';
                ctx.lineWidth = isActive ? 3 : 2;
                ctx.stroke();
            } else {
                // Empty step marker
                ctx.fillStyle = 'rgba(0,128,128,0.15)';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    });

    // ROTATING PLAYHEAD (like clock hand)
    const playheadLength = R - 25;
    const playheadX = CX + Math.cos(State.playheadAngle) * playheadLength;
    const playheadY = CY + Math.sin(State.playheadAngle) * playheadLength;
    
    // Playhead line with glow
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#F4D03F';
    ctx.strokeStyle = '#F4D03F';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(CX, CY);
    ctx.lineTo(playheadX, playheadY);
    ctx.stroke();
    ctx.shadowBlur = 0;
    
    // Playhead tip
    ctx.fillStyle = '#F4D03F';
    ctx.beginPath();
    ctx.arc(playheadX, playheadY, 9, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#FFFFFF';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Center hub
    const cGrad = ctx.createRadialGradient(CX, CY, 0, CX, CY, 18);
    cGrad.addColorStop(0, '#F4D03F');
    cGrad.addColorStop(1, 'rgba(244,208,63,0)');
    ctx.fillStyle = cGrad;
    ctx.beginPath();
    ctx.arc(CX, CY, 18, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#F4D03F';
    ctx.beginPath();
    ctx.arc(CX, CY, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#FFFFFF';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function drawDots() {
    ctx.fillStyle = 'rgba(232,232,232,0.7)';
    ctx.font = 'bold 20px Cinzel';
    ctx.textAlign = 'center';
    ctx.fillText('DOT PATTERNS', CX, 40);
    const examples = [
        { n: 2, y: 100, name: '2 DOTS ‚Üí LINE', color: '#F4D03F' },
        { n: 3, y: 165, name: '3 DOTS ‚Üí TRIANGLE', color: '#008080' },
        { n: 4, y: 230, name: '4 DOTS ‚Üí SQUARE', color: '#CF7A5A' },
        { n: 5, y: 295, name: '5 DOTS ‚Üí PENTAGON', color: '#8B6BA3' },
        { n: 6, y: 360, name: '6 DOTS ‚Üí HEXAGON', color: '#4A7BA7' },
        { n: 7, y: 425, name: '7 DOTS ‚Üí HEPTAGON', color: '#9AAF7A' }
    ];
    examples.forEach(ex => {
        ctx.fillStyle = ex.color;
        ctx.font = 'bold 12px Montserrat';
        ctx.textAlign = 'left';
        ctx.fillText(ex.name, 90, ex.y);
        const points = [];
        for (let i = 0; i < ex.n; i++) {
            const angle = (i / ex.n) * Math.PI * 2 - Math.PI / 2;
            points.push({ x: CX + Math.cos(angle) * 35, y: ex.y + 5 + Math.sin(angle) * 35 });
        }
        points.forEach(p => {
            ctx.fillStyle = ex.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 7, 0, Math.PI * 2);
            ctx.fill();
        });
        if (points.length > 1) {
            ctx.strokeStyle = ex.color + '60';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.closePath();
            ctx.stroke();
        }
    });
}

function drawNotation() {
    ctx.fillStyle = 'rgba(232,232,232,0.7)';
    ctx.font = 'bold 20px Cinzel';
    ctx.textAlign = 'center';
    ctx.fillText('NOTE VALUES', CX, 40);
    const notes = [
        { symbol: 'ùÖù', name: 'Whole', value: '4 beats', y: 110, key: 'whole' },
        { symbol: 'ùÖóùÖ•', name: 'Half', value: '2 beats', y: 175, key: 'half' },
        { symbol: '‚ô©', name: 'Quarter', value: '1 beat', y: 240, key: 'quarter' },
        { symbol: '‚ô™', name: 'Eighth', value: '¬Ω beat', y: 305, key: 'eighth' },
        { symbol: 'ùÖòùÖ•ùÖØ', name: '16th', value: '¬º beat', y: 370, key: '16th' },
        { symbol: 'ùÖòùÖ•ùÖ∞', name: '32nd', value: '‚Öõ beat', y: 435, key: '32nd' }
    ];
    notes.forEach(note => {
        const isActive = State.noteValue === note.key;
        ctx.fillStyle = isActive ? '#F4D03F' : 'rgba(232,232,232,0.5)';
        ctx.font = '48px Arial';
        ctx.fillText(note.symbol, CX - 120, note.y + 10);
        ctx.fillStyle = isActive ? '#F4D03F' : 'rgba(232,232,232,0.6)';
        ctx.font = 'bold 15px Montserrat';
        ctx.textAlign = 'left';
        ctx.fillText(note.name, CX, note.y - 8);
        ctx.fillStyle = isActive ? '#008080' : 'rgba(232,232,232,0.4)';
        ctx.font = '13px Montserrat';
        ctx.fillText(note.value, CX, note.y + 10);
    });
}

function drawSpiral() {
    ctx.strokeStyle = '#8B6BA3';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    for (let i = 0; i < 450; i++) {
        const angle = i * 0.07 + State.rotationOffset;
        const rad = 15 + i * 0.65;
        if (rad > 320) break;
        const x = CX + Math.cos(angle) * rad;
        const y = CY + Math.sin(angle) * rad;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();
    State.layers.forEach(layer => {
        if (layer.muted) return;
        for (let i = 0; i < layer.steps; i++) {
            if (layer.pattern[i] === 1) {
                const spiralPos = (i / layer.steps) * 220 + State.rotationOffset * 65;
                const angle = spiralPos * 0.07 + State.rotationOffset;
                const rad = 15 + spiralPos * 0.65;
                if (rad > 320) continue;
                const x = CX + Math.cos(angle) * rad;
                const y = CY + Math.sin(angle) * rad;
                ctx.fillStyle = layer.color;
                ctx.beginPath();
                ctx.arc(x, y, 7, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    });
}

// PRESETS
function loadPreset(name) {
    State.layers = [];
    layerIdCounter = 0;
    if (name === 'clave') {
        State.layers.push(createLayer(16, 5, 0, 'wood'));
        State.layers.push(createLayer(16, 3, 1, 'click'));
    } else if (name === 'bossa') {
        State.layers.push(createLayer(16, 5, 0, 'wood'));
        State.layers.push(createLayer(16, 3, 1, 'hihat'));
        State.layers.push(createLayer(16, 2, 2, 'kick'));
    } else if (name === 'afro') {
        State.layers.push(createLayer(12, 7, 0, 'tone'));
        State.layers.push(createLayer(12, 5, 1, 'click'));
    } else if (name === 'poly32') {
        State.layers.push(createLayer(16, 3, 0, 'click'));
        State.layers.push(createLayer(16, 2, 1, 'tone'));
    }
    renderLayers();
    showToast('üíæ ' + name.toUpperCase());
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
}

// CANVAS CLICK
canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const mx = (e.clientX - rect.left) * scaleX;
    const my = (e.clientY - rect.top) * scaleY;
    const targetLayerIdx = e.shiftKey ? 1 : e.ctrlKey || e.metaKey ? 2 : 0;
    const targetLayer = State.layers[targetLayerIdx];
    if (!targetLayer) { showToast('‚ö†Ô∏è Layer ' + (targetLayerIdx + 1) + ' not found'); return; }
    const dx = mx - CX, dy = my - CY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 40) return;
    let angle = Math.atan2(dy, dx) + Math.PI / 2 - State.rotationOffset * targetLayer.rotationSpeed;
    if (angle < 0) angle += Math.PI * 2;
    if (angle >= Math.PI * 2) angle -= Math.PI * 2;
    const stepIdx = Math.round(angle / (Math.PI * 2) * targetLayer.steps) % targetLayer.steps;
    targetLayer.pattern[stepIdx] ^= 1;
    initAudio();
    if (targetLayer.pattern[stepIdx] === 1) playSound(targetLayer.soundType);
});

// INIT
function init() {
    State.layers.push(createLayer(16, 5, 0, 'click'));
    State.layers.push(createLayer(16, 3, 1, 'kick'));
    renderLayers();
    draw();
    document.addEventListener('click', () => { initAudio(); }, { once: true });
    showToast('üéµ Rhythm Geometry Lab');
}

init();
</script>
</body>
</html>
