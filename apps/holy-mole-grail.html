<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ The Holy Grail - Keys, Codes & Modes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0e17 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 2rem 2rem;
            border-bottom: 3px solid #0f3460;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .hero-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .hero-logo-img {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0 20px rgba(233, 69, 96, 0.4));
        }
        
        .hero-logo-img svg {
            width: 100%;
            height: 100%;
        }
        
        .brand-text {
            text-align: center;
            margin-left: 1.5rem;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(90deg, #e94560, #0f3460, #16213e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #e94560;
            font-size: 1rem;
            font-weight: 600;
            margin: 0.5rem 0 0 0;
            letter-spacing: 1px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 150px);
            min-height: 700px;
        }
        
        .controls-panel {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 3px solid #e94560;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5), 0 0 20px rgba(233, 69, 96, 0.2);
            overflow-y: auto;
        }
        
        /* LAYER 1: Panel container */
        .wheel-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 700px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 50% 50%, rgba(22, 33, 62, 0.3) 0%, rgba(15, 14, 23, 0.6) 100%);
            border-radius: 24px;
            border: 3px solid #e94560;
            box-shadow: 0 0 40px rgba(233, 69, 96, 0.3);
            overflow: visible;
            padding: 0;
            margin: 0;
        }
        
        /* LAYER 2: Subdued circle background */
        .wheel-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 470px;
            height: 470px;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 50%, rgba(10, 15, 26, 0.9) 0%, rgba(26, 35, 50, 0.5) 100%);
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8), 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        
        /* LAYER 3: SVG with notes/spokes/wedges - ABSOLUTELY LOCKED */
        #holyGrailSVG {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            display: block;
            margin: 0;
            padding: 0;
        }
        
        .section-title {
            color: #e94560;
            font-size: 0.9rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 1.2rem 0 0.6rem 0;
            padding-bottom: 0.4rem;
            border-bottom: 2px solid #e94560;
            text-align: center;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        button {
            background: linear-gradient(135deg, #2a3a4f 0%, #1a2a3f 100%);
            color: #fff;
            border: 2px solid #3a4a5f;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        button:hover {
            background: linear-gradient(135deg, #3a4a5f 0%, #2a3a4f 100%);
            border-color: #FFFF00;
        }
        
        button.active {
            background: linear-gradient(135deg, #FFFF00 0%, #FFD700 100%);
            color: #000;
            border-color: #FFFF00;
            font-weight: 900;
        }
        
        button.primary {
            background: linear-gradient(135deg, #FFFF00 0%, #FFD700 100%);
            color: #000;
            font-weight: 900;
            font-size: 1rem;
            padding: 0.9rem;
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
        }
        
        .help-text {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid rgba(233, 69, 96, 0.3);
            padding: 0.7rem;
            border-radius: 8px;
            color: #e94560;
            font-size: 0.82rem;
            line-height: 1.3;
            margin: 0.8rem 0;
            text-align: center;
        }
        
        .note-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .note-node:hover {
            filter: brightness(1.2);
        }
        
        .note-node.active {
            filter: brightness(1.8) drop-shadow(0 0 8px currentColor);
            stroke: #ffffff;
            stroke-width: 2; /* Thicker outline instead of scaling */
            /* NO transform - prevents jumping! */
        }
        
        .note-node.playing {
            filter: brightness(2.5) drop-shadow(0 0 12px currentColor);
            stroke: #ffffff;
            stroke-width: 3; /* Thicker outline for playing */
            transition: all 0.1s ease-out;
            /* NO transform - prevents jumping! */
        }
        
        .note-label {
            pointer-events: none;
            user-select: none;
        }
        
        .rotate-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        footer {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 1rem;
            text-align: center;
            border-top: 2px solid #e94560;
            color: #e94560;
            font-size: 0.85rem;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a2a3f;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #FFFF00;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header>
        <div class="hero-brand">
            <div class="hero-logo-img">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="100" r="98" fill="#4A7BA7" stroke="#2a4d6f" stroke-width="1"/>
                    <polygon points="100,15 185,185 15,185" fill="#F4D03F" opacity="0.85"/>
                    <polygon points="100,15 15,185 15,55" fill="#8B6BA3" opacity="0.75"/>
                    <polygon points="100,15 185,55 185,185" fill="#6FA5A5" opacity="0.75"/>
                    <polygon points="15,55 100,100 15,185" fill="#CF7A5A" opacity="0.65"/>
                    <polygon points="185,55 100,100 185,185" fill="#9AAF7A" opacity="0.65"/>
                    <polygon points="100,55 145,100 100,145 55,100" fill="#E8D77F" opacity="0.6"/>
                    <circle cx="100" cy="100" r="50" fill="none" stroke="#2a4d6f" stroke-width="2.5"/>
                    <circle cx="100" cy="100" r="7" fill="#2a4d6f"/>
                    <line x1="40" y1="40" x2="160" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                    <line x1="160" y1="40" x2="40" y2="160" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                    <line x1="100" y1="20" x2="100" y2="180" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                    <line x1="20" y1="100" x2="180" y2="100" stroke="#2a4d6f" stroke-width="1.5" opacity="0.4"/>
                </svg>
            </div>
            <div class="brand-text">
                <h1>KEYS, CODES & MODES</h1>
                <p class="subtitle">The Holy Grail - Chromatic Visualization</p>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- CONTROLS -->
        <div class="controls-panel">
            <button id="audioBtn" class="primary danger">üî¥ START AUDIO</button>
            
            <div class="help-text">
                ‚úÖ NO JUMPING: Circles stay centered when active!<br>
                ‚è±Ô∏è SPEED: Left=Slow, Right=Fast (intuitive!)<br>
                üîÑ TEXT: 90¬∞ rotation at 12 & 6 o'clock<br>
                üé® OPACITY: 45% - chromatic colors visible!
            </div>
            
            <div class="section-title">üéπ Select Key</div>
            <select id="keySelector" style="width: 100%; padding: 0.6rem; font-size: 1rem; border-radius: 8px; border: 2px solid #e94560; background: rgba(22, 33, 62, 0.9); color: #fff; font-weight: 600; margin-bottom: 0.5rem;">
                <option value="0">C</option>
                <option value="1">C# / Db</option>
                <option value="2">D</option>
                <option value="3">D# / Eb</option>
                <option value="4">E</option>
                <option value="5">F</option>
                <option value="6">F# / Gb</option>
                <option value="7">G</option>
                <option value="8">G# / Ab</option>
                <option value="9">A</option>
                <option value="10">A# / Bb</option>
                <option value="11">B</option>
            </select>
            
            <div class="section-title">üîÑ Rotate</div>
            <div class="rotate-controls">
                <button id="rotateLeftBtn">‚Üê Left</button>
                <button id="rotateRightBtn">Right ‚Üí</button>
                <button id="autoRotateBtn">üîÑ Auto</button>
                <button id="resetBtn">‚≠ï Reset</button>
            </div>
            
            <div id="currentKeyDisplay" style="background: rgba(233,69,96,0.15); border: 2px solid #e94560; padding: 0.8rem; border-radius: 8px; text-align: center; margin-top: 0.5rem;">
                <div style="font-size: 0.75rem; color: #e94560; margin-bottom: 0.3rem;">12 O'CLOCK KEY:</div>
                <div id="currentKeyText" style="font-size: 1.5rem; font-weight: 900; color: #e94560;">C</div>
            </div>
            
            <div class="section-title">üîä Auto-Play Mode</div>
            <div class="controls">
                <button id="autoPlayChordBtn" class="active">üéπ Chord (All Notes)</button>
                <button id="autoPlayArpeggioBtn">üéµ Arpeggio (Sequential)</button>
            </div>
            
            <div class="section-title">‚è±Ô∏è Playback Speed</div>
            <div style="padding: 0.5rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: #888; margin-bottom: 0.2rem;">
                    <span>‚Üê Slow</span>
                    <span>Fast ‚Üí</span>
                </div>
                <input type="range" id="speedControl" min="50" max="400" value="300" step="10" style="width: 100%;">
                <div id="speedDisplay" style="text-align: center; font-size: 0.75rem; color: #e94560; margin-top: 0.3rem;">150ms / note</div>
            </div>
            
            <div class="section-title">‚ñ∂Ô∏è Play</div>
            <div class="controls">
                <button id="playBtn">‚ñ∂Ô∏è Play Chord</button>
                <button id="arpeggioBtn">üéµ Arpeggio Up</button>
                <button id="arpeggioDownBtn">üéµ Arpeggio Down</button>
                <button id="clearBtn">‚úñÔ∏è Clear</button>
            </div>
            
            <div class="section-title">üéπ Scales</div>
            <div class="controls">
                <button class="stencil-btn" data-pattern="major">Major</button>
                <button class="stencil-btn" data-pattern="minor">Minor</button>
                <button class="stencil-btn" data-pattern="harmonic">Harmonic Minor</button>
                <button class="stencil-btn" data-pattern="melodic">Melodic Minor</button>
                <button class="stencil-btn" data-pattern="pentatonic">Pentatonic</button>
                <button class="stencil-btn" data-pattern="blues">Blues</button>
                <button class="stencil-btn" data-pattern="chromatic">Chromatic</button>
            </div>
            
            <div class="section-title">üéµ Modes</div>
            <div class="controls">
                <button class="stencil-btn" data-pattern="ionian">Ionian</button>
                <button class="stencil-btn" data-pattern="dorian">Dorian</button>
                <button class="stencil-btn" data-pattern="phrygian">Phrygian</button>
                <button class="stencil-btn" data-pattern="lydian">Lydian</button>
                <button class="stencil-btn" data-pattern="mixolydian">Mixolydian</button>
                <button class="stencil-btn" data-pattern="aeolian">Aeolian</button>
                <button class="stencil-btn" data-pattern="locrian">Locrian</button>
            </div>
            
            <div class="section-title">üé∏ Chords</div>
            <div class="controls">
                <button class="stencil-btn" data-pattern="major-chord">Major</button>
                <button class="stencil-btn" data-pattern="minor-chord">Minor</button>
                <button class="stencil-btn" data-pattern="dim">Diminished</button>
                <button class="stencil-btn" data-pattern="aug">Augmented</button>
                <button class="stencil-btn" data-pattern="dom7">Dom 7th</button>
                <button class="stencil-btn" data-pattern="maj7">Maj 7th</button>
            </div>
        </div>
        
        <!-- WHEEL - 3 LAYERS PERFECTLY ALIGNED -->
        <div class="wheel-container">
            <svg id="holyGrailSVG" width="450" height="450" viewBox="0 0 450 450"></svg>
        </div>
    </div>
    
    <footer>
        ¬© 2024 Keys, Codes & Modes | Perfect 3-Layer Holy Grail
    </footer>
    
    <script>
        const chromaticNotes = [
            { name: 'C', color: '#FFFF00', midi: 60 },      // 0: Yellow
            { name: 'C#', color: '#FFC400', midi: 61 },     // 1: Yellow-Orange
            { name: 'D', color: '#FF8000', midi: 62 },      // 2: Orange
            { name: 'D#', color: '#FF4000', midi: 63 },     // 3: Red-Orange
            { name: 'E', color: '#FF0000', midi: 64 },      // 4: Red
            { name: 'F', color: '#C4007F', midi: 65 },      // 5: Red-Purple
            { name: 'F#', color: '#8000FF', midi: 66 },     // 6: Purple
            { name: 'G', color: '#4000FF', midi: 67 },      // 7: Blue-Purple
            { name: 'G#', color: '#0000FF', midi: 68 },     // 8: Blue
            { name: 'A', color: '#007FFF', midi: 69 },      // 9: Blue-Green
            { name: 'A#', color: '#00FF80', midi: 70 },     // 10: Green
            { name: 'B', color: '#80FF00', midi: 71 }       // 11: Yellow-Green
        ];
        
        const SLATE_COLOR = '#2a3a4f';
        
        // Function to get which chromatic note is currently at 12 o'clock
        function getNoteAt12OClock() {
            // With -15¬∞ initial rotation, wedge 0 (C) is at 12 o'clock
            // Right button: -30¬∞ brings next wedge (C#, D, D#, etc.) to 12 o'clock
            // Left button: +30¬∞ brings previous wedge (B, A#, A, etc.) to 12 o'clock
            const normalizedRotation = ((currentRotation + 15) % 360 + 360) % 360;
            const steps = Math.round(normalizedRotation / 30);
            const noteIndex = (12 - steps) % 12;
            return noteIndex;
        }
        
        function updateCurrentKeyDisplay() {
            const noteIndex = getNoteAt12OClock();
            const keyDisplay = document.getElementById('currentKeyText');
            const keySelector = document.getElementById('keySelector');
            if (keyDisplay) {
                keyDisplay.textContent = chromaticNotes[noteIndex].name;
                keyDisplay.style.color = chromaticNotes[noteIndex].color;
            }
            // Sync the dropdown selector
            if (keySelector) {
                keySelector.value = noteIndex;
            }
        }
        
        // MUSICALLY VERIFIED PATTERNS - ALL CORRECT!
        // Each pattern uses semitone intervals from the root note
        // Scales: Major, Minor (Natural, Harmonic, Melodic), Pentatonic, Blues
        // Modes: Ionian, Dorian, Phrygian, Lydian, Mixolydian, Aeolian, Locrian
        // Chords: Major, Minor, Diminished, Augmented, Dominant 7th, Major 7th
        const stencilPatterns = {
            // SCALES (8 total)
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],  // All 12 semitones
            'major': [0, 2, 4, 5, 7, 9, 11, 12],  // W-W-H-W-W-W-H
            'minor': [0, 2, 3, 5, 7, 8, 10, 12],  // Natural Minor: W-H-W-W-H-W-W
            'harmonic': [0, 2, 3, 5, 7, 8, 11, 12],  // Harmonic Minor: raises 7th
            'melodic': [0, 2, 3, 5, 7, 9, 11, 12],  // Melodic Minor: raises 6th & 7th
            'pentatonic': [0, 2, 4, 7, 9, 12],  // Major Pentatonic: 5 notes
            'blues': [0, 3, 5, 6, 7, 10, 12],  // Blues scale with blue note (b5)
            
            // MODES (7 total) - Church modes
            'ionian': [0, 2, 4, 5, 7, 9, 11, 12],  // Same as Major
            'dorian': [0, 2, 3, 5, 7, 9, 10, 12],  // Minor with raised 6th
            'phrygian': [0, 1, 3, 5, 7, 8, 10, 12],  // Minor with lowered 2nd
            'lydian': [0, 2, 4, 6, 7, 9, 11, 12],  // Major with raised 4th
            'mixolydian': [0, 2, 4, 5, 7, 9, 10, 12],  // Major with lowered 7th
            'aeolian': [0, 2, 3, 5, 7, 8, 10, 12],  // Same as Natural Minor
            'locrian': [0, 1, 3, 5, 6, 8, 10, 12],  // Diminished scale
            
            // CHORDS (6 total) - Triads (1-3-5) and 7th chords (1-3-5-7)
            'major-chord': [0, 4, 7],  // Major triad: Root, Major 3rd, Perfect 5th
            'minor-chord': [0, 3, 7],  // Minor triad: Root, Minor 3rd, Perfect 5th
            'dim': [0, 3, 6],  // Diminished triad: Root, Minor 3rd, Diminished 5th
            'aug': [0, 4, 8],  // Augmented triad: Root, Major 3rd, Augmented 5th
            'dom7': [0, 4, 7, 10],  // Dominant 7th: Major triad + Minor 7th
            'maj7': [0, 4, 7, 11]  // Major 7th: Major triad + Major 7th
        };
        
        let synth = null;
        let activeNodes = new Set();
        let currentRotation = -15; // C at 12 o'clock (original position)
        let isAutoRotating = false;
        let rotationInterval = null;
        let currentPattern = null; // Track which pattern is active
        let playbackSpeed = 150; // Milliseconds per note (adjustable with slider)
        
        // CLEAN, SMOOTH SOUND - Like Circle of Fifths
        document.getElementById('audioBtn').addEventListener('click', async function() {
            if (!synth) {
                await Tone.start();
                
                // Enhanced synth with richer sound - like Circle of Fifths quality
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { 
                        type: 'sine',
                        partialCount: 0  // Pure sine wave
                    },
                    envelope: {
                        attack: 0.005,   // Quick attack for clarity
                        decay: 0.1,
                        sustain: 0.5,    // Longer sustain for chords
                        release: 0.8     // Gentle release
                    },
                    volume: -6  // Slightly louder for better audibility
                }).toDestination();
                
                this.textContent = 'üü¢ AUDIO READY';
                this.classList.remove('danger');
                this.classList.add('success');
            }
        });
        
        function drawHolyGrail() {
            const svg = document.getElementById('holyGrailSVG');
            svg.innerHTML = '';
            
            // 450px wheel - centered at (225, 225)
            const centerX = 225;
            const centerY = 225;
            const circles = 13;
            const wedges = 12;
            const minRadius = 30;  // Smaller center
            const maxRadius = 210;  // Larger outer
            const radiusStep = (maxRadius - minRadius) / circles;  // ~13.8px steps - BIGGER!
            
            // BACKGROUND CIRCLE - Makes the wheel visible and contained
            const backgroundCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            backgroundCircle.setAttribute('cx', centerX);
            backgroundCircle.setAttribute('cy', centerY);
            backgroundCircle.setAttribute('r', maxRadius + 20);
            backgroundCircle.setAttribute('fill', '#000000'); // Pure black background
            backgroundCircle.setAttribute('stroke', '#e94560');
            backgroundCircle.setAttribute('stroke-width', '3');
            backgroundCircle.setAttribute('opacity', '1'); // Solid
            svg.appendChild(backgroundCircle);
            
            // Create rotating group - circles will be on this rotating element
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.id = 'rotatingGroup';
            g.setAttribute('transform', `rotate(${currentRotation} 225 225)`);
            
            // Calculate which wedge is at 12 o'clock (in pie window)
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            const rotationSteps = Math.round(normalizedRotation / 30);
            const wedgeAt12OClock = (12 - rotationSteps) % 12;
            
            for (let circleIdx = 0; circleIdx < circles; circleIdx++) {
                const radius = minRadius + (circleIdx * radiusStep);
                const nextRadius = radius + radiusStep;
                
                for (let wedgeIdx = 0; wedgeIdx < wedges; wedgeIdx++) {
                    // CORRECT CHROMATIC STRUCTURE: Each spoke ascends chromatically from its root
                    // Spoke 0 (C): C, C#, D, D#, E, F, F#, G, G#, A, A#, B, C (straight up!)
                    // Spoke 1 (C#): C#, D, D#, E, F, F#, G, G#, A, A#, B, C, C# (straight up!)
                    
                    // Each circle represents the next semitone up from the spoke's root
                    const rootNoteIdx = wedgeIdx;  // Root note for this spoke
                    const currentNoteIdx = (rootNoteIdx + circleIdx) % 12;  // Chromatic note at this circle
                    const note = chromaticNotes[currentNoteIdx];  // Get correct chromatic note
                    const midiValue = chromaticNotes[rootNoteIdx].midi + circleIdx;  // MIDI from root
                    
                    const startAngle = (wedgeIdx * 30 - 90) * Math.PI / 180;
                    const endAngle = ((wedgeIdx + 1) * 30 - 90) * Math.PI / 180;
                    
                    const x1 = centerX + radius * Math.cos(startAngle);
                    const y1 = centerY + radius * Math.sin(startAngle);
                    const x2 = centerX + nextRadius * Math.cos(startAngle);
                    const y2 = centerY + nextRadius * Math.sin(startAngle);
                    const x3 = centerX + nextRadius * Math.cos(endAngle);
                    const y3 = centerY + nextRadius * Math.sin(endAngle);
                    const x4 = centerX + radius * Math.cos(endAngle);
                    const y4 = centerY + radius * Math.sin(endAngle);
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${x1} ${y1} L ${x2} ${y2} A ${nextRadius} ${nextRadius} 0 0 1 ${x3} ${y3} L ${x4} ${y4} A ${radius} ${radius} 0 0 0 ${x1} ${y1}`;
                    path.setAttribute('d', d);
                    path.setAttribute('fill', 'none'); // TRANSPARENT - let circles show!
                    path.setAttribute('pointer-events', 'none'); // Don't block circles!
                    
                    // Use pre-calculated wedgeAt12OClock
                    const isInPieWindow = wedgeIdx === wedgeAt12OClock;
                    
                    path.setAttribute('stroke', isInPieWindow ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.02)');
                    path.setAttribute('stroke-width', '1');
                    g.appendChild(path);
                    
                    const midAngle = (wedgeIdx * 30 + 15 - 90) * Math.PI / 180;
                    const midRadius = radius + radiusStep / 2;
                    const circleX = centerX + midRadius * Math.cos(midAngle);
                    const circleY = centerY + midRadius * Math.sin(midAngle);
                    const circleRadius = radiusStep * 0.42; // BIGGER circles - better fit!
                    
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', circleX);
                    circle.setAttribute('cy', circleY);
                    circle.setAttribute('r', circleRadius);
                    circle.setAttribute('fill', note.color);  // Chromatic color
                    circle.setAttribute('stroke', 'none'); // NO white stroke
                    circle.setAttribute('class', 'note-node');
                    circle.setAttribute('data-wedge', wedgeIdx);
                    circle.setAttribute('data-circle', circleIdx);
                    circle.setAttribute('data-midi', midiValue);
                    circle.setAttribute('data-note-name', note.name);
                    
                    // SUBDUED SYSTEM: Only 12 o'clock bright, others lightened up for visibility
                    const isInPieWindowCircle = wedgeIdx === wedgeAt12OClock;
                    const opacity = isInPieWindowCircle ? '1' : '0.45'; // Lightened for chromatic visibility!
                    circle.setAttribute('opacity', opacity);
                    
                    circle.onclick = () => toggleNode(wedgeIdx, circleIdx);
                    g.appendChild(circle);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', circleX);
                    text.setAttribute('y', circleY);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('dominant-baseline', 'middle');
                    text.setAttribute('class', 'note-label');
                    text.setAttribute('fill', 'white');
                    text.setAttribute('font-weight', '900');
                    text.setAttribute('font-size', isInPieWindowCircle ? '9' : '7');
                    text.setAttribute('stroke', 'black');
                    text.setAttribute('stroke-width', '0.5');
                    text.setAttribute('opacity', opacity);
                    
                    // IMPROVED TEXT ORIENTATION - 90¬∞ rotation for VERTICAL spokes (12 & 6 o'clock)
                    // Counter-rotate to keep text upright regardless of wheel rotation
                    const wedgeAngle = wedgeIdx * 30 - 90;  // Position angle
                    const totalRotation = currentRotation + wedgeAngle;  // Combined rotation
                    let textRotation = -totalRotation;  // Counter-rotate to stay upright
                    
                    // If text would be upside down (bottom half), flip 180¬∞
                    const normalizedTotal = ((totalRotation % 360) + 360) % 360;
                    if (normalizedTotal > 90 && normalizedTotal < 270) {
                        textRotation += 180;  // Flip so it's not upside down
                    }
                    
                    // Add 90¬∞ clockwise rotation for VERTICAL spokes (12 o'clock and 6 o'clock)
                    // 12 o'clock is around 270¬∞ (or -90¬∞), 6 o'clock is around 90¬∞
                    const isVerticalSpoke = (normalizedTotal > 255 && normalizedTotal < 285) || // 12 o'clock (top)
                                           (normalizedTotal > 75 && normalizedTotal < 105);    // 6 o'clock (bottom)
                    if (isVerticalSpoke) {
                        textRotation += 90;  // Rotate 90¬∞ clockwise for vertical reading
                    }
                    
                    text.setAttribute('transform', `rotate(${textRotation} ${circleX} ${circleY})`);
                    
                    text.textContent = note.name;
                    g.appendChild(text);
                }
            }
            
            // CONCENTRIC CIRCLES - Make them prominent and visible!
            for (let circleIdx = 0; circleIdx <= circles; circleIdx++) {
                const radius = minRadius + (circleIdx * radiusStep);
                const concentricCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                concentricCircle.setAttribute('cx', centerX);
                concentricCircle.setAttribute('cy', centerY);
                concentricCircle.setAttribute('r', radius);
                concentricCircle.setAttribute('fill', 'none');
                concentricCircle.setAttribute('stroke', 'rgba(255, 255, 255, 0.35)');
                concentricCircle.setAttribute('stroke-width', '1.5');
                concentricCircle.setAttribute('pointer-events', 'none');
                g.appendChild(concentricCircle);
            }
            
            // Center circle - no stroke to avoid white circle artifact
            const centerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            centerCircle.setAttribute('cx', centerX);
            centerCircle.setAttribute('cy', centerY);
            centerCircle.setAttribute('r', minRadius);
            centerCircle.setAttribute('fill', '#0a0f1a');
            g.appendChild(centerCircle);
            
            // Center ring (Hero brand color)
            const centerRing = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            centerRing.setAttribute('cx', centerX);
            centerRing.setAttribute('cy', centerY);
            centerRing.setAttribute('r', minRadius - 2);
            centerRing.setAttribute('fill', 'none');
            centerRing.setAttribute('stroke', '#e94560');
            centerRing.setAttribute('stroke-width', '2.5');
            g.appendChild(centerRing);
            
            svg.appendChild(g);
            
            // BLACKOUT OVERLAY GROUP - Black circles on top to hide non-pattern notes
            const blackoutGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            blackoutGroup.id = 'blackoutGroup';
            blackoutGroup.setAttribute('transform', `rotate(${currentRotation} 225 225)`); // Rotates with wheel
            svg.appendChild(blackoutGroup);
            
            // PIE WINDOW STENCIL - ON TOP! (Added after blackout group)
            const pieWindowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            pieWindowGroup.id = 'pieWindowGroup';
            
            // Main pie slice boundary - BOLD RED DASHED BORDER
            const pieSlice = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const sliceAngle = 30;
            const sliceStartAngle = (-90 - sliceAngle/2) * Math.PI / 180;
            const sliceEndAngle = (-90 + sliceAngle/2) * Math.PI / 180;
            const sliceRadius = maxRadius + 15;
            
            const sx1 = centerX;
            const sy1 = centerY;
            const sx2 = centerX + sliceRadius * Math.cos(sliceStartAngle);
            const sy2 = centerY + sliceRadius * Math.sin(sliceStartAngle);
            const sx3 = centerX + sliceRadius * Math.cos(sliceEndAngle);
            const sy3 = centerY + sliceRadius * Math.sin(sliceEndAngle);
            
            const pieSlicePath = `M ${sx1} ${sy1} L ${sx2} ${sy2} A ${sliceRadius} ${sliceRadius} 0 0 1 ${sx3} ${sy3} Z`;
            pieSlice.setAttribute('d', pieSlicePath);
            pieSlice.setAttribute('fill', 'none'); // Transparent - see through
            pieSlice.setAttribute('stroke', '#e94560'); // Hero red
            pieSlice.setAttribute('stroke-width', '6'); // Extra thick
            pieSlice.setAttribute('opacity', '1'); // Fully visible
            pieSlice.setAttribute('pointer-events', 'none');
            pieSlice.setAttribute('stroke-dasharray', '15,8'); // Bold dashes
            pieWindowGroup.appendChild(pieSlice);
            
            // Create chromatic reference circles on LEFT
            const referenceCircleRadius = 8;
            const referenceX = centerX - maxRadius - 30;
            
            for (let i = 0; i <= 12; i++) {
                const referenceY = centerY + maxRadius - (i * (maxRadius * 2) / 12) - maxRadius/12;
                const noteIdx = i % 12;
                
                const refCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                refCircle.setAttribute('cx', referenceX);
                refCircle.setAttribute('cy', referenceY);
                refCircle.setAttribute('r', referenceCircleRadius);
                refCircle.setAttribute('fill', chromaticNotes[noteIdx].color);
                refCircle.setAttribute('stroke', '#000'); // Black outline
                refCircle.setAttribute('stroke-width', '1');
                refCircle.setAttribute('opacity', '1');
                pieWindowGroup.appendChild(refCircle);
                
                const refLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                refLabel.setAttribute('x', referenceX - referenceCircleRadius - 5);
                refLabel.setAttribute('y', referenceY);
                refLabel.setAttribute('text-anchor', 'end');
                refLabel.setAttribute('dominant-baseline', 'middle');
                refLabel.setAttribute('font-size', '11');
                refLabel.setAttribute('font-weight', '900');
                refLabel.setAttribute('fill', chromaticNotes[noteIdx].color);
                refLabel.setAttribute('stroke', '#000');
                refLabel.setAttribute('stroke-width', '0.5');
                refLabel.textContent = `${i}:${chromaticNotes[noteIdx].name}`;
                pieWindowGroup.appendChild(refLabel);
            }
            
            svg.appendChild(pieWindowGroup); // STENCIL ON TOP!
            
            // FIXED 12 O'CLOCK MARKER - Shows the activity window (never rotates!)
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const markerSize = 20;
            const markerY = centerY - maxRadius - 25;
            const markerPath = `M ${centerX} ${markerY + markerSize} 
                                L ${centerX - markerSize/2} ${markerY} 
                                L ${centerX + markerSize/2} ${markerY} Z`;
            marker.setAttribute('d', markerPath);
            marker.setAttribute('fill', '#e94560');
            marker.setAttribute('stroke', '#ffffff');
            marker.setAttribute('stroke-width', '2');
            marker.setAttribute('opacity', '0.9');
            svg.appendChild(marker);
            
            // FIXED 12 O'CLOCK LABEL
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', centerX);
            label.setAttribute('y', markerY - 5);
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('font-size', '12');
            label.setAttribute('font-weight', '900');
            label.setAttribute('fill', '#e94560');
            label.textContent = 'PIE WINDOW';
            svg.appendChild(label);
            
            // FIXED CENTER DOT - Hero brand color, never rotates!
            const fixedCenterDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            fixedCenterDot.setAttribute('cx', centerX);
            fixedCenterDot.setAttribute('cy', centerY);
            fixedCenterDot.setAttribute('r', '5');
            fixedCenterDot.setAttribute('fill', '#e94560');
            fixedCenterDot.setAttribute('stroke', '#000000');
            fixedCenterDot.setAttribute('stroke-width', '2');
            fixedCenterDot.setAttribute('opacity', '0.8');
            svg.appendChild(fixedCenterDot);
        }
        
        function toggleNode(wedgeIdx, circleIdx) {
            const nodeId = `${wedgeIdx}-${circleIdx}`;
            const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
            
            if (activeNodes.has(nodeId)) {
                activeNodes.delete(nodeId);
                node.classList.remove('active');
            } else {
                activeNodes.add(nodeId);
                node.classList.add('active');
            }
            
            if (synth) {
                const midi = parseInt(node.getAttribute('data-midi'));
                const freq = Tone.Frequency(midi, 'midi').toFrequency();
                synth.triggerAttackRelease([freq], '8n');
                
                node.classList.add('playing');
                setTimeout(() => node.classList.remove('playing'), 300);
            }
        }
        
        function applyStencil(pattern) {
            clearAll();
            currentPattern = pattern;
            const intervals = stencilPatterns[pattern];
            if (!intervals) return;
            
            // Calculate which wedge is at 12 o'clock
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            const rotationSteps = Math.round(normalizedRotation / 30);
            const wedgeAt12OClock = (12 - rotationSteps) % 12;
            
            // Get blackout group
            const blackoutGroup = document.getElementById('blackoutGroup');
            if (!blackoutGroup) return;
            
            // Clear previous blackout circles
            blackoutGroup.innerHTML = '';
            
            // Calculate circle parameters (same as in drawHolyGrail)
            const centerX = 225;
            const centerY = 225;
            const minRadius = 30;
            const maxRadius = 210;
            const radiusStep = (maxRadius - minRadius) / 13;
            
            // For each position in the 12 o'clock wedge
            for (let circleIdx = 0; circleIdx <= 12; circleIdx++) {
                const isInPattern = intervals.includes(circleIdx);
                
                const node = document.querySelector(`[data-wedge="${wedgeAt12OClock}"][data-circle="${circleIdx}"]`);
                if (!node) continue;
                
                if (isInPattern) {
                    // Pattern note: Add to active set and highlight
                    activeNodes.add(`${wedgeAt12OClock}-${circleIdx}`);
                    node.classList.add('active');
                    // Let CSS handle stroke and stroke-width via .active class
                } else {
                    // Non-pattern note: Create BLACK OVERLAY CIRCLE on top
                    const radius = minRadius + (circleIdx * radiusStep);
                    const midAngle = (wedgeAt12OClock * 30 + 15 - 90) * Math.PI / 180;
                    const midRadius = radius + radiusStep / 2;
                    const circleX = centerX + midRadius * Math.cos(midAngle);
                    const circleY = centerY + midRadius * Math.sin(midAngle);
                    const circleRadius = radiusStep * 0.42; // Same size as note circles
                    
                    // Create black circle overlay
                    const blackCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    blackCircle.setAttribute('cx', circleX);
                    blackCircle.setAttribute('cy', circleY);
                    blackCircle.setAttribute('r', circleRadius + 1); // Slightly larger to fully cover
                    blackCircle.setAttribute('fill', '#000000'); // Pure black
                    blackCircle.setAttribute('opacity', '1'); // Completely opaque
                    blackCircle.setAttribute('stroke', 'none');
                    blackCircle.setAttribute('pointer-events', 'none'); // Don't block clicks
                    blackoutGroup.appendChild(blackCircle);
                }
            }
        }
        
        function playActive() {
            if (!synth || activeNodes.size === 0) return;
            
            const freqs = [];
            const nodes = [];
            
            activeNodes.forEach(nodeId => {
                const [wedgeIdx, circleIdx] = nodeId.split('-').map(Number);
                const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                if (node) {
                    const midi = parseInt(node.getAttribute('data-midi'));
                    freqs.push(Tone.Frequency(midi, 'midi').toFrequency());
                    nodes.push(node);
                }
            });
            
            // Visual feedback - all notes pulse together
            nodes.forEach(node => node.classList.add('playing'));
            synth.triggerAttackRelease(freqs, '1n');
            
            setTimeout(() => {
                nodes.forEach(node => node.classList.remove('playing'));
            }, 300);
        }
        
        function playArpeggio() {
            if (!synth || activeNodes.size === 0) return;
            
            const notes = [];
            activeNodes.forEach(nodeId => {
                const [wedgeIdx, circleIdx] = nodeId.split('-').map(Number);
                const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                if (node) {
                    const midi = parseInt(node.getAttribute('data-midi'));
                    notes.push({ midi, node, circleIdx });
                }
            });
            
            // Sort by circle index ASCENDING (lowest to highest pitch)
            notes.sort((a, b) => a.circleIdx - b.circleIdx);
            
            const now = Tone.now();
            const noteDelay = playbackSpeed / 1000; // Use variable speed (convert ms to seconds)
            
            notes.forEach((note, idx) => {
                const freq = Tone.Frequency(note.midi, 'midi').toFrequency();
                synth.triggerAttackRelease([freq], '8n', now + idx * noteDelay);
                
                // Visual feedback - each note pulses in sequence
                setTimeout(() => {
                    note.node.classList.add('playing');
                    setTimeout(() => note.node.classList.remove('playing'), 300);
                }, idx * noteDelay * 1000);
            });
        }
        
        function playArpeggioDown() {
            if (!synth || activeNodes.size === 0) return;
            
            const notes = [];
            activeNodes.forEach(nodeId => {
                const [wedgeIdx, circleIdx] = nodeId.split('-').map(Number);
                const node = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                if (node) {
                    const midi = parseInt(node.getAttribute('data-midi'));
                    notes.push({ midi, node, circleIdx });
                }
            });
            
            // Sort by circle index DESCENDING (highest to lowest pitch)
            notes.sort((a, b) => b.circleIdx - a.circleIdx);
            
            const now = Tone.now();
            const noteDelay = playbackSpeed / 1000; // Use variable speed (convert ms to seconds)
            
            notes.forEach((note, idx) => {
                const freq = Tone.Frequency(note.midi, 'midi').toFrequency();
                synth.triggerAttackRelease([freq], '8n', now + idx * noteDelay);
                
                // Visual feedback - each note pulses in sequence
                setTimeout(() => {
                    note.node.classList.add('playing');
                    setTimeout(() => note.node.classList.remove('playing'), 300);
                }, idx * noteDelay * 1000);
            });
        }
        
        // NEW: Auto-play when stencil is applied
        async function playStencilPattern(playType = 'chord') {
            if (!synth) {
                await Tone.start();
            }
            
            // Wait a brief moment for visual update
            setTimeout(() => {
                if (playType === 'arpeggio') {
                    playArpeggio();
                } else {
                    playActive();
                }
            }, 100);
        }
        
        function clearAll() {
            currentPattern = null;
            activeNodes.clear();
            
            // Clear blackout overlay
            const blackoutGroup = document.getElementById('blackoutGroup');
            if (blackoutGroup) {
                blackoutGroup.innerHTML = '';
            }
            
            // Remove active class and white stroke from all nodes
            document.querySelectorAll('.note-node').forEach(n => {
                n.classList.remove('active');
                n.setAttribute('stroke', 'none'); // Remove white outline
            });
            
            document.querySelectorAll('.stencil-btn').forEach(b => b.classList.remove('active'));
            
            // Apply subdued system (only 12 o'clock bright)
            updateWedgeOpacity();
        }
        
        function rotateLeft() {
            // Left = Brings 1 o'clock spoke TO 12 o'clock position
            // This is CLOCKWISE rotation = -30¬∞
            currentRotation = (currentRotation - 30 + 360) % 360;
            updateRotation();
            updateCurrentKeyDisplay();
            if (currentPattern) {
                applyStencil(currentPattern);
                playStencilPattern(autoPlayMode);
            }
        }
        
        function rotateRight() {
            // Right = Brings 11 o'clock spoke TO 12 o'clock position
            // This is COUNTER-CLOCKWISE rotation = +30¬∞
            currentRotation = (currentRotation + 30) % 360;
            updateRotation();
            updateCurrentKeyDisplay();
            if (currentPattern) {
                applyStencil(currentPattern);
                playStencilPattern(autoPlayMode);
            }
        }
        
        function resetRotation() {
            currentRotation = -15; // Reset to C at 12 o'clock (original position)
            updateRotation();
            updateCurrentKeyDisplay();
            // Reapply the current pattern to the reset 12 o'clock position
            if (currentPattern) {
                applyStencil(currentPattern);
                // Play the pattern in the new key
                playStencilPattern(autoPlayMode);
            }
        }
        
        function updateRotation() {
            const g = document.getElementById('rotatingGroup');
            const blackoutGroup = document.getElementById('blackoutGroup');
            if (g) {
                g.setAttribute('transform', `rotate(${currentRotation} 225 225)`);
                // Also rotate blackout group to stay aligned
                if (blackoutGroup) {
                    blackoutGroup.setAttribute('transform', `rotate(${currentRotation} 225 225)`);
                }
                updateWedgeOpacity();
            }
        }
        
        function updateWedgeOpacity() {
            // Calculate which wedge is at 12 o'clock
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            const rotationSteps = Math.round(normalizedRotation / 30);
            const wedgeAt12OClock = (12 - rotationSteps) % 12;
            
            // If there's an active pattern, DON'T override the blackout/highlighting
            // Only update opacity for wedges that don't have a pattern applied
            if (currentPattern) {
                // Pattern is active - maintain blackout and highlighting
                return; // Don't override the pattern display
            }
            
            // NO pattern active - show normal subdued system
            for (let wedgeIdx = 0; wedgeIdx < 12; wedgeIdx++) {
                const isInPieWindow = wedgeIdx === wedgeAt12OClock;
                const opacity = isInPieWindow ? '1' : '0.45'; // Lightened for visibility!
                const fontSize = isInPieWindow ? '9' : '7';
                
                for (let circleIdx = 0; circleIdx < 13; circleIdx++) {
                    const circle = document.querySelector(`[data-wedge="${wedgeIdx}"][data-circle="${circleIdx}"]`);
                    if (circle) {
                        // Only update if not active
                        if (!circle.classList.contains('active')) {
                            circle.setAttribute('opacity', opacity);
                        }
                        
                        // Update text opacity AND font size
                        const textElements = document.querySelectorAll('.note-label');
                        textElements.forEach(text => {
                            const circleX = circle.getAttribute('cx');
                            const circleY = circle.getAttribute('cy');
                            const textX = text.getAttribute('x');
                            const textY = text.getAttribute('y');
                            if (circleX === textX && circleY === textY) {
                                text.setAttribute('opacity', opacity);
                                text.setAttribute('font-size', fontSize);
                            }
                        });
                    }
                }
            }
        }
        
        function toggleAutoRotate() {
            isAutoRotating = !isAutoRotating;
            const btn = document.getElementById('autoRotateBtn');
            
            if (isAutoRotating) {
                btn.classList.add('active');
                rotationInterval = setInterval(() => {
                    rotateRight();
                }, 2000);
            } else {
                btn.classList.remove('active');
                if (rotationInterval) {
                    clearInterval(rotationInterval);
                    rotationInterval = null;
                }
            }
        }
        
        document.getElementById('rotateLeftBtn').addEventListener('click', rotateLeft);
        document.getElementById('rotateRightBtn').addEventListener('click', rotateRight);
        document.getElementById('resetBtn').addEventListener('click', resetRotation);
        document.getElementById('autoRotateBtn').addEventListener('click', toggleAutoRotate);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('playBtn').addEventListener('click', playActive);
        document.getElementById('arpeggioBtn').addEventListener('click', playArpeggio);
        document.getElementById('arpeggioDownBtn').addEventListener('click', playArpeggioDown);
        
        // Auto-play mode controls
        document.getElementById('autoPlayChordBtn').addEventListener('click', function() {
            autoPlayMode = 'chord';
            document.getElementById('autoPlayChordBtn').classList.add('active');
            document.getElementById('autoPlayArpeggioBtn').classList.remove('active');
        });
        
        document.getElementById('autoPlayArpeggioBtn').addEventListener('click', function() {
            autoPlayMode = 'arpeggio';
            document.getElementById('autoPlayArpeggioBtn').classList.add('active');
            document.getElementById('autoPlayChordBtn').classList.remove('active');
        });
        
        // Key selector - jump to any key at 12 o'clock
        document.getElementById('keySelector').addEventListener('change', function() {
            const targetKey = parseInt(this.value);
            // Calculate rotation needed to bring this key to 12 o'clock
            // Key 0 (C) = -15¬∞, Key 1 (C#) = -45¬∞, Key 2 (D) = -75¬∞, etc.
            currentRotation = -15 - (targetKey * 30);
            // Normalize rotation
            currentRotation = ((currentRotation % 360) + 360) % 360;
            updateRotation();
            updateCurrentKeyDisplay();
            // Reapply pattern if one is active
            if (currentPattern) {
                applyStencil(currentPattern);
                playStencilPattern(autoPlayMode);
            }
        });
        
        let autoPlayMode = 'arpeggio'; // 'chord' or 'arpeggio'
        
        document.querySelectorAll('.stencil-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const patternName = this.getAttribute('data-pattern');
                applyStencil(patternName);
                document.querySelectorAll('.stencil-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Auto-detect playback mode based on pattern type
                // Chords play as chords, scales/modes play as arpeggios
                const isChord = patternName.includes('chord') || patternName === 'dim' || patternName === 'aug' || patternName === 'dom7' || patternName === 'maj7';
                const playMode = isChord ? 'chord' : 'arpeggio';
                
                // Auto-play the pattern when selected
                playStencilPattern(playMode);
            });
        });
        
        // SPEED CONTROL - INVERTED (left=slow, right=fast)
        document.getElementById('speedControl').addEventListener('input', function() {
            // Invert: slider at max (400) = fast (50ms), slider at min (50) = slow (400ms)
            playbackSpeed = 450 - parseInt(this.value);
            document.getElementById('speedDisplay').textContent = `${playbackSpeed}ms / note`;
        });
        
        drawHolyGrail();
        updateCurrentKeyDisplay(); // Initialize the current key display
        console.log('üèÜ KEYS, CODES & MODES - COMPLETE WITH PIE WINDOW + VERIFIED PATTERNS!');
        console.log('');
        console.log('ü•ß PIE WINDOW - FRONT Z-PLANE!');
        console.log('   ‚Ä¢ On top of wheel (visible)');
        console.log('   ‚Ä¢ Rainbow chromatic color bar');
        console.log('   ‚Ä¢ Labels show: Note (Circle#)');
        console.log('   ‚Ä¢ Dashed red border marks 12 o\'clock');
        console.log('');
        console.log('üìñ TEXT ORIENTATION: Book-style (always readable)');
        console.log('');
        console.log('üé® CHROMATIC SPECTRUM (Exact):');
        chromaticNotes.forEach((note, idx) => {
            console.log(`   ${idx}. ${note.name.padEnd(3)} - ${note.color}`);
        });
        console.log('');
        console.log('üéµ VERIFIED PATTERNS (All Musically Correct):');
        console.log('');
        console.log('SCALES (Auto-play as Arpeggio):');
        Object.entries(stencilPatterns).forEach(([name, intervals]) => {
            if (['chromatic', 'major', 'minor', 'harmonic', 'melodic', 'pentatonic', 'blues'].includes(name)) {
                const noteNames = intervals.map(i => chromaticNotes[i % 12].name).join('-');
                console.log(`   ${name.padEnd(12)}: [${intervals.join(',')}] = ${noteNames}`);
            }
        });
        console.log('');
        console.log('MODES (Auto-play as Arpeggio):');
        Object.entries(stencilPatterns).forEach(([name, intervals]) => {
            if (['ionian', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'aeolian', 'locrian'].includes(name)) {
                const noteNames = intervals.map(i => chromaticNotes[i % 12].name).join('-');
                console.log(`   ${name.padEnd(12)}: [${intervals.join(',')}] = ${noteNames}`);
            }
        });
        console.log('');
        console.log('CHORDS (Auto-play as Chord):');
        Object.entries(stencilPatterns).forEach(([name, intervals]) => {
            if (['major-chord', 'minor-chord', 'dim', 'aug', 'dom7', 'maj7'].includes(name)) {
                const noteNames = intervals.map(i => chromaticNotes[i % 12].name).join('-');
                console.log(`   ${name.padEnd(12)}: [${intervals.join(',')}] = ${noteNames}`);
            }
        });
        console.log('');
        console.log('üéØ TEST INSTRUCTIONS:');
        console.log('   1. Click any SCALE button ‚Üí Hear notes play sequentially (arpeggio)');
        console.log('   2. Click any CHORD button ‚Üí Hear notes play together (chord)');
        console.log('   3. Watch pie window ‚Üí Shows chromatic colors and labels');
        console.log('   4. Each pattern should sound DIFFERENT and CORRECT!');
        console.log('');
        console.log('‚úÖ ALL SYSTEMS READY FOR MUSIC EDUCATION!');
        console.log('   0. C   - Yellow        #FFFF00');
        console.log('   1. C#  - Yellow-Orange #FFC400');
        console.log('   2. D   - Orange        #FF8000');
        console.log('   3. D#  - Red-Orange    #FF4000');
        console.log('   4. E   - Red           #FF0000');
        console.log('   5. F   - Red-Purple    #C4007F');
        console.log('   6. F#  - Purple        #8000FF');
        console.log('   7. G   - Blue-Purple   #4000FF');
        console.log('   8. G#  - Blue          #0000FF');
        console.log('   9. A   - Blue-Green    #007FFF');
        console.log('  10. A#  - Green         #00FF80');
        console.log('  11. B   - Yellow-Green  #80FF00');
        console.log('');
        console.log('‚ú® VISUAL FEATURES:');
        console.log('   ‚Ä¢ Pattern notes: Highlighted with chromatic colors');
        console.log('   ‚Ä¢ Non-pattern notes: Blacked out (dark, 30% opacity)');
        console.log('   ‚Ä¢ Playing notes: Pulse animation with color');
        console.log('   ‚Ä¢ Perfect audio-visual sync');
        console.log('');
        console.log('üéØ READY FOR MUSIC EDUCATION!');
    </script>
</body>
</html>