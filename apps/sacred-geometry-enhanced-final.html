<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Sacred Geometry Music Visualizer | Keys, Codes & Modes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .hero-logo {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6B6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .tagline {
            font-size: 1.3em;
            color: #a0a0a0;
            font-style: italic;
        }

        .main-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .canvas-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #canvas3d {
            width: 100%;
            height: 700px;
            border-radius: 10px;
            cursor: grab;
        }

        #canvas3d:active {
            cursor: grabbing;
        }

        .controls-panel {
            width: 350px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-height: 700px;
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 8px;
        }

        .button-grid {
            display: grid;
            gap: 8px;
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: left;
        }

        button:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item label {
            display: block;
            color: #a0a0a0;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
        }

        .value-display {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 4px;
            margin-left: 10px;
            font-family: monospace;
            color: #FFD700;
        }

        .info-box {
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #FFD700;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .info-box h4 {
            color: #FFD700;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #c0c0c0;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .action-buttons {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 15px;
            font-size: 1em;
            text-align: center;
        }

        .play-btn {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }

        .clear-btn {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .rotate-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #FFD700;
            font-size: 1.2em;
        }

        /* Custom scrollbar */
        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 4px;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="hero-logo">KEYS, CODES & MODES</div>
        <div class="tagline">3D Sacred Geometry Through All 12 Keys</div>
    </div>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="canvas3d"></canvas>
            <div class="info-box" id="patternInfo">
                <h4>Select a Pattern</h4>
                <p>Choose any musical pattern to see it stacked through all 12 keys in beautiful 3D sacred geometry. Each layer represents the pattern starting on a different root note, colored by our chromatic system.</p>
            </div>
        </div>

        <div class="controls-panel">
            <div class="control-section">
                <h3>üéµ Intervals</h3>
                <div class="button-grid">
                    <button onclick="selectPattern('interval', 1)">Minor 2nd (Semitone)</button>
                    <button onclick="selectPattern('interval', 2)">Major 2nd (Whole Tone)</button>
                    <button onclick="selectPattern('interval', 3)">Minor 3rd</button>
                    <button onclick="selectPattern('interval', 4)">Major 3rd</button>
                    <button onclick="selectPattern('interval', 5)">Perfect 4th</button>
                    <button onclick="selectPattern('interval', 6)">Tritone</button>
                    <button onclick="selectPattern('interval', 7)">Perfect 5th</button>
                    <button onclick="selectPattern('interval', 8)">Minor 6th</button>
                    <button onclick="selectPattern('interval', 9)">Major 6th</button>
                    <button onclick="selectPattern('interval', 10)">Minor 7th</button>
                    <button onclick="selectPattern('interval', 11)">Major 7th</button>
                </div>
            </div>

            <div class="control-section">
                <h3>üéπ Triads</h3>
                <div class="button-grid">
                    <button onclick="selectPattern('major-triad')">Major Triad</button>
                    <button onclick="selectPattern('minor-triad')">Minor Triad</button>
                    <button onclick="selectPattern('diminished-triad')">Diminished Triad</button>
                    <button onclick="selectPattern('augmented-triad')">Augmented Triad</button>
                </div>
            </div>

            <div class="control-section">
                <h3>üéº Seventh Chords</h3>
                <div class="button-grid">
                    <button onclick="selectPattern('major7')">Major 7th</button>
                    <button onclick="selectPattern('minor7')">Minor 7th</button>
                    <button onclick="selectPattern('dominant7')">Dominant 7th</button>
                    <button onclick="selectPattern('diminished7')">Diminished 7th</button>
                </div>
            </div>

            <div class="control-section">
                <h3>üéµ Scales</h3>
                <div class="button-grid">
                    <button onclick="selectPattern('major-scale')">Major Scale</button>
                    <button onclick="selectPattern('minor-scale')">Natural Minor</button>
                    <button onclick="selectPattern('pentatonic-major')">Pentatonic Major</button>
                    <button onclick="selectPattern('pentatonic-minor')">Pentatonic Minor</button>
                    <button onclick="selectPattern('blues-scale')">Blues Scale</button>
                    <button onclick="selectPattern('whole-tone')">Whole Tone</button>
                </div>
            </div>

            <div class="control-section">
                <h3>üé≠ Modes</h3>
                <div class="button-grid">
                    <button onclick="selectPattern('ionian')">Ionian (Major)</button>
                    <button onclick="selectPattern('dorian')">Dorian</button>
                    <button onclick="selectPattern('phrygian')">Phrygian</button>
                    <button onclick="selectPattern('lydian')">Lydian</button>
                    <button onclick="selectPattern('mixolydian')">Mixolydian</button>
                    <button onclick="selectPattern('aeolian')">Aeolian (Minor)</button>
                    <button onclick="selectPattern('locrian')">Locrian</button>
                </div>
            </div>

            <div class="control-section">
                <h3>‚ú® Sacred Geometry</h3>
                <div class="button-grid">
                    <button onclick="selectPattern('triangle')">Triangle (3)</button>
                    <button onclick="selectPattern('square')">Square (4)</button>
                    <button onclick="selectPattern('pentagon')">Pentagon (5)</button>
                    <button onclick="selectPattern('hexagon')">Hexagon (6)</button>
                </div>
            </div>

            <div class="control-section">
                <h3>‚öôÔ∏è View Controls</h3>
                
                <div class="control-item">
                    <label>Z-Axis Spacing <span class="value-display" id="spacingValue">0.3</span></label>
                    <input type="range" id="spacing" min="0.1" max="0.8" step="0.1" value="0.3" oninput="updateSpacing()">
                </div>

                <div class="control-item">
                    <label>Line Thickness <span class="value-display" id="thicknessValue">0.02</span></label>
                    <input type="range" id="thickness" min="0.01" max="0.05" step="0.005" value="0.02" oninput="updateThickness()">
                </div>

                <div class="control-item">
                    <label>Rotation Speed <span class="value-display" id="rotSpeedValue">0.5</span></label>
                    <input type="range" id="rotSpeed" min="0" max="2" step="0.1" value="0.5" oninput="updateRotSpeed()">
                </div>

                <div class="control-item">
                    <label>Camera Distance <span class="value-display" id="zoomValue">12</span></label>
                    <input type="range" id="zoom" min="8" max="20" step="0.5" value="12" oninput="updateZoom()">
                </div>

                <div class="control-item">
                    <label>Root Key</label>
                    <select id="keySelect" onchange="updateRootKey()" style="width: 100%; padding: 8px; border-radius: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e0e0e0; font-size: 0.9em;">
                        <option value="0">C (Yellow)</option>
                        <option value="1">C# / Db (Yellow-Orange)</option>
                        <option value="2">D (Orange)</option>
                        <option value="3">D# / Eb (Red-Orange)</option>
                        <option value="4">E (Red)</option>
                        <option value="5">F (Red-Purple)</option>
                        <option value="6">F# / Gb (Purple)</option>
                        <option value="7">G (Blue-Purple)</option>
                        <option value="8">G# / Ab (Blue)</option>
                        <option value="9">A (Blue-Green)</option>
                        <option value="10">A# / Bb (Green)</option>
                        <option value="11">B (Yellow-Green)</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn rotate-btn" onclick="toggleRotation()">‚ü≥ Toggle Auto-Rotate</button>
                <button class="action-btn play-btn" onclick="playPattern()">‚ñ∂Ô∏è Play Pattern</button>
                <button class="action-btn" onclick="stopPlayback()" style="background: linear-gradient(135deg, #f5576c 0%, #c62828 100%);">‚èπ STOP</button>
                <button class="action-btn clear-btn" onclick="clearPattern()">‚äó Clear</button>
            </div>

            <div class="control-section">
                <h3>üé® Chromatic Colors</h3>
                <div class="legend" id="colorLegend"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Keys, Codes & Modes 12-Color Chromatic System
        const chromaticColors = {
            'C':  '#FFFF00',  // Yellow (MIDI 60)
            'C#': '#FFC400',  // Yellow-Orange (MIDI 61)
            'D':  '#FF8000',  // Orange (MIDI 62)
            'D#': '#FF4000',  // Red-Orange (MIDI 63)
            'E':  '#FF0000',  // Red (MIDI 64)
            'F':  '#C4007F',  // Red-Purple (MIDI 65)
            'F#': '#8000FF',  // Purple (MIDI 66)
            'G':  '#4000FF',  // Blue-Purple (MIDI 67)
            'G#': '#0000FF',  // Blue (MIDI 68)
            'A':  '#007FFF',  // Blue-Green (MIDI 69)
            'A#': '#00FF80',  // Green (MIDI 70)
            'B':  '#80FF00'   // Yellow-Green (MIDI 71)
        };

        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // Three.js setup
        let scene, camera, renderer, controls;
        let currentGeometry = null;
        let autoRotate = true;
        let rotationSpeed = 0.005;
        let audioContext;
        let currentPattern = null;
        let rootKeyOffset = 0; // Key transposition
        let isPlaying = false;
        let playbackTimeout = null;

        // Initialize
        init();
        animate();

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0f);

            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.z = 12;

            // Renderer
            const canvas = document.getElementById('canvas3d');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const pointLight1 = new THREE.PointLight(0xffffff, 1);
            pointLight1.position.set(10, 10, 10);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xffffff, 0.5);
            pointLight2.position.set(-10, -10, 10);
            scene.add(pointLight2);

            // Mouse controls
            setupMouseControls();

            // Color legend
            createColorLegend();

            // Window resize
            window.addEventListener('resize', onWindowResize);
        }

        function setupMouseControls() {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            const canvas = document.getElementById('canvas3d');

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging && currentGeometry) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;

                    currentGeometry.rotation.y += deltaX * 0.01;
                    currentGeometry.rotation.x += deltaY * 0.01;

                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });
        }

        function selectPattern(type, param) {
            // Clear previous
            if (currentGeometry) {
                scene.remove(currentGeometry);
            }

            // Get pattern definition
            const patternDef = getPatternDefinition(type, param);
            
            // Store type and param for key transposition
            patternDef.type = type;
            patternDef.param = param;
            
            currentPattern = patternDef;

            // Update info
            updatePatternInfo(patternDef);

            // Create 3D geometry
            currentGeometry = create3DPattern(patternDef);
            scene.add(currentGeometry);

            // Update active button
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function getPatternDefinition(type, param) {
            let intervals = [];
            let name = '';
            let description = '';

            switch(type) {
                case 'interval':
                    intervals = [0, param];
                    name = getIntervalName(param);
                    description = `${name} interval stacked through all 12 keys creates ${12} parallel lines in 3D space.`;
                    break;

                case 'major-triad':
                    intervals = [0, 4, 7];
                    name = 'Major Triad';
                    description = 'Perfect triangular columns rising through all keys. The foundation of Western harmony in 3D.';
                    break;

                case 'minor-triad':
                    intervals = [0, 3, 7];
                    name = 'Minor Triad';
                    description = 'Slightly asymmetric triangular columns. Notice how the shape differs from major.';
                    break;

                case 'diminished-triad':
                    intervals = [0, 3, 6];
                    name = 'Diminished Triad';
                    description = 'Creates 4 unique triangular helixes due to symmetrical division (every 3 semitones).';
                    break;

                case 'augmented-triad':
                    intervals = [0, 4, 8];
                    name = 'Augmented Triad';
                    description = 'Only 3 unique shapes! Perfect symmetry divides the octave into thirds.';
                    break;

                case 'major7':
                    intervals = [0, 4, 7, 11];
                    name = 'Major 7th Chord';
                    description = 'Four-sided geometric columns with sophisticated harmonic structure.';
                    break;

                case 'minor7':
                    intervals = [0, 3, 7, 10];
                    name = 'Minor 7th Chord';
                    description = 'Asymmetric four-point structures creating unique visual signatures per key.';
                    break;

                case 'dominant7':
                    intervals = [0, 4, 7, 10];
                    name = 'Dominant 7th Chord';
                    description = 'The tension chord in 3D - notice the asymmetric pull in the geometry.';
                    break;

                case 'diminished7':
                    intervals = [0, 3, 6, 9];
                    name = 'Diminished 7th Chord';
                    description = 'Only 3 unique shapes! Perfect square columns due to symmetrical division.';
                    break;

                case 'major-scale':
                    intervals = [0, 2, 4, 5, 7, 9, 11];
                    name = 'Major Scale';
                    description = 'Seven-pointed star columns. The fundamental structure of Western music in 3D.';
                    break;

                case 'minor-scale':
                    intervals = [0, 2, 3, 5, 7, 8, 10];
                    name = 'Natural Minor Scale';
                    description = 'Compare with major - see the subtle but profound geometric differences.';
                    break;

                case 'pentatonic-major':
                    intervals = [0, 2, 4, 7, 9];
                    name = 'Major Pentatonic Scale';
                    description = 'Five-pointed star columns. Universal across cultures, now in 3D.';
                    break;

                case 'pentatonic-minor':
                    intervals = [0, 3, 5, 7, 10];
                    name = 'Minor Pentatonic Scale';
                    description = 'The blues foundation - pentagonal columns through all keys.';
                    break;

                case 'blues-scale':
                    intervals = [0, 3, 5, 6, 7, 10];
                    name = 'Blues Scale';
                    description = 'Six-pointed structures with the characteristic "blue note" visible in the geometry.';
                    break;

                case 'whole-tone':
                    intervals = [0, 2, 4, 6, 8, 10];
                    name = 'Whole Tone Scale';
                    description = 'Only 2 unique hexagonal patterns! Perfect symmetry creates dreamlike geometry.';
                    break;

                case 'ionian':
                    intervals = [0, 2, 4, 5, 7, 9, 11];
                    name = 'Ionian Mode';
                    description = 'The major scale. Foundation pattern creating 12 unique seven-pointed columns.';
                    break;

                case 'dorian':
                    intervals = [0, 2, 3, 5, 7, 9, 10];
                    name = 'Dorian Mode';
                    description = 'Minor with raised 6th creates unique asymmetric heptagons.';
                    break;

                case 'phrygian':
                    intervals = [0, 1, 3, 5, 7, 8, 10];
                    name = 'Phrygian Mode';
                    description = 'Exotic flat-2nd creates distinctive geometric signature.';
                    break;

                case 'lydian':
                    intervals = [0, 2, 4, 6, 7, 9, 11];
                    name = 'Lydian Mode';
                    description = 'Raised 4th creates ethereal, floating geometric patterns.';
                    break;

                case 'mixolydian':
                    intervals = [0, 2, 4, 5, 7, 9, 10];
                    name = 'Mixolydian Mode';
                    description = 'Dominant character visible in the asymmetric seven-point structure.';
                    break;

                case 'aeolian':
                    intervals = [0, 2, 3, 5, 7, 8, 10];
                    name = 'Aeolian Mode';
                    description = 'Natural minor - melancholic geometry reflected in all 12 keys.';
                    break;

                case 'locrian':
                    intervals = [0, 1, 3, 5, 6, 8, 10];
                    name = 'Locrian Mode';
                    description = 'Most unstable mode creates unique, tension-filled geometric forms.';
                    break;

                case 'triangle':
                    intervals = [0, 4, 8];
                    name = 'Equilateral Triangle';
                    description = 'Sacred trinity in 3D - only 3 unique augmented triad columns.';
                    break;

                case 'square':
                    intervals = [0, 3, 6, 9];
                    name = 'Square / Cross';
                    description = 'Four elements, four directions - only 3 unique diminished 7th columns.';
                    break;

                case 'pentagon':
                    intervals = [0, 2, 5, 7, 10];
                    name = 'Pentagon';
                    description = 'Golden ratio relationships visible in five-pointed helical structure.';
                    break;

                case 'hexagon':
                    intervals = [0, 2, 4, 6, 8, 10];
                    name = 'Hexagon';
                    description = 'Perfect six-fold symmetry - only 2 unique whole-tone columns.';
                    break;
            }

            return { intervals, name, description, type, param };
        }

        function create3DPattern(patternDef) {
            const group = new THREE.Group();
            const spacing = parseFloat(document.getElementById('spacing').value);
            const thickness = parseFloat(document.getElementById('thickness').value);

            // Create pattern for each of 12 keys (stacked on Z-axis)
            for (let key = 0; key < 12; key++) {
                const zPosition = (key - 5.5) * spacing; // Center around 0
                
                // Apply root key offset for transposition
                const transposedKey = (key + rootKeyOffset) % 12;
                const rootNote = noteNames[transposedKey];
                const color = new THREE.Color(chromaticColors[rootNote]);

                // Get transposed intervals
                const transposedIntervals = patternDef.intervals.map(interval => 
                    (interval + transposedKey) % 12
                );

                // Create geometry for this key layer
                createPatternLayer(group, transposedIntervals, zPosition, color, thickness);
            }

            return group;
        }

        function createPatternLayer(group, intervals, zPos, color, thickness) {
            const radius = 3;
            const points = intervals.map(interval => {
                const angle = (interval * 30 - 90) * Math.PI / 180;
                return new THREE.Vector3(
                    radius * Math.cos(angle),
                    radius * Math.sin(angle),
                    zPos
                );
            });

            // Create lines connecting points
            for (let i = 0; i < points.length; i++) {
                const start = points[i];
                const end = points[(i + 1) % points.length];

                // Create tube geometry for thick lines
                const path = new THREE.LineCurve3(start, end);
                const tubeGeometry = new THREE.TubeGeometry(path, 1, thickness, 8, false);
                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.3,
                    shininess: 100
                });
                const tube = new THREE.Mesh(tubeGeometry, material);
                group.add(tube);
            }

            // Create spheres at vertices
            intervals.forEach(interval => {
                const angle = (interval * 30 - 90) * Math.PI / 180;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const sphereGeometry = new THREE.SphereGeometry(thickness * 2, 16, 16);
                const sphereMaterial = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.5,
                    shininess: 100
                });
                const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                sphere.position.set(x, y, zPos);
                group.add(sphere);
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            if (currentGeometry && autoRotate) {
                currentGeometry.rotation.y += rotationSpeed;
            }

            renderer.render(scene, camera);
        }

        function updatePatternInfo(patternDef) {
            const infoBox = document.getElementById('patternInfo');
            infoBox.innerHTML = `
                <h4>${patternDef.name}</h4>
                <p>${patternDef.description}</p>
                <p style="margin-top: 10px; color: #FFD700;">
                    <strong>Structure:</strong> ${patternDef.intervals.length} notes per key √ó 12 keys = 
                    ${patternDef.intervals.length * 12} total points in 3D space
                </p>
            `;
        }

        function toggleRotation() {
            autoRotate = !autoRotate;
            event.target.textContent = autoRotate ? '‚ü≥ Toggle Auto-Rotate (ON)' : '‚ü≥ Toggle Auto-Rotate (OFF)';
        }

        function updateSpacing() {
            const value = document.getElementById('spacing').value;
            document.getElementById('spacingValue').textContent = value;
            if (currentPattern) {
                selectPattern(currentPattern.type, currentPattern.param);
            }
        }

        function updateThickness() {
            const value = document.getElementById('thickness').value;
            document.getElementById('thicknessValue').textContent = value;
            if (currentPattern) {
                selectPattern(currentPattern.type, currentPattern.param);
            }
        }

        function updateRotSpeed() {
            const value = parseFloat(document.getElementById('rotSpeed').value);
            document.getElementById('rotSpeedValue').textContent = value;
            rotationSpeed = value * 0.01;
        }

        function updateZoom() {
            const value = parseFloat(document.getElementById('zoom').value);
            document.getElementById('zoomValue').textContent = value;
            camera.position.z = value;
        }

        function stopPlayback() {
            isPlaying = false;
            
            if (playbackTimeout) {
                clearTimeout(playbackTimeout);
                playbackTimeout = null;
            }
            
            // Clear all pending timeouts (if any were set in playPattern)
            for (let i = 0; i < 1000; i++) {
                clearTimeout(i);
            }
        }

        function updateRootKey() {
            rootKeyOffset = parseInt(document.getElementById('keySelect').value);
            
            // Redraw current pattern with new key if one is loaded
            if (currentPattern) {
                const type = currentPattern.type;
                const param = currentPattern.param;
                selectPattern(type, param);
            }
        }

        function clearPattern() {
            if (currentGeometry) {
                scene.remove(currentGeometry);
                currentGeometry = null;
                currentPattern = null;
                document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                document.getElementById('patternInfo').innerHTML = `
                    <h4>Select a Pattern</h4>
                    <p>Choose any musical pattern to see it stacked through all 12 keys in beautiful 3D sacred geometry.</p>
                `;
            }
        }

        function playPattern() {
            if (!currentPattern) {
                alert('Please select a pattern first!');
                return;
            }

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const speed = 150; // ms per note
            let noteIndex = 0;

            // Play through all 12 keys
            for (let key = 0; key < 12; key++) {
                currentPattern.intervals.forEach((interval, i) => {
                    const noteNum = (interval + key) % 12;
                    const noteName = noteNames[noteNum];
                    
                    setTimeout(() => {
                        playNote(noteName);
                        highlightLayer(key);
                    }, noteIndex * speed);
                    
                    noteIndex++;
                });
            }
        }

        function playNote(noteName) {
            if (!audioContext) return;

            const noteIndex = noteNames.indexOf(noteName);
            const frequency = 261.63 * Math.pow(2, noteIndex / 12);

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function highlightLayer(keyIndex) {
            // Could add visual highlighting of specific layer
            // Implementation would modify material emissive temporarily
        }

        function getIntervalName(semitones) {
            const names = ['Unison', 'Minor 2nd', 'Major 2nd', 'Minor 3rd', 'Major 3rd',
                          'Perfect 4th', 'Tritone', 'Perfect 5th', 'Minor 6th', 'Major 6th',
                          'Minor 7th', 'Major 7th'];
            return names[semitones] || 'Interval';
        }

        function createColorLegend() {
            const legend = document.getElementById('colorLegend');
            noteNames.forEach(note => {
                const item = document.createElement('div');
                item.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = chromaticColors[note];

                const label = document.createElement('span');
                label.textContent = note;

                item.appendChild(colorBox);
                item.appendChild(label);
                legend.appendChild(item);
            });
        }

        function onWindowResize() {
            const canvas = document.getElementById('canvas3d');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }

        // Initialize audio on first click
        document.addEventListener('click', () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }, { once: true });
    </script>
</body>
</html>