<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Fretboard Explorer Pro | Keys, Codes & Modes</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-teal: #008080;
            --primary-gold: #F4D03F;
            --primary-purple: #8B6BA3;
            --primary-coral: #CF7A5A;
            --accent-blue: #4A7BA7;
            --dark-bg: #0f0f1e;
            --light-text: #E8E8E8;
            --font-display: 'Cinzel', serif;
            --font-body: 'Montserrat', sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-body);
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a15 100%);
            color: var(--light-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* HEADER */
        .app-header {
            background: linear-gradient(135deg, rgba(15, 15, 30, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--primary-teal);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 128, 128, 0.2);
        }
        
        .app-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .app-logo-svg {
            width: 50px;
            height: 50px;
            filter: drop-shadow(0 2px 8px rgba(244, 208, 63, 0.3));
            transition: transform 0.3s ease;
        }
        
        .app-logo-section:hover .app-logo-svg {
            transform: scale(1.1) rotate(5deg);
        }
        
        .app-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-teal), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1.2;
            letter-spacing: 2px;
        }
        
        .app-nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        
        .app-nav-links a {
            color: var(--light-text);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .app-nav-links a:hover {
            color: var(--primary-gold);
            background: rgba(244, 208, 63, 0.1);
            transform: translateY(-2px);
        }
        
        /* MAIN CONTENT */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(244, 208, 63, 0.3);
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 128, 128, 0.3);
            box-shadow: 0 4px 20px rgba(0, 128, 128, 0.1);
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: var(--primary-teal);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, button {
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid rgba(0, 128, 128, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--primary-teal);
            transform: translateY(-2px);
        }

        select:focus, button:focus {
            outline: none;
            border-color: var(--primary-teal);
            box-shadow: 0 0 15px rgba(0, 128, 128, 0.3);
        }

        button {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Fret Count Toggle */
        .fret-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .fret-toggle button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 128, 128, 0.3);
            color: var(--light-text);
        }

        .fret-toggle button.active {
            background: linear-gradient(135deg, var(--primary-teal), var(--accent-blue));
            border-color: var(--primary-teal);
            box-shadow: 0 0 15px rgba(0, 128, 128, 0.5);
        }

        /* FRETBOARD STYLES */
        .fretboard-container {
            position: relative;
            background: rgba(0, 128, 128, 0.15);
            border-radius: 15px;
            padding: 80px 10px 20px 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(0, 128, 128, 0.3);
            box-shadow: 0 8px 32px rgba(0, 128, 128, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .fretboard {
            position: relative;
            width: 180px;
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.3) 0%, rgba(74, 123, 167, 0.3) 50%, rgba(139, 107, 163, 0.3) 100%);
            border-radius: 2px;
            border: 1px solid rgba(0, 128, 128, 0.5);
            cursor: pointer;
            transition: height 0.3s ease;
            box-shadow: inset 0 2px 10px rgba(0, 128, 128, 0.2);
        }

        .fretboard.frets-5 {
            height: 400px;
        }

        .fretboard.frets-12 {
            height: 600px;
        }
        
        .guitar-string {
            position: absolute;
            height: 100%;
            width: 2px;
            background: linear-gradient(to bottom, #C0C0C0 0%, #808080 100%);
            top: 0;
        }
        
        .fret-wire {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, #888 0%, #aaa 50%, #888 100%);
            left: 0;
        }
        
        .note-dot {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transform: translate(-15px, -15px);
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            user-select: none;
        }
        
        .note-dot:hover {
            transform: translate(-15px, -15px) scale(1.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }
        
        .note-dot.playing {
            border-color: #ffffff;
            box-shadow: 0 0 20px rgba(255,255,255,1);
            transform: translate(-15px, -15px) scale(1.4);
            animation: dotPulse 0.3s ease-in-out;
        }
        
        @keyframes dotPulse {
            0% { transform: translate(-15px, -15px) scale(1); }
            50% { transform: translate(-15px, -15px) scale(1.5); }
            100% { transform: translate(-15px, -15px) scale(1.4); }
        }
        
        .string-label {
            position: absolute;
            top: -60px;
            font-weight: bold;
            font-size: 32px;
            color: white;
            text-align: center;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 500;
            transition: color 0.3s, transform 0.3s, text-shadow 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .string-label:hover {
            color: var(--primary-gold);
            transform: scale(1.35);
        }

        .chord-btn {
            padding: 8px 16px;
            background: rgba(0, 128, 128, 0.2);
            border: 2px solid rgba(0, 128, 128, 0.4);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chord-btn:hover {
            background: rgba(0, 128, 128, 0.4);
            border-color: var(--primary-teal);
            transform: translateY(-2px);
        }

        .chord-btn.active {
            background: linear-gradient(135deg, var(--primary-teal), var(--accent-blue));
            border-color: var(--primary-teal);
            box-shadow: 0 0 15px rgba(0, 128, 128, 0.6);
        }

        .play-btn {
            background: linear-gradient(135deg, var(--primary-teal), var(--accent-blue));
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 128, 128, 0.3);
        }

        .play-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 128, 128, 0.5);
        }

        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0, 128, 128, 0.2);
            border-radius: 5px;
            height: 8px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-teal);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 128, 128, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-teal);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 128, 128, 0.5);
        }

        /* Note colors */
        .note-C { background: #ff6b6b; color: white; }
        .note-Db { background: #ff8787; color: white; }
        .note-D { background: #ffa94d; color: white; }
        .note-Eb { background: #ffc078; color: white; }
        .note-E { background: #ffd43b; color: black; }
        .note-F { background: #8ce99a; color: black; }
        .note-Gb { background: #63e6be; color: black; }
        .note-G { background: #74c0fc; color: white; }
        .note-Ab { background: #91a7ff; color: white; }
        .note-A { background: #b197fc; color: white; }
        .note-Bb { background: #da77f2; color: white; }
        .note-B { background: #ff6b9d; color: white; }

        /* FOOTER */
        footer {
            background: rgba(15, 15, 30, 0.95);
            border-top: 2px solid var(--primary-teal);
            padding: 2rem;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }
        
        .footer-section h3 {
            font-family: var(--font-display);
            color: var(--primary-gold);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .footer-section p {
            color: rgba(232, 232, 232, 0.8);
            line-height: 1.6;
        }
        
        .footer-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .footer-links a {
            color: var(--light-text);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: var(--primary-teal);
        }
        
        .copyright {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid rgba(0, 128, 128, 0.3);
            color: rgba(232, 232, 232, 0.6);
        }

        @media (max-width: 768px) {
            .app-header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .app-nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            /* Stack panels vertically on mobile */
            main > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Staff and TAB panel styling */
        .notation-panel {
            background: rgba(0, 128, 128, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(0, 128, 128, 0.3);
            backdrop-filter: blur(10px);
        }

        .notation-panel h3 {
            color: var(--primary-gold);
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-family: var(--font-display);
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="app-header">
        <div class="app-header-content">
            <div class="app-logo-section">
                <svg class="app-logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#F4D03F" stroke-width="3"/>
                    <circle cx="50" cy="50" r="35" fill="none" stroke="#008080" stroke-width="2"/>
                    <path d="M 50 15 L 50 50 L 75 50" stroke="#8B6BA3" stroke-width="3" fill="none" stroke-linecap="round"/>
                    <circle cx="50" cy="50" r="5" fill="#CF7A5A"/>
                </svg>
                <h1 class="app-title">KEYS, CODES & MODES</h1>
            </div>
            <nav class="app-nav-links">
                <a href="#home">Home</a>
                <a href="#apps">Apps</a>
                <a href="#learn">Learn</a>
                <a href="#about">About</a>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
        <h1>Guitar Fretboard Explorer Pro</h1>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="rootNote">Root Note</label>
                    <select id="rootNote">
                        <option value="0">C</option>
                        <option value="1">C# / Db</option>
                        <option value="2">D</option>
                        <option value="3">D# / Eb</option>
                        <option value="4">E</option>
                        <option value="5">F</option>
                        <option value="6">F# / Gb</option>
                        <option value="7">G</option>
                        <option value="8">G# / Ab</option>
                        <option value="9">A</option>
                        <option value="10">A# / Bb</option>
                        <option value="11">B</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="scaleType">Scale Type</label>
                    <select id="scaleType">
                        <option value="all">Show All Notes</option>
                        <option value="chromatic">Chromatic Scale (All 12 Notes)</option>
                        <option value="major">Major Scale</option>
                        <option value="minor">Natural Minor Scale</option>
                        <option value="harmonicMinor">Harmonic Minor Scale</option>
                        <option value="melodicMinor">Melodic Minor Scale</option>
                        <option value="majorPentatonic">Major Pentatonic</option>
                        <option value="minorPentatonic">Minor Pentatonic</option>
                        <option value="blues">Blues Scale</option>
                        <option value="wholeTone">Whole Tone Scale</option>
                        <option value="diminished">Diminished Scale</option>
                        <option value="chords">Chord Shapes</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="modeType">Modal Scales</label>
                    <select id="modeType">
                        <option value="">Select a Mode...</option>
                        <option value="ionian">Ionian (Major)</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="aeolian">Aeolian (Natural Minor)</option>
                        <option value="locrian">Locrian</option>
                    </select>
                </div>

                <div class="control-item">
                    <label>Fretboard Display</label>
                    <div class="fret-toggle">
                        <button id="fret5Btn" onclick="setFretCount(5)">5 Frets</button>
                        <button id="fret12Btn" class="active" onclick="setFretCount(12)">12 Frets</button>
                    </div>
                </div>

                <div class="control-item">
                    <label for="playSpeed">Playback Speed</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="range" id="playSpeed" min="200" max="1000" value="500" step="50" 
                               style="flex: 1; cursor: pointer;">
                        <span id="speedValue" style="min-width: 60px; color: var(--primary-gold);">500ms</span>
                    </div>
                </div>
            </div>

            <div class="control-group" style="margin-top: 15px; justify-content: center;">
                <button class="play-btn" id="playPatternBtn">‚ñ∂ Play Scale Pattern</button>
                <button class="play-btn" id="stopPatternBtn" disabled>‚èπ Stop</button>
                <button class="play-btn" id="playChordBtn" style="display: none;">üé∏ Strum Chord</button>
            </div>

            <div class="control-group" style="margin-top: 10px; justify-content: center;">
                <div class="control-item">
                    <label>Playback Direction</label>
                    <div class="fret-toggle">
                        <button id="ascendBtn" class="active" onclick="setPlayDirection('ascending')">‚ñ≤ Ascending</button>
                        <button id="descendBtn" onclick="setPlayDirection('descending')">‚ñº Descending</button>
                        <button id="bothBtn" onclick="setPlayDirection('both')">‚ñ≤‚ñº Both</button>
                    </div>
                </div>
            </div>

            <div id="chordSelector" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0, 128, 128, 0.3);">
                <label style="display: block; margin-bottom: 10px; color: var(--primary-teal); font-weight: 600;">Major Chords:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <button class="chord-btn" data-chord="C">C</button>
                    <button class="chord-btn" data-chord="D">D</button>
                    <button class="chord-btn" data-chord="E">E</button>
                    <button class="chord-btn" data-chord="F">F</button>
                    <button class="chord-btn" data-chord="G">G</button>
                    <button class="chord-btn" data-chord="A">A</button>
                    <button class="chord-btn" data-chord="B">B</button>
                </div>
                <label style="display: block; margin-bottom: 10px; color: var(--primary-teal); font-weight: 600;">Minor Chords:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="chord-btn" data-chord="Am">Am</button>
                    <button class="chord-btn" data-chord="Em">Em</button>
                    <button class="chord-btn" data-chord="Dm">Dm</button>
                    <button class="chord-btn" data-chord="Bm">Bm</button>
                    <button class="chord-btn" data-chord="Cm">Cm</button>
                    <button class="chord-btn" data-chord="Fm">Fm</button>
                    <button class="chord-btn" data-chord="Gm">Gm</button>
                </div>
                <div id="chordInfo" style="display: none; margin-top: 15px; padding: 12px; background: rgba(0, 128, 128, 0.1); border-radius: 8px; border-left: 4px solid var(--primary-teal);">
                    <h4 id="chordName" style="color: var(--primary-gold); margin-bottom: 8px;"></h4>
                    <div id="chordFingering" style="display: flex; gap: 15px; flex-wrap: wrap; font-family: monospace; font-size: 0.9em;"></div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; align-items: start; margin-bottom: 20px;">
            
            <!-- LEFT PANEL: STAFF NOTATION -->
            <div style="background: rgba(0, 128, 128, 0.1); border-radius: 15px; padding: 20px; border: 2px solid rgba(0, 128, 128, 0.3); backdrop-filter: blur(10px);">
                <h3 style="color: var(--primary-gold); text-align: center; margin-bottom: 15px; font-size: 1.1rem;">Staff Notation</h3>
                <svg id="staffSvg" width="100%" height="300" viewBox="0 0 300 300" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                    <!-- Staff lines will be drawn here -->
                </svg>
            </div>

            <!-- CENTER PANEL: FRETBOARD -->
            <div class="fretboard-container">
                <div class="fretboard frets-12" id="fretboard"></div>
            </div>

            <!-- RIGHT PANEL: GUITAR TAB -->
            <div style="background: rgba(0, 128, 128, 0.1); border-radius: 15px; padding: 20px; border: 2px solid rgba(0, 128, 128, 0.3); backdrop-filter: blur(10px);">
                <h3 style="color: var(--primary-gold); text-align: center; margin-bottom: 15px; font-size: 1.1rem;">Guitar TAB</h3>
                <div id="tabDisplay" style="font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; min-height: 300px; font-size: 14px; line-height: 1.8; color: var(--primary-teal); overflow-x: auto; white-space: pre;">
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(0, 128, 128, 0.1); border-radius: 10px; border: 1px solid rgba(0, 128, 128, 0.3);">
            <div style="color: var(--primary-gold); font-size: 0.9em; font-weight: 600;" id="patternInfo">
                Select a scale or chord pattern to begin
            </div>
            <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em; margin-top: 5px;">
                üí° <strong>Fretboard Layout:</strong> 6th String/Low E (Left/Top) ‚Üí 1st String/High E (Right/Bottom) | Click any note to hear it
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Keys, Codes & Modes</h3>
                <p>Interactive music theory education platform designed to make learning music intuitive and visual.</p>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="#home">Home</a></li>
                    <li><a href="#apps">Interactive Apps</a></li>
                    <li><a href="#learn">Learning Resources</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Connect</h3>
                <ul class="footer-links">
                    <li><a href="#subscribe">Subscribe</a></li>
                    <li><a href="#support">Support</a></li>
                    <li><a href="#feedback">Feedback</a></li>
                </ul>
            </div>
        </div>
        
        <div class="copyright">
            <p>&copy; 2025 Keys, Codes & Modes | Created by Ben Ryan | All Rights Reserved</p>
        </div>
    </footer>

    <script>
        // Audio context
        let audioContext;
        let currentFretCount = 12;
        let currentRoot = 0;
        let currentScale = 'all';
        let currentChord = null;
        let isPlayingPattern = false;
        let patternNotes = [];
        let playDirection = 'ascending'; // 'ascending', 'descending', or 'both'

        // Note data - KCM Official Chromatic Color System
        const colors = [
            '#FFFF00',  // 0: C - Yellow
            '#FFC400',  // 1: C#/Db - Yellow-Orange
            '#FF8000',  // 2: D - Orange
            '#FF4000',  // 3: D#/Eb - Red-Orange
            '#FF0000',  // 4: E - Red
            '#C4007F',  // 5: F - Red-Purple
            '#8000FF',  // 6: F#/Gb - Purple
            '#4000FF',  // 7: G - Blue-Purple
            '#0000FF',  // 8: G#/Ab - Blue
            '#007FFF',  // 9: A - Blue-Green
            '#00FF80',  // 10: A#/Bb - Green
            '#80FF00'   // 11: B - Yellow-Green
        ];
        const textColors = [
            'black',    // C - Yellow (dark text)
            'black',    // C#/Db - Yellow-Orange (dark text)
            'black',    // D - Orange (dark text)
            'white',    // D#/Eb - Red-Orange
            'white',    // E - Red
            'white',    // F - Red-Purple
            'white',    // F#/Gb - Purple
            'white',    // G - Blue-Purple
            'white',    // G#/Ab - Blue
            'white',    // A - Blue-Green
            'black',    // A#/Bb - Green (dark text)
            'black'     // B - Yellow-Green (dark text)
        ];
        const noteNamesShort = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const GUITAR_TUNING = [4, 9, 2, 7, 11, 4]; // E(4), A(9), D(2), G(7), B(11), E(4) - Standard Tuning

        // Scale patterns (intervals from root)
        // Each scale shows which semitones from the root are included
        const SCALES = {
            'all': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],           // All notes on fretboard
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],     // Chromatic - all 12 notes
            'major': [0, 2, 4, 5, 7, 9, 11],                          // W-W-H-W-W-W-H (Ionian)
            'minor': [0, 2, 3, 5, 7, 8, 10],                          // W-H-W-W-H-W-W (Aeolian/Natural Minor)
            'harmonicMinor': [0, 2, 3, 5, 7, 8, 11],                  // Natural minor with raised 7th
            'melodicMinor': [0, 2, 3, 5, 7, 9, 11],                   // Natural minor with raised 6th and 7th
            'majorPentatonic': [0, 2, 4, 7, 9],                       // Major without 4th and 7th
            'minorPentatonic': [0, 3, 5, 7, 10],                      // Minor without 2nd and 6th
            'blues': [0, 3, 5, 6, 7, 10],                             // Minor Pentatonic + b5
            'wholeTone': [0, 2, 4, 6, 8, 10],                         // All whole steps
            'diminished': [0, 2, 3, 5, 6, 8, 9, 11],                  // Half-Whole diminished scale
            // The 7 Modes (Greek modes)
            'ionian': [0, 2, 4, 5, 7, 9, 11],                         // W-W-H-W-W-W-H (Major)
            'dorian': [0, 2, 3, 5, 7, 9, 10],                         // W-H-W-W-W-H-W
            'phrygian': [0, 1, 3, 5, 7, 8, 10],                       // H-W-W-W-H-W-W
            'lydian': [0, 2, 4, 6, 7, 9, 11],                         // W-W-W-H-W-W-H
            'mixolydian': [0, 2, 4, 5, 7, 9, 10],                     // W-W-H-W-W-H-W
            'aeolian': [0, 2, 3, 5, 7, 8, 10],                        // W-H-W-W-H-W-W (Natural Minor)
            'locrian': [0, 1, 3, 5, 6, 8, 10]                         // H-W-W-H-W-W-W
        };

        // Chord definitions
        const CHORDS = {
            'C': { name: 'C Major', notes: [0, 4, 7], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: 3}, {string: 2, fret: 2},
                {string: 3, fret: 0}, {string: 4, fret: 1}, {string: 5, fret: 0}
            ]},
            'G': { name: 'G Major', notes: [7, 11, 2], fingering: [
                {string: 0, fret: 3}, {string: 1, fret: 2}, {string: 2, fret: 0},
                {string: 3, fret: 0}, {string: 4, fret: 0}, {string: 5, fret: 3}
            ]},
            'D': { name: 'D Major', notes: [2, 6, 9], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: -1}, {string: 2, fret: 0},
                {string: 3, fret: 2}, {string: 4, fret: 3}, {string: 5, fret: 2}
            ]},
            'A': { name: 'A Major', notes: [9, 1, 4], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: 0}, {string: 2, fret: 2},
                {string: 3, fret: 2}, {string: 4, fret: 2}, {string: 5, fret: 0}
            ]},
            'E': { name: 'E Major', notes: [4, 8, 11], fingering: [
                {string: 0, fret: 0}, {string: 1, fret: 2}, {string: 2, fret: 2},
                {string: 3, fret: 1}, {string: 4, fret: 0}, {string: 5, fret: 0}
            ]},
            'F': { name: 'F Major', notes: [5, 9, 0], fingering: [
                {string: 0, fret: 1}, {string: 1, fret: 3}, {string: 2, fret: 3},
                {string: 3, fret: 2}, {string: 4, fret: 1}, {string: 5, fret: 1}
            ]},
            'B': { name: 'B Major', notes: [11, 3, 6], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: 2}, {string: 2, fret: 4},
                {string: 3, fret: 4}, {string: 4, fret: 4}, {string: 5, fret: 2}
            ]},
            'Am': { name: 'A Minor', notes: [9, 0, 4], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: 0}, {string: 2, fret: 2},
                {string: 3, fret: 2}, {string: 4, fret: 1}, {string: 5, fret: 0}
            ]},
            'Em': { name: 'E Minor', notes: [4, 7, 11], fingering: [
                {string: 0, fret: 0}, {string: 1, fret: 2}, {string: 2, fret: 2},
                {string: 3, fret: 0}, {string: 4, fret: 0}, {string: 5, fret: 0}
            ]},
            'Dm': { name: 'D Minor', notes: [2, 5, 9], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: -1}, {string: 2, fret: 0},
                {string: 3, fret: 2}, {string: 4, fret: 3}, {string: 5, fret: 1}
            ]},
            'Bm': { name: 'B Minor', notes: [11, 2, 6], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: 2}, {string: 2, fret: 4},
                {string: 3, fret: 4}, {string: 4, fret: 3}, {string: 5, fret: 2}
            ]},
            'Cm': { name: 'C Minor', notes: [0, 3, 7], fingering: [
                {string: 0, fret: -1}, {string: 1, fret: 3}, {string: 2, fret: 5},
                {string: 3, fret: 5}, {string: 4, fret: 4}, {string: 5, fret: 3}
            ]},
            'Fm': { name: 'F Minor', notes: [5, 8, 0], fingering: [
                {string: 0, fret: 1}, {string: 1, fret: 3}, {string: 2, fret: 3},
                {string: 3, fret: 1}, {string: 4, fret: 1}, {string: 5, fret: 1}
            ]},
            'Gm': { name: 'G Minor', notes: [7, 10, 2], fingering: [
                {string: 0, fret: 3}, {string: 1, fret: 5}, {string: 2, fret: 5},
                {string: 3, fret: 3}, {string: 4, fret: 3}, {string: 5, fret: 3}
            ]}
        };

        // Initialize audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play note function
        function playNote(n, oct = 4, dur = 0.8) {
            try {
                initAudio();
                if (!audioContext) return;

                const freqs = [261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88];
                const freq = freqs[n] * Math.pow(2, oct - 4);

                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                osc.type = 'sine';

                const now = audioContext.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + dur);

                osc.start(now);
                osc.stop(now + dur);
            } catch (e) {
                console.error('Play note error:', e);
            }
        }

        // Play chord with strumming
        async function playChord() {
            if (!currentChord) return;
            
            const chord = CHORDS[currentChord];
            const strumDelay = 50;
            
            const baseAbsolutePitch = [
                4 + (2 * 12), // E2
                9 + (2 * 12), // A2
                2 + (3 * 12), // D3
                7 + (3 * 12), // G3
                11 + (3 * 12), // B3
                4 + (4 * 12)  // E4
            ];
            
            for (let i = 0; i < chord.fingering.length; i++) {
                const pos = chord.fingering[i];
                
                if (pos.fret !== -1) {
                    const absolutePitch = baseAbsolutePitch[pos.string] + pos.fret;
                    const noteValue = absolutePitch % 12;
                    const octave = Math.floor(absolutePitch / 12);
                    playNote(noteValue, octave, 1.5);
                    
                    // Highlight the note being played
                    const targetDot = document.querySelector(
                        `.note-dot[data-string="${pos.string}"][data-fret="${pos.fret}"]`
                    );
                    
                    if (targetDot) {
                        targetDot.classList.add('playing');
                        setTimeout(() => targetDot.classList.remove('playing'), 500);
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, strumDelay));
            }
        }

        // Set playback direction
        function setPlayDirection(direction) {
            playDirection = direction;
            
            const ascendBtn = document.getElementById('ascendBtn');
            const descendBtn = document.getElementById('descendBtn');
            const bothBtn = document.getElementById('bothBtn');
            
            ascendBtn.classList.remove('active');
            descendBtn.classList.remove('active');
            bothBtn.classList.remove('active');
            
            if (direction === 'ascending') {
                ascendBtn.classList.add('active');
            } else if (direction === 'descending') {
                descendBtn.classList.add('active');
            } else {
                bothBtn.classList.add('active');
            }
        }

        // Play scale pattern
        async function playPattern() {
            if (patternNotes.length === 0) return;
            
            const playBtn = document.getElementById('playPatternBtn');
            const stopBtn = document.getElementById('stopPatternBtn');
            playBtn.disabled = true;
            stopBtn.disabled = false;
            isPlayingPattern = true;
            
            const speed = parseInt(document.getElementById('playSpeed').value);
            
            // Create playback array based on direction
            let playbackNotes = [...patternNotes];
            
            if (playDirection === 'descending') {
                playbackNotes.reverse();
            } else if (playDirection === 'both') {
                // Ascending then descending (don't repeat the top note)
                const descending = [...patternNotes].reverse().slice(1);
                playbackNotes = [...patternNotes, ...descending];
            }
            
            // Play the notes
            for (let i = 0; i < playbackNotes.length && isPlayingPattern; i++) {
                const note = playbackNotes[i];
                
                // Play the note
                playNote(note.noteValue, note.octave, speed / 1000);
                
                // Update staff notation and TAB
                updateNotation(note.noteValue, note.octave, note.string, note.fret);
                
                // Find and highlight the specific note dot
                const targetDot = document.querySelector(
                    `.note-dot[data-string="${note.string}"][data-fret="${note.fret}"]`
                );
                
                if (targetDot) {
                    targetDot.classList.add('playing');
                    setTimeout(() => targetDot.classList.remove('playing'), speed - 50);
                }
                
                await new Promise(resolve => setTimeout(resolve, speed));
            }
            
            isPlayingPattern = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            
            // Clear displays after pattern finishes
            setTimeout(() => {
                initStaff();
                clearTab();
            }, 1000);
        }

        // Stop pattern
        function stopPattern() {
            isPlayingPattern = false;
            document.getElementById('playPatternBtn').disabled = false;
            document.getElementById('stopPatternBtn').disabled = true;
        }

        // Set fret count
        function setFretCount(count) {
            currentFretCount = count;
            const fret5Btn = document.getElementById('fret5Btn');
            const fret12Btn = document.getElementById('fret12Btn');
            
            if (count === 5) {
                fret5Btn.classList.add('active');
                fret12Btn.classList.remove('active');
            } else {
                fret12Btn.classList.add('active');
                fret5Btn.classList.remove('active');
            }
            
            createGuitar();
        }

        // Check if note is in scale/chord
        function isNoteInPattern(noteValue) {
            if (currentScale === 'chords') {
                if (!currentChord) return false;
                const chord = CHORDS[currentChord];
                if (!chord) return false;
                return chord.notes.includes(noteValue);
            } else if (currentScale !== 'all' && SCALES[currentScale]) {
                const scale = SCALES[currentScale];
                const relativeNote = (noteValue - currentRoot + 12) % 12;
                return scale.includes(relativeNote);
            }
            return true;
        }

        // Check if note is in chord fingering
        function isNoteInChordFingering(string, fret) {
            if (!currentChord || currentScale !== 'chords') return false;
            const chord = CHORDS[currentChord];
            if (!chord || !chord.fingering) return false;
            return chord.fingering.some(f => f.string === string && f.fret === fret);
        }

        // Update chord info display
        function updateChordInfo() {
            if (!currentChord) return;
            
            const chord = CHORDS[currentChord];
            const chordInfo = document.getElementById('chordInfo');
            const chordName = document.getElementById('chordName');
            const chordFingering = document.getElementById('chordFingering');
            
            chordInfo.style.display = 'block';
            chordName.textContent = chord.name;
            chordFingering.innerHTML = '';
            
            const stringNames = ['6th-E (Low)', '5th-A', '4th-D', '3rd-G', '2nd-B', '1st-E (High)'];
            
            chord.fingering.forEach((pos) => {
                const fingerDiv = document.createElement('div');
                if (pos.fret === -1) {
                    fingerDiv.textContent = `${stringNames[pos.string]}: X`;
                    fingerDiv.style.color = '#ff6666';
                } else {
                    fingerDiv.textContent = `${stringNames[pos.string]}: Fret ${pos.fret}`;
                }
                chordFingering.appendChild(fingerDiv);
            });
        }

        // Collect pattern notes for playback
        function collectPatternNotes() {
            patternNotes = [];
            
            if (currentScale === 'chords' && currentChord && CHORDS[currentChord]) {
                // For chords, collect fingering positions in proper order (low to high string)
                const chord = CHORDS[currentChord];
                const baseAbsolutePitch = [
                    4 + (2 * 12), // E2
                    9 + (2 * 12), // A2
                    2 + (3 * 12), // D3
                    7 + (3 * 12), // G3
                    11 + (3 * 12), // B3
                    4 + (4 * 12)  // E4
                ];
                
                if (chord.fingering) {
                    chord.fingering.forEach(pos => {
                        if (pos.fret !== -1) {
                            const absolutePitch = baseAbsolutePitch[pos.string] + pos.fret;
                            const noteValue = absolutePitch % 12;
                            const octave = Math.floor(absolutePitch / 12);
                            patternNotes.push({ 
                                noteValue, 
                                octave, 
                                string: pos.string, 
                                fret: pos.fret,
                                absolutePitch 
                            });
                        }
                    });
                }
                
                // Update pattern info
                updatePatternInfo(`${chord.name} - ${patternNotes.length} notes in chord`);
            } else {
                // For scales, collect notes but ELIMINATE DUPLICATES
                const scale = SCALES[currentScale];
                
                // Safety check - if scale doesn't exist, show all notes
                if (!scale) {
                    currentScale = 'all';
                    createGuitar();
                    return;
                }
                
                const allNotes = [];
                const seenPitches = new Set(); // Track which absolute pitches we've already added
                
                const baseAbsolutePitch = [
                    4 + (2 * 12), // E2
                    9 + (2 * 12), // A2
                    2 + (3 * 12), // D3
                    7 + (3 * 12), // G3
                    11 + (3 * 12), // B3
                    4 + (4 * 12)  // E4
                ];
                
                // Collect all notes with their absolute pitch
                for (let s = 0; s < 6; s++) {
                    for (let f = 0; f <= currentFretCount; f++) {
                        const absolutePitch = baseAbsolutePitch[s] + f;
                        const noteValue = absolutePitch % 12;
                        const octave = Math.floor(absolutePitch / 12);
                        const relativeNote = (noteValue - currentRoot + 12) % 12;
                        
                        // Only add if note is in scale AND we haven't seen this exact pitch before
                        if (scale.includes(relativeNote) && !seenPitches.has(absolutePitch)) {
                            seenPitches.add(absolutePitch);
                            allNotes.push({ 
                                noteValue, 
                                octave, 
                                string: s, 
                                fret: f,
                                absolutePitch 
                            });
                        }
                    }
                }
                
                // Sort by absolute pitch (lowest to highest)
                allNotes.sort((a, b) => a.absolutePitch - b.absolutePitch);
                patternNotes = allNotes;
                
                // Update pattern info
                const scaleNames = {
                    'all': 'All Notes (Fretboard)',
                    'chromatic': 'Chromatic Scale',
                    'major': 'Major Scale',
                    'minor': 'Natural Minor Scale',
                    'harmonicMinor': 'Harmonic Minor Scale',
                    'melodicMinor': 'Melodic Minor Scale',
                    'majorPentatonic': 'Major Pentatonic',
                    'minorPentatonic': 'Minor Pentatonic',
                    'blues': 'Blues Scale',
                    'wholeTone': 'Whole Tone Scale',
                    'diminished': 'Diminished Scale',
                    'ionian': 'Ionian Mode (Major)',
                    'dorian': 'Dorian Mode',
                    'phrygian': 'Phrygian Mode',
                    'lydian': 'Lydian Mode',
                    'mixolydian': 'Mixolydian Mode',
                    'aeolian': 'Aeolian Mode (Natural Minor)',
                    'locrian': 'Locrian Mode'
                };
                const rootName = noteNamesShort[currentRoot];
                const scaleName = scaleNames[currentScale] || currentScale;
                updatePatternInfo(`${rootName} ${scaleName} - ${patternNotes.length} unique notes`);
            }
        }

        // Update pattern info display
        function updatePatternInfo(text) {
            const infoDiv = document.getElementById('patternInfo');
            if (infoDiv) {
                infoDiv.textContent = text;
            }
        }

        // Initialize Staff Notation
        function initStaff() {
            const svg = document.getElementById('staffSvg');
            if (!svg) return;
            
            svg.innerHTML = '';
            
            // Draw 5 staff lines
            // Lines from BOTTOM to TOP: E4(130), G4(110), B4(90), D5(70), F5(50)
            const staffLinePositions = [130, 110, 90, 70, 50];
            
            for (let i = 0; i < 5; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '20');
                line.setAttribute('x2', '280');
                line.setAttribute('y1', staffLinePositions[i]);
                line.setAttribute('y2', staffLinePositions[i]);
                line.setAttribute('stroke', 'rgba(0, 128, 128, 0.6)');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);
            }
            
            // Draw treble clef - clean and elegant
            const clef = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            clef.setAttribute('x', '30');
            clef.setAttribute('y', '125');
            clef.setAttribute('font-size', '80');
            clef.setAttribute('font-family', 'serif');
            clef.setAttribute('fill', 'var(--primary-gold)');
            clef.setAttribute('opacity', '0.9');
            clef.textContent = 'ùÑû';
            svg.appendChild(clef);
        }

        // Update Staff Notation with current note
        function updateStaff(noteValue, octave) {
            const svg = document.getElementById('staffSvg');
            if (!svg) return;
            
            // Clear previous notes
            const existingNotes = svg.querySelectorAll('.staff-note');
            existingNotes.forEach(n => n.remove());
            
            const noteLetters = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const fullNoteName = noteLetters[noteValue];
            const baseLetter = fullNoteName.replace('#', '');
            const isSharp = fullNoteName.includes('#');
            
            // TREBLE CLEF STAFF - Lines: E4, G4, B4, D5, F5 | Spaces: F4, A4, C5, E5
            // Staff lines at y: 130, 110, 90, 70, 50 (20px apart)
            
            // Use explicit position mapping for accuracy
            const positions = {
                // Octave 2
                'C2': 270, 'D2': 260, 'E2': 250, 'F2': 240, 'G2': 230, 'A2': 220, 'B2': 210,
                // Octave 3
                'C3': 200, 'D3': 190, 'E3': 180, 'F3': 170, 'G3': 160, 'A3': 150, 'B3': 140,
                // Octave 4
                'C4': 150, 'D4': 140, 'E4': 130, 'F4': 120, 'G4': 110, 'A4': 100, 'B4': 90,
                // Octave 5
                'C5': 80, 'D5': 70, 'E5': 60, 'F5': 50, 'G5': 40, 'A5': 30, 'B5': 20,
                // Octave 6
                'C6': 10, 'D6': 0
            };
            
            const noteKey = baseLetter + octave;
            let yPos = positions[noteKey];
            
            // Fallback calculation if note not in map
            if (yPos === undefined) {
                const noteOrder = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const letterIndex = noteOrder.indexOf(baseLetter);
                // E4 at y=130, each step = 10px
                const stepsFromE4 = (letterIndex - 2) + ((octave - 4) * 7);
                yPos = 130 - (stepsFromE4 * 10);
            }
            
            // Draw note head
            const note = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
            note.setAttribute('class', 'staff-note');
            note.setAttribute('cx', '150');
            note.setAttribute('cy', yPos);
            note.setAttribute('rx', '8');
            note.setAttribute('ry', '6');
            note.setAttribute('fill', colors[noteValue]);
            note.setAttribute('stroke', 'white');
            note.setAttribute('stroke-width', '2');
            svg.appendChild(note);
            
            // Add sharp symbol if needed
            if (isSharp) {
                const sharp = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                sharp.setAttribute('class', 'staff-note');
                sharp.setAttribute('x', '128');
                sharp.setAttribute('y', yPos + 6);
                sharp.setAttribute('font-size', '24');
                sharp.setAttribute('fill', 'var(--primary-gold)');
                sharp.setAttribute('font-weight', 'bold');
                sharp.textContent = '‚ôØ';
                svg.appendChild(sharp);
            }
            
            // Add ledger lines below staff (C4 and below at y > 130)
            if (yPos > 130) {
                // Ledger lines at C4 (150), A3 (170), etc.
                for (let y = 150; y <= yPos; y += 20) {
                    const ledger = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    ledger.setAttribute('class', 'staff-note');
                    ledger.setAttribute('x1', '135');
                    ledger.setAttribute('x2', '165');
                    ledger.setAttribute('y1', y);
                    ledger.setAttribute('y2', y);
                    ledger.setAttribute('stroke', 'rgba(0, 128, 128, 0.6)');
                    ledger.setAttribute('stroke-width', '2');
                    svg.appendChild(ledger);
                }
            }
            
            // Add ledger lines above staff (A5 and above at y < 50)
            if (yPos < 50) {
                for (let y = 40; y >= yPos; y -= 20) {
                    const ledger = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    ledger.setAttribute('class', 'staff-note');
                    ledger.setAttribute('x1', '135');
                    ledger.setAttribute('x2', '165');
                    ledger.setAttribute('y1', y);
                    ledger.setAttribute('y2', y);
                    ledger.setAttribute('stroke', 'rgba(0, 128, 128, 0.6)');
                    ledger.setAttribute('stroke-width', '2');
                    svg.appendChild(ledger);
                }
            }
        }

        // Initialize TAB display
        function initTab() {
            const tabDisplay = document.getElementById('tabDisplay');
            if (!tabDisplay) return;
            
            tabDisplay.innerHTML = 
`e|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
B|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
G|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
D|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
A|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
E|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

   1st (High E)
   2nd (B)
   3rd (G)
   4th (D)
   5th (A)
   6th (Low E)`;
        }

        // Update TAB with current note
        function updateTab(string, fret) {
            const tabDisplay = document.getElementById('tabDisplay');
            if (!tabDisplay) return;
            
            const stringNames = ['e', 'B', 'G', 'D', 'A', 'E'];
            const stringLabels = ['1st (High E)', '2nd (B)', '3rd (G)', '4th (D)', '5th (A)', '6th (Low E)'];
            
            let tab = '';
            for (let i = 5; i >= 0; i--) {
                const currentString = stringNames[5 - i];
                if (i === string) {
                    // Highlight the active string with WHITE fret number
                    const fretDisplay = fret.toString();
                    const padding = '‚îÄ'.repeat(Math.max(0, 7 - fretDisplay.length));
                    tab += `${currentString}|‚îÄ‚îÄ${padding}<span style="color: white; font-weight: bold; background: rgba(0, 128, 128, 0.4); padding: 2px 6px; border-radius: 3px;">${fretDisplay}</span>${padding}‚îÄ‚îÄ\n`;
                } else {
                    tab += `${currentString}|‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                }
            }
            
            tab += '\n';
            for (let i = 5; i >= 0; i--) {
                const indicator = i === string ? 'üëâ ' : '   ';
                tab += `${indicator}${stringLabels[5 - i]}\n`;
            }
            
            tabDisplay.innerHTML = tab;
        }

        // Clear TAB
        function clearTab() {
            initTab();
        }

        // Update both staff and TAB for pattern playback
        function updateNotation(noteValue, octave, string, fret) {
            updateStaff(noteValue, octave);
            updateTab(string, fret);
        }

        // Create guitar fretboard
        // FRETBOARD ORIENTATION:
        // - Viewed from FRONT (as if guitar is facing you)
        // - STRINGS run VERTICALLY (left to right = 6th string to 1st string)
        // - String numbering: 6th(Low E), 5th(A), 4th(D), 3rd(G), 2nd(B), 1st(High E)
        // - Code uses index 0-5: [0]=6th string, [1]=5th, [2]=4th, [3]=3rd, [4]=2nd, [5]=1st
        // - FRETS run HORIZONTALLY (top to bottom = nut to bridge)
        // - LOWEST NOTE (E2) = Upper Left (Northwest) - 6th String (index 0), Fret 0
        // - HIGHEST NOTE (E5) = Lower Right (Southeast) - 1st String (index 5), Fret 12
        // - Notes ascend in pitch as you: move right across strings OR move down the frets
        function createGuitar() {
            try {
                const fb = document.getElementById('fretboard');
                if (!fb) return;
                
                fb.innerHTML = '';
                fb.className = currentFretCount === 5 ? 'fretboard frets-5' : 'fretboard frets-12';
                
                const names = ['E', 'A', 'D', 'G', 'B', 'E'];
                const baseOctaves = [2, 2, 3, 3, 3, 4]; // Open string octaves: E2, A2, D3, G3, B3, E4
                
                // Calculate absolute MIDI-style pitch for each open string
                // E2=4+(2*12)=28, A2=9+(2*12)=33, D3=2+(3*12)=38, G3=7+(3*12)=43, B3=11+(3*12)=47, E4=4+(4*12)=52
                const baseAbsolutePitch = [
                    GUITAR_TUNING[0] + (baseOctaves[0] * 12), // E2 = 4 + 24 = 28
                    GUITAR_TUNING[1] + (baseOctaves[1] * 12), // A2 = 9 + 24 = 33
                    GUITAR_TUNING[2] + (baseOctaves[2] * 12), // D3 = 2 + 36 = 38
                    GUITAR_TUNING[3] + (baseOctaves[3] * 12), // G3 = 7 + 36 = 43
                    GUITAR_TUNING[4] + (baseOctaves[4] * 12), // B3 = 11 + 36 = 47
                    GUITAR_TUNING[5] + (baseOctaves[5] * 12)  // E4 = 4 + 48 = 52
                ];

                const fretHeight = currentFretCount === 12 ? 50 : 80;
                const totalHeight = currentFretCount * fretHeight;
                fb.style.height = totalHeight + 'px';
                fb.style.width = '180px';

                // Create strings
                for (let s = 0; s < 6; s++) {
                    const str = document.createElement('div');
                    str.className = 'guitar-string';
                    str.style.left = (30 * s + 15) + 'px';
                    str.style.width = (s >= 4 ? '1px' : s >= 2 ? '2px' : '3px');
                    str.style.height = '100%';
                    fb.appendChild(str);

                    const lbl = document.createElement('div');
                    lbl.className = 'string-label';
                    lbl.textContent = names[s];
                    lbl.style.left = (30 * s - 5) + 'px';
                    lbl.onclick = () => playNote(GUITAR_TUNING[s], baseOctaves[s], 0.8);
                    fb.appendChild(lbl);
                }

                // Create fret wires
                for (let f = 1; f <= currentFretCount; f++) {
                    const fw = document.createElement('div');
                    fw.className = 'fret-wire';
                    fw.style.top = (f * fretHeight) + 'px';
                    fb.appendChild(fw);
                }

                // Create fret markers
                const markerFrets = currentFretCount === 12 ? [3, 5, 7, 9, 12] : [3, 5];
                markerFrets.forEach(fret => {
                    if (fret <= currentFretCount) {
                        if (fret === 12) {
                            [1.5, 4.5].forEach(stringPos => {
                                const marker = document.createElement('div');
                                marker.style.position = 'absolute';
                                marker.style.width = '8px';
                                marker.style.height = '8px';
                                marker.style.borderRadius = '50%';
                                marker.style.background = 'rgba(244, 208, 63, 0.3)';
                                marker.style.left = (30 * stringPos) + 'px';
                                marker.style.top = (fret * fretHeight - fretHeight / 2) + 'px';
                                marker.style.transform = 'translate(-4px, -4px)';
                                marker.style.pointerEvents = 'none';
                                fb.appendChild(marker);
                            });
                        } else {
                            const marker = document.createElement('div');
                            marker.style.position = 'absolute';
                            marker.style.width = '10px';
                            marker.style.height = '10px';
                            marker.style.borderRadius = '50%';
                            marker.style.background = 'rgba(244, 208, 63, 0.3)';
                            marker.style.left = '90px';
                            marker.style.top = (fret * fretHeight - fretHeight / 2) + 'px';
                            marker.style.transform = 'translate(-5px, -5px)';
                            marker.style.pointerEvents = 'none';
                            fb.appendChild(marker);
                        }
                    }
                });

                // Create note dots
                for (let s = 0; s < 6; s++) {
                    for (let f = 1; f <= currentFretCount; f++) {
                        const absolutePitch = baseAbsolutePitch[s] + f;
                        const n = absolutePitch % 12;
                        const calculatedOctave = Math.floor(absolutePitch / 12);
                        
                        const inPattern = isNoteInPattern(n);
                        const inFingering = isNoteInChordFingering(s, f);
                        
                        const dot = document.createElement('div');
                        dot.className = 'note-dot note-' + noteNamesShort[n].replace('#', 'b');
                        dot.style.left = (30 * s + 15) + 'px';
                        dot.style.top = (f * fretHeight - fretHeight / 2) + 'px';
                        dot.style.background = colors[n];
                        dot.style.color = textColors[n];
                        dot.textContent = noteNamesShort[n];
                        
                        // Add data attributes for identification
                        dot.dataset.string = s;
                        dot.dataset.fret = f;
                        dot.dataset.noteValue = n;
                        dot.dataset.octave = calculatedOctave;
                        
                        // Dim notes not in pattern - make them much more subdued
                        if (!inPattern) {
                            dot.style.opacity = '0.15';
                            dot.style.filter = 'grayscale(100%) brightness(0.5)';
                            dot.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                        } else if (inFingering) {
                            dot.style.opacity = '1';
                            dot.style.filter = 'none';
                            dot.style.boxShadow = '0 0 15px rgba(255, 255, 255, 0.8)';
                            dot.style.borderWidth = '3px';
                        } else {
                            // In pattern but not specifically fingered
                            dot.style.opacity = '1';
                            dot.style.filter = 'none';
                        }
                        
                        dot.onclick = function() {
                            playNote(n, calculatedOctave, 0.8);
                            
                            // Update notation displays
                            updateNotation(n, calculatedOctave, s, f);
                            
                            this.classList.add('playing');
                            setTimeout(() => this.classList.remove('playing'), 300);
                        };
                        fb.appendChild(dot);
                    }
                }

                // Add X marks for muted strings in chords
                if (currentChord) {
                    const chord = CHORDS[currentChord];
                    chord.fingering.forEach(pos => {
                        if (pos.fret === -1) {
                            const x = document.createElement('div');
                            x.style.position = 'absolute';
                            x.style.left = (30 * pos.string + 15) + 'px';
                            x.style.top = '-30px';
                            x.style.color = '#ff6b6b';
                            x.style.fontSize = '24px';
                            x.style.fontWeight = 'bold';
                            x.style.transform = 'translateX(-50%)';
                            x.textContent = 'X';
                            fb.appendChild(x);
                        }
                    });
                }

                // Collect notes for pattern playback
                collectPatternNotes();
            } catch (e) {
                console.error('Create guitar error:', e);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize displays
            initStaff();
            initTab();
            createGuitar();

            // Root note selector
            document.getElementById('rootNote').addEventListener('change', (e) => {
                currentRoot = parseInt(e.target.value);
                createGuitar();
            });

            // Scale type selector
            document.getElementById('scaleType').addEventListener('change', (e) => {
                currentScale = e.target.value;
                const chordSelector = document.getElementById('chordSelector');
                const playChordBtn = document.getElementById('playChordBtn');
                const modeSelector = document.getElementById('modeType');
                
                // Clear mode selection when scale is selected
                if (modeSelector) {
                    modeSelector.value = '';
                }
                
                if (currentScale === 'chords') {
                    chordSelector.style.display = 'block';
                } else {
                    chordSelector.style.display = 'none';
                    playChordBtn.style.display = 'none';
                    currentChord = null;
                    document.querySelectorAll('.chord-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('chordInfo').style.display = 'none';
                }
                
                createGuitar();
            });

            // Mode type selector
            document.getElementById('modeType').addEventListener('change', (e) => {
                if (e.target.value) {
                    currentScale = e.target.value;
                    // Clear scale selection
                    document.getElementById('scaleType').value = 'all';
                    // Hide chord selector
                    document.getElementById('chordSelector').style.display = 'none';
                    document.getElementById('playChordBtn').style.display = 'none';
                    currentChord = null;
                    document.querySelectorAll('.chord-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('chordInfo').style.display = 'none';
                    
                    createGuitar();
                }
            });

            // Speed control
            document.getElementById('playSpeed').addEventListener('input', (e) => {
                document.getElementById('speedValue').textContent = e.target.value + 'ms';
            });

            // Play pattern button
            document.getElementById('playPatternBtn').addEventListener('click', playPattern);

            // Stop pattern button
            document.getElementById('stopPatternBtn').addEventListener('click', stopPattern);

            // Play chord button
            document.getElementById('playChordBtn').addEventListener('click', playChord);

            // Chord buttons
            document.querySelectorAll('.chord-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentChord = btn.dataset.chord;
                    currentScale = 'chords'; // Set scale mode to chords
                    
                    // Update UI
                    document.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('playChordBtn').style.display = 'inline-block';
                    
                    // Update chord info and fretboard
                    updateChordInfo();
                    createGuitar();
                });
            });
        });
    </script>
</body>
</html>
