<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EGC5ZNZPF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-6EGC5ZNZPF');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEYS, CODES AND MODES - Guitar Fretboard Explorer Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            line-height: 1.3;
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #00d4ff;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, button {
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #00d4ff;
            transform: translateY(-2px);
        }

        select:focus, button:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        button {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button.play-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
        }

        button.play-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        button.play-btn:active {
            transform: translateY(-1px);
        }

        .chord-presets {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chord-presets h3 {
            color: #00d4ff;
            margin-bottom: 12px;
            font-size: 1.05em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chord-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chord-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 153, 204, 0.2) 100%);
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chord-btn:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.4) 0%, rgba(0, 153, 204, 0.4) 100%);
            border-color: #00d4ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }

        .chord-btn.active {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border-color: #00d4ff;
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.6);
        }

        .chord-info {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
        }

        .chord-info h4 {
            color: #00d4ff;
            margin-bottom: 8px;
        }

        .chord-fingering {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-family: monospace;
            font-size: 0.95em;
        }

        .fretboard-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 100px 50px 30px 60px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        .fretboard {
            position: relative;
            width: 240px;
            height: 200px;
            margin: 0 auto;
        }

        .string-labels {
            position: absolute;
            left: 0;
            top: -70px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
        }

        .string-label {
            font-size: 1.2em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .string-label.active {
            color: #00d4ff;
            text-shadow: 0 0 15px currentColor;
            transform: scale(1.2);
        }

        .strings {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .string {
            position: absolute;
            height: 100%;
            background: linear-gradient(to right, rgba(200, 200, 200, 0.3), rgba(150, 150, 150, 0.3));
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.3);
            top: 0;
        }

        /* Strings from left to right: E(bass) - A - D - G - B - E(treble) - 2.5 INCH WIDTH */
        .string:nth-child(1) { left: 20%; width: 4px; }     /* Low E (bass) */
        .string:nth-child(2) { left: 32%; width: 3.5px; }   /* A */
        .string:nth-child(3) { left: 44%; width: 3px; }     /* D */
        .string:nth-child(4) { left: 56%; width: 2.5px; }   /* G */
        .string:nth-child(5) { left: 68%; width: 2px; }     /* B */
        .string:nth-child(6) { left: 80%; width: 1.5px; }   /* High E (treble) */

        .frets {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            top: 0;
            left: 0;
        }

        .fret {
            flex: 1;
            position: relative;
            border-bottom: 3px solid rgba(150, 150, 150, 0.4);
        }

        .fret:first-child {
            border-top: 8px solid rgba(200, 200, 200, 0.6);
        }

        .fret-markers {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .fret-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .fret-numbers {
            position: absolute;
            left: -35px;
            top: 0;
            height: 100%;
            width: 30px;
            pointer-events: none;
        }

        .fret-number {
            position: absolute;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
            transform: translateY(-50%);
        }

        .notes-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .note-dot {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            opacity: 0.25;
            filter: grayscale(0.5);
        }

        .note-dot.in-pattern {
            opacity: 1;
            filter: grayscale(0);
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 0 20px currentColor;
        }

        .note-dot.playing {
            animation: notePulse 0.5s ease-out;
            transform: translate(-50%, -50%) scale(1.4);
            box-shadow: 0 0 30px currentColor;
            z-index: 100;
        }

        @keyframes notePulse {
            0% {
                transform: translate(-50%, -50%) scale(1.15);
                box-shadow: 0 0 20px currentColor;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5);
                box-shadow: 0 0 40px currentColor;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.4);
                box-shadow: 0 0 30px currentColor;
            }
        }

        .note-dot:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 50;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.05);
            padding: 18px;
            border-radius: 15px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-panel h3 {
            color: #00d4ff;
            margin-bottom: 12px;
        }

        .pattern-info {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .pattern-step {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
        }

        .legend {
            display: flex;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-control input[type="range"] {
            width: 150px;
        }

        /* Note colors - chromatic circle starting with E */
        .note-E { background: #FFFF00; }      /* Yellow */
        .note-F { background: #FFC400; }      /* Yellow-Orange */
        .note-Gb { background: #FF8000; }     /* Orange */
        .note-G { background: #FF4000; }      /* Red-Orange */
        .note-Ab { background: #FF0000; }     /* Red */
        .note-A { background: #C4007F; }      /* Red-Purple */
        .note-Bb { background: #8000FF; }     /* Purple */
        .note-B { background: #4000FF; }      /* Blue-Purple */
        .note-C { background: #0000FF; }      /* Blue */
        .note-Db { background: #007FFF; }     /* Blue-Green */
        .note-D { background: #00FF80; }      /* Green */
        .note-Eb { background: #80FF00; }     /* Yellow-Green */

        @media (max-width: 1000px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .fretboard-container {
                overflow-x: auto;
                padding: 90px 20px 20px 50px;
            }

            .fretboard {
                width: 220px;
                height: 180px;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }

            .fretboard-container {
                padding: 80px 15px 20px 45px;
            }

            .fretboard {
                width: 200px;
                height: 160px;
            }

            .note-dot {
                width: 20px;
                height: 20px;
                font-size: 0.5em;
            }

            .string-label {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∏ KEYS, CODES AND MODES<br>Guitar Fretboard Explorer Pro</h1>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="scaleType">Scale Type</label>
                    <select id="scaleType">
                        <option value="major">Major Scale</option>
                        <option value="minor">Natural Minor Scale</option>
                        <option value="harmonicMinor">Harmonic Minor</option>
                        <option value="melodicMinor">Melodic Minor</option>
                        <option value="majorPentatonic">Major Pentatonic</option>
                        <option value="minorPentatonic">Minor Pentatonic</option>
                        <option value="blues">Blues Scale</option>
                        <option value="dorian">Dorian Mode</option>
                        <option value="phrygian">Phrygian Mode</option>
                        <option value="lydian">Lydian Mode</option>
                        <option value="mixolydian">Mixolydian Mode</option>
                        <option value="aeolian">Aeolian Mode</option>
                        <option value="locrian">Locrian Mode</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="rootNote">Root Note</label>
                    <select id="rootNote">
                        <option value="0" selected>E</option>
                        <option value="1">F</option>
                        <option value="2">F# / Gb</option>
                        <option value="3">G</option>
                        <option value="4">G# / Ab</option>
                        <option value="5">A</option>
                        <option value="6">A# / Bb</option>
                        <option value="7">B</option>
                        <option value="8">C</option>
                        <option value="9">C# / Db</option>
                        <option value="10">D</option>
                        <option value="11">D# / Eb</option>
                    </select>
                </div>

                <div class="control-item speed-control">
                    <label for="playSpeed">Play Speed</label>
                    <input type="range" id="playSpeed" min="200" max="1000" value="500" step="50">
                    <span id="speedValue">500ms</span>
                </div>

            <div class="chord-presets">
                <h3>üé∏ Chord Presets</h3>
                <div style="margin-bottom: 10px; color: rgba(255, 255, 255, 0.6); font-size: 0.9em;">
                    <strong>Major Chords:</strong>
                </div>
                <div class="chord-buttons" style="margin-bottom: 15px;">
                    <button class="chord-btn" data-chord="C">C</button>
                    <button class="chord-btn" data-chord="D">D</button>
                    <button class="chord-btn" data-chord="E">E</button>
                    <button class="chord-btn" data-chord="F">F</button>
                    <button class="chord-btn" data-chord="G">G</button>
                    <button class="chord-btn" data-chord="A">A</button>
                    <button class="chord-btn" data-chord="B">B</button>
                </div>
                <div style="margin-bottom: 10px; color: rgba(255, 255, 255, 0.6); font-size: 0.9em;">
                    <strong>Minor Chords:</strong>
                </div>
                <div class="chord-buttons">
                    <button class="chord-btn" data-chord="Am">Am</button>
                    <button class="chord-btn" data-chord="Bm">Bm</button>
                    <button class="chord-btn" data-chord="Cm">Cm</button>
                    <button class="chord-btn" data-chord="Dm">Dm</button>
                    <button class="chord-btn" data-chord="Em">Em</button>
                    <button class="chord-btn" data-chord="Fm">Fm</button>
                    <button class="chord-btn" data-chord="Gm">Gm</button>
                </div>
                <div class="chord-info" id="chordInfo" style="display: none;">
                    <h4 id="chordName"></h4>
                    <div class="chord-fingering" id="chordFingering"></div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="play-btn" id="playPattern">‚ñ∂ PLAY THE CORRESPONDING SCALE</button>
                    <button id="stopPattern">‚èπ Stop</button>
                    <button class="play-btn" id="playChordBtn" style="display: none;">üé∏ Play Chord</button>
                </div>
            </div>
        </div>

        <div class="fretboard-container">
            <div class="fretboard" id="fretboard">
                <div class="fret-numbers" id="fretNumbers"></div>
                <div class="string-labels" id="stringLabels"></div>
                <div class="strings" id="strings"></div>
                <div class="frets" id="frets"></div>
                <div class="fret-markers" id="fretMarkers"></div>
                <div class="notes-layer" id="notesLayer"></div>
            </div>
        </div>

        <div class="info-panel">
            <h3>üé∏ Pattern Information</h3>
            <p style="margin-bottom: 15px; color: rgba(255, 255, 255, 0.7); font-style: italic;">
                <strong>14 Chords</strong>: 7 Major + 7 Minor | <strong>5 Frets Shown</strong>
            </p>
            <div id="patternInfo" class="pattern-info"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="opacity: 1; filter: grayscale(0); box-shadow: 0 0 10px #00d4ff;"></div>
                    <span>Active Pattern Notes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="opacity: 0.25; filter: grayscale(0.5);"></div>
                    <span>Inactive Notes (Subdued)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="animation: notePulse 1s infinite;"></div>
                    <span>Currently Playing</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: rgba(0, 212, 255, 0.1); border-radius: 8px; border-left: 3px solid #00d4ff;">
                <strong style="color: #00d4ff;">Register Map:</strong> 
                <span style="font-size: 0.9em;">Strings increase in pitch LEFT‚ÜíRIGHT: 
                Low E (bass) ‚Üí A ‚Üí D ‚Üí G ‚Üí B ‚Üí High E (treble)</span>
            </div>
        </div>
    </div>

    <script>
        // Chromatic scale starting with E=0
        // E=0, F=1, F#/Gb=2, G=3, G#/Ab=4, A=5, A#/Bb=6, B=7, C=8, C#/Db=9, D=10, D#/Eb=11
        const NOTE_NAMES = ['E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B', 'C', 'Db', 'D', 'Eb'];
        const NOTE_NAMES_SHARP = ['E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C', 'C#', 'D', 'D#'];
        
        // Standard guitar tuning: E-A-D-G-B-E (pitch classes starting from E=0)
        // String intervals: E‚ÜíA(+5), A‚ÜíD(+5), D‚ÜíG(+5), G‚ÜíB(+4), B‚ÜíE(+5)
        const GUITAR_TUNING = [0, 5, 10, 3, 7, 0]; // Low E to High E
        const TUNING_NAMES = ['E', 'A', 'D', 'G', 'B', 'E'];
        const NUM_FRETS = 5;
        const NUM_STRINGS = 6;
        
        // REGISTER MAPPING - Absolute pitch heights from lowest to highest
        // String 0 (Low E):  Pitch 0  - LOWEST (Bass)
        // String 1 (A):      Pitch 5  - (+5 semitones)
        // String 2 (D):      Pitch 10 - (+10 semitones)
        // String 3 (G):      Pitch 15 - (+15 semitones)
        // String 4 (B):      Pitch 19 - (+19 semitones, only +4 from G)
        // String 5 (High E): Pitch 24 - HIGHEST (Treble, +2 octaves from Low E)

        // Scale interval patterns (in semitones)
        const SCALE_PATTERNS = {
            major: [2, 2, 1, 2, 2, 2, 1],
            minor: [2, 1, 2, 2, 1, 2, 2],
            harmonicMinor: [2, 1, 2, 2, 1, 3, 1],
            melodicMinor: [2, 1, 2, 2, 2, 2, 1],
            majorPentatonic: [2, 2, 3, 2, 3],
            minorPentatonic: [3, 2, 2, 3, 2],
            blues: [3, 2, 1, 1, 3, 2],
            dorian: [2, 1, 2, 2, 2, 1, 2],
            phrygian: [1, 2, 2, 2, 1, 2, 2],
            lydian: [2, 2, 2, 1, 2, 2, 1],
            mixolydian: [2, 2, 1, 2, 2, 1, 2],
            aeolian: [2, 1, 2, 2, 1, 2, 2],
            locrian: [1, 2, 2, 1, 2, 2, 2]
        };

        // Chord fingering patterns
        const CHORD_PATTERNS = {
            'C': {
                name: 'C Major',
                fingering: [
                    { string: 0, fret: 0, note: 'E' },   // Low E - OPEN
                    { string: 1, fret: 3, note: 'C' },   // A string, 3rd fret
                    { string: 2, fret: 2, note: 'E' },   // D string, 2nd fret
                    { string: 3, fret: 0, note: 'G' },   // G string, open
                    { string: 4, fret: 1, note: 'C' },   // B string, 1st fret
                    { string: 5, fret: 0, note: 'E' }    // High E, open
                ],
                notes: [8, 0, 3] // C, E, G
            },
            'G': {
                name: 'G Major',
                fingering: [
                    { string: 0, fret: 3, note: 'G' },
                    { string: 1, fret: 2, note: 'B' },
                    { string: 2, fret: 0, note: 'D' },
                    { string: 3, fret: 0, note: 'G' },
                    { string: 4, fret: 0, note: 'B' },
                    { string: 5, fret: 3, note: 'G' }
                ],
                notes: [3, 7, 10] // G, B, D
            },
            'D': {
                name: 'D Major',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },
                    { string: 1, fret: -1, note: 'X' },
                    { string: 2, fret: 0, note: 'D' },
                    { string: 3, fret: 2, note: 'A' },
                    { string: 4, fret: 3, note: 'D' },
                    { string: 5, fret: 2, note: 'F#' }
                ],
                notes: [10, 2, 5] // D, F#, A
            },
            'A': {
                name: 'A Major',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },
                    { string: 1, fret: 0, note: 'A' },
                    { string: 2, fret: 2, note: 'E' },
                    { string: 3, fret: 2, note: 'A' },
                    { string: 4, fret: 2, note: 'C#' },
                    { string: 5, fret: 0, note: 'E' }
                ],
                notes: [5, 9, 0] // A, C#, E
            },
            'E': {
                name: 'E Major',
                fingering: [
                    { string: 0, fret: 0, note: 'E' },
                    { string: 1, fret: 2, note: 'B' },
                    { string: 2, fret: 2, note: 'E' },
                    { string: 3, fret: 1, note: 'G#' },
                    { string: 4, fret: 0, note: 'B' },
                    { string: 5, fret: 0, note: 'E' }
                ],
                notes: [0, 4, 7] // E, G#, B
            },
            'Am': {
                name: 'A Minor',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },  // Low E - muted
                    { string: 1, fret: 0, note: 'A' },   // A string, open
                    { string: 2, fret: 2, note: 'E' },   // D string, 2nd fret
                    { string: 3, fret: 2, note: 'A' },   // G string, 2nd fret
                    { string: 4, fret: 1, note: 'C' },   // B string, 1st fret
                    { string: 5, fret: 0, note: 'E' }    // High E, open
                ],
                notes: [5, 8, 0] // A, C, E
            },
            'Em': {
                name: 'E Minor',
                fingering: [
                    { string: 0, fret: 0, note: 'E' },
                    { string: 1, fret: 2, note: 'B' },
                    { string: 2, fret: 2, note: 'E' },
                    { string: 3, fret: 0, note: 'G' },
                    { string: 4, fret: 0, note: 'B' },
                    { string: 5, fret: 0, note: 'E' }
                ],
                notes: [0, 3, 7] // E, G, B
            },
            'Dm': {
                name: 'D Minor',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },
                    { string: 1, fret: -1, note: 'X' },
                    { string: 2, fret: 0, note: 'D' },
                    { string: 3, fret: 2, note: 'A' },
                    { string: 4, fret: 3, note: 'D' },
                    { string: 5, fret: 1, note: 'F' }
                ],
                notes: [10, 1, 5] // D, F, A
            },
            'F': {
                name: 'F Major',
                fingering: [
                    { string: 0, fret: 1, note: 'F' },   // Low E, 1st fret
                    { string: 1, fret: 3, note: 'C' },   // A string, 3rd fret
                    { string: 2, fret: 3, note: 'F' },   // D string, 3rd fret
                    { string: 3, fret: 2, note: 'A' },   // G string, 2nd fret
                    { string: 4, fret: 1, note: 'C' },   // B string, 1st fret
                    { string: 5, fret: 1, note: 'F' }    // High E, 1st fret
                ],
                notes: [1, 5, 8] // F, A, C
            },
            'B': {
                name: 'B Major',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },  // Low E - muted
                    { string: 1, fret: 2, note: 'B' },   // A string, 2nd fret
                    { string: 2, fret: 4, note: 'F#' },  // D string, 4th fret
                    { string: 3, fret: 4, note: 'B' },   // G string, 4th fret
                    { string: 4, fret: 4, note: 'D#' },  // B string, 4th fret
                    { string: 5, fret: 2, note: 'F#' }   // High E, 2nd fret
                ],
                notes: [7, 11, 2] // B, D#, F#
            },
            'Bm': {
                name: 'B Minor',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },  // Low E - muted
                    { string: 1, fret: 2, note: 'B' },   // A string, 2nd fret
                    { string: 2, fret: 4, note: 'F#' },  // D string, 4th fret
                    { string: 3, fret: 4, note: 'B' },   // G string, 4th fret
                    { string: 4, fret: 3, note: 'D' },   // B string, 3rd fret
                    { string: 5, fret: 2, note: 'F#' }   // High E, 2nd fret
                ],
                notes: [7, 10, 2] // B, D, F#
            },
            'Cm': {
                name: 'C Minor',
                fingering: [
                    { string: 0, fret: -1, note: 'X' },
                    { string: 1, fret: 3, note: 'C' },
                    { string: 2, fret: 5, note: 'G' },
                    { string: 3, fret: 5, note: 'C' },
                    { string: 4, fret: 4, note: 'Eb' },
                    { string: 5, fret: 3, note: 'G' }
                ],
                notes: [8, 11, 3] // C, Eb, G
            },
            'Fm': {
                name: 'F Minor',
                fingering: [
                    { string: 0, fret: 1, note: 'F' },
                    { string: 1, fret: 3, note: 'C' },
                    { string: 2, fret: 3, note: 'F' },
                    { string: 3, fret: 1, note: 'Ab' },
                    { string: 4, fret: 1, note: 'C' },
                    { string: 5, fret: 1, note: 'F' }
                ],
                notes: [1, 4, 8] // F, Ab, C
            },
            'Gm': {
                name: 'G Minor',
                fingering: [
                    { string: 0, fret: 3, note: 'G' },
                    { string: 1, fret: 5, note: 'D' },
                    { string: 2, fret: 5, note: 'G' },
                    { string: 3, fret: 3, note: 'Bb' },
                    { string: 4, fret: 3, note: 'D' },
                    { string: 5, fret: 3, note: 'G' }
                ],
                notes: [3, 6, 10] // G, Bb, D
            }
        };

        // Audio context for playing notes
        let audioContext = null;
        let currentPlayback = null;

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play a note with given frequency
        function playNote(frequency, duration = 0.5) {
            if (!audioContext) initAudio();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            return oscillator;
        }

        // Convert pitch class and octave to frequency
        function pitchToFrequency(pitchClass, octave) {
            const A4 = 440;
            const semitoneFromA4 = (octave - 4) * 12 + (pitchClass - 9);
            return A4 * Math.pow(2, semitoneFromA4 / 12);
        }

        // Get note frequency from string and fret
        function getNoteFrequency(string, fret) {
            const basePitch = GUITAR_TUNING[string];
            const pitchClass = (basePitch + fret) % 12;
            
            // Calculate octave
            let octave = 2;
            if (string === 0) octave = 2;
            else if (string === 1) octave = 2;
            else if (string === 2) octave = 3;
            else if (string === 3) octave = 3;
            else if (string === 4) octave = 3;
            else if (string === 5) octave = 4;
            
            octave += Math.floor((basePitch + fret) / 12);
            
            return pitchToFrequency(pitchClass, octave);
        }

        // Generate scale notes from root and pattern
        function generateScale(rootNote, pattern) {
            const scale = [rootNote];
            let currentNote = rootNote;
            
            for (const interval of pattern) {
                currentNote = (currentNote + interval) % 12;
                scale.push(currentNote);
            }
            
            return scale;
        }

        // Generate guitar fingering pattern - SMOOTH ASCENDING (prefer open strings/low frets)
        // VISUAL LAYOUT: Bass (LOW) on LEFT ‚Üê ‚Üí Treble (HIGH) on RIGHT
        function generateGuitarPattern(rootNote, scaleNotes) {
            const pattern = [];
            
            // String pitch offsets - INCREASES LEFT TO RIGHT (bass to treble)
            const stringBasePitch = [
                0,   // String 0: Low E (LEFTMOST - BASS - LOWEST PITCH)
                5,   // String 1: A (5 semitones higher)
                10,  // String 2: D (10 semitones higher)
                15,  // String 3: G (15 semitones higher)
                19,  // String 4: B (19 semitones higher - only 4 semitones from G)
                24   // String 5: High E (RIGHTMOST - TREBLE - HIGHEST PITCH)
            ];
            
            const MAX_FRET_ON_STRING = 4; // NEVER use fret 5 - move to next string instead
            
            // ASCENDING: Start low, go high
            let currentPitch = -1;
            
            // Find starting position - PREFER OPEN STRING if root note matches
            let startString = -1;
            let startFret = -1;
            let startPitch = Infinity;
            
            // FIRST: Check if root note matches any open string (fret 0)
            for (let string = 0; string < NUM_STRINGS; string++) {
                const notePitch = GUITAR_TUNING[string];
                if (notePitch === rootNote) {
                    const absolutePitch = stringBasePitch[string];
                    // Prefer the LOWEST open string that matches
                    if (absolutePitch < startPitch) {
                        startPitch = absolutePitch;
                        startString = string;
                        startFret = 0;
                    }
                }
            }
            
            // SECOND: If no open string matches, find lowest occurrence
            if (startString === -1) {
                for (let string = 0; string < NUM_STRINGS; string++) {
                    for (let fret = 1; fret <= MAX_FRET_ON_STRING; fret++) {
                        const notePitch = (GUITAR_TUNING[string] + fret) % 12;
                        if (notePitch === rootNote) {
                            const absolutePitch = stringBasePitch[string] + fret;
                            if (absolutePitch < startPitch) {
                                startPitch = absolutePitch;
                                startString = string;
                                startFret = fret;
                            }
                        }
                    }
                }
            }
            
            if (startString === -1) return pattern;
            
            console.log(`Starting scale on String ${startString} (${['E','A','D','G','B','E'][startString]}) Fret ${startFret}`);
            
            // Add root note
            pattern.push({
                string: startString,
                fret: startFret,
                note: rootNote,
                interval: 0
            });
            currentPitch = startPitch;
            let currentString = startString;
            
            // For each subsequent note in scale
            for (let i = 1; i < scaleNotes.length; i++) {
                const targetNote = scaleNotes[i];
                let found = false;
                let bestString = -1;
                let bestFret = -1;
                let bestPitch = Infinity;
                
                // STRATEGY: Try next string FIRST (prefer open string)
                // Then try current string if next string doesn't work
                
                // FIRST: Try NEXT STRING - prefer open/low frets
                if (currentString < NUM_STRINGS - 1) {
                    const nextString = currentString + 1;
                    for (let fret = 0; fret <= MAX_FRET_ON_STRING; fret++) {
                        const notePitch = (GUITAR_TUNING[nextString] + fret) % 12;
                        
                        if (notePitch === targetNote) {
                            const absolutePitch = stringBasePitch[nextString] + fret;
                            
                            // Take next string if it's higher than current pitch
                            if (absolutePitch > currentPitch) {
                                bestPitch = absolutePitch;
                                bestString = nextString;
                                bestFret = fret;
                                found = true;
                                break; // Take first valid on next string (prefer open)
                            }
                        }
                    }
                }
                
                // SECOND: If next string didn't work, try current string (up to fret 4 only)
                if (!found) {
                    for (let fret = 0; fret <= MAX_FRET_ON_STRING; fret++) {
                        const notePitch = (GUITAR_TUNING[currentString] + fret) % 12;
                        
                        if (notePitch === targetNote) {
                            const absolutePitch = stringBasePitch[currentString] + fret;
                            
                            if (absolutePitch > currentPitch && absolutePitch < bestPitch) {
                                bestPitch = absolutePitch;
                                bestString = currentString;
                                bestFret = fret;
                                found = true;
                            }
                        }
                    }
                }
                
                // THIRD: If still not found, search all remaining strings
                if (!found) {
                    for (let string = currentString + 1; string < NUM_STRINGS; string++) {
                        for (let fret = 0; fret <= MAX_FRET_ON_STRING; fret++) {
                            const notePitch = (GUITAR_TUNING[string] + fret) % 12;
                            
                            if (notePitch === targetNote) {
                                const absolutePitch = stringBasePitch[string] + fret;
                                
                                if (absolutePitch > currentPitch && absolutePitch < bestPitch) {
                                    bestPitch = absolutePitch;
                                    bestString = string;
                                    bestFret = fret;
                                    found = true;
                                }
                            }
                        }
                    }
                }
                
                if (found) {
                    const prevNote = scaleNotes[i - 1];
                    let interval = (targetNote - prevNote + 12) % 12;
                    
                    pattern.push({
                        string: bestString,
                        fret: bestFret,
                        note: targetNote,
                        interval: interval
                    });
                    currentPitch = bestPitch;
                    currentString = bestString;
                }
            }
            
            // DESCENDING: Go back down
            for (let i = scaleNotes.length - 2; i >= 0; i--) {
                const targetNote = scaleNotes[i];
                let found = false;
                let bestString = -1;
                let bestFret = -1;
                let bestPitch = -1;
                
                for (let string = 0; string < NUM_STRINGS; string++) {
                    for (let fret = 0; fret <= MAX_FRET_ON_STRING; fret++) {
                        const notePitch = (GUITAR_TUNING[string] + fret) % 12;
                        
                        if (notePitch === targetNote) {
                            const absolutePitch = stringBasePitch[string] + fret;
                            
                            if (absolutePitch < currentPitch && absolutePitch > bestPitch) {
                                bestPitch = absolutePitch;
                                bestString = string;
                                bestFret = fret;
                                found = true;
                            }
                        }
                    }
                }
                
                if (found) {
                    const nextNote = scaleNotes[i + 1];
                    let interval = (nextNote - targetNote + 12) % 12;
                    
                    pattern.push({
                        string: bestString,
                        fret: bestFret,
                        note: targetNote,
                        interval: interval
                    });
                    currentPitch = bestPitch;
                    currentString = bestString;
                }
            }
            
            return pattern;
        }

        // Initialize fretboard display
        function initFretboard() {
            const strings = document.getElementById('strings');
            const frets = document.getElementById('frets');
            const fretMarkers = document.getElementById('fretMarkers');
            const stringLabels = document.getElementById('stringLabels');
            const fretNumbers = document.getElementById('fretNumbers');
            
            for (let i = 0; i < NUM_STRINGS; i++) {
                const string = document.createElement('div');
                string.className = 'string';
                strings.appendChild(string);
            }
            
            TUNING_NAMES.forEach((name, index) => {
                const label = document.createElement('div');
                label.className = 'string-label';
                label.textContent = name;
                label.id = `string-label-${index}`;
                stringLabels.appendChild(label);
            });
            
            for (let i = 0; i <= NUM_FRETS; i++) {
                const fretNum = document.createElement('div');
                fretNum.className = 'fret-number';
                fretNum.textContent = i;
                // Position fret numbers in the center of fret spaces
                if (i === 0) {
                    fretNum.style.top = '-2%';
                } else {
                    // Center in the space: (i - 0.5) / NUM_FRETS * 100
                    fretNum.style.top = `${((i - 0.5) / NUM_FRETS) * 100}%`;
                }
                fretNumbers.appendChild(fretNum);
            }
            
            for (let i = 0; i <= NUM_FRETS; i++) {
                const fret = document.createElement('div');
                fret.className = 'fret';
                frets.appendChild(fret);
            }
            
            const markerFrets = [3, 5];
            const doubleMarkerFrets = [];
            
            markerFrets.forEach(fretNum => {
                if (doubleMarkerFrets.includes(fretNum)) {
                    const marker1 = document.createElement('div');
                    marker1.className = 'fret-marker';
                    marker1.style.top = `${((2 * fretNum - 1) / (2 * NUM_FRETS)) * 100}%`;
                    marker1.style.left = '35%';
                    fretMarkers.appendChild(marker1);
                    
                    const marker2 = document.createElement('div');
                    marker2.className = 'fret-marker';
                    marker2.style.top = `${((2 * fretNum - 1) / (2 * NUM_FRETS)) * 100}%`;
                    marker2.style.left = '65%';
                    fretMarkers.appendChild(marker2);
                } else {
                    const marker = document.createElement('div');
                    marker.className = 'fret-marker';
                    marker.style.top = `${((2 * fretNum - 1) / (2 * NUM_FRETS)) * 100}%`;
                    marker.style.left = '50%';
                    fretMarkers.appendChild(marker);
                }
            });
        }

        // Update fretboard display
        function updateFretboard() {
            const rootNote = parseInt(document.getElementById('rootNote').value);
            const scaleType = document.getElementById('scaleType').value;
            const pattern = SCALE_PATTERNS[scaleType];
            
            const scaleNotes = generateScale(rootNote, pattern);
            const guitarPattern = generateGuitarPattern(rootNote, scaleNotes);
            
            window.currentPattern = guitarPattern;
            
            const notesLayer = document.getElementById('notesLayer');
            notesLayer.innerHTML = '';
            
            for (let i = 0; i < NUM_STRINGS; i++) {
                const label = document.getElementById(`string-label-${i}`);
                label.classList.remove('active');
                label.style.color = '';
                label.style.textShadow = '';
            }
            
            const patternPositions = new Set();
            guitarPattern.forEach(p => {
                patternPositions.add(`${p.string}-${p.fret}`);
            });
            
            for (let string = 0; string < NUM_STRINGS; string++) {
                for (let fret = 0; fret <= NUM_FRETS; fret++) {
                    const notePitch = (GUITAR_TUNING[string] + fret) % 12;
                    
                    if (scaleNotes.includes(notePitch)) {
                        const noteDot = document.createElement('div');
                        noteDot.className = `note-dot note-${NOTE_NAMES[notePitch].replace('#', 'b')}`;
                        
                        const stringPositions = [20, 32, 44, 56, 68, 80];
                        const stringPos = stringPositions[string];
                        
                        let fretPos;
                        if (fret === 0) {
                            fretPos = -1.5; // Open string at nut
                        } else {
                            // Center notes in fret spaces: between fret wires
                            fretPos = ((2 * fret - 1) / (2 * NUM_FRETS)) * 100;
                        }
                        
                        noteDot.style.left = `${stringPos}%`;
                        noteDot.style.top = `${fretPos}%`;
                        
                        const posKey = `${string}-${fret}`;
                        if (patternPositions.has(posKey)) {
                            noteDot.classList.add('in-pattern');
                            
                            const label = document.getElementById(`string-label-${string}`);
                            label.classList.add('active');
                            label.style.color = getComputedStyle(noteDot).backgroundColor;
                            label.style.textShadow = `0 0 15px ${getComputedStyle(noteDot).backgroundColor}`;
                        }
                        
                        noteDot.textContent = NOTE_NAMES_SHARP[notePitch];
                        
                        noteDot.addEventListener('click', () => {
                            const freq = getNoteFrequency(string, fret);
                            playNote(freq);
                            
                            noteDot.classList.add('playing');
                            setTimeout(() => {
                                noteDot.classList.remove('playing');
                            }, 500);
                        });
                        
                        noteDot.dataset.string = string;
                        noteDot.dataset.fret = fret;
                        noteDot.dataset.note = notePitch;
                        
                        notesLayer.appendChild(noteDot);
                    }
                }
            }
            
            updatePatternInfo(guitarPattern, scaleNotes);
        }

        // Update pattern information display
        function updatePatternInfo(pattern, scaleNotes) {
            const patternInfo = document.getElementById('patternInfo');
            patternInfo.innerHTML = '';
            
            if (pattern.length === 0) {
                patternInfo.innerHTML = '<div style="color: rgba(255, 100, 100, 0.8);">No pattern generated. Try selecting a different root note or scale type.</div>';
                return;
            }
            
            const infoHeader = document.createElement('div');
            infoHeader.style.marginBottom = '10px';
            infoHeader.style.color = 'rgba(0, 212, 255, 0.9)';
            infoHeader.style.fontWeight = 'bold';
            infoHeader.innerHTML = `‚úì Scale Pattern Ready: ${pattern.length} notes (Ascending ‚Üó + Descending ‚Üò)`;
            patternInfo.appendChild(infoHeader);
            
            const stringNames = ['Low E', 'A', 'D', 'G', 'B', 'High E'];
            const stringBasePitch = [0, 5, 10, 15, 19, 24];
            
            // Calculate turnaround point (where ascending ends)
            const turnaroundPoint = scaleNotes.length;
            
            // Debug: Log pattern to console AND track D string usage
            console.log('\n=== SCALE PATTERN DEBUG ===');
            console.log('Scale notes (pitch classes):', scaleNotes.map(n => NOTE_NAMES_SHARP[n]).join('-'));
            
            let dStringUsed = false;
            let dStringNotes = [];
            
            pattern.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'pattern-step';
                
                // Calculate absolute pitch for verification
                const absPitch = stringBasePitch[step.string] + step.fret;
                
                // Track D string usage
                if (step.string === 2) {
                    dStringUsed = true;
                    dStringNotes.push(`${NOTE_NAMES_SHARP[step.note]} (fret ${step.fret})`);
                }
                
                // Mark ascending vs descending
                let direction = '';
                if (index === 0) {
                    direction = '‚Üó ASCENDING: ';
                } else if (index === turnaroundPoint) {
                    direction = '‚Üò DESCENDING: ';
                } else {
                    direction = '';
                }
                
                // Highlight D string in display
                let stringDisplay = stringNames[step.string];
                if (step.string === 2) {
                    stringDisplay = `<strong style="color: #00FF80;">${stringDisplay}</strong>`;
                }
                
                stepDiv.innerHTML = `${direction}${index + 1}. ${stringDisplay} - Fret ${step.fret} - ${NOTE_NAMES_SHARP[step.note]} (pitch: ${absPitch})`;
                if (index > 0 && index < turnaroundPoint) {
                    const prevStep = pattern[index - 1];
                    const prevAbsPitch = stringBasePitch[prevStep.string] + prevStep.fret;
                    const pitchDiff = absPitch - prevAbsPitch;
                    stepDiv.innerHTML += ` [+${pitchDiff}]`;
                }
                
                // Style the turnaround point
                if (index === turnaroundPoint) {
                    stepDiv.style.borderTop = '2px solid rgba(0, 212, 255, 0.5)';
                    stepDiv.style.paddingTop = '8px';
                    stepDiv.style.marginTop = '8px';
                }
                
                // Console debug
                if (index < turnaroundPoint) {
                    console.log(`${index + 1}. String ${step.string} (${stringNames[step.string]}) Fret ${step.fret} = ${NOTE_NAMES_SHARP[step.note]} (abs pitch: ${absPitch})`);
                }
                
                patternInfo.appendChild(stepDiv);
            });
            
            console.log(`\n*** D STRING USAGE: ${dStringUsed ? 'YES' : 'NO'} ***`);
            if (dStringUsed) {
                console.log('D string notes used:', dStringNotes.join(', '));
            }
            console.log('=== END PATTERN DEBUG ===\n');
            
            // Add D string warning if not used
            if (!dStringUsed && scaleNotes.length >= 6) {
                const warning = document.createElement('div');
                warning.style.marginTop = '10px';
                warning.style.padding = '10px';
                warning.style.background = 'rgba(255, 200, 0, 0.2)';
                warning.style.border = '2px solid rgba(255, 200, 0, 0.5)';
                warning.style.borderRadius = '5px';
                warning.style.color = 'rgba(255, 200, 0, 0.9)';
                warning.innerHTML = '‚ö†Ô∏è NOTE: D string (String 2) not used in this pattern';
                patternInfo.appendChild(warning);
            }
        }

        // Display chord on fretboard
        function displayChord(chordKey) {
            const chord = CHORD_PATTERNS[chordKey];
            if (!chord) return;

            window.currentChord = chord;
            
            const notesLayer = document.getElementById('notesLayer');
            notesLayer.innerHTML = '';
            
            for (let i = 0; i < NUM_STRINGS; i++) {
                const label = document.getElementById(`string-label-${i}`);
                label.classList.remove('active');
                label.style.color = '';
                label.style.textShadow = '';
            }
            
            for (let string = 0; string < NUM_STRINGS; string++) {
                for (let fret = 0; fret <= NUM_FRETS; fret++) {
                    const notePitch = (GUITAR_TUNING[string] + fret) % 12;
                    
                    if (chord.notes.includes(notePitch)) {
                        const noteDot = document.createElement('div');
                        noteDot.className = `note-dot note-${NOTE_NAMES[notePitch].replace('#', 'b')}`;
                        
                        const stringPositions = [20, 32, 44, 56, 68, 80];
                        const stringPos = stringPositions[string];
                        
                        let fretPos;
                        if (fret === 0) {
                            fretPos = -1.5; // Open string at nut
                        } else {
                            // Center notes in fret spaces: between fret wires
                            fretPos = ((2 * fret - 1) / (2 * NUM_FRETS)) * 100;
                        }
                        
                        noteDot.style.left = `${stringPos}%`;
                        noteDot.style.top = `${fretPos}%`;
                        
                        const fingerPos = chord.fingering.find(f => f.string === string && f.fret === fret);
                        
                        if (fingerPos) {
                            noteDot.classList.add('in-pattern');
                            
                            const label = document.getElementById(`string-label-${string}`);
                            label.classList.add('active');
                            label.style.color = getComputedStyle(noteDot).backgroundColor;
                            label.style.textShadow = `0 0 15px ${getComputedStyle(noteDot).backgroundColor}`;
                        }
                        
                        noteDot.textContent = NOTE_NAMES_SHARP[notePitch];
                        
                        noteDot.addEventListener('click', () => {
                            const freq = getNoteFrequency(string, fret);
                            playNote(freq);
                            
                            noteDot.classList.add('playing');
                            setTimeout(() => {
                                noteDot.classList.remove('playing');
                            }, 500);
                        });
                        
                        noteDot.dataset.string = string;
                        noteDot.dataset.fret = fret;
                        noteDot.dataset.note = notePitch;
                        
                        notesLayer.appendChild(noteDot);
                    }
                }
            }
            
            chord.fingering.forEach(pos => {
                if (pos.fret === -1) {
                    const stringPositions = [20, 32, 44, 56, 68, 80];
                    const mutedIndicator = document.createElement('div');
                    mutedIndicator.className = 'note-dot';
                    mutedIndicator.style.left = `${stringPositions[pos.string]}%`;
                    mutedIndicator.style.top = '-1.5%'; // Moved up 3/8 inch higher
                    mutedIndicator.style.background = 'rgba(255, 0, 0, 0.5)';
                    mutedIndicator.style.opacity = '0.6';
                    mutedIndicator.textContent = 'X';
                    mutedIndicator.style.filter = 'none';
                    notesLayer.appendChild(mutedIndicator);
                }
            });
            
            updateChordInfo(chord);
        }

        // Update chord information display
        function updateChordInfo(chord) {
            const chordInfo = document.getElementById('chordInfo');
            const chordName = document.getElementById('chordName');
            const chordFingering = document.getElementById('chordFingering');
            
            chordInfo.style.display = 'block';
            chordName.textContent = chord.name;
            chordFingering.innerHTML = '';
            
            const stringNames = ['E (Bass)', 'A', 'D', 'G', 'B', 'E (Treble)'];
            
            chord.fingering.forEach((pos, index) => {
                const fingerDiv = document.createElement('div');
                if (pos.fret === -1) {
                    fingerDiv.textContent = `${stringNames[pos.string]}: X (muted)`;
                    fingerDiv.style.color = '#ff6666';
                } else {
                    fingerDiv.textContent = `${stringNames[pos.string]}: Fret ${pos.fret} (${pos.note})`;
                }
                chordFingering.appendChild(fingerDiv);
            });
        }

        // Play chord
        async function playChord() {
            if (!window.currentChord) return;
            
            const chord = window.currentChord;
            const strumDelay = 50;
            
            for (let i = 0; i < chord.fingering.length; i++) {
                const pos = chord.fingering[i];
                
                if (pos.fret !== -1) {
                    const noteDot = document.querySelector(
                        `.note-dot[data-string="${pos.string}"][data-fret="${pos.fret}"]`
                    );
                    
                    if (noteDot) {
                        noteDot.classList.add('playing');
                        const freq = getNoteFrequency(pos.string, pos.fret);
                        playNote(freq, 1.5);
                        
                        setTimeout(() => {
                            noteDot.classList.remove('playing');
                        }, 500);
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, strumDelay));
            }
        }

        // Play pattern function
        async function playPattern() {
            if (!window.currentPattern || window.currentPattern.length === 0) return;
            
            const playBtn = document.getElementById('playPattern');
            const stopBtn = document.getElementById('stopPattern');
            playBtn.disabled = true;
            stopBtn.disabled = false;
            
            const speed = parseInt(document.getElementById('playSpeed').value);
            
            for (let i = 0; i < window.currentPattern.length; i++) {
                if (!window.isPlayingPattern) break;
                
                const step = window.currentPattern[i];
                const noteDot = document.querySelector(
                    `.note-dot[data-string="${step.string}"][data-fret="${step.fret}"]`
                );
                
                if (noteDot) {
                    noteDot.classList.add('playing');
                    const freq = getNoteFrequency(step.string, step.fret);
                    playNote(freq, speed / 1000);
                    
                    await new Promise(resolve => setTimeout(resolve, speed));
                    noteDot.classList.remove('playing');
                }
            }
            
            window.isPlayingPattern = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // VERIFY REGISTER MAPPING - Console output for debugging
            console.log('=== GUITAR FRETBOARD REGISTER VERIFICATION ===');
            console.log('Chromatic Order: E=0, F=1, F#=2, G=3, G#=4, A=5, A#=6, B=7, C=8, C#=9, D=10, D#=11');
            console.log('\nString Tuning (open strings):');
            TUNING_NAMES.forEach((name, idx) => {
                const pitchClass = GUITAR_TUNING[idx];
                const basePitch = [0, 5, 10, 15, 19, 24][idx];
                console.log(`  String ${idx}: ${name} (pitch class: ${pitchClass}, absolute pitch: ${basePitch} semitones from Low E)`);
            });
            
            console.log('\n*** D STRING DETAILED CHECK (String 2) ***');
            console.log('D string tuning value: GUITAR_TUNING[2] =', GUITAR_TUNING[2]);
            console.log('Expected: 10 (which is D in E-based chromatic)');
            console.log('D string absolute pitch base: 10 semitones from Low E');
            console.log('\nD String Notes (Frets 0-5):');
            for (let fret = 0; fret <= 5; fret++) {
                const notePitch = (GUITAR_TUNING[2] + fret) % 12;
                const absolutePitch = 10 + fret; // D string base is 10
                console.log(`  Fret ${fret}: ${NOTE_NAMES_SHARP[notePitch]} (pitch class: ${notePitch}, absolute pitch: ${absolutePitch})`);
            }
            
            console.log('\nFull Fretboard Map (All strings, All 5 frets):');
            for (let string = 0; string < NUM_STRINGS; string++) {
                let row = `String ${string} (${TUNING_NAMES[string]}): `;
                for (let fret = 0; fret <= 5; fret++) {
                    const notePitch = (GUITAR_TUNING[string] + fret) % 12;
                    row += `[Fret ${fret}: ${NOTE_NAMES_SHARP[notePitch]}] `;
                }
                console.log(row);
                if (string === 2) {
                    console.log('  ^^^ D STRING - Should be: D, D#, E, F, F#, G ^^^');
                }
            }
            console.log('=== END VERIFICATION ===\n');
            
            initFretboard();
            updateFretboard();
            
            document.getElementById('playSpeed').addEventListener('input', (e) => {
                document.getElementById('speedValue').textContent = `${e.target.value}ms`;
            });
            
            document.getElementById('playPattern').addEventListener('click', () => {
                window.isPlayingPattern = true;
                playPattern();
            });
            
            document.getElementById('stopPattern').addEventListener('click', () => {
                window.isPlayingPattern = false;
                document.getElementById('playPattern').disabled = false;
                document.getElementById('stopPattern').disabled = true;
            });

            const chordButtons = document.querySelectorAll('.chord-btn');
            const playChordBtn = document.getElementById('playChordBtn');
            
            chordButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const chordKey = btn.dataset.chord;
                    
                    chordButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Map chord to root note (chromatic order starting with E=0)
                    const chordToRoot = {
                        'C': 8, 'D': 10, 'E': 0, 'F': 1, 'G': 3, 'A': 5, 'B': 7,
                        'Am': 5, 'Bm': 7, 'Cm': 8, 'Dm': 10, 'Em': 0, 'Fm': 1, 'Gm': 3
                    };
                    
                    // Determine if major or minor
                    const isMajor = !chordKey.includes('m');
                    const scaleType = isMajor ? 'major' : 'minor';
                    
                    // Set the scale controls
                    document.getElementById('scaleType').value = scaleType;
                    document.getElementById('rootNote').value = chordToRoot[chordKey];
                    
                    // Update the fretboard with the scale pattern - this generates the pattern
                    updateFretboard();
                    
                    // Store the chord for playing
                    window.currentChord = CHORD_PATTERNS[chordKey];
                    
                    // Show chord info
                    const chordInfo = document.getElementById('chordInfo');
                    const chordName = document.getElementById('chordName');
                    const chordFingering = document.getElementById('chordFingering');
                    
                    chordName.textContent = CHORD_PATTERNS[chordKey].name;
                    chordFingering.innerHTML = '';
                    
                    CHORD_PATTERNS[chordKey].fingering.forEach(pos => {
                        if (pos.fret !== -1) {
                            const fingerDiv = document.createElement('div');
                            fingerDiv.textContent = `String ${pos.string + 1}: Fret ${pos.fret} (${pos.note})`;
                            chordFingering.appendChild(fingerDiv);
                        }
                    });
                    
                    chordInfo.style.display = 'block';
                    playChordBtn.style.display = 'block';
                    
                    // Play the chord
                    setTimeout(() => playChord(), 100);
                });
            });

            playChordBtn.addEventListener('click', () => {
                if (window.currentChord) {
                    playChord();
                }
            });

            document.getElementById('scaleType').addEventListener('change', () => {
                playChordBtn.style.display = 'none';
                chordButtons.forEach(b => b.classList.remove('active'));
                document.getElementById('chordInfo').style.display = 'none';
                updateFretboard();
            });

            document.getElementById('rootNote').addEventListener('change', () => {
                playChordBtn.style.display = 'none';
                chordButtons.forEach(b => b.classList.remove('active'));
                document.getElementById('chordInfo').style.display = 'none';
                updateFretboard();
            });
        });
    </script>
</body>
</html>