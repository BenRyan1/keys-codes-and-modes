<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- SEO Meta Tags -->
    <title>Chladni Plate Cymatics Visualizer | Interactive Sound & Music Theory | Keys, Codes & Modes</title>
    <meta name="description" content="Experience the beauty of sound with our interactive Chladni Plate Cymatics Visualizer. Watch 10,000+ particles form stunning geometric patterns as sound frequencies create visual art. Explore music theory, intervals, chords, and harmony through real-time physics simulation. Perfect for musicians, educators, students, and sound enthusiasts.">
    <meta name="keywords" content="chladni plate, cymatics, sound visualization, music theory visualizer, interactive music education, frequency patterns, sound geometry, harmonic patterns, music intervals, chord visualizer, MIDI keyboard, physics of sound, cymatic patterns, standing waves, nodal patterns, music education tool, visual learning music, sound waves, acoustic physics, music theory app, interactive sound art, frequency visualization, harmonic resonance, sacred geometry, sound design tool, audio visualization, music teacher resources, stem education, physics demonstration, ben ryan, keys codes modes">
    <meta name="author" content="Ben Ryan, Keys Codes & Modes">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <meta name="category" content="Music Education, Science, Technology, Interactive Learning">
    
    <!-- Open Graph Meta Tags (Facebook, LinkedIn) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Chladni Plate Cymatics Visualizer | Keys, Codes & Modes">
    <meta property="og:description" content="Interactive cymatics visualizer showing how sound frequencies create geometric patterns. 10,000+ particles, MIDI support, extended chords, real-time physics simulation.">
    <meta property="og:url" content="https://keyscodesandmodes.com/chladni-visualizer">
    <meta property="og:site_name" content="Keys, Codes & Modes">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Chladni Plate Cymatics Visualizer | Interactive Sound & Music">
    <meta name="twitter:description" content="Watch sound create art. Interactive cymatics with MIDI, extended chords, real-time physics simulation.">
    <meta name="twitter:creator" content="@keyscodesandmodes">
    
    <!-- Additional SEO -->
    <meta name="application-name" content="Chladni Plate Visualizer">
    <meta name="apple-mobile-web-app-title" content="Cymatics">
    <link rel="canonical" href="https://keyscodesandmodes.com/chladni-visualizer">
    
    <!-- Schema.org Structured Data for Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Chladni Plate Cymatics Visualizer",
      "description": "Interactive cymatics visualizer demonstrating how sound frequencies create geometric patterns through particle physics simulation",
      "url": "https://keyscodesandmodes.com/chladni-visualizer",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "creator": {
        "@type": "Person",
        "name": "Ben Ryan",
        "jobTitle": "Music Educator & Visual Systems Designer"
      },
      "keywords": "cymatics, chladni plate, music theory, sound visualization, physics education, interactive learning",
      "audience": {
        "@type": "EducationalAudience",
        "educationalRole": "student, teacher, musician, researcher"
      }
    }
    </script>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MMQVHC40B9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MMQVHC40B9', {
        'page_title': 'Chladni Plate Visualizer',
        'page_location': window.location.href,
        'send_page_view': true
      });
      
      // Custom event tracking
      function trackEvent(eventName, eventParams) {
        gtag('event', eventName, eventParams);
      }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-teal: #008080;
            --primary-gold: #F4D03F;
            --primary-purple: #8B6BA3;
            --primary-coral: #CF7A5A;
            --accent-blue: #4A7BA7;
            --dark-bg: #0f0f1e;
            --light-text: #E8E8E8;
            --font-display: 'Cinzel', serif;
            --font-body: 'Montserrat', sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-body);
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a15 100%);
            color: var(--light-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        /* HEADER */
        .app-header {
            background: linear-gradient(135deg, rgba(15, 15, 30, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--primary-teal);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 128, 128, 0.2);
        }
        
        .app-header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .app-logo-svg {
            width: 50px;
            height: 50px;
            filter: drop-shadow(0 2px 8px rgba(244, 208, 63, 0.3));
            transition: transform 0.3s ease;
        }
        
        .app-logo-section:hover .app-logo-svg {
            transform: scale(1.1) rotate(5deg);
        }
        
        .app-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-teal), var(--primary-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1.2;
            letter-spacing: 2px;
        }
        
        .app-subtitle {
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: rgba(232, 232, 232, 0.7);
            margin-top: 0.25rem;
        }
        
        .app-nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        
        .app-nav-links a {
            color: var(--light-text);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .app-nav-links a:hover {
            color: var(--primary-gold);
            background: rgba(0, 128, 128, 0.1);
        }
        
        .upgrade-link {
            background: linear-gradient(135deg, var(--primary-teal), #006666) !important;
            color: white !important;
            padding: 0.75rem 1.5rem !important;
            border-radius: 50px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 128, 128, 0.3);
        }
        
        .upgrade-link:hover {
            background: linear-gradient(135deg, #006666, var(--primary-teal)) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 128, 128, 0.5);
        }
        
        /* MAIN CONTENT */
        .app-main {
            flex: 1;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            min-height: 600px;
        }
        
        /* DISPLAY AREA - CHLADNI PLATE */
        .display-area {
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.1), rgba(139, 107, 163, 0.1));
            border: 3px solid rgba(0, 128, 128, 0.4);
            border-radius: 25px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 128, 128, 0.2);
            position: relative;
        }
        
        .display-title {
            font-family: var(--font-display);
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .display-content {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            height: 70vh;
            min-height: 500px;
        }
        
        #cymatics-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .overlay-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 30, 0.9);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--primary-gold);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
            z-index: 10;
        }
        
        .overlay-info .current-note {
            color: var(--primary-gold);
            font-size: 1.5em;
            font-weight: bold;
            font-family: var(--font-display);
            margin-bottom: 5px;
        }
        
        .overlay-info .current-freq {
            color: var(--primary-teal);
            font-size: 1em;
        }
        
        .pattern-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            border: 1px solid var(--primary-teal);
            z-index: 10;
        }
        
        .pattern-info .label {
            color: var(--primary-teal);
            font-size: 0.8em;
            margin-bottom: 3px;
        }
        
        .pattern-info .value {
            color: white;
            font-size: 0.95em;
            font-weight: bold;
        }
        
        .viewing-mode-label {
            text-align: center;
            color: var(--primary-teal);
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 1rem;
            padding: 0.5rem;
            background: rgba(0, 128, 128, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 128, 128, 0.3);
        }
        
        /* CONTROL PANEL */
        .control-panel {
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.15), rgba(139, 107, 163, 0.15));
            border: 3px solid rgba(0, 128, 128, 0.5);
            border-radius: 25px;
            padding: 1.5rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 50px rgba(0, 128, 128, 0.3);
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .control-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-teal) 25%, var(--primary-purple) 50%, var(--primary-coral) 75%, #6FA5A5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease infinite;
            letter-spacing: 2px;
        }
        
        @keyframes shimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        
        .control-section {
            padding: 0.9rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(0, 128, 128, 0.2);
        }
        
        .section-label {
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.65rem;
            text-align: center;
        }
        
        .key-dropdown {
            width: 100%;
            padding: 0.7rem 0.9rem;
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.2), rgba(139, 107, 163, 0.2));
            border: 2px solid rgba(0, 128, 128, 0.4);
            border-radius: 12px;
            color: var(--light-text);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23F4D03F' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.9rem center;
            padding-right: 2.5rem;
            text-align: center;
        }
        
        .key-dropdown:hover {
            border-color: var(--primary-teal);
            background: linear-gradient(135deg, rgba(0, 128, 128, 0.3), rgba(139, 107, 163, 0.3));
            box-shadow: 0 0 20px rgba(0, 128, 128, 0.3);
        }
        
        .key-dropdown:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 25px rgba(244, 208, 63, 0.4);
        }
        
        .key-dropdown option {
            background: var(--dark-bg);
            color: var(--light-text);
            padding: 0.75rem;
        }
        
        .key-dropdown optgroup {
            background: rgba(0, 128, 128, 0.1);
            color: var(--primary-gold);
            font-weight: 700;
        }
        
        /* FREQUENCY DISPLAY */
        .frequency-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 0.85rem;
            border-radius: 12px;
            border: 2px solid var(--primary-teal);
            text-align: center;
        }
        
        .frequency-display .label {
            color: rgba(232, 232, 232, 0.7);
            font-size: 0.7rem;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            text-align: center;
        }
        
        .frequency-display .value {
            color: var(--primary-gold);
            font-size: 1.4em;
            font-weight: bold;
            font-family: var(--font-display);
            text-shadow: 0 0 10px rgba(244, 208, 63, 0.5);
            text-align: center;
        }
        
        /* PLAY BUTTON */
        .play-button {
            width: 100%;
            padding: 0.9rem;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            font-family: var(--font-body);
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .play-icon {
            font-size: 1.1em;
        }
        
        .play-button:hover {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.6);
        }
        
        .play-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
        }
        
        .play-icon {
            font-size: 1.3em;
        }
        
        /* MIDI BUTTON */
        .midi-button {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--accent-blue) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: var(--font-body);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(139, 107, 163, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            text-align: center;
        }
        
        .midi-button:hover {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--primary-purple) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 107, 163, 0.6);
        }
        
        .midi-button.connected {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .midi-status {
            font-size: 0.75rem;
            color: rgba(232, 232, 232, 0.7);
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        .midi-status.connected {
            color: #2ecc71;
            font-weight: bold;
        }
        
        /* INFO BOX */
        .info-box {
            background: rgba(74, 123, 167, 0.15);
            padding: 0.9rem;
            border-radius: 12px;
            border: 1px solid rgba(0, 128, 128, 0.3);
        }
        
        .info-box p {
            font-size: 0.8rem;
            line-height: 1.5;
            color: rgba(232, 232, 232, 0.8);
            text-align: center;
        }
        
        .info-box strong {
            color: var(--primary-gold);
        }
        
        /* FOOTER */
        .app-footer {
            background: linear-gradient(135deg, rgba(15, 15, 30, 0.95), rgba(26, 26, 46, 0.95));
            border-top: 2px solid rgba(0, 128, 128, 0.3);
            padding: 2rem;
            text-align: center;
        }
        
        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .footer-text {
            color: rgba(232, 232, 232, 0.6);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .footer-links {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: var(--primary-teal);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: var(--primary-gold);
        }
        
        /* SCROLLBAR */
        .control-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .control-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .control-panel::-webkit-scrollbar-thumb {
            background: var(--primary-teal);
            border-radius: 10px;
        }
        
        .control-panel::-webkit-scrollbar-thumb:hover {
            background: var(--primary-gold);
        }
        
        /* ==============================================
           RESPONSIVE DESIGN - ALL DEVICES
           ============================================== */
        
        /* LARGE DESKTOPS (1920px+) */
        @media screen and (min-width: 1920px) {
            .app-main {
                max-width: 1800px;
            }
            
            .app-container {
                grid-template-columns: 2.5fr 1fr;
                gap: 2.5rem;
            }
            
            .display-content {
                height: 75vh;
            }
            
            .control-panel {
                max-height: 85vh;
            }
        }
        
        /* STANDARD DESKTOPS & LAPTOPS (1200px - 1919px) */
        @media screen and (min-width: 1200px) and (max-width: 1919px) {
            .app-main {
                max-width: 1400px;
            }
            
            .app-container {
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }
            
            .display-content {
                height: 70vh;
            }
        }
        
        /* SMALL LAPTOPS & TABLETS LANDSCAPE (992px - 1199px) */
        @media screen and (min-width: 992px) and (max-width: 1199px) {
            .app-main {
                max-width: 1100px;
                padding: 1.5rem;
            }
            
            .app-container {
                grid-template-columns: 1.8fr 1fr;
                gap: 1.5rem;
            }
            
            .display-area {
                padding: 1.5rem;
            }
            
            .display-title {
                font-size: 1.8rem;
            }
            
            .display-content {
                height: 65vh;
                min-height: 450px;
            }
            
            .control-panel {
                padding: 1.25rem;
                gap: 0.9rem;
            }
            
            .control-title {
                font-size: 1.3rem;
            }
            
            .section-label {
                font-size: 0.78rem;
            }
            
            .key-dropdown {
                font-size: 0.83rem;
                padding: 0.68rem 0.85rem;
            }
        }
        
        /* TABLETS PORTRAIT & SMALL LAPTOPS (768px - 991px) */
        @media screen and (min-width: 768px) and (max-width: 991px) {
            .app-header {
                padding: 1rem 1.5rem;
            }
            
            .app-logo-svg {
                width: 45px;
                height: 45px;
            }
            
            .app-title {
                font-size: 1.3rem;
            }
            
            .app-nav-links a {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }
            
            .upgrade-link {
                padding: 0.6rem 1.2rem !important;
            }
            
            .app-main {
                padding: 1.5rem;
            }
            
            .app-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .display-area {
                padding: 1.5rem;
            }
            
            .display-title {
                font-size: 1.7rem;
            }
            
            .display-content {
                height: 55vh;
                min-height: 400px;
            }
            
            .overlay-info {
                top: 15px;
                right: 15px;
                padding: 0.9rem 1.2rem;
            }
            
            .overlay-info .current-note {
                font-size: 1.3em;
            }
            
            .viewing-mode-label {
                font-size: 0.88rem;
            }
            
            .control-panel {
                padding: 1.25rem;
                gap: 0.85rem;
                max-height: none;
            }
            
            .control-title {
                font-size: 1.3rem;
            }
            
            .control-section {
                padding: 0.85rem;
            }
            
            .section-label {
                font-size: 0.78rem;
            }
            
            .key-dropdown {
                padding: 0.7rem 0.85rem;
                font-size: 0.83rem;
            }
            
            .play-button {
                padding: 0.88rem;
                font-size: 0.88rem;
            }
            
            .midi-button {
                padding: 0.78rem;
                font-size: 0.83rem;
            }
            
            .frequency-display .value {
                font-size: 1.35em;
            }
        }
        
        /* LARGE PHONES / SMALL TABLETS (576px - 767px) */
        @media screen and (min-width: 576px) and (max-width: 767px) {
            .app-header {
                padding: 0.85rem 1.2rem;
            }
            
            .app-logo-svg {
                width: 42px;
                height: 42px;
            }
            
            .app-title {
                font-size: 1.15rem;
            }
            
            .app-subtitle {
                font-size: 0.78rem;
            }
            
            .app-nav-links {
                display: none;
            }
            
            .app-main {
                padding: 1.2rem;
            }
            
            .app-container {
                grid-template-columns: 1fr;
                gap: 1.2rem;
            }
            
            .display-area {
                padding: 1.2rem;
            }
            
            .display-title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .display-content {
                height: 50vh;
                min-height: 380px;
            }
            
            .overlay-info {
                top: 12px;
                right: 12px;
                padding: 0.8rem 1.1rem;
            }
            
            .overlay-info .current-note {
                font-size: 1.25em;
            }
            
            .overlay-info .current-freq {
                font-size: 0.92em;
            }
            
            .viewing-mode-label {
                font-size: 0.87rem;
                margin-top: 0.8rem;
                padding: 0.45rem;
            }
            
            .control-panel {
                padding: 1.1rem;
                gap: 0.8rem;
            }
            
            .control-title {
                font-size: 1.25rem;
            }
            
            .control-section {
                padding: 0.8rem;
            }
            
            .section-label {
                font-size: 0.76rem;
            }
            
            .key-dropdown {
                padding: 0.68rem 0.82rem;
                font-size: 0.82rem;
            }
            
            .play-button {
                padding: 0.85rem;
                font-size: 0.86rem;
            }
            
            .midi-button {
                padding: 0.77rem;
                font-size: 0.82rem;
            }
            
            .frequency-display {
                padding: 0.78rem;
            }
            
            .frequency-display .label {
                font-size: 0.68rem;
            }
            
            .frequency-display .value {
                font-size: 1.32em;
            }
            
            .info-box {
                padding: 0.8rem;
            }
            
            .info-box p {
                font-size: 0.78rem;
            }
        }
        
        /* STANDARD PHONES (375px - 575px) */
        @media screen and (min-width: 375px) and (max-width: 575px) {
            .app-header {
                padding: 0.75rem 1rem;
            }
            
            .app-logo-svg {
                width: 40px;
                height: 40px;
            }
            
            .app-title {
                font-size: 1.1rem;
            }
            
            .app-subtitle {
                font-size: 0.75rem;
            }
            
            .app-nav-links {
                display: none;
            }
            
            .app-main {
                padding: 1rem;
            }
            
            .app-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .display-area {
                padding: 1rem;
            }
            
            .display-title {
                font-size: 1.4rem;
                margin-bottom: 0.9rem;
            }
            
            .display-content {
                height: 48vh;
                min-height: 360px;
            }
            
            .overlay-info {
                top: 10px;
                right: 10px;
                padding: 0.7rem 1rem;
            }
            
            .overlay-info .current-note {
                font-size: 1.2em;
            }
            
            .overlay-info .current-freq {
                font-size: 0.9em;
            }
            
            .viewing-mode-label {
                font-size: 0.85rem;
                margin-top: 0.75rem;
                padding: 0.4rem;
            }
            
            .control-panel {
                padding: 1rem;
                gap: 0.75rem;
            }
            
            .control-title {
                font-size: 1.2rem;
                margin-bottom: 0.3rem;
            }
            
            .control-section {
                padding: 0.75rem;
            }
            
            .section-label {
                font-size: 0.74rem;
                margin-bottom: 0.5rem;
            }
            
            .key-dropdown {
                padding: 0.65rem 0.8rem;
                font-size: 0.8rem;
                background-position: right 0.8rem center;
            }
            
            .play-button {
                padding: 0.83rem;
                font-size: 0.84rem;
            }
            
            .play-icon {
                font-size: 1.05em;
            }
            
            .midi-button {
                padding: 0.75rem;
                font-size: 0.8rem;
            }
            
            .midi-status {
                font-size: 0.73rem;
            }
            
            .frequency-display {
                padding: 0.75rem;
            }
            
            .frequency-display .label {
                font-size: 0.66rem;
            }
            
            .frequency-display .value {
                font-size: 1.3em;
            }
            
            .info-box {
                padding: 0.75rem;
            }
            
            .info-box p {
                font-size: 0.76rem;
                line-height: 1.45;
            }
            
            .app-footer {
                padding: 1.5rem 1rem;
            }
            
            .footer-text {
                font-size: 0.8rem;
            }
            
            .footer-links {
                gap: 1rem;
                font-size: 0.85rem;
            }
        }
        
        /* SMALL PHONES - iPhone SE, etc (320px - 374px) */
        @media screen and (max-width: 374px) {
            .app-header {
                padding: 0.65rem 0.85rem;
            }
            
            .app-logo-svg {
                width: 36px;
                height: 36px;
            }
            
            .app-title {
                font-size: 1rem;
                letter-spacing: 1.5px;
            }
            
            .app-subtitle {
                font-size: 0.7rem;
            }
            
            .app-nav-links {
                display: none;
            }
            
            .app-main {
                padding: 0.85rem;
            }
            
            .app-container {
                grid-template-columns: 1fr;
                gap: 0.9rem;
            }
            
            .display-area {
                padding: 0.9rem;
            }
            
            .display-title {
                font-size: 1.25rem;
                margin-bottom: 0.8rem;
            }
            
            .display-content {
                height: 45vh;
                min-height: 320px;
            }
            
            .overlay-info {
                top: 8px;
                right: 8px;
                padding: 0.6rem 0.85rem;
            }
            
            .overlay-info .current-note {
                font-size: 1.1em;
            }
            
            .overlay-info .current-freq {
                font-size: 0.85em;
            }
            
            .viewing-mode-label {
                font-size: 0.8rem;
                margin-top: 0.65rem;
                padding: 0.35rem;
            }
            
            .control-panel {
                padding: 0.9rem;
                gap: 0.7rem;
            }
            
            .control-title {
                font-size: 1.1rem;
                margin-bottom: 0.25rem;
            }
            
            .control-section {
                padding: 0.7rem;
            }
            
            .section-label {
                font-size: 0.7rem;
                margin-bottom: 0.45rem;
                letter-spacing: 0.7px;
            }
            
            .key-dropdown {
                padding: 0.6rem 0.75rem;
                font-size: 0.75rem;
                background-position: right 0.75rem center;
            }
            
            .play-button {
                padding: 0.8rem;
                font-size: 0.8rem;
                letter-spacing: 0.6px;
            }
            
            .play-icon {
                font-size: 1em;
            }
            
            .midi-button {
                padding: 0.7rem;
                font-size: 0.75rem;
                letter-spacing: 0.6px;
            }
            
            .midi-status {
                font-size: 0.7rem;
                padding: 0.45rem;
            }
            
            .frequency-display {
                padding: 0.7rem;
            }
            
            .frequency-display .label {
                font-size: 0.62rem;
                margin-bottom: 0.35rem;
            }
            
            .frequency-display .value {
                font-size: 1.2em;
            }
            
            .info-box {
                padding: 0.7rem;
            }
            
            .info-box p {
                font-size: 0.72rem;
                line-height: 1.4;
            }
            
            .app-footer {
                padding: 1.2rem 0.85rem;
            }
            
            .footer-text {
                font-size: 0.75rem;
            }
            
            .footer-links {
                gap: 0.85rem;
                font-size: 0.8rem;
            }
        }
        
        /* LANDSCAPE MODE - PHONES & TABLETS */
        @media screen and (max-width: 991px) and (orientation: landscape) {
            .app-header {
                padding: 0.6rem 1rem;
            }
            
            .app-main {
                padding: 1rem;
            }
            
            .app-container {
                grid-template-columns: 1.6fr 1fr;
                gap: 1rem;
            }
            
            .display-area {
                padding: 1rem;
            }
            
            .display-title {
                font-size: 1.3rem;
                margin-bottom: 0.75rem;
            }
            
            .display-content {
                height: 70vh;
                min-height: 280px;
            }
            
            .viewing-mode-label {
                margin-top: 0.6rem;
                padding: 0.35rem;
                font-size: 0.8rem;
            }
            
            .control-panel {
                max-height: 72vh;
                overflow-y: auto;
                padding: 1rem;
                gap: 0.7rem;
            }
            
            .control-title {
                font-size: 1.15rem;
            }
            
            .control-section {
                padding: 0.7rem;
            }
            
            .app-footer {
                display: none;
            }
        }
        
        /* TOUCH DEVICE OPTIMIZATIONS */
        @media (hover: none) and (pointer: coarse) {
            .key-dropdown,
            .play-button,
            .midi-button {
                min-height: 44px; /* Apple's recommended touch target size */
            }
            
            .control-section {
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="app-header">
        <div class="app-header-content">
            <div class="app-logo-section">
                <svg class="app-logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#F4D03F" stroke-width="3"/>
                    <circle cx="50" cy="50" r="35" fill="none" stroke="#008080" stroke-width="2"/>
                    <circle cx="50" cy="50" r="25" fill="none" stroke="#8B6BA3" stroke-width="2"/>
                    <path d="M 50 15 L 50 85" stroke="#F4D03F" stroke-width="2"/>
                    <path d="M 15 50 L 85 50" stroke="#F4D03F" stroke-width="2"/>
                </svg>
                <div>
                    <h1 class="app-title">Keys, Codes & Modes</h1>
                    <p class="app-subtitle">Chladni Plate Cymatics Visualizer</p>
                </div>
            </div>
            <nav class="app-nav-links">
                <a href="#">Home</a>
                <a href="#">About</a>
                <a href="#">Tools</a>
                <a href="#" class="upgrade-link">Upgrade Pro</a>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="app-main">
        <div class="app-container">
            <!-- DISPLAY AREA -->
            <section class="display-area">
                <h2 class="display-title">Chladni Plate Visualization</h2>
                <div class="display-content">
                    <canvas id="cymatics-canvas"></canvas>
                    
                    <div class="overlay-info">
                        <div class="current-note" id="current-note">C4</div>
                        <div class="current-freq" id="current-freq-overlay">261.63 Hz</div>
                    </div>
                </div>
                <div class="viewing-mode-label">Viewing Mode: Chladni Plate</div>
            </section>

            <!-- CONTROL PANEL -->
            <aside class="control-panel">
                <h2 class="control-title">Sound Controls</h2>
                
                <!-- Note Selection -->
                <div class="control-section">
                    <div class="section-label">
                        Select Note
                    </div>
                    <select id="note-select" class="key-dropdown" onchange="changeNote()">
                        <option value="C">C</option>
                        <option value="C#">C# / D♭</option>
                        <option value="D">D</option>
                        <option value="D#">D# / E♭</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F# / G♭</option>
                        <option value="G">G</option>
                        <option value="G#">G# / A♭</option>
                        <option value="A">A</option>
                        <option value="A#">A# / B♭</option>
                        <option value="B">B</option>
                    </select>
                </div>

                <!-- Octave Selection -->
                <div class="control-section">
                    <div class="section-label">
                        Octave
                    </div>
                    <select id="octave-select" class="key-dropdown" onchange="changeNote()">
                        <option value="1">Octave 1 (Very Low)</option>
                        <option value="2">Octave 2 (Low)</option>
                        <option value="3">Octave 3</option>
                        <option value="4" selected>Octave 4 (Middle C)</option>
                        <option value="5">Octave 5</option>
                        <option value="6">Octave 6 (High)</option>
                        <option value="7">Octave 7 (Very High)</option>
                    </select>
                </div>

                <!-- MIDI Connection -->
                <div class="control-section">
                    <div class="section-label">
                        MIDI Input
                    </div>
                    <button class="midi-button" id="midi-connect-btn" onclick="connectMIDI()">
                        Connect MIDI Device
                    </button>
                    <div id="midi-status" class="midi-status">No MIDI device connected</div>
                    <select id="midi-input-select" class="key-dropdown" style="display:none;">
                        <option value="">Select MIDI Input...</option>
                    </select>
                </div>

                <!-- Play Button -->
                <div class="control-section">
                    <button class="play-button" id="play-btn" 
                        onmousedown="startPlayingNote()" 
                        onmouseup="stopPlayingNote()" 
                        onmouseleave="stopPlayingNote()" 
                        ontouchstart="event.preventDefault(); startPlayingNote()" 
                        ontouchend="event.preventDefault(); stopPlayingNote()">
                        <span class="play-icon">▶</span> Play Note
                    </button>
                </div>

                <!-- Frequency Display -->
                <div class="frequency-display">
                    <div class="label">Current Frequency</div>
                    <div class="value" id="freq-display">261.63 Hz</div>
                </div>

                <!-- Intervals -->
                <div class="control-section">
                    <div class="section-label">
                        Intervals
                    </div>
                    <select id="interval-select" class="key-dropdown" onchange="playInterval()">
                        <option value="none">Single Note</option>
                        <option value="minor 2nd">Minor 2nd (m2)</option>
                        <option value="major 2nd">Major 2nd (M2)</option>
                        <option value="minor 3rd">Minor 3rd (m3)</option>
                        <option value="major 3rd">Major 3rd (M3)</option>
                        <option value="perfect 4th">Perfect 4th (P4)</option>
                        <option value="tritone">Tritone (TT)</option>
                        <option value="perfect 5th">Perfect 5th (P5)</option>
                        <option value="octave">Octave (P8)</option>
                    </select>
                </div>

                <!-- Chords -->
                <div class="control-section">
                    <div class="section-label">
                        Chords
                    </div>
                    <select id="chord-select" class="key-dropdown" onchange="playChord()">
                        <option value="none">Single Note</option>
                        <optgroup label="Triads">
                            <option value="major">Major Triad</option>
                            <option value="minor">Minor Triad</option>
                            <option value="diminished">Diminished</option>
                            <option value="augmented">Augmented</option>
                        </optgroup>
                        <optgroup label="7th Chords">
                            <option value="major7">Major 7th</option>
                            <option value="minor7">Minor 7th</option>
                            <option value="dominant7">Dominant 7th</option>
                            <option value="minor7b5">Minor 7♭5 (Half-Dim)</option>
                            <option value="diminished7">Diminished 7th</option>
                        </optgroup>
                        <optgroup label="9th Chords">
                            <option value="major9">Major 9th</option>
                            <option value="minor9">Minor 9th</option>
                            <option value="dominant9">Dominant 9th</option>
                            <option value="add9">Add 9</option>
                        </optgroup>
                        <optgroup label="11th Chords">
                            <option value="major11">Major 11th</option>
                            <option value="minor11">Minor 11th</option>
                            <option value="dominant11">Dominant 11th</option>
                        </optgroup>
                        <optgroup label="13th Chords">
                            <option value="major13">Major 13th</option>
                            <option value="minor13">Minor 13th</option>
                            <option value="dominant13">Dominant 13th</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Plate Shape -->
                <div class="control-section">
                    <div class="section-label">
                        Plate Shape
                    </div>
                    <select id="shape-select" class="key-dropdown" onchange="changePlateShape()">
                        <option value="circle" selected>Circle</option>
                        <option value="square">Square</option>
                    </select>
                </div>

                <!-- Particle Density -->
                <div class="control-section">
                    <div class="section-label">
                        Particle Density
                    </div>
                    <select id="density-select" class="key-dropdown" onchange="changeDensity()">
                        <option value="5000">Low (5,000)</option>
                        <option value="10000" selected>Medium (10,000)</option>
                        <option value="15000">High (15,000)</option>
                        <option value="20000">Ultra (20,000)</option>
                    </select>
                </div>

                <!-- Info Box -->
                <div class="info-box">
                    <p><strong>Chladni Plates:</strong> Watch sand particles migrate to nodes (areas of no vibration) creating intricate geometric patterns. Each frequency produces a unique design!</p>
                </div>
            </aside>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="app-footer">
        <div class="footer-content">
            <p class="footer-text">© 2026 Keys, Codes & Modes | Visual Music Theory Education</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Contact</a>
                <a href="#">Support</a>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
// ============================================
// CONFIGURATION & STATE
// ============================================

const chromaticNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

let scene, camera, renderer;
let particles = [];
let currentFrequency = 261.63;
let currentNote = 'C';
let currentOctave = 4;
let plateType = 'circle';
let particleCount = 10000;
let animationId;
let plateRadius = 5;

let audioContext;
let oscillators = [];
let gainNode;

// MIDI variables
let midiAccess = null;
let midiInput = null;
let activeNotes = new Map();

// Play button state
let isPlayButtonHeld = false;
let playButtonTimeout = null;
let sustainedOscillators = [];

// ============================================
// AUDIO SYSTEM
// ============================================

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = audioContext.createGain();
    gainNode.connect(audioContext.destination);
    gainNode.gain.value = 0.15;
  }
}

function getNoteFrequency(note, octave) {
  const noteIndex = chromaticNotes.indexOf(note);
  const A4 = 440;
  const semitoneOffset = (octave - 4) * 12 + (noteIndex - 9);
  return A4 * Math.pow(2, semitoneOffset / 12);
}

function stopAllOscillators() {
  oscillators.forEach(osc => {
    try {
      osc.stop();
    } catch(e) {}
  });
  oscillators = [];
}

function playTone(frequency, duration = 1000) {
  initAudio();
  stopAllOscillators();
  
  const osc = audioContext.createOscillator();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
  osc.connect(gainNode);
  osc.start();
  oscillators.push(osc);
  
  setTimeout(() => {
    try {
      osc.stop();
    } catch(e) {}
  }, duration);
}

function playMultipleTones(frequencies, duration = 1500) {
  initAudio();
  stopAllOscillators();
  
  frequencies.forEach(freq => {
    const osc = audioContext.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, audioContext.currentTime);
    osc.connect(gainNode);
    osc.start();
    oscillators.push(osc);
    
    setTimeout(() => {
      try {
        osc.stop();
      } catch(e) {}
    }, duration);
  });
}

// ============================================
// THREE.JS VISUALIZATION
// ============================================

function initCymatics() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000000);
  
  const canvas = document.getElementById('cymatics-canvas');
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;
  
  camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
  camera.position.set(0, 12, 8);
  camera.lookAt(0, 0, 0);
  
  renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
  renderer.setSize(width, height);
  renderer.setPixelRatio(window.devicePixelRatio);
  
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);
  
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(5, 10, 5);
  scene.add(directionalLight);
  
  const plateGeometry = plateType === 'circle' 
    ? new THREE.CircleGeometry(plateRadius, 64)
    : new THREE.PlaneGeometry(plateRadius * 2, plateRadius * 2);
    
  const plateMaterial = new THREE.MeshStandardMaterial({
    color: 0x1a1a1a,
    side: THREE.DoubleSide,
    roughness: 0.8,
    metalness: 0.2
  });
  
  const plateMesh = new THREE.Mesh(plateGeometry, plateMaterial);
  plateMesh.rotation.x = -Math.PI / 2;
  scene.add(plateMesh);
  
  createParticles();
  animate();
  
  window.addEventListener('resize', onWindowResize);
}

function createParticles() {
  particles.forEach(p => scene.remove(p));
  particles = [];
  
  const particleGeometry = new THREE.SphereGeometry(0.02, 4, 4);
  const particleMaterial = new THREE.MeshStandardMaterial({
    color: 0xe0e0e0,
    roughness: 0.9,
    metalness: 0.1
  });
  
  for (let i = 0; i < particleCount; i++) {
    const particle = new THREE.Mesh(particleGeometry, particleMaterial);
    
    let x, z;
    if (plateType === 'circle') {
      const angle = Math.random() * Math.PI * 2;
      const radius = Math.sqrt(Math.random()) * plateRadius * 0.95;
      x = Math.cos(angle) * radius;
      z = Math.sin(angle) * radius;
    } else {
      x = (Math.random() - 0.5) * plateRadius * 1.9;
      z = (Math.random() - 0.5) * plateRadius * 1.9;
    }
    
    particle.position.set(x, 0.02, z);
    particle.userData.homeX = x;
    particle.userData.homeZ = z;
    particle.userData.velocity = { x: 0, z: 0 };
    
    scene.add(particle);
    particles.push(particle);
  }
  
  updateParticlePositions();
}

function updateParticlePositions() {
  const freqFactor = currentFrequency / 261.63;
  
  particles.forEach(particle => {
    const x = particle.position.x;
    const z = particle.position.z;
    const distance = Math.sqrt(x * x + z * z);
    const angle = Math.atan2(z, x);
    
    const m = Math.floor(freqFactor * 2 + 1);
    const n = Math.floor(freqFactor * 1.5 + 1);
    
    const radialComponent = Math.sin(distance * m * Math.PI / plateRadius);
    const angularComponent = Math.cos(n * angle);
    const amplitude = Math.abs(radialComponent * angularComponent);
    
    const threshold = 0.15;
    
    if (amplitude < threshold) {
      particle.userData.velocity.x *= 0.85;
      particle.userData.velocity.z *= 0.85;
    } else {
      const force = (amplitude - threshold) * 0.05;
      
      const gradX = Math.cos(distance * m * Math.PI / plateRadius) * m * Math.PI / plateRadius * (x / distance) * angularComponent;
      const gradZ = Math.cos(distance * m * Math.PI / plateRadius) * m * Math.PI / plateRadius * (z / distance) * angularComponent;
      
      particle.userData.velocity.x -= gradX * force;
      particle.userData.velocity.z -= gradZ * force;
    }
    
    particle.position.x += particle.userData.velocity.x;
    particle.position.z += particle.userData.velocity.z;
    
    const currentDist = Math.sqrt(
      particle.position.x * particle.position.x + 
      particle.position.z * particle.position.z
    );
    
    if (plateType === 'circle' && currentDist > plateRadius * 0.95) {
      const scaleFactor = (plateRadius * 0.95) / currentDist;
      particle.position.x *= scaleFactor;
      particle.position.z *= scaleFactor;
      particle.userData.velocity.x *= -0.5;
      particle.userData.velocity.z *= -0.5;
    } else if (plateType === 'square') {
      const limit = plateRadius * 0.95;
      if (Math.abs(particle.position.x) > limit) {
        particle.position.x = Math.sign(particle.position.x) * limit;
        particle.userData.velocity.x *= -0.5;
      }
      if (Math.abs(particle.position.z) > limit) {
        particle.position.z = Math.sign(particle.position.z) * limit;
        particle.userData.velocity.z *= -0.5;
      }
    }
    
    particle.userData.velocity.x += (Math.random() - 0.5) * 0.002;
    particle.userData.velocity.z += (Math.random() - 0.5) * 0.002;
    
    particle.userData.velocity.x *= 0.95;
    particle.userData.velocity.z *= 0.95;
  });
}

function animate() {
  animationId = requestAnimationFrame(animate);
  
  updateParticlePositions();
  renderer.render(scene, camera);
}

function onWindowResize() {
  const canvas = document.getElementById('cymatics-canvas');
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;
  
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
  
  renderer.setSize(width, height);
}

// ============================================
// UI CONTROL FUNCTIONS
// ============================================

function changeNote() {
  const noteSelect = document.getElementById('note-select');
  const octaveSelect = document.getElementById('octave-select');
  
  currentNote = noteSelect.value;
  currentOctave = parseInt(octaveSelect.value);
  currentFrequency = getNoteFrequency(currentNote, currentOctave);
  
  document.getElementById('interval-select').value = 'none';
  document.getElementById('chord-select').value = 'none';
  
  updateDisplay();
  
  // Analytics tracking
  if (typeof trackEvent === 'function') {
    trackEvent('note_selected', {
      note: currentNote,
      octave: currentOctave,
      frequency: currentFrequency.toFixed(2)
    });
  }
}

// ============================================
// PLAY BUTTON PRESS-AND-HOLD FUNCTIONALITY
// ============================================

function startPlayingNote() {
  isPlayButtonHeld = true;
  
  const playBtn = document.getElementById('play-btn');
  playBtn.style.transform = 'translateY(0)';
  playBtn.style.boxShadow = '0 2px 8px rgba(46, 204, 113, 0.4)';
  
  playButtonTimeout = setTimeout(() => {
    playSustainedSound();
  }, 150);
}

function stopPlayingNote() {
  const playBtn = document.getElementById('play-btn');
  playBtn.style.transform = '';
  playBtn.style.boxShadow = '';
  
  if (!isPlayButtonHeld) return;
  
  isPlayButtonHeld = false;
  
  if (playButtonTimeout) {
    clearTimeout(playButtonTimeout);
    playButtonTimeout = null;
    playTimedSound();
  } else {
    stopSustainedSound();
  }
}

function playTimedSound() {
  const intervalSelect = document.getElementById('interval-select');
  const chordSelect = document.getElementById('chord-select');
  
  // Analytics tracking
  if (typeof trackEvent === 'function') {
    trackEvent('play_button_clicked', {
      type: chordSelect.value !== 'none' ? 'chord' : (intervalSelect.value !== 'none' ? 'interval' : 'note'),
      selection: chordSelect.value !== 'none' ? chordSelect.value : (intervalSelect.value !== 'none' ? intervalSelect.value : currentNote)
    });
  }
  
  if (chordSelect.value !== 'none') {
    playChord();
  } else if (intervalSelect.value !== 'none') {
    playInterval();
  } else {
    playTone(currentFrequency);
    createParticles();
  }
}

function playSustainedSound() {
  initAudio();
  stopSustainedSound();
  playButtonTimeout = null;
  
  const intervalSelect = document.getElementById('interval-select');
  const chordSelect = document.getElementById('chord-select');
  
  let frequencies = [];
  
  if (chordSelect.value !== 'none') {
    const chordIntervals = {
      'major': [0, 4, 7],
      'minor': [0, 3, 7],
      'diminished': [0, 3, 6],
      'augmented': [0, 4, 8],
      'major7': [0, 4, 7, 11],
      'minor7': [0, 3, 7, 10],
      'dominant7': [0, 4, 7, 10],
      'minor7b5': [0, 3, 6, 10],
      'diminished7': [0, 3, 6, 9],
      'major9': [0, 4, 7, 11, 14],
      'minor9': [0, 3, 7, 10, 14],
      'dominant9': [0, 4, 7, 10, 14],
      'add9': [0, 4, 7, 14],
      'major11': [0, 4, 7, 11, 14, 17],
      'minor11': [0, 3, 7, 10, 14, 17],
      'dominant11': [0, 4, 7, 10, 14, 17],
      'major13': [0, 4, 7, 11, 14, 21],
      'minor13': [0, 3, 7, 10, 14, 21],
      'dominant13': [0, 4, 7, 10, 14, 21]
    };
    
    const rootIndex = chromaticNotes.indexOf(currentNote);
    const intervals = chordIntervals[chordSelect.value];
    
    intervals.forEach(interval => {
      const noteIndex = (rootIndex + interval) % 12;
      const freq = getNoteFrequency(
        chromaticNotes[noteIndex],
        currentOctave + Math.floor((rootIndex + interval) / 12)
      );
      frequencies.push(freq);
    });
    
  } else if (intervalSelect.value !== 'none') {
    const intervalMap = {
      'minor 2nd': 1,
      'major 2nd': 2,
      'minor 3rd': 3,
      'major 3rd': 4,
      'perfect 4th': 5,
      'tritone': 6,
      'perfect 5th': 7,
      'octave': 12
    };
    
    const rootFreq = getNoteFrequency(currentNote, currentOctave);
    const rootIndex = chromaticNotes.indexOf(currentNote);
    const intervalSemitones = intervalMap[intervalSelect.value];
    const secondNoteIndex = (rootIndex + intervalSemitones) % 12;
    const secondFreq = getNoteFrequency(
      chromaticNotes[secondNoteIndex],
      currentOctave + Math.floor((rootIndex + intervalSemitones) / 12)
    );
    
    frequencies = [rootFreq, secondFreq];
  } else {
    frequencies = [currentFrequency];
  }
  
  frequencies.forEach(freq => {
    const osc = audioContext.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, audioContext.currentTime);
    osc.connect(gainNode);
    osc.start();
    sustainedOscillators.push(osc);
  });
  
  createParticles();
}

function stopSustainedSound() {
  sustainedOscillators.forEach(osc => {
    try {
      osc.stop();
    } catch(e) {}
  });
  sustainedOscillators = [];
}

function playInterval() {
  const intervalSelect = document.getElementById('interval-select');
  const interval = intervalSelect.value;
  
  if (interval === 'none') {
    changeNote();
    return;
  }
  
  document.getElementById('chord-select').value = 'none';
  
  const intervalMap = {
    'minor 2nd': 1,
    'major 2nd': 2,
    'minor 3rd': 3,
    'major 3rd': 4,
    'perfect 4th': 5,
    'tritone': 6,
    'perfect 5th': 7,
    'octave': 12
  };
  
  const rootFreq = getNoteFrequency(currentNote, currentOctave);
  const rootIndex = chromaticNotes.indexOf(currentNote);
  const intervalSemitones = intervalMap[interval];
  const secondNoteIndex = (rootIndex + intervalSemitones) % 12;
  const secondFreq = getNoteFrequency(
    chromaticNotes[secondNoteIndex],
    currentOctave + Math.floor((rootIndex + intervalSemitones) / 12)
  );
  
  currentFrequency = (rootFreq + secondFreq) / 2;
  updateDisplay();
  playMultipleTones([rootFreq, secondFreq]);
  createParticles();
}

function playChord() {
  const chordSelect = document.getElementById('chord-select');
  const chordType = chordSelect.value;
  
  if (chordType === 'none') {
    changeNote();
    return;
  }
  
  document.getElementById('interval-select').value = 'none';
  
  // Analytics tracking
  if (typeof trackEvent === 'function') {
    trackEvent('chord_played', {
      chord_type: chordType,
      root_note: currentNote,
      octave: currentOctave
    });
  }
  
  const chordIntervals = {
    'major': [0, 4, 7],
    'minor': [0, 3, 7],
    'diminished': [0, 3, 6],
    'augmented': [0, 4, 8],
    'major7': [0, 4, 7, 11],
    'minor7': [0, 3, 7, 10],
    'dominant7': [0, 4, 7, 10],
    'minor7b5': [0, 3, 6, 10],
    'diminished7': [0, 3, 6, 9],
    'major9': [0, 4, 7, 11, 14],
    'minor9': [0, 3, 7, 10, 14],
    'dominant9': [0, 4, 7, 10, 14],
    'add9': [0, 4, 7, 14],
    'major11': [0, 4, 7, 11, 14, 17],
    'minor11': [0, 3, 7, 10, 14, 17],
    'dominant11': [0, 4, 7, 10, 14, 17],
    'major13': [0, 4, 7, 11, 14, 21],
    'minor13': [0, 3, 7, 10, 14, 21],
    'dominant13': [0, 4, 7, 10, 14, 21]
  };
  
  const rootIndex = chromaticNotes.indexOf(currentNote);
  const intervals = chordIntervals[chordType];
  const frequencies = [];
  
  intervals.forEach(interval => {
    const noteIndex = (rootIndex + interval) % 12;
    const freq = getNoteFrequency(
      chromaticNotes[noteIndex],
      currentOctave + Math.floor((rootIndex + interval) / 12)
    );
    frequencies.push(freq);
  });
  
  currentFrequency = frequencies.reduce((a, b) => a + b, 0) / frequencies.length;
  updateDisplay();
  playMultipleTones(frequencies, 2000);
  createParticles();
}

function changePlateShape() {
  const shapeSelect = document.getElementById('shape-select');
  plateType = shapeSelect.value;
  
  // Analytics tracking
  if (typeof trackEvent === 'function') {
    trackEvent('plate_shape_changed', {
      shape: plateType
    });
  }
  
  scene.children.forEach(child => {
    if (child instanceof THREE.Mesh && (child.geometry instanceof THREE.PlaneGeometry ||
        child.geometry instanceof THREE.CircleGeometry)) {
      scene.remove(child);
    }
  });
  
  const plateGeometry = plateType === 'circle' 
    ? new THREE.CircleGeometry(plateRadius, 64)
    : new THREE.PlaneGeometry(plateRadius * 2, plateRadius * 2);
    
  const plateMaterial = new THREE.MeshStandardMaterial({
    color: 0x1a1a1a,
    side: THREE.DoubleSide,
    roughness: 0.8,
    metalness: 0.2
  });
  
  const plateMesh = new THREE.Mesh(plateGeometry, plateMaterial);
  plateMesh.rotation.x = -Math.PI / 2;
  scene.add(plateMesh);
  
  createParticles();
}

function changeDensity() {
  const densitySelect = document.getElementById('density-select');
  particleCount = parseInt(densitySelect.value);
  
  // Analytics tracking
  if (typeof trackEvent === 'function') {
    trackEvent('particle_density_changed', {
      particle_count: particleCount
    });
  }
  
  createParticles();
}

function updateDisplay() {
  const freqDisplay = document.getElementById('freq-display');
  const currentNoteDisplay = document.getElementById('current-note');
  const currentFreqOverlay = document.getElementById('current-freq-overlay');
  
  freqDisplay.textContent = currentFrequency.toFixed(2) + ' Hz';
  currentNoteDisplay.textContent = currentNote + currentOctave;
  currentFreqOverlay.textContent = currentFrequency.toFixed(2) + ' Hz';
}

// ============================================
// MIDI FUNCTIONALITY
// ============================================

async function connectMIDI() {
  if (navigator.requestMIDIAccess) {
    try {
      midiAccess = await navigator.requestMIDIAccess();
      const inputs = Array.from(midiAccess.inputs.values());
      
      if (inputs.length === 0) {
        updateMIDIStatus('No MIDI devices found', false);
        return;
      }
      
      const inputSelect = document.getElementById('midi-input-select');
      inputSelect.innerHTML = '<option value="">Select MIDI Input...</option>';
      
      inputs.forEach((input, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = input.name || `MIDI Input ${index + 1}`;
        inputSelect.appendChild(option);
      });
      
      if (inputs.length === 1) {
        setupMIDIInput(inputs[0]);
        updateMIDIStatus(`Connected: ${inputs[0].name || 'MIDI Device'}`, true);
      } else {
        inputSelect.style.display = 'block';
        inputSelect.onchange = (e) => {
          const selectedInput = inputs[parseInt(e.target.value)];
          setupMIDIInput(selectedInput);
          updateMIDIStatus(`Connected: ${selectedInput.name || 'MIDI Device'}`, true);
        };
        updateMIDIStatus('Select a MIDI input device', false);
      }
      
    } catch (err) {
      console.error('MIDI Access Error:', err);
      updateMIDIStatus('MIDI access denied', false);
    }
  } else {
    updateMIDIStatus('MIDI not supported in this browser', false);
  }
}

function setupMIDIInput(input) {
  if (midiInput) {
    midiInput.onmidimessage = null;
  }
  
  midiInput = input;
  midiInput.onmidimessage = handleMIDIMessage;
  
  const connectBtn = document.getElementById('midi-connect-btn');
  connectBtn.classList.add('connected');
  connectBtn.textContent = 'MIDI Connected ✓';
  
  // Analytics tracking
  if (typeof trackEvent === 'function') {
    trackEvent('midi_connected', {
      device_name: input.name || 'Unknown MIDI Device'
    });
  }
}

function handleMIDIMessage(message) {
  const [status, note, velocity] = message.data;
  const command = status & 0xf0;
  
  if (command === 144 && velocity > 0) {
    playMIDINote(note, velocity);
  }
  else if (command === 128 || (command === 144 && velocity === 0)) {
    stopMIDINote(note);
  }
}

function playMIDINote(midiNote, velocity) {
  initAudio();
  
  const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
  
  const noteIndex = midiNote % 12;
  const octave = Math.floor(midiNote / 12) - 1;
  const noteName = chromaticNotes[noteIndex];
  
  currentNote = noteName;
  currentOctave = octave;
  currentFrequency = frequency;
  updateDisplay();
  
  const osc = audioContext.createOscillator();
  const noteGain = audioContext.createGain();
  
  osc.type = 'sine';
  osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
  
  const volume = (velocity / 127) * 0.2;
  noteGain.gain.setValueAtTime(volume, audioContext.currentTime);
  
  osc.connect(noteGain);
  noteGain.connect(audioContext.destination);
  osc.start();
  
  activeNotes.set(midiNote, { osc, noteGain });
  
  createParticles();
}

function stopMIDINote(midiNote) {
  const noteData = activeNotes.get(midiNote);
  
  if (noteData) {
    const { osc, noteGain } = noteData;
    
    noteGain.gain.setValueAtTime(noteGain.gain.value, audioContext.currentTime);
    noteGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
    
    setTimeout(() => {
      try {
        osc.stop();
      } catch (e) {}
    }, 100);
    
    activeNotes.delete(midiNote);
  }
}

function updateMIDIStatus(message, isConnected) {
  const statusDiv = document.getElementById('midi-status');
  statusDiv.textContent = message;
  
  if (isConnected) {
    statusDiv.classList.add('connected');
  } else {
    statusDiv.classList.remove('connected');
  }
}

// ============================================
// INITIALIZATION
// ============================================

window.addEventListener('DOMContentLoaded', () => {
  initCymatics();
  updateDisplay();
});

    </script>
</body>
</html>